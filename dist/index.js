"use strict";var u=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var m=Object.prototype.hasOwnProperty;var E=(n,e)=>{for(var r in e)u(n,r,{get:e[r],enumerable:!0})},T=(n,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of d(e))!m.call(n,t)&&t!==r&&u(n,t,{get:()=>e[t],enumerable:!(i=f(e,t))||i.enumerable});return n};var v=n=>T(u({},"__esModule",{value:!0}),n);var x={};E(x,{default:()=>_,history:()=>p,save:()=>R});module.exports=v(x);function p(n=2){if(n<2)throw new Error("History depth must be greater than 1");return function(e,r){let i=null,{gl:t,uniforms:s}=r;e.registerHook("init",o),e.registerHook("step",(h,l)=>{let g=l%n;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D_ARRAY,i),t.copyTexSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,g,0,0,t.drawingBufferWidth,t.drawingBufferHeight)}),e.registerHook("updateResolution",()=>{t.deleteTexture(i),o()}),e.registerHook("reset",a),e.registerHook("destroy",()=>{t.deleteTexture(i),i=null});function o(){if(i=t.createTexture(),!i)throw new Error("Failed to create history texture");t.bindTexture(t.TEXTURE_2D_ARRAY,i),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.RGBA8,t.drawingBufferWidth,t.drawingBufferHeight,n),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D_ARRAY,i),a(),s.has("u_history")||e.initializeUniform("u_history","int",0)}function a(){t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D_ARRAY,i);let h=new Uint8Array(t.drawingBufferWidth*t.drawingBufferHeight*4);for(let l=0;l<n;++l)t.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,l,t.drawingBufferWidth,t.drawingBufferHeight,1,t.RGBA,t.UNSIGNED_BYTE,h)}}}function R(){return function(n,e){let{gl:r,canvas:i}=e,t=document.createElement("a");n.save=async function(s){if(r.clear(r.COLOR_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6),s&&!`${s}`.toLowerCase().endsWith(".png")&&(s=`${s}.png`),s=s||"export.png","ongesturechange"in window)try{let o=await new Promise(h=>i.toBlob(h,"image/png")),a=new File([o],s,{type:o.type});if(navigator.canShare?.({files:[a]})){await navigator.share({files:[a]});return}}catch(o){console.warn("Web Share API failed:",o)}else t.download=s,t.href=i.toDataURL(),t.click()}}}var w=`#version 300 es
in vec2 aPosition;
out vec2 v_uv;
void main() {
    v_uv = aPosition * 0.5 + 0.5;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}
`,b=1e3/30,c=class{constructor(e,r={}){this.isInternalCanvas=!1;this.isTouchDevice=!1;this.uniforms=new Map;this.textures=new Map;this.buffer=null;this.program=null;this.resizeTimeout=null;this.lastResizeTime=0;this.eventListeners=new Map;this.frame=0;this.startTime=0;this.cursorPosition=[.5,.5];this.clickPosition=[.5,.5];this.isMouseDown=!1;this.hooks=new Map;if(this.canvas=r.canvas||document.createElement("canvas"),r.canvas||(this.isInternalCanvas=!0,document.body.appendChild(this.canvas),this.canvas.style.position="fixed",this.canvas.style.inset="0",this.canvas.style.height="100dvh",this.canvas.style.width="100dvw"),this.gl=this.canvas.getContext("webgl2",{antialias:!1}),!this.gl)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");if(this.downloadLink=document.createElement("a"),this.fragmentShaderSrc=e,this.animationFrameId=null,this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resizeObserver=new ResizeObserver(()=>this.throttledHandleResize()),r.plugins){let i={gl:this.gl,uniforms:this.uniforms,textures:this.textures,program:this.program,canvas:this.canvas};r.plugins.forEach(t=>t(this,i))}this.init(),this.addEventListeners()}registerHook(e,r){this.hooks.has(e)||this.hooks.set(e,[]),this.hooks.get(e).push(r)}init(){let e=w;if(this.program=this.gl.createProgram(),!this.program)throw new Error("Failed to create WebGL program");let r=this.createShader(this.gl.VERTEX_SHADER,e),i=this.createShader(this.gl.FRAGMENT_SHADER,this.fragmentShaderSrc);if(this.gl.attachShader(this.program,r),this.gl.attachShader(this.program,i),this.gl.linkProgram(this.program),this.gl.deleteShader(r),this.gl.deleteShader(i),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw console.error("Program link error:",this.gl.getProgramInfoLog(this.program)),this.gl.deleteProgram(this.program),new Error("Failed to link WebGL program");let t=this.gl.getAttribLocation(this.program,"aPosition");this.setupBuffer(t),this.gl.useProgram(this.program),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}),this.resizeObserver.observe(this.canvas),this.isInternalCanvas||this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this.hooks.get("init")?.forEach(s=>s.call(this))}createShader(e,r){let i=this.gl.createShader(e);if(this.gl.shaderSource(i,r),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",r),console.error(this.gl.getShaderInfoLog(i)),this.gl.deleteShader(i),new Error("Shader compilation failed");return i}setupBuffer(e){let r=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.STATIC_DRAW),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,2,this.gl.FLOAT,!1,0,0)}throttledHandleResize(){clearTimeout(this.resizeTimeout);let e=performance.now(),r=this.lastResizeTime+b-e;r<=0?(this.lastResizeTime=e,this.handleResize()):this.resizeTimeout=setTimeout(()=>this.throttledHandleResize(),r)}handleResize(){let e=window.devicePixelRatio||1,r=this.canvas.clientWidth*e,i=this.canvas.clientHeight*e;this.isInternalCanvas&&(this.canvas.width!==r||this.canvas.height!==i)&&(this.canvas.width=r,this.canvas.height=i),this.onResize?.(r,i)}addEventListeners(){let e=(i,t)=>{if(!this.uniforms.has("u_cursor"))return;let s=this.canvas.getBoundingClientRect();this.cursorPosition[0]=(i-s.left)/s.width,this.cursorPosition[1]=1-(t-s.top)/s.height,this.updateUniforms({u_cursor:this.cursorPosition})},r=(i,t,s)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=i,i){let o=this.canvas.getBoundingClientRect(),a=t,h=s;this.clickPosition[0]=(a-o.left)/o.width,this.clickPosition[1]=1-(h-o.top)/o.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",i=>{let t=i;this.isTouchDevice||e(t.clientX,t.clientY)}),this.eventListeners.set("mousedown",i=>{let t=i;this.isTouchDevice||t.button===0&&(this.isMouseDown=!0,r(!0,t.clientX,t.clientY))}),this.eventListeners.set("mouseup",i=>{let t=i;this.isTouchDevice||t.button===0&&r(!1)}),this.eventListeners.set("touchmove",i=>{let t=i;t.touches.length>0&&e(t.touches[0].clientX,t.touches[0].clientY)}),this.eventListeners.set("touchstart",i=>{let t=i;this.isTouchDevice=!0,t.touches.length>0&&(e(t.touches[0].clientX,t.touches[0].clientY),r(!0,t.touches[0].clientX,t.touches[0].clientY))}),this.eventListeners.set("touchend",i=>{i.touches.length===0&&r(!1)}),this.eventListeners.forEach((i,t)=>{this.canvas.addEventListener(t,i)})}updateResolution(){let e=this.gl.drawingBufferWidth,r=this.gl.drawingBufferHeight;this.gl.viewport(0,0,e,r),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:[e,r]}):this.initializeUniform("u_resolution","float",[e,r]),this.hooks.get("updateResolution")?.forEach(i=>i.call(this))}initializeUniform(e,r,i){if(this.uniforms.has(e))throw new Error(`Uniform '${e}' is already initialized.`);if(r!=="float"&&r!=="int")throw new Error(`Invalid uniform type: ${r}. Expected 'float' or 'int'.`);let t=this.gl.getUniformLocation(this.program,e);if(!t){console.debug(`Uniform ${e} not found in fragment shader. Skipping initialization.`);return}if(Array.isArray(i)||(i=[i]),i.length<1||i.length>4)throw new Error(`Invalid uniform value length: ${i.length}. Expected a length between 1 and 4.`);let s=i.length;this.uniforms.set(e,{type:r,length:s,location:t}),this.updateUniforms({[e]:i})}updateUniforms(e){Object.entries(e).forEach(([r,i])=>{if(!this.uniforms.has(r))throw new Error(`Uniform '${r}' is not initialized.`);let t=this.uniforms.get(r);if(Array.isArray(i)||(i=[i]),i.length!==t.length)throw new Error(`Invalid uniform value length: ${i.length}. Expected ${t.length}.`);this.gl[`uniform${t.length}${t.type.charAt(0)}`](t.location,...i)})}step(e){let r=this.gl;this.uniforms.has("u_time")&&this.updateUniforms({u_time:e}),this.uniforms.has("u_frame")&&this.updateUniforms({u_frame:this.frame}),r.clear(r.COLOR_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6),this.hooks.get("step")?.forEach(i=>i.call(this,e,this.frame)),++this.frame}play(e){this.pause();let r=i=>{i=(i-this.startTime)/1e3,this.step(i),this.animationFrameId=requestAnimationFrame(r),e&&e(i,this.frame)};this.animationFrameId=requestAnimationFrame(r)}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}reset(){this.frame=0,this.startTime=performance.now(),this.hooks.get("reset")?.forEach(e=>e.call(this))}initializeTexture(e,r){if(this.textures.has(e))throw new Error(`Texture '${e}' is already initialized.`);let i=this.gl.createTexture();if(!i)throw new Error("Failed to create texture");let t=this.textures.size+1;this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.textures.set(e,{texture:i,unitIndex:t}),this.updateTextures({[e]:r});let s=this.gl.getUniformLocation(this.program,e);s&&this.gl.uniform1i(s,t)}updateTextures(e){Object.entries(e).forEach(([r,i])=>{let t=this.textures.get(r);if(!t)throw new Error(`Texture '${r}' is not initialized.`);this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,t.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i)})}async save(e){if(this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.drawArrays(this.gl.TRIANGLES,0,6),e&&!`${e}`.toLowerCase().endsWith(".png")&&(e=`${e}.png`),e=e||"export.png","ongesturechange"in window)try{let r=await new Promise(t=>this.canvas.toBlob(t,"image/png")),i=new File([r],e,{type:r.type});if(navigator.canShare?.({files:[i]})){await navigator.share({files:[i]});return}}catch(r){console.warn("Web Share API failed:",r)}else this.downloadLink.download=e,this.downloadLink.href=this.canvas.toDataURL(),this.downloadLink.click()}destroy(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resolutionObserver.disconnect(),this.resizeObserver.disconnect(),this.eventListeners.forEach((e,r)=>{this.canvas.removeEventListener(r,e)}),this.program&&this.gl.deleteProgram(this.program),this.textures.forEach(e=>{this.gl.deleteTexture(e.texture)}),this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.hooks.get("destroy")?.forEach(e=>e.call(this)),this.isInternalCanvas&&this.canvas.remove()}},_=c;0&&(module.exports={history,save});
//# sourceMappingURL=index.js.map