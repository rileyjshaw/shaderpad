"use strict";var T=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var _=(a,e)=>{for(var t in e)T(a,t,{get:e[t],enumerable:!0})},A=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of L(e))!w.call(a,i)&&i!==t&&T(a,i,{get:()=>e[i],enumerable:!(r=F(e,i))||r.enumerable});return a};var U=a=>A(T({},"__esModule",{value:!0}),a);var H={};_(H,{default:()=>O});module.exports=U(H);var P=`#version 300 es
in vec2 aPosition;
out vec2 v_uv;
void main() {
    v_uv = aPosition * 0.5 + 0.5;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}`,I=33.333333333333336,g=Symbol("u_history"),p=Symbol("__SHADERPAD_BUFFER");function S(a,e){if(!e?.length)return a;let t=a.split(`
`),r=t.findLastIndex(i=>{let s=i.trimStart();return s.startsWith("precision ")||s.startsWith("#version ")})+1;return t.splice(r,0,...e),t.join(`
`)}function E(a){return a instanceof WebGLTexture?{width:0,height:0}:a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a instanceof HTMLImageElement?{width:a.naturalWidth??a.width,height:a.naturalHeight??a.height}:{width:a.width,height:a.height}}function d(a){return typeof a=="symbol"?a.description??"":a}var x=class{isInternalCanvas=!1;isTouchDevice=!1;gl;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;program=null;aPositionLocation=0;animationFrameId;resolutionObserver;resizeObserver;resizeTimeout=null;lastResizeTime=-1/0;eventListeners=new Map;frame=0;startTime=0;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;hooks=new Map;historyDepth=0;textureOptions;debug;intermediateFbo=null;constructor(e,{canvas:t,plugins:r,history:i,debug:s,...o}={}){if(this.canvas=t||document.createElement("canvas"),!t){this.isInternalCanvas=!0;let f=this.canvas;f.style.position="fixed",f.style.inset="0",f.style.height="100dvh",f.style.width="100dvw",document.body.appendChild(f)}let n=this.canvas.getContext("webgl2",{antialias:!1});if(!n)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=n,this.textureUnitPool={free:[],next:0,max:n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.textureOptions=o;let{internalFormat:l,type:h}=o;(h===n.FLOAT||h===n.HALF_FLOAT||l===n.RGBA16F||l===n.RGBA32F||l===n.R16F||l===n.R32F||l===n.RG16F||l===n.RG32F)&&!n.getExtension("EXT_color_buffer_float")&&(console.warn("EXT_color_buffer_float not supported, falling back to RGBA8"),delete this.textureOptions?.internalFormat,delete this.textureOptions?.format,delete this.textureOptions?.type),i&&(this.historyDepth=i),this.debug=s??(typeof process<"u"&&!1),this.animationFrameId=null,this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resizeObserver=new ResizeObserver(()=>this.throttledHandleResize());let m=[];r&&r.forEach(f=>f(this,{gl:n,canvas:this.canvas,injectGLSL:R=>{m.push(R)},emitHook:this.emitHook.bind(this)}));let c=this.gl.createProgram();if(!c)throw new Error("Failed to create WebGL program");this.program=c;let v=this.createShader(this.gl.VERTEX_SHADER,P),b=this.createShader(n.FRAGMENT_SHADER,S(e,m));if(n.attachShader(c,v),n.attachShader(c,b),n.linkProgram(c),n.deleteShader(v),n.deleteShader(b),!n.getProgramParameter(c,n.LINK_STATUS))throw console.error("Program link error:",n.getProgramInfoLog(c)),n.deleteProgram(c),new Error("Failed to link WebGL program");this.aPositionLocation=n.getAttribLocation(c,"aPosition");let y=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);this.buffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.buffer),n.bufferData(n.ARRAY_BUFFER,y,n.STATIC_DRAW),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.enableVertexAttribArray(this.aPositionLocation),n.vertexAttribPointer(this.aPositionLocation,2,n.FLOAT,!1,0,0),n.useProgram(c),this.canvas instanceof HTMLCanvasElement&&(this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}),this.resizeObserver.observe(this.canvas)),this.isInternalCanvas||this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this.historyDepth>0&&(this._initializeTexture(p,this.canvas,{...this.textureOptions}),this._initializeTexture(g,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.intermediateFbo=n.createFramebuffer()),this.canvas instanceof HTMLCanvasElement&&this.addEventListeners(),this.emitHook("init")}emitHook(e,...t){this.hooks.get(e)?.forEach(r=>r.call(this,...t))}on(e,t){this.hooks.has(e)||this.hooks.set(e,[]),this.hooks.get(e).push(t)}off(e,t){let r=this.hooks.get(e);r&&r.splice(r.indexOf(t),1)}createShader(e,t){let r=this.gl.createShader(e);if(this.gl.shaderSource(r,t),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",t),console.error(this.gl.getShaderInfoLog(r)),this.gl.deleteShader(r),new Error("Shader compilation failed");return r}throttledHandleResize(){clearTimeout(this.resizeTimeout);let e=performance.now(),t=this.lastResizeTime+I-e;t<=0?(this.lastResizeTime=e,this.handleResize()):this.resizeTimeout=setTimeout(()=>this.throttledHandleResize(),t)}handleResize(){if(!(this.canvas instanceof HTMLCanvasElement))return;let e=window.devicePixelRatio||1,t=this.canvas.clientWidth*e,r=this.canvas.clientHeight*e;this.isInternalCanvas&&(this.canvas.width!==t||this.canvas.height!==r)&&(this.canvas.width=t,this.canvas.height=r),this.emitHook("resize",t,r)}addEventListeners(){let e=this.canvas,t=(i,s)=>{if(!this.uniforms.has("u_cursor"))return;let o=e.getBoundingClientRect();this.cursorPosition[0]=(i-o.left)/o.width,this.cursorPosition[1]=1-(s-o.top)/o.height,this.updateUniforms({u_cursor:this.cursorPosition})},r=(i,s,o)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=i,i){let n=e.getBoundingClientRect(),l=s,h=o;this.clickPosition[0]=(l-n.left)/n.width,this.clickPosition[1]=1-(h-n.top)/n.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",i=>{let s=i;this.isTouchDevice||t(s.clientX,s.clientY)}),this.eventListeners.set("mousedown",i=>{let s=i;this.isTouchDevice||s.button===0&&(this.isMouseDown=!0,r(!0,s.clientX,s.clientY))}),this.eventListeners.set("mouseup",i=>{let s=i;this.isTouchDevice||s.button===0&&r(!1)}),this.eventListeners.set("touchmove",i=>{let s=i;s.touches.length>0&&t(s.touches[0].clientX,s.touches[0].clientY)}),this.eventListeners.set("touchstart",i=>{let s=i;this.isTouchDevice=!0,s.touches.length>0&&(t(s.touches[0].clientX,s.touches[0].clientY),r(!0,s.touches[0].clientX,s.touches[0].clientY))}),this.eventListeners.set("touchend",i=>{i.touches.length===0&&r(!1)}),this.eventListeners.forEach((i,s)=>{e.addEventListener(s,i)})}updateResolution(){let e=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...e),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:e}):this.initializeUniform("u_resolution","float",e),this.historyDepth>0&&(this.resizeTexture(g,...e),this.resizeTexture(p,...e)),this.emitHook("updateResolution",...e)}resizeTexture(e,t,r){let i=this.textures.get(e);if(!i||i.width===t&&i.height===r)return;this.gl.deleteTexture(i.texture),i.width=t,i.height=r;let{texture:s}=this.createTexture(e,i);i.texture=s,i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}reserveTextureUnit(e){let t=this.textures.get(e);if(t)return t.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}releaseTextureUnit(e){let t=this.textures.get(e);t&&this.textureUnitPool.free.push(t.unitIndex)}resolveTextureOptions(e){let{gl:t}=this,r=e?.type??t.UNSIGNED_BYTE;return{type:r,format:e?.format??t.RGBA,internalFormat:e?.internalFormat??(r===t.FLOAT?t.RGBA32F:r===t.HALF_FLOAT?t.RGBA16F:t.RGBA8),minFilter:e?.minFilter??t.LINEAR,magFilter:e?.magFilter??t.LINEAR,wrapS:e?.wrapS??t.CLAMP_TO_EDGE,wrapT:e?.wrapT??t.CLAMP_TO_EDGE,preserveY:e?.preserveY}}clearHistoryTextureLayers(e){if(!e.history)return;let t=this.gl,{type:r,format:i}=e.options,s=e.width*e.height*4,o=r===t.FLOAT?new Float32Array(s):r===t.HALF_FLOAT?new Uint16Array(s):new Uint8Array(s);t.activeTexture(t.TEXTURE0+e.unitIndex),t.bindTexture(t.TEXTURE_2D_ARRAY,e.texture);for(let n=0;n<e.history.depth;++n)t.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,n,e.width,e.height,1,i,r,o)}initializeUniform(e,t,r,i){let s=i?.arrayLength;if(this.uniforms.has(e))throw new Error(`${e} is already initialized.`);if(t!=="float"&&t!=="int")throw new Error(`Invalid uniform type: ${t}. Expected 'float' or 'int'.`);if(s&&!(Array.isArray(r)&&r.length===s))throw new Error(`${e} array length mismatch: must initialize with ${s} elements.`);let o=this.gl.getUniformLocation(this.program,e);if(!o&&s&&(o=this.gl.getUniformLocation(this.program,`${e}[0]`)),!o){this.log(`${e} not in shader. Skipping initialization.`);return}let n=s?r[0]:r,l=Array.isArray(n)?n.length:1;this.uniforms.set(e,{type:t,length:l,location:o,arrayLength:s});try{this.updateUniforms({[e]:r})}catch(h){throw this.uniforms.delete(e),h}this.emitHook("initializeUniform",...arguments)}log(...e){this.debug&&console.debug(...e)}updateUniforms(e,t){this.gl.useProgram(this.program),Object.entries(e).forEach(([r,i])=>{let s=this.uniforms.get(r);if(!s){this.log(`${r} not in shader. Skipping update.`);return}let o=`uniform${s.length}${s.type.charAt(0)}`;if(s.arrayLength){if(!Array.isArray(i))throw new Error(`${r} is an array, but the value passed to updateUniforms is not an array.`);let n=i.length;if(!n)return;if(n>s.arrayLength)throw new Error(`${r} received ${n} values, but maximum length is ${s.arrayLength}.`);if(i.some(u=>(Array.isArray(u)?u.length:1)!==s.length))throw new Error(`Tried to update ${r} with some elements that are not length ${s.length}.`);let l=new(s.type==="float"?Float32Array:Int32Array)(i.flat()),h=s.location;if(t?.startIndex){let u=this.gl.getUniformLocation(this.program,`${r}[${t.startIndex}]`);if(!u)throw new Error(`${r}[${t.startIndex}] not in shader. Did you pass an invalid startIndex?`);h=u}this.gl[o+"v"](h,l)}else{if(Array.isArray(i)||(i=[i]),i.length!==s.length)throw new Error(`Invalid uniform value length: ${i.length}. Expected ${s.length}.`);this.gl[o](s.location,...i)}}),this.emitHook("updateUniforms",...arguments)}createTexture(e,t){let{width:r,height:i}=t,s=t.history?.depth??0,o=this.gl.createTexture();if(!o)throw new Error("Failed to create texture");let n=t.unitIndex;if(typeof n!="number")try{n=this.reserveTextureUnit(e)}catch(m){throw this.gl.deleteTexture(o),m}let l=s>0,h=l?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:u}=t;return this.gl.activeTexture(this.gl.TEXTURE0+n),this.gl.bindTexture(h,o),this.gl.texParameteri(h,this.gl.TEXTURE_WRAP_S,u.wrapS),this.gl.texParameteri(h,this.gl.TEXTURE_WRAP_T,u.wrapT),this.gl.texParameteri(h,this.gl.TEXTURE_MIN_FILTER,u.minFilter),this.gl.texParameteri(h,this.gl.TEXTURE_MAG_FILTER,u.magFilter),l?this.gl.texStorage3D(h,1,u.internalFormat,r,i,s):e===p&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,u.internalFormat,r,i,0,u.format,u.type,null),{texture:o,unitIndex:n}}_initializeTexture(e,t,r){if(this.textures.has(e))throw new Error(`Texture '${d(e)}' is already initialized.`);let{history:i=0,...s}=r??{},{width:o,height:n}=E(t);if(!o||!n)throw new Error("Texture source must have valid dimensions");let l={width:o,height:n,options:this.resolveTextureOptions(s)};i>0&&(l.history={depth:i,writeIndex:0});let{texture:h,unitIndex:u}=this.createTexture(e,l),m={texture:h,unitIndex:u,...l};i>0&&(this.initializeUniform(`${d(e)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(m)),this.textures.set(e,m),this.updateTexture(e,t);let c=this.gl.getUniformLocation(this.program,d(e));c&&this.gl.uniform1i(c,u)}initializeTexture(e,t,r){this._initializeTexture(e,t,r),this.emitHook("initializeTexture",...arguments)}updateTextures(e,t){Object.entries(e).forEach(([r,i])=>{this.updateTexture(r,i,t)}),this.emitHook("updateTextures",...arguments)}updateTexture(e,t,r){let i=this.textures.get(e);if(!i)throw new Error(`Texture '${d(e)}' is not initialized.`);if(t instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,t);return}let{width:s,height:o}=E(t);if(!s||!o)return;let n="isPartial"in t&&t.isPartial;n||this.resizeTexture(e,s,o);let h=!("data"in t&&t.data)&&!i.options?.preserveY,u=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL);if(i.history){if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture),!r?.skipHistoryWrite){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h),this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,i.history.writeIndex,s,o,1,i.options.format,i.options.type,t.data??t),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,u);let m=`${d(e)}FrameOffset`;this.updateUniforms({[m]:i.history.writeIndex}),i.history.writeIndex=(i.history.writeIndex+1)%i.history.depth}}else this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,i.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h),n?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,t.x??0,t.y??0,s,o,i.options.format,i.options.type,t.data):this.gl.texImage2D(this.gl.TEXTURE_2D,0,i.options.internalFormat,s,o,0,i.options.format,i.options.type,t.data??t),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,u)}draw(e){this.emitHook("beforeDraw",...arguments);let t=this.gl,r=t.drawingBufferWidth,i=t.drawingBufferHeight,s=this.textures.get(g),o=this.textures.get(p),n=s&&!e?.skipHistoryWrite;n&&(t.bindFramebuffer(t.FRAMEBUFFER,this.intermediateFbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,o.texture,0)),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.vertexAttribPointer(this.aPositionLocation,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.aPositionLocation),t.viewport(0,0,r,i),e?.skipClear||t.clear(t.COLOR_BUFFER_BIT),t.drawArrays(t.TRIANGLES,0,6),n&&(t.bindTexture(t.TEXTURE_2D_ARRAY,s.texture),t.copyTexSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,s.history.writeIndex,0,0,r,i),t.bindFramebuffer(t.READ_FRAMEBUFFER,this.intermediateFbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.blitFramebuffer(0,0,r,i,0,0,r,i,t.COLOR_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,null)),this.emitHook("afterDraw",...arguments)}step(e,t){this.emitHook("beforeStep",...arguments);let r={};this.uniforms.has("u_time")&&(r.u_time=e),this.uniforms.has("u_frame")&&(r.u_frame=this.frame),this.updateUniforms(r),this.draw(t);let i=this.textures.get(g);if(i&&!t?.skipHistoryWrite){let{writeIndex:s,depth:o}=i.history;this.updateUniforms({[`${d(g)}FrameOffset`]:s}),i.history.writeIndex=(s+1)%o}++this.frame,this.emitHook("afterStep",...arguments)}play(e,t){this.pause();let r=i=>{i=(i-this.startTime)/1e3;let s=t?.(i,this.frame)??void 0;this.step(i,s),this.animationFrameId=requestAnimationFrame(r),e?.(i,this.frame)};this.animationFrameId=requestAnimationFrame(r),this.emitHook("play")}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.emitHook("pause")}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(e=>{e.history&&(e.history.writeIndex=0,this.clearHistoryTextureLayers(e))}),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resolutionObserver.disconnect(),this.resizeObserver.disconnect(),this.canvas instanceof HTMLCanvasElement&&this.eventListeners.forEach((e,t)=>{this.canvas.removeEventListener(t,e)}),this.program&&this.gl.deleteProgram(this.program),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(e=>{this.gl.deleteTexture(e.texture)}),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.isInternalCanvas&&this.canvas instanceof HTMLCanvasElement&&this.canvas.remove()}},O=x;
//# sourceMappingURL=index.js.map