"use strict";var z=Object.create;var R=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var G=(n,e)=>{for(var i in e)R(n,i,{get:e[i],enumerable:!0})},P=(n,e,i,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of N(e))!B.call(n,r)&&r!==i&&R(n,r,{get:()=>e[r],enumerable:!(t=O(e,r))||t.enumerable});return n};var F=(n,e,i)=>(i=n!=null?z(H(n)):{},P(e||!n||!n.__esModule?R(i,"default",{value:n,enumerable:!0}):i,n)),Y=n=>P(R({},"__esModule",{value:!0}),n);var J={};G(J,{default:()=>q,face:()=>X,helpers:()=>$,save:()=>W});module.exports=Y(J);function W(){return function(n,e){let{gl:i,canvas:t}=e,r=document.createElement("a");n.save=async function(s){if(i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLES,0,6),s&&!`${s}`.toLowerCase().endsWith(".png")&&(s=`${s}.png`),s=s||"export.png","ongesturechange"in window)try{let h=await new Promise(c=>t.toBlob(c,"image/png")),l=new File([h],s,{type:h.type});if(navigator.canShare?.({files:[l]})){await navigator.share({files:[l]});return}}catch(h){console.warn("Web Share API failed:",h)}else r.download=s,r.href=t.toDataURL(),r.click()}}}var d={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function X(n){let{textureName:e,options:i}=n,t="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(r,s){let{uniforms:h,injectGLSL:l}=s,c=null,m=null,x=-1,v=new Map,A=512,C=512,f=document.createElement("canvas");f.width=A,f.height=C;let T=f.getContext("2d");T.globalCompositeOperation="lighten";async function k(){try{let{FilesetResolver:u,FaceLandmarker:a}=await import("@mediapipe/tasks-vision");m=await u.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),c=await a.createFromOptions(m,{baseOptions:{modelAssetPath:i?.modelPath||t},runningMode:"VIDEO",numFaces:i?.numFaces??1,minFaceDetectionConfidence:i?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:i?.minFacePresenceConfidence??.5,minTrackingConfidence:i?.minTrackingConfidence??.5,outputFaceBlendshapes:i?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:i?.outputFacialTransformationMatrixes??!1})}catch(u){throw console.error("Failed to initialize Face Landmarker:",u),u}}function M(u){let a=1/0,o=-1/0,g=1/0,p=-1/0;for(let y of u)a=Math.min(a,y.x),o=Math.max(o,y.x),g=Math.min(g,y.y),p=Math.max(p,y.y);let _=(a+o)/2,L=(g+p)/2;return[_,L]}function E(u,a){T.fillStyle=`rgb(${Math.round(a.r*255)}, ${Math.round(a.g*255)}, ${Math.round(a.b*255)})`;let o=u[0];T.beginPath(),T.moveTo(o.x*f.width,o.y*f.height);for(let g=1;g<u.length;g++){let p=u[g];T.lineTo(p.x*f.width,p.y*f.height)}T.closePath(),T.fill()}async function D(u){if(!c){console.warn("[Face Plugin] Cannot update mask: faceLandmarker or canvas missing");return}try{let{FaceLandmarker:a}=await import("@mediapipe/tasks-vision");T.clearRect(0,0,f.width,f.height),E(d.OUTER_LIP.map(o=>u[o]),{r:.25,g:0,b:0}),E(d.INNER_LIP.map(o=>u[o]),{r:.75,g:0,b:0}),E(a.FACE_LANDMARKS_TESSELATION.map(({start:o})=>u[o]),{r:0,g:.25,b:0}),E(a.FACE_LANDMARKS_FACE_OVAL.map(({start:o})=>u[o]),{r:0,g:1,b:0}),E(d.LEFT_EYEBROW.map(o=>u[o]),{r:0,g:0,b:.15}),E(d.RIGHT_EYEBROW.map(o=>u[o]),{r:0,g:0,b:.35}),E(d.LEFT_EYE.map(o=>u[o]),{r:0,g:0,b:.65}),E(d.RIGHT_EYE.map(o=>u[o]),{r:0,g:0,b:.85}),r.updateTextures({u_faceMask:f})}catch(a){console.error("[Face Plugin] Failed to generate mask texture:",a)}}function U(u){if(!u.faceLandmarks||u.faceLandmarks.length===0)return;let a=u.faceLandmarks[0];if(!a||a.length!==478)return;let o=M(a),g=[a[d.LEFT_EYE_CENTER].x,a[d.LEFT_EYE_CENTER].y],p=[a[d.RIGHT_EYE_CENTER].x,a[d.RIGHT_EYE_CENTER].y],_=[a[d.NOSE_TIP].x,a[d.NOSE_TIP].y];D(a).catch(L=>{console.warn("Mask texture update error:",L)}),h.has("u_faceCenter")&&r.updateUniforms({u_faceCenter:[o[0],1-o[1]]}),h.has("u_leftEye")&&r.updateUniforms({u_leftEye:[g[0],1-g[1]]}),h.has("u_rightEye")&&r.updateUniforms({u_rightEye:[p[0],1-p[1]]}),h.has("u_noseTip")&&r.updateUniforms({u_noseTip:[_[0],1-_[1]]})}r.registerHook("init",async()=>{r.initializeTexture("u_faceMask",f),r.initializeUniform("u_faceCenter","float",[.5,.5]),r.initializeUniform("u_leftEye","float",[.5,.5]),r.initializeUniform("u_rightEye","float",[.5,.5]),r.initializeUniform("u_noseTip","float",[.5,.5]),await k()}),r.registerHook("updateTextures",u=>{Object.entries(u).forEach(([a,o])=>{if(a===e&&(v.set(a,o),!!c))try{if(o instanceof HTMLVideoElement){if(o.currentTime!==x){x=o.currentTime;let g=performance.now(),p=c.detectForVideo(o,g);U(p)}}else if(o instanceof HTMLImageElement){let g=c.detect(o);U(g)}}catch(g){console.warn("Face detection error:",g)}})}),r.registerHook("destroy",()=>{c&&(c.close(),c=null),m=null,v.clear(),f.remove()}),l(`
uniform vec2 u_faceCenter;
uniform vec2 u_leftEye;
uniform vec2 u_rightEye;
uniform vec2 u_noseTip;
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}function $(){return function(n,e){e.injectGLSL(`
float historyZ(highp sampler2DArray tex, int frameOffset, int framesAgo) {
	int historyDepth = textureSize(tex, 0).z;
	int z = (historyDepth + frameOffset - framesAgo) % historyDepth;
	return float(z);
}`)}}var V=`#version 300 es
in vec2 aPosition;
out vec2 v_uv;
void main() {
    v_uv = aPosition * 0.5 + 0.5;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}
`,j=1e3/30,w=Symbol("u_history");function K(n,e){if(!e?.length)return n;let i=n.split(`
`),t=i.findLastIndex(r=>{let s=r.trimStart();return s.startsWith("precision ")||s.startsWith("#version ")})+1;return i.splice(t,0,"",...e),i.join(`
`)}function I(n){if(n instanceof HTMLVideoElement)return{width:n.videoWidth,height:n.videoHeight};if(n instanceof HTMLCanvasElement){let e=n.getContext("webgl2");return e?{width:e.drawingBufferWidth,height:e.drawingBufferHeight}:{width:n.width,height:n.height}}return{width:n.naturalWidth??n.width,height:n.naturalHeight??n.height}}function b(n){return typeof n=="symbol"?n.description??"":n}var S=class{isInternalCanvas=!1;isTouchDevice=!1;gl;fragmentShaderSrc;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;program=null;animationFrameId;resolutionObserver;resizeObserver;resizeTimeout=null;lastResizeTime=0;eventListeners=new Map;frame=0;startTime=0;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;onResize;hooks=new Map;historyDepth;constructor(e,i={}){if(this.canvas=i.canvas||document.createElement("canvas"),i.canvas||(this.isInternalCanvas=!0,document.body.appendChild(this.canvas),this.canvas.style.position="fixed",this.canvas.style.inset="0",this.canvas.style.height="100dvh",this.canvas.style.width="100dvw"),this.gl=this.canvas.getContext("webgl2",{antialias:!1}),!this.gl)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.textureUnitPool={free:[],next:0,max:this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.historyDepth=i.history??0,this.animationFrameId=null,this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resizeObserver=new ResizeObserver(()=>this.throttledHandleResize());let t=[];if(i.plugins){let r={gl:this.gl,uniforms:this.uniforms,textures:this.textures,canvas:this.canvas,reserveTextureUnit:this.reserveTextureUnit.bind(this),releaseTextureUnit:this.releaseTextureUnit.bind(this),injectGLSL:s=>{t.push(s)}};Object.defineProperty(r,"program",{get:()=>this.program,enumerable:!0,configurable:!0}),i.plugins.forEach(s=>s(this,r))}this.fragmentShaderSrc=K(e,t),this.init(),this.addEventListeners()}registerHook(e,i){this.hooks.has(e)||this.hooks.set(e,[]),this.hooks.get(e).push(i)}init(){let e=V;if(this.program=this.gl.createProgram(),!this.program)throw new Error("Failed to create WebGL program");let i=this.createShader(this.gl.VERTEX_SHADER,e),t=this.createShader(this.gl.FRAGMENT_SHADER,this.fragmentShaderSrc);if(this.gl.attachShader(this.program,i),this.gl.attachShader(this.program,t),this.gl.linkProgram(this.program),this.gl.deleteShader(i),this.gl.deleteShader(t),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw console.error("Program link error:",this.gl.getProgramInfoLog(this.program)),this.gl.deleteProgram(this.program),new Error("Failed to link WebGL program");let r=this.gl.getAttribLocation(this.program,"aPosition");this.setupBuffer(r),this.gl.useProgram(this.program),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}),this.resizeObserver.observe(this.canvas),this.isInternalCanvas||this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this.historyDepth>=1&&this._initializeTexture(w,this.canvas,{history:this.historyDepth}),this.hooks.get("init")?.forEach(s=>s.call(this))}createShader(e,i){let t=this.gl.createShader(e);if(this.gl.shaderSource(t,i),this.gl.compileShader(t),!this.gl.getShaderParameter(t,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",i),console.error(this.gl.getShaderInfoLog(t)),this.gl.deleteShader(t),new Error("Shader compilation failed");return t}setupBuffer(e){let i=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,2,this.gl.FLOAT,!1,0,0)}throttledHandleResize(){clearTimeout(this.resizeTimeout);let e=performance.now(),i=this.lastResizeTime+j-e;i<=0?(this.lastResizeTime=e,this.handleResize()):this.resizeTimeout=setTimeout(()=>this.throttledHandleResize(),i)}handleResize(){let e=window.devicePixelRatio||1,i=this.canvas.clientWidth*e,t=this.canvas.clientHeight*e;this.isInternalCanvas&&(this.canvas.width!==i||this.canvas.height!==t)&&(this.canvas.width=i,this.canvas.height=t),this.onResize?.(i,t)}addEventListeners(){let e=(t,r)=>{if(!this.uniforms.has("u_cursor"))return;let s=this.canvas.getBoundingClientRect();this.cursorPosition[0]=(t-s.left)/s.width,this.cursorPosition[1]=1-(r-s.top)/s.height,this.updateUniforms({u_cursor:this.cursorPosition})},i=(t,r,s)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=t,t){let h=this.canvas.getBoundingClientRect(),l=r,c=s;this.clickPosition[0]=(l-h.left)/h.width,this.clickPosition[1]=1-(c-h.top)/h.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",t=>{let r=t;this.isTouchDevice||e(r.clientX,r.clientY)}),this.eventListeners.set("mousedown",t=>{let r=t;this.isTouchDevice||r.button===0&&(this.isMouseDown=!0,i(!0,r.clientX,r.clientY))}),this.eventListeners.set("mouseup",t=>{let r=t;this.isTouchDevice||r.button===0&&i(!1)}),this.eventListeners.set("touchmove",t=>{let r=t;r.touches.length>0&&e(r.touches[0].clientX,r.touches[0].clientY)}),this.eventListeners.set("touchstart",t=>{let r=t;this.isTouchDevice=!0,r.touches.length>0&&(e(r.touches[0].clientX,r.touches[0].clientY),i(!0,r.touches[0].clientX,r.touches[0].clientY))}),this.eventListeners.set("touchend",t=>{t.touches.length===0&&i(!1)}),this.eventListeners.forEach((t,r)=>{this.canvas.addEventListener(r,t)})}updateResolution(){let e=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...e),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:e}):this.initializeUniform("u_resolution","float",e),this.hooks.get("updateResolution")?.forEach(i=>i.call(this))}reserveTextureUnit(e){let i=this.textures.get(e);if(i)return i.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}releaseTextureUnit(e){let i=this.textures.get(e);i&&this.textureUnitPool.free.push(i.unitIndex)}clearHistoryTextureLayers(e){if(!e.history)return;let i=new Uint8Array(e.width*e.height*4);this.gl.activeTexture(this.gl.TEXTURE0+e.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,e.texture);for(let t=0;t<e.history.depth;++t)this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,t,e.width,e.height,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i)}initializeUniform(e,i,t){if(this.uniforms.has(e))throw new Error(`Uniform '${e}' is already initialized.`);if(i!=="float"&&i!=="int")throw new Error(`Invalid uniform type: ${i}. Expected 'float' or 'int'.`);let r=this.gl.getUniformLocation(this.program,e);if(!r){console.debug(`Uniform ${e} not found in fragment shader. Skipping initialization.`);return}if(Array.isArray(t)||(t=[t]),t.length<1||t.length>4)throw new Error(`Invalid uniform value length: ${t.length}. Expected a length between 1 and 4.`);let s=t.length;this.uniforms.set(e,{type:i,length:s,location:r}),this.hooks.get("initializeUniform")?.forEach(h=>h.call(this,...arguments)),this.updateUniforms({[e]:t})}updateUniforms(e){this.hooks.get("updateUniforms")?.forEach(i=>i.call(this,...arguments)),Object.entries(e).forEach(([i,t])=>{let r=this.uniforms.get(i);if(!r){console.debug(`Uniform ${i} not found in fragment shader. Skipping update.`);return}if(Array.isArray(t)||(t=[t]),t.length!==r.length)throw new Error(`Invalid uniform value length: ${t.length}. Expected ${r.length}.`);this.gl[`uniform${r.length}${r.type.charAt(0)}`](r.location,...t)})}createTexture(e,i,t){let{width:r,height:s}=i,h=i.history?.depth??0,l=this.gl.createTexture();if(!l)throw new Error("Failed to create texture");if(typeof t!="number")try{t=this.reserveTextureUnit(e)}catch(x){throw this.gl.deleteTexture(l),x}let c=h>=1,m=c?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D;return this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(m,l),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(m,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(m,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),c&&this.gl.texStorage3D(m,1,this.gl.RGBA8,r,s,h),{texture:l,unitIndex:t}}_initializeTexture(e,i,t){if(this.textures.has(e))throw new Error(`Texture '${b(e)}' is already initialized.`);let r=t?.history??0,{width:s,height:h}=I(i);if(!s||!h)throw new Error("Texture source must have valid dimensions");let l={width:s,height:h};r>=1&&(l.history={depth:r,writeIndex:0});let{texture:c,unitIndex:m}=this.createTexture(e,l),x={texture:c,unitIndex:m,...l};r>=1&&(this.initializeUniform(`${b(e)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(x)),this.textures.set(e,x),this.updateTexture(e,i);let v=this.gl.getUniformLocation(this.program,b(e));v&&this.gl.uniform1i(v,m)}initializeTexture(e,i,t){this._initializeTexture(e,i,t),this.hooks.get("initializeTexture")?.forEach(r=>r.call(this,...arguments))}updateTextures(e){this.hooks.get("updateTextures")?.forEach(i=>i.call(this,...arguments)),Object.entries(e).forEach(([i,t])=>{this.updateTexture(i,t)})}updateTexture(e,i){let t=this.textures.get(e);if(!t)throw new Error(`Texture '${b(e)}' is not initialized.`);let{width:r,height:s}=I(i);if(t.width!==r||t.height!==s){this.gl.deleteTexture(t.texture),t.width=r,t.height=s;let{texture:h}=this.createTexture(e,t,t.unitIndex);t.texture=h,t.history&&(t.history.writeIndex=0,this.clearHistoryTextureLayers(t))}if(t.history){let h=e===w;this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,t.texture),h?this.gl.copyTexSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,t.history.writeIndex,0,0,r,s):this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,t.history.writeIndex,r,s,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i);let l=`${b(e)}FrameOffset`;this.updateUniforms({[l]:t.history.writeIndex}),t.history.writeIndex=(t.history.writeIndex+1)%t.history.depth}else this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,t.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i)}step(e){let i=this.gl;this.uniforms.has("u_time")&&this.updateUniforms({u_time:e}),this.uniforms.has("u_frame")&&this.updateUniforms({u_frame:this.frame}),i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLES,0,6),this.textures.get(w)&&this.updateTexture(w,this.canvas),this.hooks.get("step")?.forEach(t=>t.call(this,e,this.frame)),++this.frame}play(e){this.pause();let i=t=>{t=(t-this.startTime)/1e3,this.step(t),this.animationFrameId=requestAnimationFrame(i),e&&e(t,this.frame)};this.animationFrameId=requestAnimationFrame(i)}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(e=>{e.history&&(e.history.writeIndex=0,this.clearHistoryTextureLayers(e))}),this.hooks.get("reset")?.forEach(e=>e.call(this))}destroy(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resolutionObserver.disconnect(),this.resizeObserver.disconnect(),this.eventListeners.forEach((e,i)=>{this.canvas.removeEventListener(i,e)}),this.program&&this.gl.deleteProgram(this.program),this.textures.forEach(e=>{this.gl.deleteTexture(e.texture)}),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.hooks.get("destroy")?.forEach(e=>e.call(this)),this.isInternalCanvas&&this.canvas.remove()}},q=S;0&&(module.exports={face,helpers,save});
//# sourceMappingURL=index.js.map