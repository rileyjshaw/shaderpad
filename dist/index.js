"use strict";var v=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var A=(a,t)=>{for(var e in t)v(a,e,{get:t[e],enumerable:!0})},S=(a,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of R(t))!_.call(a,i)&&i!==e&&v(a,i,{get:()=>t[i],enumerable:!(r=w(t,i))||r.enumerable});return a};var U=a=>S(v({},"__esModule",{value:!0}),a);var C={};A(C,{default:()=>G});module.exports=U(C);function y(a,t){return(a%t+t)%t}var P=`#version 300 es
out vec2 v_uv;
void main() {
    int id = gl_VertexID;
    vec2 uv = vec2(float((id << 1) & 2), float(id & 2));
    gl_Position = vec4(uv * vec2(2.0, -2.0) + vec2(-1.0, 1.0), 0.0, 1.0);
    v_uv = gl_Position.xy * 0.5 + 0.5;
}`,E=Symbol("u_history"),T=Symbol("__SHADERPAD_BUFFER");function I(a,t){if(!t?.length)return a;let e=a.split(`
`),r=e.findLastIndex(i=>{let s=i.trimStart();return s.startsWith("precision ")||s.startsWith("#version ")})+1;return e.splice(r,0,...t),e.join(`
`)}function F(a){return a instanceof WebGLTexture?{width:0,height:0}:a instanceof b?{width:a.canvas.width,height:a.canvas.height}:a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a instanceof HTMLImageElement?{width:a.naturalWidth??a.width,height:a.naturalHeight??a.height}:{width:a.width,height:a.height}}function p(a){return typeof a=="symbol"?a.description??"":a}var b=class a{isHeadless=!1;isTouchDevice=!1;gl;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;program=null;aPositionLocation=0;animationFrameId;eventListeners=new Map;frame=0;startTime=0;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;resolutionObserver=null;hooks=new Map;historyDepth=0;textureOptions;debug;intermediateFbo=null;constructor(t,{canvas:e,plugins:r,history:i,debug:s,...o}={}){if(e&&"getContext"in e)this.canvas=e;else{let{width:m=1,height:c=1}=e||{};this.canvas=new OffscreenCanvas(m,c),this.isHeadless=!0}let n=this.canvas.getContext("webgl2",{antialias:!1});if(!n)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=n,this.textureUnitPool={free:[],next:0,max:n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.textureOptions=o,i&&(this.historyDepth=i),this.debug=s??(typeof process<"u"&&!1),this.animationFrameId=null;let u=[];r&&r.forEach(m=>m(this,{gl:n,canvas:this.canvas,injectGLSL:c=>{u.push(c)},emitHook:this.emitHook.bind(this)}));let h=this.gl.createProgram();if(!h)throw new Error("Failed to create WebGL program");this.program=h;let l=this.createShader(this.gl.VERTEX_SHADER,P),g=this.createShader(n.FRAGMENT_SHADER,I(t,u));if(n.attachShader(h,l),n.attachShader(h,g),n.linkProgram(h),n.deleteShader(l),n.deleteShader(g),!n.getProgramParameter(h,n.LINK_STATUS))throw console.error("Program link error:",n.getProgramInfoLog(h)),n.deleteProgram(h),new Error("Failed to link WebGL program");if(this.aPositionLocation=n.getAttribLocation(h,"aPosition"),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.useProgram(h),this.canvas instanceof HTMLCanvasElement)this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]});else{let m=c=>{let f=Object.getOwnPropertyDescriptor(OffscreenCanvas.prototype,c);Object.defineProperty(this.canvas,c,{get:()=>f.get.call(this.canvas),set:x=>{f.set.call(this.canvas,x),this.updateResolution()},configurable:f.configurable,enumerable:f.enumerable})};m("width"),m("height")}this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this._initializeTexture(T,this.canvas,{...this.textureOptions}),this.intermediateFbo=n.createFramebuffer(),this.historyDepth>0&&this._initializeTexture(E,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.canvas instanceof HTMLCanvasElement&&this.addEventListeners(),this.emitHook("init")}resolveGLConstant(t){let e=this.gl[t];if(e===void 0)throw new Error(`Unknown GL constant: ${t}`);return e}emitHook(t,...e){this.hooks.get(t)?.forEach(r=>r.call(this,...e))}on(t,e){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(e)}off(t,e){let r=this.hooks.get(t);r&&r.splice(r.indexOf(e),1)}createShader(t,e){let r=this.gl.createShader(t);if(this.gl.shaderSource(r,e),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",e),console.error(this.gl.getShaderInfoLog(r)),this.gl.deleteShader(r),new Error("Shader compilation failed");return r}addEventListeners(){let t=this.canvas,e=(i,s)=>{if(!this.uniforms.has("u_cursor"))return;let o=t.getBoundingClientRect();this.cursorPosition[0]=(i-o.left)/o.width,this.cursorPosition[1]=1-(s-o.top)/o.height,this.updateUniforms({u_cursor:this.cursorPosition})},r=(i,s,o)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=i,i){let n=t.getBoundingClientRect(),u=s,h=o;this.clickPosition[0]=(u-n.left)/n.width,this.clickPosition[1]=1-(h-n.top)/n.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",i=>{let s=i;this.isTouchDevice||e(s.clientX,s.clientY)}),this.eventListeners.set("mousedown",i=>{let s=i;this.isTouchDevice||s.button===0&&(this.isMouseDown=!0,r(!0,s.clientX,s.clientY))}),this.eventListeners.set("mouseup",i=>{let s=i;this.isTouchDevice||s.button===0&&r(!1)}),this.eventListeners.set("touchmove",i=>{let s=i;s.touches.length>0&&e(s.touches[0].clientX,s.touches[0].clientY)}),this.eventListeners.set("touchstart",i=>{let s=i;this.isTouchDevice=!0,s.touches.length>0&&(e(s.touches[0].clientX,s.touches[0].clientY),r(!0,s.touches[0].clientX,s.touches[0].clientY))}),this.eventListeners.set("touchend",i=>{i.touches.length===0&&r(!1)}),this.eventListeners.forEach((i,s)=>{t.addEventListener(s,i)})}updateResolution(){let t=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...t),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:t}):this.initializeUniform("u_resolution","float",t),this.resizeTexture(T,...t),this.historyDepth>0&&this.resizeTexture(E,...t),this.emitHook("updateResolution",...t)}resizeTexture(t,e,r){let i=this.textures.get(t);if(!i||i.width===e&&i.height===r)return;this.gl.deleteTexture(i.texture),i.width=e,i.height=r;let{texture:s}=this.createTexture(t,i);i.texture=s,i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}reserveTextureUnit(t){let e=this.textures.get(t);if(e)return e.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}resolveTextureOptions(t){let{gl:e}=this,r=this.resolveGLConstant(t?.type??"UNSIGNED_BYTE"),i={type:r,format:this.resolveGLConstant(t?.format??"RGBA"),internalFormat:this.resolveGLConstant(t?.internalFormat??(r===e.FLOAT?"RGBA32F":r===e.HALF_FLOAT?"RGBA16F":"RGBA8")),minFilter:this.resolveGLConstant(t?.minFilter??"LINEAR"),magFilter:this.resolveGLConstant(t?.magFilter??"LINEAR"),wrapS:this.resolveGLConstant(t?.wrapS??"CLAMP_TO_EDGE"),wrapT:this.resolveGLConstant(t?.wrapT??"CLAMP_TO_EDGE"),preserveY:t?.preserveY};if((i.internalFormat===e.RGBA16F||i.internalFormat===e.RGBA32F)&&!e.getExtension("EXT_color_buffer_float"))throw new Error("Missing EXT_color_buffer_float.");return i}getPixelArray(t,e){return t===this.gl.FLOAT?new Float32Array(e):t===this.gl.HALF_FLOAT?new Uint16Array(e):new Uint8Array(e)}clearHistoryTextureLayers(t){if(!t.history)return;let e=this.gl,{type:r,format:i}=t.options,s=this.getPixelArray(r,t.width*t.height*4);e.activeTexture(e.TEXTURE0+t.unitIndex),e.bindTexture(e.TEXTURE_2D_ARRAY,t.texture);for(let o=0;o<t.history.depth;++o)e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,o,t.width,t.height,1,i,r,s)}initializeUniform(t,e,r,i){let s=i?.arrayLength;if(this.uniforms.has(t))throw new Error(`${t} is already initialized.`);if(e!=="float"&&e!=="int")throw new Error(`Invalid uniform type: ${e}. Expected 'float' or 'int'.`);if(s&&!(Array.isArray(r)&&r.length===s))throw new Error(`${t} array length mismatch: must initialize with ${s} elements.`);let o=this.gl.getUniformLocation(this.program,t);if(!o&&s&&(o=this.gl.getUniformLocation(this.program,`${t}[0]`)),!o){this.log(`${t} not in shader. Skipping initialization.`);return}let n=s?r[0]:r,u=Array.isArray(n)?n.length:1;this.uniforms.set(t,{type:e,length:u,location:o,arrayLength:s});try{this.updateUniforms({[t]:r})}catch(h){throw this.uniforms.delete(t),h}this.emitHook("initializeUniform",...arguments)}log(...t){this.debug&&console.debug(...t)}updateUniforms(t,e){this.gl.useProgram(this.program),Object.entries(t).forEach(([r,i])=>{let s=this.uniforms.get(r);if(!s){this.log(`${r} not in shader. Skipping update.`);return}let o=`uniform${s.length}${s.type.charAt(0)}`;if(s.arrayLength){if(!Array.isArray(i))throw new Error(`${r} is an array, but the value passed to updateUniforms is not an array.`);let n=i.length;if(!n)return;if(n>s.arrayLength)throw new Error(`${r} received ${n} values, but maximum length is ${s.arrayLength}.`);if(i.some(l=>(Array.isArray(l)?l.length:1)!==s.length))throw new Error(`Tried to update ${r} with some elements that are not length ${s.length}.`);let u=new(s.type==="float"?Float32Array:Int32Array)(i.flat()),h=s.location;if(e?.startIndex){let l=this.gl.getUniformLocation(this.program,`${r}[${e.startIndex}]`);if(!l)throw new Error(`${r}[${e.startIndex}] not in shader. Did you pass an invalid startIndex?`);h=l}this.gl[o+"v"](h,u)}else{if(Array.isArray(i)||(i=[i]),i.length!==s.length)throw new Error(`Invalid uniform value length: ${i.length}. Expected ${s.length}.`);this.gl[o](s.location,...i)}}),this.emitHook("updateUniforms",...arguments)}createTexture(t,e){let{width:r,height:i}=e,s=e.history?.depth??0,o=this.gl.createTexture();if(!o)throw new Error("Failed to create texture");let n=e.unitIndex;if(typeof n!="number")try{n=this.reserveTextureUnit(t)}catch(g){throw this.gl.deleteTexture(o),g}let u=s>0,h=u?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:l}=e;return this.gl.activeTexture(this.gl.TEXTURE0+n),this.gl.bindTexture(h,o),this.gl.texParameteri(h,this.gl.TEXTURE_WRAP_S,l.wrapS),this.gl.texParameteri(h,this.gl.TEXTURE_WRAP_T,l.wrapT),this.gl.texParameteri(h,this.gl.TEXTURE_MIN_FILTER,l.minFilter),this.gl.texParameteri(h,this.gl.TEXTURE_MAG_FILTER,l.magFilter),u?this.gl.texStorage3D(h,1,l.internalFormat,r,i,s):t===T&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,l.internalFormat,r,i,0,l.format,l.type,null),{texture:o,unitIndex:n}}_initializeTexture(t,e,r){if(this.textures.has(t))throw new Error(`Texture '${p(t)}' is already initialized.`);let{history:i=0,...s}=r??{},{width:o,height:n}=F(e);if(!o||!n)throw new Error("Texture source must have valid dimensions");let u={width:o,height:n,options:this.resolveTextureOptions(s)};i>0&&(u.history={depth:i,writeIndex:0});let{texture:h,unitIndex:l}=this.createTexture(t,u),g={texture:h,unitIndex:l,...u};i>0&&(this.initializeUniform(`${p(t)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(g)),this.textures.set(t,g),this.updateTexture(t,e);let m=this.gl.getUniformLocation(this.program,p(t));m&&this.gl.uniform1i(m,l)}initializeTexture(t,e,r){let i=r?.history!=null&&r.history>0?{...r,history:r.history+1}:r;this._initializeTexture(t,e,i),this.emitHook("initializeTexture",...arguments)}updateTextures(t,e){Object.entries(t).forEach(([r,i])=>{this.updateTexture(r,i,e)}),this.emitHook("updateTextures",...arguments)}updateTexture(t,e,r){let i=this.textures.get(t);if(!i)throw new Error(`Texture '${p(t)}' is not initialized.`);if(e instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,e);return}let s=e;if(e instanceof a){let m=e.textures.get(T);if(e.gl===this.gl){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,m.texture);return}let{width:c,height:f,options:{format:x,type:d}}=m,L=this.getPixelArray(d,c*f*4);e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,e.intermediateFbo),e.gl.readPixels(0,0,c,f,x,d,L),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),s={data:L,width:c,height:f}}let{width:o,height:n}=F(s);if(!o||!n)return;let u="isPartial"in s&&s.isPartial;u||this.resizeTexture(t,o,n);let l=!("data"in s&&s.data)&&!i.options?.preserveY,g=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL);if(i.history){if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture),!r?.skipHistoryWrite){let{depth:m}=i.history,c=r?.historyWriteIndex===void 0?[i.history.writeIndex]:Array.isArray(r.historyWriteIndex)?r.historyWriteIndex.map(d=>y(d,m)):[y(r.historyWriteIndex,m)];this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,l);let f=s.data??s;for(let d of c)this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,d,o,n,1,i.options.format,i.options.type,f);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g);let x=`${p(t)}FrameOffset`;this.updateUniforms({[x]:c[c.length-1]}),r?.historyWriteIndex===void 0&&(i.history.writeIndex=(i.history.writeIndex+1)%m)}}else{if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,i.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,l),u){let m=s;this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,m.x??0,m.y??0,o,n,i.options.format,i.options.type,m.data)}else this.gl.texImage2D(this.gl.TEXTURE_2D,0,i.options.internalFormat,o,n,0,i.options.format,i.options.type,s.data??s);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g)}}bindIntermediate(){let t=this.gl,e=this.textures.get(T);t.bindFramebuffer(t.FRAMEBUFFER,this.intermediateFbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.texture,0)}clear(){this.bindIntermediate(),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}draw(t){this.emitHook("beforeDraw",...arguments);let e=this.gl,r=e.drawingBufferWidth,i=e.drawingBufferHeight;t?.skipClear?this.bindIntermediate():this.clear(),e.useProgram(this.program),e.viewport(0,0,r,i),e.drawArrays(e.TRIANGLES,0,3),this.isHeadless||(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.intermediateFbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.blitFramebuffer(0,0,r,i,0,0,r,i,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,null)),this.emitHook("afterDraw",...arguments)}step(t){this._step(performance.now()-this.startTime,t)}_step(t,e){this.emitHook("beforeStep",...arguments);let r={};this.uniforms.has("u_time")&&(r.u_time=t),this.uniforms.has("u_frame")&&(r.u_frame=this.frame),this.updateUniforms(r),this.draw(e);let i=this.textures.get(E);if(i&&!e?.skipHistoryWrite){let{writeIndex:s,depth:o}=i.history,n=this.gl;n.bindTexture(n.TEXTURE_2D_ARRAY,i.texture),n.copyTexSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,s,0,0,n.drawingBufferWidth,n.drawingBufferHeight);let u=(s+1)%o;this.updateUniforms({[`${p(E)}FrameOffset`]:u}),i.history.writeIndex=u}++this.frame,this.emitHook("afterStep",...arguments)}play(t,e){this.pause();let r=i=>{i=(i-this.startTime)/1e3;let s=t?.(i,this.frame)??void 0;this._step(i,s),this.animationFrameId=requestAnimationFrame(r),e?.(i,this.frame)};this.animationFrameId=requestAnimationFrame(r),this.emitHook("play")}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.emitHook("pause")}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(t=>{t.history&&(t.history.writeIndex=0,this.clearHistoryTextureLayers(t))}),this.clear(),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.canvas instanceof HTMLCanvasElement&&(this.eventListeners.forEach((t,e)=>{this.canvas.removeEventListener(e,t)}),this.eventListeners.clear()),this.resolutionObserver&&(this.resolutionObserver.disconnect(),this.resolutionObserver=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(t=>{this.gl.deleteTexture(t.texture)}),this.textures.clear(),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.uniforms.clear(),this.hooks.clear()}},G=b;
//# sourceMappingURL=index.js.map