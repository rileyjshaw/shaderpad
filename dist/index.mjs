function y(n){return n instanceof HTMLVideoElement?{width:n.videoWidth,height:n.videoHeight}:n instanceof HTMLCanvasElement?{width:n.width,height:n.height}:{width:n.naturalWidth||n.width,height:n.naturalHeight||n.height}}function C(n,i,t,e){let r=new Uint8Array(i*t*4);for(let u=0;u<e;++u)n.texSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,u,i,t,1,n.RGBA,n.UNSIGNED_BYTE,r)}function F(n,i,t,e){let r=n.createTexture();if(!r)throw new Error("Failed to create history texture");return n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D_ARRAY,r),n.texParameteri(n.TEXTURE_2D_ARRAY,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D_ARRAY,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D_ARRAY,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D_ARRAY,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.RGBA8,t,e,i),C(n,t,e,i),r}function D(n=1){return function(i,t){let{gl:e,uniforms:r,textures:u,reserveTextureUnit:h}=t,f=i,R=i.initializeTexture.bind(i),L=i.updateTextures.bind(i),b=new Map,l=null;if(n>1){let c=function(){l=F(e,n,e.drawingBufferWidth,e.drawingBufferHeight),r.has("u_history")||i.initializeUniform("u_history","int",0)},T=function(){l&&(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D_ARRAY,l),C(e,e.drawingBufferWidth,e.drawingBufferHeight,n))};var P=c,S=T;i.registerHook("init",c),i.registerHook("step",(v,m)=>{if(!l)return;let E=m%n;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D_ARRAY,l),e.copyTexSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,E,0,0,e.drawingBufferWidth,e.drawingBufferHeight)}),i.registerHook("updateResolution",()=>{l&&e.deleteTexture(l),c()}),i.registerHook("reset",T)}i.registerHook("reset",()=>{b.forEach(c=>{c.writeIndex=0})}),f.initializeTexture=function(c,T,v=1){let{width:m,height:E}=y(T);if(!m||!E)throw new Error("Texture source must have valid dimensions");let _=Math.floor(v);if(_<=1)return R(c,T);if(u.has(c))throw new Error(`Texture '${c}' is already initialized.`);let a,o=null;try{if(a=h(c),o=F(e,_,m,E),e.activeTexture(e.TEXTURE0+a),e.bindTexture(e.TEXTURE_2D_ARRAY,o),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),t.program){let s=e.getUniformLocation(t.program,c);s&&e.uniform1i(s,a)}u.set(c,{texture:o,unitIndex:a}),b.set(c,{depth:_,writeIndex:0}),f.updateTextures({[c]:T})}catch(s){throw o&&e.deleteTexture(o),a!==void 0&&t.releaseTextureUnit(c),s}},f.updateTextures=function(c){Object.entries(c).forEach(([T,v])=>{let m=u.get(T),E=b.get(T);if(!m||!E||E.depth<=1)return L({[T]:v});let{width:_,height:a}=y(v),o=E.writeIndex;e.activeTexture(e.TEXTURE0+m.unitIndex),e.bindTexture(e.TEXTURE_2D_ARRAY,m.texture),e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,o,_,a,1,e.RGBA,e.UNSIGNED_BYTE,v),E.writeIndex=(o+1)%E.depth})},i.registerHook("destroy",()=>{l&&e.deleteTexture(l),b.clear()})}}function X(){return function(n,i){let{gl:t,canvas:e}=i,r=document.createElement("a");n.save=async function(u){if(t.clear(t.COLOR_BUFFER_BIT),t.drawArrays(t.TRIANGLES,0,6),u&&!`${u}`.toLowerCase().endsWith(".png")&&(u=`${u}.png`),u=u||"export.png","ongesturechange"in window)try{let h=await new Promise(R=>e.toBlob(R,"image/png")),f=new File([h],u,{type:h.type});if(navigator.canShare?.({files:[f]})){await navigator.share({files:[f]});return}}catch(h){console.warn("Web Share API failed:",h)}else r.download=u,r.href=e.toDataURL(),r.click()}}}var x={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function N(n){let{textureName:i,options:t}=n,e="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(r,u){let{uniforms:h}=u,f=null,R=null,L=-1,b=new Map,l=null,d=null,P=512,S=512;function c(){l=document.createElement("canvas"),l.width=P,l.height=S,d=l.getContext("2d"),d.globalCompositeOperation="lighten"}async function T(){try{let{FilesetResolver:a,FaceLandmarker:o}=await import("@mediapipe/tasks-vision");R=await a.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),f=await o.createFromOptions(R,{baseOptions:{modelAssetPath:t?.modelPath||e},runningMode:"VIDEO",numFaces:t?.numFaces??1,minFaceDetectionConfidence:t?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:t?.minFacePresenceConfidence??.5,minTrackingConfidence:t?.minTrackingConfidence??.5,outputFaceBlendshapes:t?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:t?.outputFacialTransformationMatrixes??!1})}catch(a){throw console.error("Failed to initialize Face Landmarker:",a),a}}function v(a){let o=1/0,s=-1/0,g=1/0,p=-1/0;for(let U of a)o=Math.min(o,U.x),s=Math.max(s,U.x),g=Math.min(g,U.y),p=Math.max(p,U.y);let w=(o+s)/2,A=(g+p)/2;return[w,A]}function m(a,o){if(!d)return;d.fillStyle=`rgb(${Math.round(o.r*255)}, ${Math.round(o.g*255)}, ${Math.round(o.b*255)})`;let s=a[0];d.beginPath(),d.moveTo(s.x*d.canvas.width,s.y*d.canvas.height);for(let g=1;g<a.length;g++){let p=a[g];d.lineTo(p.x*d.canvas.width,p.y*d.canvas.height)}d.closePath(),d.fill()}async function E(a){if(!f||!l){console.warn("[Face Plugin] Cannot update mask: faceLandmarker or canvas missing");return}try{let{FaceLandmarker:o}=await import("@mediapipe/tasks-vision");if(!d)return;d.clearRect(0,0,l.width,l.height),m(x.OUTER_LIP.map(s=>a[s]),{r:.25,g:0,b:0}),m(x.INNER_LIP.map(s=>a[s]),{r:.75,g:0,b:0}),m(o.FACE_LANDMARKS_TESSELATION.map(({start:s})=>a[s]),{r:0,g:.25,b:0}),m(o.FACE_LANDMARKS_FACE_OVAL.map(({start:s})=>a[s]),{r:0,g:1,b:0}),m(x.LEFT_EYEBROW.map(s=>a[s]),{r:0,g:0,b:.15}),m(x.RIGHT_EYEBROW.map(s=>a[s]),{r:0,g:0,b:.35}),m(x.LEFT_EYE.map(s=>a[s]),{r:0,g:0,b:.65}),m(x.RIGHT_EYE.map(s=>a[s]),{r:0,g:0,b:.85}),r.updateTextures({u_faceMask:l})}catch(o){console.error("[Face Plugin] Failed to generate mask texture:",o)}}function _(a){if(!a.faceLandmarks||a.faceLandmarks.length===0)return;let o=a.faceLandmarks[0];if(!o||o.length!==478)return;let s=v(o),g=[o[x.LEFT_EYE_CENTER].x,o[x.LEFT_EYE_CENTER].y],p=[o[x.RIGHT_EYE_CENTER].x,o[x.RIGHT_EYE_CENTER].y],w=[o[x.NOSE_TIP].x,o[x.NOSE_TIP].y];console.log(s,g,p,w),E(o).catch(A=>{console.warn("Mask texture update error:",A)}),h.has("u_faceCenter")&&r.updateUniforms({u_faceCenter:[s[0],1-s[1]]}),h.has("u_leftEye")&&r.updateUniforms({u_leftEye:[g[0],1-g[1]]}),h.has("u_rightEye")&&r.updateUniforms({u_rightEye:[p[0],1-p[1]]}),h.has("u_noseTip")&&r.updateUniforms({u_noseTip:[w[0],1-w[1]]})}r.registerHook("init",async()=>{if(c(),await T(),!l)throw new Error("Face mask canvas not initialized");r.initializeTexture("u_faceMask",l),r.initializeUniform("u_faceCenter","float",[.5,.5]),r.initializeUniform("u_leftEye","float",[.5,.5]),r.initializeUniform("u_rightEye","float",[.5,.5]),r.initializeUniform("u_noseTip","float",[.5,.5])}),r.registerHook("updateTextures",a=>{Object.entries(a).forEach(([o,s])=>{if(o===i&&(b.set(o,s),!!f))try{if(s instanceof HTMLVideoElement){if(s.currentTime!==L){L=s.currentTime;let g=performance.now(),p=f.detectForVideo(s,g);_(p)}}else if(s instanceof HTMLImageElement){let g=f.detect(s);_(g)}}catch(g){console.warn("Face detection error:",g)}})}),r.registerHook("destroy",()=>{f&&(f.close(),f=null),R=null,b.clear(),l=null})}}var M=`#version 300 es
in vec2 aPosition;
out vec2 v_uv;
void main() {
    v_uv = aPosition * 0.5 + 0.5;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}
`,k=1e3/30,I=class{constructor(i,t={}){this.isInternalCanvas=!1;this.isTouchDevice=!1;this.uniforms=new Map;this.textures=new Map;this.buffer=null;this.program=null;this.resizeTimeout=null;this.lastResizeTime=0;this.eventListeners=new Map;this.frame=0;this.startTime=0;this.cursorPosition=[.5,.5];this.clickPosition=[.5,.5];this.isMouseDown=!1;this.hooks=new Map;if(this.canvas=t.canvas||document.createElement("canvas"),t.canvas||(this.isInternalCanvas=!0,document.body.appendChild(this.canvas),this.canvas.style.position="fixed",this.canvas.style.inset="0",this.canvas.style.height="100dvh",this.canvas.style.width="100dvw"),this.gl=this.canvas.getContext("webgl2",{antialias:!1}),!this.gl)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");if(this.textureUnitPool={free:[],next:1,max:this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.downloadLink=document.createElement("a"),this.fragmentShaderSrc=i,this.animationFrameId=null,this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resizeObserver=new ResizeObserver(()=>this.throttledHandleResize()),t.plugins){let e={gl:this.gl,uniforms:this.uniforms,textures:this.textures,canvas:this.canvas,reserveTextureUnit:this.reserveTextureUnit.bind(this),releaseTextureUnit:this.releaseTextureUnit.bind(this)};Object.defineProperty(e,"program",{get:()=>this.program,enumerable:!0,configurable:!0}),t.plugins.forEach(r=>r(this,e))}this.init(),this.addEventListeners()}registerHook(i,t){this.hooks.has(i)||this.hooks.set(i,[]),this.hooks.get(i).push(t)}init(){let i=M;if(this.program=this.gl.createProgram(),!this.program)throw new Error("Failed to create WebGL program");let t=this.createShader(this.gl.VERTEX_SHADER,i),e=this.createShader(this.gl.FRAGMENT_SHADER,this.fragmentShaderSrc);if(this.gl.attachShader(this.program,t),this.gl.attachShader(this.program,e),this.gl.linkProgram(this.program),this.gl.deleteShader(t),this.gl.deleteShader(e),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw console.error("Program link error:",this.gl.getProgramInfoLog(this.program)),this.gl.deleteProgram(this.program),new Error("Failed to link WebGL program");let r=this.gl.getAttribLocation(this.program,"aPosition");this.setupBuffer(r),this.gl.useProgram(this.program),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}),this.resizeObserver.observe(this.canvas),this.isInternalCanvas||this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this.hooks.get("init")?.forEach(u=>u.call(this))}createShader(i,t){let e=this.gl.createShader(i);if(this.gl.shaderSource(e,t),this.gl.compileShader(e),!this.gl.getShaderParameter(e,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",t),console.error(this.gl.getShaderInfoLog(e)),this.gl.deleteShader(e),new Error("Shader compilation failed");return e}setupBuffer(i){let t=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0)}throttledHandleResize(){clearTimeout(this.resizeTimeout);let i=performance.now(),t=this.lastResizeTime+k-i;t<=0?(this.lastResizeTime=i,this.handleResize()):this.resizeTimeout=setTimeout(()=>this.throttledHandleResize(),t)}handleResize(){let i=window.devicePixelRatio||1,t=this.canvas.clientWidth*i,e=this.canvas.clientHeight*i;this.isInternalCanvas&&(this.canvas.width!==t||this.canvas.height!==e)&&(this.canvas.width=t,this.canvas.height=e),this.onResize?.(t,e)}addEventListeners(){let i=(e,r)=>{if(!this.uniforms.has("u_cursor"))return;let u=this.canvas.getBoundingClientRect();this.cursorPosition[0]=(e-u.left)/u.width,this.cursorPosition[1]=1-(r-u.top)/u.height,this.updateUniforms({u_cursor:this.cursorPosition})},t=(e,r,u)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=e,e){let h=this.canvas.getBoundingClientRect(),f=r,R=u;this.clickPosition[0]=(f-h.left)/h.width,this.clickPosition[1]=1-(R-h.top)/h.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",e=>{let r=e;this.isTouchDevice||i(r.clientX,r.clientY)}),this.eventListeners.set("mousedown",e=>{let r=e;this.isTouchDevice||r.button===0&&(this.isMouseDown=!0,t(!0,r.clientX,r.clientY))}),this.eventListeners.set("mouseup",e=>{let r=e;this.isTouchDevice||r.button===0&&t(!1)}),this.eventListeners.set("touchmove",e=>{let r=e;r.touches.length>0&&i(r.touches[0].clientX,r.touches[0].clientY)}),this.eventListeners.set("touchstart",e=>{let r=e;this.isTouchDevice=!0,r.touches.length>0&&(i(r.touches[0].clientX,r.touches[0].clientY),t(!0,r.touches[0].clientX,r.touches[0].clientY))}),this.eventListeners.set("touchend",e=>{e.touches.length===0&&t(!1)}),this.eventListeners.forEach((e,r)=>{this.canvas.addEventListener(r,e)})}updateResolution(){let i=this.gl.drawingBufferWidth,t=this.gl.drawingBufferHeight;this.gl.viewport(0,0,i,t),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:[i,t]}):this.initializeUniform("u_resolution","float",[i,t]),this.hooks.get("updateResolution")?.forEach(e=>e.call(this))}reserveTextureUnit(i){let t=this.textures.get(i);if(t)return t.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}releaseTextureUnit(i){let t=this.textures.get(i);t&&this.textureUnitPool.free.push(t.unitIndex)}initializeUniform(i,t,e){if(this.uniforms.has(i))throw new Error(`Uniform '${i}' is already initialized.`);if(t!=="float"&&t!=="int")throw new Error(`Invalid uniform type: ${t}. Expected 'float' or 'int'.`);let r=this.gl.getUniformLocation(this.program,i);if(!r){console.debug(`Uniform ${i} not found in fragment shader. Skipping initialization.`);return}if(Array.isArray(e)||(e=[e]),e.length<1||e.length>4)throw new Error(`Invalid uniform value length: ${e.length}. Expected a length between 1 and 4.`);let u=e.length;this.uniforms.set(i,{type:t,length:u,location:r}),this.hooks.get("initializeUniform")?.forEach(h=>h.call(this,...arguments)),this.updateUniforms({[i]:e})}updateUniforms(i){this.hooks.get("updateUniforms")?.forEach(t=>t.call(this,...arguments)),Object.entries(i).forEach(([t,e])=>{if(!this.uniforms.has(t))throw new Error(`Uniform '${t}' is not initialized.`);let r=this.uniforms.get(t);if(Array.isArray(e)||(e=[e]),e.length!==r.length)throw new Error(`Invalid uniform value length: ${e.length}. Expected ${r.length}.`);this.gl[`uniform${r.length}${r.type.charAt(0)}`](r.location,...e)})}initializeTexture(i,t){if(this.textures.has(i))throw new Error(`Texture '${i}' is already initialized.`);let e=this.gl.createTexture();if(!e)throw new Error("Failed to create texture");let r;try{r=this.reserveTextureUnit(i)}catch(h){throw this.gl.deleteTexture(e),h}this.gl.activeTexture(this.gl.TEXTURE0+r),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.textures.set(i,{texture:e,unitIndex:r}),this.hooks.get("initializeTexture")?.forEach(h=>h.call(this,...arguments)),this.updateTextures({[i]:t});let u=this.gl.getUniformLocation(this.program,i);u&&this.gl.uniform1i(u,r)}updateTextures(i){this.hooks.get("updateTextures")?.forEach(t=>t.call(this,...arguments)),Object.entries(i).forEach(([t,e])=>{let r=this.textures.get(t);if(!r)throw new Error(`Texture '${t}' is not initialized.`);this.gl.activeTexture(this.gl.TEXTURE0+r.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,r.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e)})}step(i){let t=this.gl;this.uniforms.has("u_time")&&this.updateUniforms({u_time:i}),this.uniforms.has("u_frame")&&this.updateUniforms({u_frame:this.frame}),t.clear(t.COLOR_BUFFER_BIT),t.drawArrays(t.TRIANGLES,0,6),this.hooks.get("step")?.forEach(e=>e.call(this,i,this.frame)),++this.frame}play(i){this.pause();let t=e=>{e=(e-this.startTime)/1e3,this.step(e),this.animationFrameId=requestAnimationFrame(t),i&&i(e,this.frame)};this.animationFrameId=requestAnimationFrame(t)}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}reset(){this.frame=0,this.startTime=performance.now(),this.hooks.get("reset")?.forEach(i=>i.call(this))}destroy(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resolutionObserver.disconnect(),this.resizeObserver.disconnect(),this.eventListeners.forEach((i,t)=>{this.canvas.removeEventListener(t,i)}),this.program&&this.gl.deleteProgram(this.program),this.textures.forEach(i=>{this.gl.deleteTexture(i.texture)}),this.textureUnitPool.free=[],this.textureUnitPool.next=1,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.hooks.get("destroy")?.forEach(i=>i.call(this)),this.isInternalCanvas&&this.canvas.remove()}},$=I;export{$ as default,N as face,D as history,X as save};
//# sourceMappingURL=index.mjs.map