function v(s){let t=s,i=s,e=t.videoWidth||i.naturalWidth||i.width,r=t.videoHeight||i.naturalHeight||i.height;return{width:e,height:r}}function b(s,t,i,e){let r=new Uint8Array(t*i*4);for(let n=0;n<e;++n)s.texSubImage3D(s.TEXTURE_2D_ARRAY,0,0,0,n,t,i,1,s.RGBA,s.UNSIGNED_BYTE,r)}function R(s,t,i,e){let r=s.createTexture();if(!r)throw new Error("Failed to create history texture");return s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D_ARRAY,r),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D_ARRAY,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texStorage3D(s.TEXTURE_2D_ARRAY,1,s.RGBA8,i,e,t),b(s,i,e,t),r}function I(s=1){return function(t,i){let{gl:e,uniforms:r,textures:n,reserveTextureUnit:a}=i,c=t,T=t.initializeTexture.bind(t),_=t.updateTextures.bind(t),u=null;if(s>1){let o=function(){u=R(e,s,e.drawingBufferWidth,e.drawingBufferHeight),r.has("u_history")||t.initializeUniform("u_history","int",0)},l=function(){u&&(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D_ARRAY,u),b(e,e.drawingBufferWidth,e.drawingBufferHeight,s))};var L=o,P=l;t.registerHook("init",o),t.registerHook("step",(d,h)=>{if(!u)return;let f=h%s;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D_ARRAY,u),e.copyTexSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,f,0,0,e.drawingBufferWidth,e.drawingBufferHeight)}),t.registerHook("updateResolution",()=>{u&&e.deleteTexture(u),o()}),t.registerHook("reset",l)}t.registerHook("reset",()=>{n.forEach(o=>{o.historyDepth&&o.historyDepth>1&&o.writeIndex!==void 0&&(o.writeIndex=0)})}),c.initializeTexture=function(o,l,d=1){let{width:h,height:f}=v(l);if(!h||!f)throw new Error("Texture source must have valid dimensions");let m=Math.floor(d);if(m<=1)return T(o,l);if(n.has(o))throw new Error(`Texture '${o}' is already initialized.`);let g,E=null;try{if(g=a(o),E=R(e,m,h,f),e.activeTexture(e.TEXTURE0+g),e.bindTexture(e.TEXTURE_2D_ARRAY,E),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),i.program){let x=e.getUniformLocation(i.program,o);x&&e.uniform1i(x,g)}n.set(o,{texture:E,unitIndex:g,historyDepth:m,writeIndex:0}),c.updateTextures({[o]:l})}catch(x){throw E&&e.deleteTexture(E),g!==void 0&&i.releaseTextureUnit(o),x}},c.updateTextures=function(o){Object.entries(o).forEach(([l,d])=>{let h=n.get(l);if(!h||!h.historyDepth||h.historyDepth<=1)return _({[l]:d});let{width:f,height:m}=v(d),g=h.writeIndex??0;e.activeTexture(e.TEXTURE0+h.unitIndex),e.bindTexture(e.TEXTURE_2D_ARRAY,h.texture),e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,g,f,m,1,e.RGBA,e.UNSIGNED_BYTE,d),h.writeIndex=(g+1)%h.historyDepth})},t.registerHook("destroy",()=>{u&&e.deleteTexture(u)})}}function y(){return function(s,t){let{gl:i,canvas:e}=t,r=document.createElement("a");s.save=async function(n){if(i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLES,0,6),n&&!`${n}`.toLowerCase().endsWith(".png")&&(n=`${n}.png`),n=n||"export.png","ongesturechange"in window)try{let a=await new Promise(T=>e.toBlob(T,"image/png")),c=new File([a],n,{type:a.type});if(navigator.canShare?.({files:[c]})){await navigator.share({files:[c]});return}}catch(a){console.warn("Web Share API failed:",a)}else r.download=n,r.href=e.toDataURL(),r.click()}}}var w=`#version 300 es
in vec2 aPosition;
out vec2 v_uv;
void main() {
    v_uv = aPosition * 0.5 + 0.5;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}
`,U=1e3/30,p=class{constructor(t,i={}){this.isInternalCanvas=!1;this.isTouchDevice=!1;this.uniforms=new Map;this.textures=new Map;this.buffer=null;this.program=null;this.resizeTimeout=null;this.lastResizeTime=0;this.eventListeners=new Map;this.frame=0;this.startTime=0;this.cursorPosition=[.5,.5];this.clickPosition=[.5,.5];this.isMouseDown=!1;this.hooks=new Map;if(this.canvas=i.canvas||document.createElement("canvas"),i.canvas||(this.isInternalCanvas=!0,document.body.appendChild(this.canvas),this.canvas.style.position="fixed",this.canvas.style.inset="0",this.canvas.style.height="100dvh",this.canvas.style.width="100dvw"),this.gl=this.canvas.getContext("webgl2",{antialias:!1}),!this.gl)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");if(this.textureUnitPool={free:[],next:1,max:this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.downloadLink=document.createElement("a"),this.fragmentShaderSrc=t,this.animationFrameId=null,this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resizeObserver=new ResizeObserver(()=>this.throttledHandleResize()),i.plugins){let e={gl:this.gl,uniforms:this.uniforms,textures:this.textures,canvas:this.canvas,reserveTextureUnit:this.reserveTextureUnit.bind(this),releaseTextureUnit:this.releaseTextureUnit.bind(this)};Object.defineProperty(e,"program",{get:()=>this.program,enumerable:!0,configurable:!0}),i.plugins.forEach(r=>r(this,e))}this.init(),this.addEventListeners()}registerHook(t,i){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(i)}init(){let t=w;if(this.program=this.gl.createProgram(),!this.program)throw new Error("Failed to create WebGL program");let i=this.createShader(this.gl.VERTEX_SHADER,t),e=this.createShader(this.gl.FRAGMENT_SHADER,this.fragmentShaderSrc);if(this.gl.attachShader(this.program,i),this.gl.attachShader(this.program,e),this.gl.linkProgram(this.program),this.gl.deleteShader(i),this.gl.deleteShader(e),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw console.error("Program link error:",this.gl.getProgramInfoLog(this.program)),this.gl.deleteProgram(this.program),new Error("Failed to link WebGL program");let r=this.gl.getAttribLocation(this.program,"aPosition");this.setupBuffer(r),this.gl.useProgram(this.program),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}),this.resizeObserver.observe(this.canvas),this.isInternalCanvas||this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this.hooks.get("init")?.forEach(n=>n.call(this))}createShader(t,i){let e=this.gl.createShader(t);if(this.gl.shaderSource(e,i),this.gl.compileShader(e),!this.gl.getShaderParameter(e,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",i),console.error(this.gl.getShaderInfoLog(e)),this.gl.deleteShader(e),new Error("Shader compilation failed");return e}setupBuffer(t){let i=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0)}throttledHandleResize(){clearTimeout(this.resizeTimeout);let t=performance.now(),i=this.lastResizeTime+U-t;i<=0?(this.lastResizeTime=t,this.handleResize()):this.resizeTimeout=setTimeout(()=>this.throttledHandleResize(),i)}handleResize(){let t=window.devicePixelRatio||1,i=this.canvas.clientWidth*t,e=this.canvas.clientHeight*t;this.isInternalCanvas&&(this.canvas.width!==i||this.canvas.height!==e)&&(this.canvas.width=i,this.canvas.height=e),this.onResize?.(i,e)}addEventListeners(){let t=(e,r)=>{if(!this.uniforms.has("u_cursor"))return;let n=this.canvas.getBoundingClientRect();this.cursorPosition[0]=(e-n.left)/n.width,this.cursorPosition[1]=1-(r-n.top)/n.height,this.updateUniforms({u_cursor:this.cursorPosition})},i=(e,r,n)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=e,e){let a=this.canvas.getBoundingClientRect(),c=r,T=n;this.clickPosition[0]=(c-a.left)/a.width,this.clickPosition[1]=1-(T-a.top)/a.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",e=>{let r=e;this.isTouchDevice||t(r.clientX,r.clientY)}),this.eventListeners.set("mousedown",e=>{let r=e;this.isTouchDevice||r.button===0&&(this.isMouseDown=!0,i(!0,r.clientX,r.clientY))}),this.eventListeners.set("mouseup",e=>{let r=e;this.isTouchDevice||r.button===0&&i(!1)}),this.eventListeners.set("touchmove",e=>{let r=e;r.touches.length>0&&t(r.touches[0].clientX,r.touches[0].clientY)}),this.eventListeners.set("touchstart",e=>{let r=e;this.isTouchDevice=!0,r.touches.length>0&&(t(r.touches[0].clientX,r.touches[0].clientY),i(!0,r.touches[0].clientX,r.touches[0].clientY))}),this.eventListeners.set("touchend",e=>{e.touches.length===0&&i(!1)}),this.eventListeners.forEach((e,r)=>{this.canvas.addEventListener(r,e)})}updateResolution(){let t=this.gl.drawingBufferWidth,i=this.gl.drawingBufferHeight;this.gl.viewport(0,0,t,i),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:[t,i]}):this.initializeUniform("u_resolution","float",[t,i]),this.hooks.get("updateResolution")?.forEach(e=>e.call(this))}initializeUniform(t,i,e){if(this.uniforms.has(t))throw new Error(`Uniform '${t}' is already initialized.`);if(i!=="float"&&i!=="int")throw new Error(`Invalid uniform type: ${i}. Expected 'float' or 'int'.`);let r=this.gl.getUniformLocation(this.program,t);if(!r){console.debug(`Uniform ${t} not found in fragment shader. Skipping initialization.`);return}if(Array.isArray(e)||(e=[e]),e.length<1||e.length>4)throw new Error(`Invalid uniform value length: ${e.length}. Expected a length between 1 and 4.`);let n=e.length;this.uniforms.set(t,{type:i,length:n,location:r}),this.updateUniforms({[t]:e})}updateUniforms(t){Object.entries(t).forEach(([i,e])=>{if(!this.uniforms.has(i))throw new Error(`Uniform '${i}' is not initialized.`);let r=this.uniforms.get(i);if(Array.isArray(e)||(e=[e]),e.length!==r.length)throw new Error(`Invalid uniform value length: ${e.length}. Expected ${r.length}.`);this.gl[`uniform${r.length}${r.type.charAt(0)}`](r.location,...e)})}step(t){let i=this.gl;this.uniforms.has("u_time")&&this.updateUniforms({u_time:t}),this.uniforms.has("u_frame")&&this.updateUniforms({u_frame:this.frame}),i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLES,0,6),this.hooks.get("step")?.forEach(e=>e.call(this,t,this.frame)),++this.frame}play(t){this.pause();let i=e=>{e=(e-this.startTime)/1e3,this.step(e),this.animationFrameId=requestAnimationFrame(i),t&&t(e,this.frame)};this.animationFrameId=requestAnimationFrame(i)}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}reset(){this.frame=0,this.startTime=performance.now(),this.hooks.get("reset")?.forEach(t=>t.call(this))}initializeTexture(t,i){if(this.textures.has(t))throw new Error(`Texture '${t}' is already initialized.`);let e=this.gl.createTexture();if(!e)throw new Error("Failed to create texture");let r;try{r=this.reserveTextureUnit(t)}catch(a){throw this.gl.deleteTexture(e),a}this.gl.activeTexture(this.gl.TEXTURE0+r),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.textures.set(t,{texture:e,unitIndex:r}),this.updateTextures({[t]:i});let n=this.gl.getUniformLocation(this.program,t);n&&this.gl.uniform1i(n,r)}updateTextures(t){Object.entries(t).forEach(([i,e])=>{let r=this.textures.get(i);if(!r)throw new Error(`Texture '${i}' is not initialized.`);this.gl.activeTexture(this.gl.TEXTURE0+r.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,r.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e)})}async save(t){if(this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.drawArrays(this.gl.TRIANGLES,0,6),t&&!`${t}`.toLowerCase().endsWith(".png")&&(t=`${t}.png`),t=t||"export.png","ongesturechange"in window)try{let i=await new Promise(r=>this.canvas.toBlob(r,"image/png")),e=new File([i],t,{type:i.type});if(navigator.canShare?.({files:[e]})){await navigator.share({files:[e]});return}}catch(i){console.warn("Web Share API failed:",i)}else this.downloadLink.download=t,this.downloadLink.href=this.canvas.toDataURL(),this.downloadLink.click()}destroy(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resolutionObserver.disconnect(),this.resizeObserver.disconnect(),this.eventListeners.forEach((t,i)=>{this.canvas.removeEventListener(i,t)}),this.program&&this.gl.deleteProgram(this.program),this.textures.forEach(t=>{this.gl.deleteTexture(t.texture)}),this.textureUnitPool.free=[],this.textureUnitPool.next=1,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.hooks.get("destroy")?.forEach(t=>t.call(this)),this.isInternalCanvas&&this.canvas.remove()}reserveTextureUnit(t){if(!t)throw new Error("Texture unit name must be provided.");let i=this.textures.get(t);if(i)return i.unitIndex;let e;if(this.textureUnitPool.free.length>0)e=this.textureUnitPool.free.pop();else{if(e=this.textureUnitPool.next,e>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");this.textureUnitPool.next+=1}return e}releaseTextureUnit(t){let i=this.textures.get(t);if(!i)return;let e=i.unitIndex;e>0&&this.textureUnitPool.free.push(e)}},C=p;export{C as default,I as history,y as save};
//# sourceMappingURL=index.mjs.map