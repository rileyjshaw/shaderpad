import{a as M,b as R,c as S,d as v}from"../chunk-IW3Y5DYQ.mjs";var C=21,P=1,g=C+P,w=[0,0,5,9,13,17],o=512,y={modelPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",maxHands:2,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},x=new Map;function F(T,m,b){let t=T.landmarks.data,d=m.length;for(let r=0;r<d;++r){let p=m[r],i=b[r]?.[0]?.categoryName==="Right";for(let s=0;s<C;++s){let l=p[s],H=(r*g+s)*4;t[H]=l.x,t[H+1]=1-l.y,t[H+2]=l.z??0,t[H+3]=i?1:0}let h=S(t,r,w,g),c=(r*g+C)*4;t[c]=h[0],t[c+1]=h[1],t[c+2]=h[2],t[c+3]=i?1:0}T.state.nHands=d}function U(T){let{textureName:m,options:b={}}=T,t={...y,...b},d=R({...t,textureName:m}),r=t.maxHands*g,p=Math.ceil(r/o);return function(i,h){let{injectGLSL:c,gl:s,emitHook:l}=h,A=x.get(d)?.landmarks.data??new Float32Array(o*p*4),e=null;function k(){if(!e)return;let{nHands:n}=e.state,a=n*g,u=Math.ceil(a/o);i.updateTextures({u_handLandmarksTex:{data:e.landmarks.data,width:o,height:u,isPartial:n!==t.maxHands}}),i.updateUniforms({u_nHands:n}),l("hands:result",e.state.result)}async function E(){if(x.has(d))e=x.get(d);else{let[n,{HandLandmarker:a}]=await Promise.all([v(),import("@mediapipe/tasks-vision")]),u=new OffscreenCanvas(1,1);e={landmarker:await a.createFromOptions(n,{baseOptions:{modelAssetPath:t.modelPath,delegate:"GPU"},canvas:u,runningMode:"VIDEO",numHands:t.maxHands,minHandDetectionConfidence:t.minHandDetectionConfidence,minHandPresenceConfidence:t.minHandPresenceConfidence,minTrackingConfidence:t.minTrackingConfidence}),canvas:u,subscribers:new Map,state:{runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nHands:0},landmarks:{data:A,textureHeight:p}},x.set(d,e)}e.subscribers.set(k,!1)}let _=E();i.on("init",()=>{i.initializeUniform("u_maxHands","int",t.maxHands),i.initializeUniform("u_nHands","int",0),i.initializeTexture("u_handLandmarksTex",{data:A,width:o,height:p},{internalFormat:s.RGBA32F,type:s.FLOAT,minFilter:s.NEAREST,magFilter:s.NEAREST}),_.then(()=>l("hands:ready"))}),i.on("initializeTexture",(n,a)=>{n===m&&M(a)&&I(a)}),i.on("updateTextures",n=>{let a=n[m];M(a)&&I(a)});let O=0;async function I(n){let a=performance.now(),u=++O;await _,e&&(e.state.pending=e.state.pending.then(async()=>{if(u!==O||!e)return;let L=n instanceof HTMLVideoElement?"VIDEO":"IMAGE";e.state.runningMode!==L&&(e.state.runningMode=L,await e.landmarker.setOptions({runningMode:L}));let D=!1;if(n!==e.state.source?(e.state.source=n,e.state.videoTime=-1,D=!0):n instanceof HTMLVideoElement?n.currentTime!==e.state.videoTime&&(e.state.videoTime=n.currentTime,D=!0):n instanceof HTMLImageElement||a-e.state.resultTimestamp>2&&(D=!0),D){let f;if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;f=e.landmarker.detectForVideo(n,a)}else{if(n.width===0||n.height===0)return;f=e.landmarker.detect(n)}if(f){e.state.resultTimestamp=a,e.state.result=f,F(e,f.landmarks,f.handedness);for(let N of e.subscribers.keys())N(),e.subscribers.set(N,!0)}}else e.state.result&&!e.subscribers.get(k)&&(k(),e.subscribers.set(k,!0))}),await e.state.pending)}i.on("destroy",()=>{e&&(e.subscribers.delete(k),e.subscribers.size===0&&(e.landmarker.close(),x.delete(d))),e=null}),c(`
uniform int u_maxHands;
uniform int u_nHands;
uniform sampler2D u_handLandmarksTex;

vec4 handLandmark(int handIndex, int landmarkIndex) {
	int i = handIndex * ${g} + landmarkIndex;
	int x = i % ${o};
	int y = i / ${o};
	return texelFetch(u_handLandmarksTex, ivec2(x, y), 0);
}

float isRightHand(int handIndex) {
	return handLandmark(handIndex, 0).w;
}

float isLeftHand(int handIndex) {
	return 1.0 - handLandmark(handIndex, 0).w;
}`)}}var K=U;export{K as default};
//# sourceMappingURL=hands.mjs.map