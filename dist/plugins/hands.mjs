import{b as M,c as P,d as F,e as w,f as $}from"../chunk-JRSBIGBN.mjs";var C=21,z=1,g=C+z,V=[0,0,5,9,13,17],m=512,k=1,K={modelPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",maxHands:2,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},L=new Map;function G(D,l,r){let s=D.landmarks.data,t=l.length;s[0]=t;for(let a=0;a<t;++a){let y=l[a],c=r[a]?.[0]?.categoryName==="Right";for(let f=0;f<C;++f){let h=y[f],H=(k+a*g+f)*4;s[H]=h.x,s[H+1]=1-h.y,s[H+2]=h.z??0,s[H+3]=c?1:0}let i=F(s,a,V,g,k),u=(k+a*g+C)*4;s[u]=i[0],s[u+1]=i[1],s[u+2]=i[2],s[u+3]=c?1:0}D.state.nHands=t}function W(D){let{textureName:l,options:{history:r,...s}={}}=D,t={...K,...s},a=P({...t,textureName:l}),y=t.maxHands*g+k,c=Math.ceil(y/m);return function(i,u){let{injectGLSL:f,emitHook:h}=u,O=L.get(a)?.landmarks.data??new Float32Array(m*c*4),e=null,A=!1,S=!1;function T(){if(!e)return;let{nHands:n}=e.state,d=n*g+k,o=Math.ceil(d/m);i.updateTextures({u_handLandmarksTex:{data:e.landmarks.data,width:m,height:o,isPartial:!0}},{skipHistoryWrite:S}),i.updateUniforms({u_nHands:n}),h("hands:result",e.state.result)}async function U(){if(L.has(a))e=L.get(a);else{let[n,{HandLandmarker:d}]=await Promise.all([w(),import("@mediapipe/tasks-vision")]);if(A)return;let o=new OffscreenCanvas(1,1),p=await d.createFromOptions(n,{baseOptions:{modelAssetPath:t.modelPath,delegate:"GPU"},canvas:o,runningMode:"VIDEO",numHands:t.maxHands,minHandDetectionConfidence:t.minHandDetectionConfidence,minHandPresenceConfidence:t.minHandPresenceConfidence,minTrackingConfidence:t.minTrackingConfidence});if(A){p.close();return}e={landmarker:p,mediapipeCanvas:o,subscribers:new Map,maxHands:t.maxHands,state:{runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nHands:0},landmarks:{data:O,textureHeight:c}},L.set(a,e)}e.subscribers.set(T,!1)}let N=U();i.on("init",()=>{i.initializeUniform("u_maxHands","int",t.maxHands),i.initializeUniform("u_nHands","int",0),i.initializeTexture("u_handLandmarksTex",{data:O,width:m,height:c},{internalFormat:"RGBA32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST",history:r}),N.then(()=>{A||!e||h("hands:ready")})}),i.on("initializeTexture",(n,d)=>{n===l&&M(d)&&I(d)}),i.on("updateTextures",(n,d)=>{let o=n[l];M(o)&&(S=d?.skipHistoryWrite??!1,I(o))});let v=0;async function I(n){let d=performance.now(),o=++v;await N,e&&(e.state.pending=e.state.pending.then(async()=>{if(o!==v||!e)return;let p=n instanceof HTMLVideoElement?"VIDEO":"IMAGE";e.state.runningMode!==p&&(e.state.runningMode=p,await e.landmarker.setOptions({runningMode:p}));let _=!1;if(n!==e.state.source?(e.state.source=n,e.state.videoTime=-1,_=!0):n instanceof HTMLVideoElement?n.currentTime!==e.state.videoTime&&(e.state.videoTime=n.currentTime,_=!0):n instanceof HTMLImageElement||d-e.state.resultTimestamp>2&&(_=!0),_){let x;if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;x=e.landmarker.detectForVideo(n,d)}else{if(n.width===0||n.height===0)return;x=e.landmarker.detect(n)}if(x){e.state.resultTimestamp=d,e.state.result=x,G(e,x.landmarks,x.handedness);for(let E of e.subscribers.keys())E(),e.subscribers.set(E,!0)}}else e.state.result&&!e.subscribers.get(T)&&(T(),e.subscribers.set(T,!0))}),await e.state.pending)}i.on("destroy",()=>{A=!0,e&&(e.subscribers.delete(T),e.subscribers.size===0&&(e.landmarker.close(),L.delete(a))),e=null});let{fn:b,historyParams:R}=$(r);f(`
uniform int u_maxHands;
uniform int u_nHands;
uniform highp sampler2D${r?"Array":""} u_handLandmarksTex;${r?`
uniform int u_handLandmarksTexFrameOffset;`:""}

${b("int","nHandsAt","",r?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${r}) % ${r};
	return int(texelFetch(u_handLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_handLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${b("vec4","handLandmark","int handIndex, int landmarkIndex",`int i = ${k} + handIndex * ${g} + landmarkIndex;
	int x = i % ${m};
	int y = i / ${m};${r?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${r}) % ${r};
	return texelFetch(u_handLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_handLandmarksTex, ivec2(x, y), 0);`}`)}
${b("float","isRightHand","int handIndex",`return handLandmark(handIndex, 0${R}).w;`)}
${b("float","isLeftHand","int handIndex",`return 1.0 - handLandmark(handIndex, 0${R}).w;`)}`)}}var j=W;export{j as default};
//# sourceMappingURL=hands.mjs.map