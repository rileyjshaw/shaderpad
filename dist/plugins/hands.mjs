import{b as N,c as w,d as $,e as U,f as z}from"../chunk-JRSBIGBN.mjs";var I=21,K=1,k=I+K,W=[0,0,5,9,13,17],c=512,H=1,G={modelPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",maxHands:2,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},L=new Map;function B(b,f,t){let d=b.landmarks.data,a=f.length;d[0]=a;for(let i=0;i<a;++i){let M=f[i],h=t[i]?.[0]?.categoryName==="Right";for(let x=0;x<I;++x){let g=M[x],T=(H+i*k+x)*4;d[T]=g.x,d[T+1]=1-g.y,d[T+2]=g.z??0,d[T+3]=h?1:0}let r=$(d,i,W,k,H),p=(H+i*k+I)*4;d[p]=r[0],d[p+1]=r[1],d[p+2]=r[2],d[p+3]=h?1:0}b.state.nHands=a}function q(b){let{textureName:f,options:{history:t,...d}={}}=b,a={...G,...d},i=w({...a,textureName:f}),M=a.maxHands*k+H,h=Math.ceil(M/c);return function(r,p){let{injectGLSL:x,emitHook:g}=p,R=L.get(i)?.landmarks.data??new Float32Array(c*h*4),e=null,y=!1,O=!1;function S(n){if(!e)return;let{nHands:s}=e.state,o=s*k+H,l=Math.ceil(o/c),u=n;typeof u>"u"&&D.length>0&&(u=D,D=[]),r.updateTextures({u_handLandmarksTex:{data:e.landmarks.data,width:c,height:l,isPartial:!0}},t?{skipHistoryWrite:O,historyWriteIndex:u}:void 0),r.updateUniforms({u_nHands:s}),g("hands:result",e.state.result)}async function V(){if(L.has(i))e=L.get(i);else{let[n,{HandLandmarker:s}]=await Promise.all([U(),import("@mediapipe/tasks-vision")]);if(y)return;let o=new OffscreenCanvas(1,1),l=await s.createFromOptions(n,{baseOptions:{modelAssetPath:a.modelPath,delegate:"GPU"},canvas:o,runningMode:"VIDEO",numHands:a.maxHands,minHandDetectionConfidence:a.minHandDetectionConfidence,minHandPresenceConfidence:a.minHandPresenceConfidence,minTrackingConfidence:a.minTrackingConfidence});if(y){l.close();return}e={landmarker:l,mediapipeCanvas:o,subscribers:new Map,maxHands:a.maxHands,state:{nCalls:0,runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nHands:0},landmarks:{data:R,textureHeight:h}},L.set(i,e)}e.subscribers.set(S,!1)}let v=V();r.on("init",()=>{r.initializeUniform("u_maxHands","int",a.maxHands),r.initializeUniform("u_nHands","int",0),r.initializeTexture("u_handLandmarksTex",{data:R,width:c,height:h},{internalFormat:"RGBA32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST",history:t}),v.then(()=>{y||!e||g("hands:ready")})});let A=0,D=[],E=()=>{t&&(S(A),D.push(A),A=(A+1)%(t+1))};r.on("initializeTexture",(n,s)=>{n===f&&N(s)&&(E(),F(s))}),r.on("updateTextures",(n,s)=>{let o=n[f];N(o)&&(O=s?.skipHistoryWrite??!1,O||E(),F(o))});async function F(n){let s=performance.now();if(await v,!e)return;let o=++e.state.nCalls;e.state.pending=e.state.pending.then(async()=>{if(!e||o!==e.state.nCalls)return;let l=n instanceof HTMLVideoElement?"VIDEO":"IMAGE";e.state.runningMode!==l&&(e.state.runningMode=l,await e.landmarker.setOptions({runningMode:l}));let u=!1;if(n!==e.state.source?(e.state.source=n,e.state.videoTime=-1,u=!0):n instanceof HTMLVideoElement?n.currentTime!==e.state.videoTime&&(e.state.videoTime=n.currentTime,u=!0):n instanceof HTMLImageElement||s-e.state.resultTimestamp>2&&(u=!0),u){let m;if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;m=e.landmarker.detectForVideo(n,s)}else{if(n.width===0||n.height===0)return;m=e.landmarker.detect(n)}if(m){e.state.resultTimestamp=s,e.state.result=m,B(e,m.landmarks,m.handedness);for(let _ of e.subscribers.keys())_(),e.subscribers.set(_,!0)}}else if(e.state.result)for(let[m,_]of e.subscribers.entries())_||(m(),e.subscribers.set(m,!0))}),await e.state.pending}r.on("destroy",()=>{y=!0,e&&(e.subscribers.delete(S),e.subscribers.size===0&&(e.landmarker.close(),L.delete(i))),e=null});let{fn:C,historyParams:P}=z(t);x(`
uniform int u_maxHands;
uniform int u_nHands;
uniform highp sampler2D${t?"Array":""} u_handLandmarksTex;${t?`
uniform int u_handLandmarksTexFrameOffset;`:""}

${C("int","nHandsAt","",t?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${t+1}) % ${t+1};
	return int(texelFetch(u_handLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_handLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${C("vec4","handLandmark","int handIndex, int landmarkIndex",`int i = ${H} + handIndex * ${k} + landmarkIndex;
	int x = i % ${c};
	int y = i / ${c};${t?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${t+1}) % ${t+1};
	return texelFetch(u_handLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_handLandmarksTex, ivec2(x, y), 0);`}`)}
${C("float","isRightHand","int handIndex",`return handLandmark(handIndex, 0${P}).w;`)}
${C("float","isLeftHand","int handIndex",`return 1.0 - handLandmark(handIndex, 0${P}).w;`)}`)}}var J=q;export{J as default};
//# sourceMappingURL=hands.mjs.map