import{b as M,c as E,d as P,e as F,f as w}from"../chunk-JRSBIGBN.mjs";var y=21,U=1,p=y+U,z=[0,0,5,9,13,17],m=512,k=1,V={modelPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",maxHands:2,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},T=new Map;function K(L,l,r){let s=L.landmarks.data,t=l.length;s[0]=t;for(let a=0;a<t;++a){let _=l[a],c=r[a]?.[0]?.categoryName==="Right";for(let f=0;f<y;++f){let h=_[f],g=(k+a*p+f)*4;s[g]=h.x,s[g+1]=1-h.y,s[g+2]=h.z??0,s[g+3]=c?1:0}let i=P(s,a,z,p,k),u=(k+a*p+y)*4;s[u]=i[0],s[u+1]=i[1],s[u+2]=i[2],s[u+3]=c?1:0}L.state.nHands=t}function G(L){let{textureName:l,options:{history:r,...s}={}}=L,t={...V,...s},a=E({...t,textureName:l}),_=t.maxHands*p+k,c=Math.ceil(_/m);return function(i,u){let{injectGLSL:f,emitHook:h}=u,O=T.get(a)?.landmarks.data??new Float32Array(m*c*4),e=null,C=!1;function H(){if(!e)return;let{nHands:n}=e.state,d=n*p+k,o=Math.ceil(d/m);i.updateTextures({u_handLandmarksTex:{data:e.landmarks.data,width:m,height:o,isPartial:!0}},{skipHistoryWrite:C}),i.updateUniforms({u_nHands:n}),h("hands:result",e.state.result)}async function $(){if(T.has(a))e=T.get(a);else{let[n,{HandLandmarker:d}]=await Promise.all([F(),import("@mediapipe/tasks-vision")]),o=new OffscreenCanvas(1,1);e={landmarker:await d.createFromOptions(n,{baseOptions:{modelAssetPath:t.modelPath,delegate:"GPU"},canvas:o,runningMode:"VIDEO",numHands:t.maxHands,minHandDetectionConfidence:t.minHandDetectionConfidence,minHandPresenceConfidence:t.minHandPresenceConfidence,minTrackingConfidence:t.minTrackingConfidence}),canvas:o,subscribers:new Map,maxHands:t.maxHands,state:{runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nHands:0},landmarks:{data:O,textureHeight:c}},T.set(a,e)}e.subscribers.set(H,!1)}let S=$();i.on("init",()=>{i.initializeUniform("u_maxHands","int",t.maxHands),i.initializeUniform("u_nHands","int",0),i.initializeTexture("u_handLandmarksTex",{data:O,width:m,height:c},{internalFormat:"RGBA32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST",history:r}),S.then(()=>h("hands:ready"))}),i.on("initializeTexture",(n,d)=>{n===l&&M(d)&&v(d)}),i.on("updateTextures",(n,d)=>{let o=n[l];M(o)&&(C=d?.skipHistoryWrite??!1,v(o))});let N=0;async function v(n){let d=performance.now(),o=++N;await S,e&&(e.state.pending=e.state.pending.then(async()=>{if(o!==N||!e)return;let A=n instanceof HTMLVideoElement?"VIDEO":"IMAGE";e.state.runningMode!==A&&(e.state.runningMode=A,await e.landmarker.setOptions({runningMode:A}));let b=!1;if(n!==e.state.source?(e.state.source=n,e.state.videoTime=-1,b=!0):n instanceof HTMLVideoElement?n.currentTime!==e.state.videoTime&&(e.state.videoTime=n.currentTime,b=!0):n instanceof HTMLImageElement||d-e.state.resultTimestamp>2&&(b=!0),b){let x;if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;x=e.landmarker.detectForVideo(n,d)}else{if(n.width===0||n.height===0)return;x=e.landmarker.detect(n)}if(x){e.state.resultTimestamp=d,e.state.result=x,K(e,x.landmarks,x.handedness);for(let R of e.subscribers.keys())R(),e.subscribers.set(R,!0)}}else e.state.result&&!e.subscribers.get(H)&&(H(),e.subscribers.set(H,!0))}),await e.state.pending)}i.on("destroy",()=>{e&&(e.subscribers.delete(H),e.subscribers.size===0&&(e.landmarker.close(),T.delete(a))),e=null});let{fn:D,historyParams:I}=w(r);f(`
uniform int u_maxHands;
uniform int u_nHands;
uniform highp sampler2D${r?"Array":""} u_handLandmarksTex;${r?`
uniform int u_handLandmarksTexFrameOffset;`:""}

${D("int","nHandsAt","",r?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${r}) % ${r};
	return int(texelFetch(u_handLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_handLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${D("vec4","handLandmark","int handIndex, int landmarkIndex",`int i = ${k} + handIndex * ${p} + landmarkIndex;
	int x = i % ${m};
	int y = i / ${m};${r?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${r}) % ${r};
	return texelFetch(u_handLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_handLandmarksTex, ivec2(x, y), 0);`}`)}
${D("float","isRightHand","int handIndex",`return handLandmark(handIndex, 0${I}).w;`)}
${D("float","isLeftHand","int handIndex",`return 1.0 - handLandmark(handIndex, 0${I}).w;`)}`)}}var q=G;export{q as default};
//# sourceMappingURL=hands.mjs.map