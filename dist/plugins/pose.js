"use strict";var U=Object.create;var x=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var V=(r,u)=>{for(var a in u)x(r,a,{get:u[a],enumerable:!0})},T=(r,u,a,P)=>{if(u&&typeof u=="object"||typeof u=="function")for(let s of H(u))!R.call(r,s)&&s!==a&&x(r,s,{get:()=>u[s],enumerable:!(P=A(u,s))||P.enumerable});return r};var W=(r,u,a)=>(a=r!=null?U(F(r)):{},T(u||!r||!r.__esModule?x(a,"default",{value:r,enumerable:!0}):a,r)),X=r=>T(x({},"__esModule",{value:!0}),r);var j={};V(j,{default:()=>$});module.exports=X(j);var C=33;function Y(r){let{textureName:u,options:a}=r,P="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task";return function(s,S){let{injectGLSL:I}=S,f=null,y=null,M=-1,b=new Map,g=a?.maxPoses??1,D=512,z=512,o=document.createElement("canvas");o.width=D,o.height=z;let l=o.getContext("2d"),h=document.createElement("canvas"),L=h.getContext("2d");l.globalCompositeOperation=L.globalCompositeOperation="lighten";let w=[];async function E(){try{let{FilesetResolver:n,PoseLandmarker:e}=await import("@mediapipe/tasks-vision");y=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),w.push(...e.POSE_CONNECTIONS),f=await e.createFromOptions(y,{baseOptions:{modelAssetPath:a?.modelPath||P},runningMode:"VIDEO",numPoses:a?.maxPoses??1,minPoseDetectionConfidence:a?.minPoseDetectionConfidence??.5,minPosePresenceConfidence:a?.minPosePresenceConfidence??.5,minTrackingConfidence:a?.minTrackingConfidence??.5,outputSegmentationMasks:a?.outputSegmentationMasks??!0})}catch(n){throw console.error("[Pose Plugin] Failed to initialize Pose Landmarker:",n),n}}function N(n){let e=1/0,m=-1/0,t=1/0,i=-1/0;for(let c of n)e=Math.min(e,c.x),m=Math.max(m,c.x),t=Math.min(t,c.y),i=Math.max(i,c.y);let d=(e+m)/2,p=(t+i)/2;return[d,p]}async function O(n,e){if(!f){console.warn("[Pose Plugin] Cannot update mask: poseLandmarker missing");return}try{if(l.clearRect(0,0,o.width,o.height),e&&e.length>0&&e.forEach(m=>{if(!m)return;let{width:t,height:i}=m,d=m.getAsUint8Array(),p=t*i,c=new Uint8ClampedArray(p*4);for(let k=0;k<p;k++)c[k*4+1]=d[k],c[k*4+3]=255;let v=new ImageData(c,t,i);t===o.width&&i===o.height?l.putImageData(v,0,0):(h.width!==t&&(h.width=t),h.height!==i&&(h.height=i),L.putImageData(v,0,0),l.drawImage(h,0,0,o.width,o.height))}),w.length){let m=Math.max(2,o.width/256);l.lineWidth=m,l.lineCap="round",l.strokeStyle="#00f",n.forEach(t=>{w.forEach(({start:i,end:d})=>{let p=t[i],c=t[d];!p||!c||(p.visibility??1)<.3||(c.visibility??1)<.3||(l.beginPath(),l.moveTo(p.x*o.width,p.y*o.height),l.lineTo(c.x*o.width,c.y*o.height),l.stroke())})})}s.updateTextures({u_poseMask:o})}catch(m){console.error("[Pose Plugin] Failed to generate mask texture:",m)}}function _(n){if(!n.landmarks)return;O(n.landmarks,n.segmentationMasks).catch(t=>{console.warn("[Pose Plugin] Mask texture update error:",t)});let e=n.landmarks.length,m={u_nPoses:e};if(e){m.u_poseLandmarks=n.landmarks.flatMap(i=>i.map(d=>[d.x,1-d.y]));let t=[];for(let i of n.landmarks){let d=N(i);t.push([d[0],1-d[1]])}m.u_poseCenter=t}s.updateUniforms(m)}s.registerHook("init",async()=>{s.initializeTexture("u_poseMask",o),s.initializeUniform("u_maxPoses","int",g),s.initializeUniform("u_nPoses","int",0);let n=Array.from({length:g*C},()=>[.5,.5]);s.initializeUniform("u_poseLandmarks","float",n,{arrayLength:g*C});let e=Array.from({length:g},()=>[.5,.5]);s.initializeUniform("u_poseCenter","float",e,{arrayLength:g}),await E()}),s.registerHook("updateTextures",n=>{let e=n[u];if(!(!e||(b.get(u)!==e&&(M=-1),b.set(u,e),!f)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==M){M=e.currentTime;let t=performance.now(),i=f.detectForVideo(e,t);_(i)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let t=f.detect(e);_(t)}}catch(t){console.error("[Pose Plugin] Pose detection error:",t)}}),s.registerHook("destroy",()=>{f&&(f.close(),f=null),y=null,b.clear(),o.remove()}),I(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform vec2 u_poseLandmarks[${g*C}];
uniform sampler2D u_poseMask;
uniform vec2 u_poseCenter[${g}];
vec2 poseLandmark(int poseIndex, int landmarkIndex) {
	return u_poseLandmarks[poseIndex * ${C} + landmarkIndex];
}
float getBody(vec2 pos) { return texture(u_poseMask, pos).g; }
float getSkeleton(vec2 pos) { return texture(u_poseMask, pos).b; }`)}}var $=Y;
//# sourceMappingURL=pose.js.map