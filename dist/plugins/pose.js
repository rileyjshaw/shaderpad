"use strict";var Q=Object.create;var y=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ne=Object.getPrototypeOf,oe=Object.prototype.hasOwnProperty;var ie=(a,_)=>{for(var s in _)y(a,s,{get:_[s],enumerable:!0})},W=(a,_,s,k)=>{if(_&&typeof _=="object"||typeof _=="function")for(let E of te(_))!oe.call(a,E)&&E!==s&&y(a,E,{get:()=>_[E],enumerable:!(k=ee(_,E))||k.enumerable});return a};var se=(a,_,s)=>(s=a!=null?Q(ne(a)):{},W(_||!a||!a.__esModule?y(s,"default",{value:a,enumerable:!0}):s,a)),re=a=>W(y({},"__esModule",{value:!0}),a);var Te={};ie(Te,{default:()=>_e});module.exports=re(Te);var L=33,ae=6,u=L+ae,t={LEFT_EYE:2,RIGHT_EYE:5,LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_HIP:23,RIGHT_HIP:24,LEFT_KNEE:25,RIGHT_KNEE:26,LEFT_WRIST:15,RIGHT_WRIST:16,LEFT_PINKY:17,RIGHT_PINKY:18,LEFT_INDEX:19,RIGHT_INDEX:20,LEFT_THUMB:21,RIGHT_THUMB:22,LEFT_ANKLE:27,RIGHT_ANKLE:28,LEFT_HEEL:29,RIGHT_HEEL:30,LEFT_FOOT_INDEX:31,RIGHT_FOOT_INDEX:32,BODY_CENTER:L,LEFT_HAND_CENTER:L+1,RIGHT_HAND_CENTER:L+2,LEFT_FOOT_CENTER:L+3,RIGHT_FOOT_CENTER:L+4,TORSO_CENTER:L+5};function Ee(a){let{textureName:_,options:s}=a,k="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task";return function(E,X){let{injectGLSL:z,gl:S}=X,I=null,w=null,U=-1,v=new Map,$=s?.maxPoses??1,H=512,b=0,e=null,V=512,j=512,l=document.createElement("canvas");l.width=V,l.height=j;let M=l.getContext("2d"),p=document.createElement("canvas"),B=p.getContext("2d");M.globalCompositeOperation=B.globalCompositeOperation="lighten";async function Z(){try{let{FilesetResolver:o,PoseLandmarker:n}=await import("@mediapipe/tasks-vision");w=await o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),I=await n.createFromOptions(w,{baseOptions:{modelAssetPath:s?.modelPath||k},runningMode:"VIDEO",numPoses:s?.maxPoses??1,minPoseDetectionConfidence:s?.minPoseDetectionConfidence??.5,minPosePresenceConfidence:s?.minPosePresenceConfidence??.5,minTrackingConfidence:s?.minTrackingConfidence??.5,outputSegmentationMasks:s?.outputSegmentationMasks??!0})}catch(o){throw console.error("[Pose Plugin] Failed to initialize Pose Landmarker:",o),o}}function P(o,n,T){let r=1/0,i=-1/0,N=1/0,m=-1/0,d=0,c=0;for(let D of T){let R=(n*u+D)*4,f=o[R],O=o[R+1];r=Math.min(r,f),i=Math.max(i,f),N=Math.min(N,O),m=Math.max(m,O),d+=o[R+2],c+=o[R+3]}let g=(r+i)/2,F=(N+m)/2,A=d/T.length,C=c/T.length;return[g,F,A,C]}async function q(o){if(!I||!e){console.warn("[Pose Plugin] Cannot update mask: poseLandmarker or landmarksDataArray missing");return}try{M.clearRect(0,0,l.width,l.height),o&&o.length>0&&o.forEach(n=>{if(!n)return;let{width:T,height:r}=n,i=n.getAsUint8Array(),N=T*r,m=new Uint8ClampedArray(N*4);for(let c=0;c<N;c++)m[c*4+1]=i[c],m[c*4+3]=255;let d=new ImageData(m,T,r);T===l.width&&r===l.height?M.putImageData(d,0,0):(p.width!==T&&(p.width=T),p.height!==r&&(p.height=r),B.putImageData(d,0,0),M.drawImage(p,0,0,l.width,l.height))}),E.updateTextures({u_poseMask:l})}catch(n){console.error("[Pose Plugin] Failed to generate mask texture:",n)}}function J(o){if(!e)return;let n=o.length,T=n*u;for(let i=0;i<n;++i){let N=o[i];for(let h=0;h<L;++h){let x=N[h],K=(i*u+h)*4;e[K]=x.x,e[K+1]=1-x.y,e[K+2]=x.z??0,e[K+3]=x.visibility??1}let m=P(e,i,Array.from({length:L},(h,x)=>x)),d=(i*u+t.BODY_CENTER)*4;e[d]=m[0],e[d+1]=m[1],e[d+2]=m[2],e[d+3]=m[3];let c=P(e,i,[t.LEFT_WRIST,t.LEFT_PINKY,t.LEFT_THUMB,t.LEFT_INDEX]),g=(i*u+t.LEFT_HAND_CENTER)*4;e[g]=c[0],e[g+1]=c[1],e[g+2]=c[2],e[g+3]=c[3];let F=P(e,i,[t.RIGHT_WRIST,t.RIGHT_PINKY,t.RIGHT_THUMB,t.RIGHT_INDEX]),A=(i*u+t.RIGHT_HAND_CENTER)*4;e[A]=F[0],e[A+1]=F[1],e[A+2]=F[2],e[A+3]=F[3];let C=P(e,i,[t.LEFT_ANKLE,t.LEFT_HEEL,t.LEFT_FOOT_INDEX]),D=(i*u+t.LEFT_FOOT_CENTER)*4;e[D]=C[0],e[D+1]=C[1],e[D+2]=C[2],e[D+3]=C[3];let R=P(e,i,[t.RIGHT_ANKLE,t.RIGHT_HEEL,t.RIGHT_FOOT_INDEX]),f=(i*u+t.RIGHT_FOOT_CENTER)*4;e[f]=R[0],e[f+1]=R[1],e[f+2]=R[2],e[f+3]=R[3];let O=P(e,i,[t.LEFT_SHOULDER,t.RIGHT_SHOULDER,t.LEFT_HIP,t.RIGHT_HIP]),G=(i*u+t.TORSO_CENTER)*4;e[G]=O[0],e[G+1]=O[1],e[G+2]=O[2],e[G+3]=O[3]}let r=Math.ceil(T/H);E.updateTextures({u_poseLandmarksTex:{data:e,width:H,height:r}})}function Y(o){if(!o.landmarks||!e)return;let n=o.landmarks.length;J(o.landmarks),q(o.segmentationMasks).catch(T=>{console.warn("[Pose Plugin] Mask texture update error:",T)}),E.updateUniforms({u_nPoses:n}),s?.onResults?.(o)}E.registerHook("init",async()=>{E.initializeTexture("u_poseMask",l),E.initializeUniform("u_maxPoses","int",$),E.initializeUniform("u_nPoses","int",0);let o=$*u;b=Math.ceil(o/H);let n=H*b*4;e=new Float32Array(n),E.initializeTexture("u_poseLandmarksTex",{data:e,width:H,height:b},{internalFormat:S.RGBA32F,type:S.FLOAT,minFilter:S.NEAREST,magFilter:S.NEAREST}),await Z()}),E.registerHook("updateTextures",o=>{let n=o[_];if(!(!n||(v.get(_)!==n&&(U=-1),v.set(_,n),!I)))try{if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;if(n.currentTime!==U){U=n.currentTime;let r=performance.now(),i=I.detectForVideo(n,r);Y(i)}}else if(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement){if(n.width===0||n.height===0)return;let r=I.detect(n);Y(r)}}catch(r){console.error("[Pose Plugin] Pose detection error:",r)}}),E.registerHook("destroy",()=>{I&&(I.close(),I=null),w=null,v.clear(),l.remove(),e=null}),z(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform sampler2D u_poseLandmarksTex;
uniform sampler2D u_poseMask;

#define POSE_LANDMARK_LEFT_EYE ${t.LEFT_EYE}
#define POSE_LANDMARK_RIGHT_EYE ${t.RIGHT_EYE}
#define POSE_LANDMARK_LEFT_SHOULDER ${t.LEFT_SHOULDER}
#define POSE_LANDMARK_RIGHT_SHOULDER ${t.RIGHT_SHOULDER}
#define POSE_LANDMARK_LEFT_ELBOW ${t.LEFT_ELBOW}
#define POSE_LANDMARK_RIGHT_ELBOW ${t.RIGHT_ELBOW}
#define POSE_LANDMARK_LEFT_HIP ${t.LEFT_HIP}
#define POSE_LANDMARK_RIGHT_HIP ${t.RIGHT_HIP}
#define POSE_LANDMARK_LEFT_KNEE ${t.LEFT_KNEE}
#define POSE_LANDMARK_RIGHT_KNEE ${t.RIGHT_KNEE}
#define POSE_LANDMARK_BODY_CENTER ${t.BODY_CENTER}
#define POSE_LANDMARK_LEFT_HAND_CENTER ${t.LEFT_HAND_CENTER}
#define POSE_LANDMARK_RIGHT_HAND_CENTER ${t.RIGHT_HAND_CENTER}
#define POSE_LANDMARK_LEFT_FOOT_CENTER ${t.LEFT_FOOT_CENTER}
#define POSE_LANDMARK_RIGHT_FOOT_CENTER ${t.RIGHT_FOOT_CENTER}
#define POSE_LANDMARK_TORSO_CENTER ${t.TORSO_CENTER}

vec4 poseLandmark(int poseIndex, int landmarkIndex) {
	int i = poseIndex * ${u} + landmarkIndex;
	int x = i % ${H};
	int y = i / ${H};
	return texelFetch(u_poseLandmarksTex, ivec2(x, y), 0);
}
float inBody(vec2 pos) { return texture(u_poseMask, pos).g; }`)}}var _e=Ee;
//# sourceMappingURL=pose.js.map