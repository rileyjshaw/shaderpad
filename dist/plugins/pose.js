"use strict";var Q=Object.create;var y=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ne=Object.getPrototypeOf,oe=Object.prototype.hasOwnProperty;var ie=(s,_)=>{for(var a in _)y(s,a,{get:_[a],enumerable:!0})},W=(s,_,a,S)=>{if(_&&typeof _=="object"||typeof _=="function")for(let E of te(_))!oe.call(s,E)&&E!==a&&y(s,E,{get:()=>_[E],enumerable:!(S=ee(_,E))||S.enumerable});return s};var re=(s,_,a)=>(a=s!=null?Q(ne(s)):{},W(_||!s||!s.__esModule?y(a,"default",{value:s,enumerable:!0}):a,s)),se=s=>W(y({},"__esModule",{value:!0}),s);var Te={};ie(Te,{default:()=>_e});module.exports=se(Te);var L=33,ae=6,u=L+ae,t={LEFT_EYE:2,RIGHT_EYE:5,LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_HIP:23,RIGHT_HIP:24,LEFT_KNEE:25,RIGHT_KNEE:26,LEFT_WRIST:15,RIGHT_WRIST:16,LEFT_PINKY:17,RIGHT_PINKY:18,LEFT_INDEX:19,RIGHT_INDEX:20,LEFT_THUMB:21,RIGHT_THUMB:22,LEFT_ANKLE:27,RIGHT_ANKLE:28,LEFT_HEEL:29,RIGHT_HEEL:30,LEFT_FOOT_INDEX:31,RIGHT_FOOT_INDEX:32,BODY_CENTER:L,LEFT_HAND_CENTER:L+1,RIGHT_HAND_CENTER:L+2,LEFT_FOOT_CENTER:L+3,RIGHT_FOOT_CENTER:L+4,TORSO_CENTER:L+5};function Ee(s){let{textureName:_,options:a}=s,S="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task";return function(E,X){let{injectGLSL:z,gl:k}=X,I=null,w=null,U=-1,v=new Map,$=a?.maxPoses??1,H=512,b=0,e=null,V=512,j=512,m=document.createElement("canvas");m.width=V,m.height=j;let M=m.getContext("2d"),p=document.createElement("canvas"),B=p.getContext("2d");M.globalCompositeOperation=B.globalCompositeOperation="lighten";async function Z(){try{let{FilesetResolver:o,PoseLandmarker:n}=await import("@mediapipe/tasks-vision");w=await o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),I=await n.createFromOptions(w,{baseOptions:{modelAssetPath:a?.modelPath||S},runningMode:"VIDEO",numPoses:a?.maxPoses??1,minPoseDetectionConfidence:a?.minPoseDetectionConfidence??.5,minPosePresenceConfidence:a?.minPosePresenceConfidence??.5,minTrackingConfidence:a?.minTrackingConfidence??.5,outputSegmentationMasks:a?.outputSegmentationMasks??!0})}catch(o){throw console.error("[Pose Plugin] Failed to initialize Pose Landmarker:",o),o}}function g(o,n,T){let r=1/0,i=-1/0,N=1/0,l=-1/0,d=0,c=0;for(let D of T){let R=(n*u+D)*4,f=o[R],O=o[R+1];r=Math.min(r,f),i=Math.max(i,f),N=Math.min(N,O),l=Math.max(l,O),d+=o[R+2],c+=o[R+3]}let F=(r+i)/2,P=(N+l)/2,A=d/T.length,C=c/T.length;return[F,P,A,C]}async function q(o){if(!I||!e){console.warn("[Pose Plugin] Cannot update mask: poseLandmarker or landmarksDataArray missing");return}try{M.clearRect(0,0,m.width,m.height),o&&o.length>0&&o.forEach(n=>{if(!n)return;let{width:T,height:r}=n,i=n.getAsUint8Array(),N=T*r,l=new Uint8ClampedArray(N*4);for(let c=0;c<N;c++)l[c*4+1]=i[c],l[c*4+3]=255;let d=new ImageData(l,T,r);T===m.width&&r===m.height?M.putImageData(d,0,0):(p.width!==T&&(p.width=T),p.height!==r&&(p.height=r),B.putImageData(d,0,0),M.drawImage(p,0,0,m.width,m.height))}),E.updateTextures({u_poseMask:m})}catch(n){console.error("[Pose Plugin] Failed to generate mask texture:",n)}}function J(o){if(!e)return;let n=o.length,T=n*u;for(let i=0;i<n;++i){let N=o[i];for(let h=0;h<L;++h){let x=N[h],K=(i*u+h)*4;e[K]=x.x,e[K+1]=1-x.y,e[K+2]=x.z??0,e[K+3]=x.visibility??1}let l=g(e,i,Array.from({length:L},(h,x)=>x)),d=(i*u+t.BODY_CENTER)*4;e[d]=l[0],e[d+1]=l[1],e[d+2]=l[2],e[d+3]=l[3];let c=g(e,i,[t.LEFT_WRIST,t.LEFT_PINKY,t.LEFT_THUMB,t.LEFT_INDEX]),F=(i*u+t.LEFT_HAND_CENTER)*4;e[F]=c[0],e[F+1]=c[1],e[F+2]=c[2],e[F+3]=c[3];let P=g(e,i,[t.RIGHT_WRIST,t.RIGHT_PINKY,t.RIGHT_THUMB,t.RIGHT_INDEX]),A=(i*u+t.RIGHT_HAND_CENTER)*4;e[A]=P[0],e[A+1]=P[1],e[A+2]=P[2],e[A+3]=P[3];let C=g(e,i,[t.LEFT_ANKLE,t.LEFT_HEEL,t.LEFT_FOOT_INDEX]),D=(i*u+t.LEFT_FOOT_CENTER)*4;e[D]=C[0],e[D+1]=C[1],e[D+2]=C[2],e[D+3]=C[3];let R=g(e,i,[t.RIGHT_ANKLE,t.RIGHT_HEEL,t.RIGHT_FOOT_INDEX]),f=(i*u+t.RIGHT_FOOT_CENTER)*4;e[f]=R[0],e[f+1]=R[1],e[f+2]=R[2],e[f+3]=R[3];let O=g(e,i,[t.LEFT_SHOULDER,t.RIGHT_SHOULDER,t.LEFT_HIP,t.RIGHT_HIP]),G=(i*u+t.TORSO_CENTER)*4;e[G]=O[0],e[G+1]=O[1],e[G+2]=O[2],e[G+3]=O[3]}let r=Math.ceil(T/H);E.updateTextures({u_poseLandmarksTex:{data:e,width:H,height:r}})}function Y(o){if(!o.landmarks||!e)return;let n=o.landmarks.length;J(o.landmarks),q(o.segmentationMasks).catch(T=>{console.warn("[Pose Plugin] Mask texture update error:",T)}),E.updateUniforms({u_nPoses:n})}E.registerHook("init",async()=>{E.initializeTexture("u_poseMask",m),E.initializeUniform("u_maxPoses","int",$),E.initializeUniform("u_nPoses","int",0);let o=$*u;b=Math.ceil(o/H);let n=H*b*4;e=new Float32Array(n),E.initializeTexture("u_poseLandmarksTex",{data:e,width:H,height:b},{internalFormat:k.RGBA32F,type:k.FLOAT,minFilter:k.NEAREST,magFilter:k.NEAREST}),await Z()}),E.registerHook("updateTextures",o=>{let n=o[_];if(!(!n||(v.get(_)!==n&&(U=-1),v.set(_,n),!I)))try{if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;if(n.currentTime!==U){U=n.currentTime;let r=performance.now(),i=I.detectForVideo(n,r);Y(i)}}else if(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement){if(n.width===0||n.height===0)return;let r=I.detect(n);Y(r)}}catch(r){console.error("[Pose Plugin] Pose detection error:",r)}}),E.registerHook("destroy",()=>{I&&(I.close(),I=null),w=null,v.clear(),m.remove(),e=null}),z(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform sampler2D u_poseLandmarksTex;
uniform sampler2D u_poseMask;

#define POSE_LANDMARK_LEFT_EYE ${t.LEFT_EYE}
#define POSE_LANDMARK_RIGHT_EYE ${t.RIGHT_EYE}
#define POSE_LANDMARK_LEFT_SHOULDER ${t.LEFT_SHOULDER}
#define POSE_LANDMARK_RIGHT_SHOULDER ${t.RIGHT_SHOULDER}
#define POSE_LANDMARK_LEFT_ELBOW ${t.LEFT_ELBOW}
#define POSE_LANDMARK_RIGHT_ELBOW ${t.RIGHT_ELBOW}
#define POSE_LANDMARK_LEFT_HIP ${t.LEFT_HIP}
#define POSE_LANDMARK_RIGHT_HIP ${t.RIGHT_HIP}
#define POSE_LANDMARK_LEFT_KNEE ${t.LEFT_KNEE}
#define POSE_LANDMARK_RIGHT_KNEE ${t.RIGHT_KNEE}
#define POSE_LANDMARK_BODY_CENTER ${t.BODY_CENTER}
#define POSE_LANDMARK_LEFT_HAND_CENTER ${t.LEFT_HAND_CENTER}
#define POSE_LANDMARK_RIGHT_HAND_CENTER ${t.RIGHT_HAND_CENTER}
#define POSE_LANDMARK_LEFT_FOOT_CENTER ${t.LEFT_FOOT_CENTER}
#define POSE_LANDMARK_RIGHT_FOOT_CENTER ${t.RIGHT_FOOT_CENTER}
#define POSE_LANDMARK_TORSO_CENTER ${t.TORSO_CENTER}

vec4 poseLandmark(int poseIndex, int landmarkIndex) {
	int i = poseIndex * ${u} + landmarkIndex;
	int x = i % ${H};
	int y = i / ${H};
	return texelFetch(u_poseLandmarksTex, ivec2(x, y), 0);
}
float inBody(vec2 pos) { return texture(u_poseMask, pos).g; }`)}}var _e=Ee;
//# sourceMappingURL=pose.js.map