"use strict";var se=Object.create;var $=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty;var he=(o,t)=>{for(var e in t)$(o,e,{get:t[e],enumerable:!0})},j=(o,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ae(t))!le.call(o,r)&&r!==e&&$(o,r,{get:()=>t[r],enumerable:!(i=oe(t,r))||i.enumerable});return o};var q=(o,t,e)=>(e=o!=null?se(ue(o)):{},j(t||!o||!o.__esModule?$(e,"default",{value:o,enumerable:!0}):e,o)),me=o=>j($({},"__esModule",{value:!0}),o);var Se={};he(Se,{default:()=>ve});module.exports=me(Se);function U(o,t){return(o%t+t)%t}var de=`#version 300 es
in vec2 a_position;
out vec2 v_uv;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
    v_uv = a_position * 0.5 + 0.5;
}`,ce=[["8UI","UNSIGNED_BYTE"],["8I","BYTE"],["16UI","UNSIGNED_SHORT"],["16I","SHORT"],["16F","HALF_FLOAT"],["32UI","UNSIGNED_INT"],["32I","INT"],["32F","FLOAT"],["8","UNSIGNED_BYTE"]];function fe(o){return o&&ce.find(([t])=>o.endsWith(t))?.[1]}var W=Symbol("u_history"),P=Symbol("__SHADERPAD_BUFFER");function Te(o,t){if(!t?.length)return o;let e=o.split(`
`),i=e.findLastIndex(r=>{let s=r.trimStart();return s.startsWith("precision ")||s.startsWith("#version ")})+1;return e.splice(i,0,...t),e.join(`
`)}function J(o){return o instanceof WebGLTexture?{width:0,height:0}:o instanceof Y?{width:o.canvas.width,height:o.canvas.height}:o instanceof HTMLVideoElement?{width:o.videoWidth,height:o.videoHeight}:o instanceof HTMLImageElement?{width:o.naturalWidth??o.width,height:o.naturalHeight??o.height}:{width:o.width,height:o.height}}function D(o){return typeof o=="symbol"?o.description??"":o}var Y=class o{isHeadless=!1;isTouchDevice=!1;gl;glHelpers;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;vao=null;program=null;animationFrameId;eventListeners=new Map;frame=0;startTime=0;isPlaying=!1;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;resolutionObserver=null;hooks=new Map;historyDepth=0;textureOptions;debug;cursorTarget;intermediateFbo=null;constructor(t,{canvas:e,plugins:i,history:r,debug:s,cursorTarget:l,...u}={}){if(e&&"getContext"in e)this.canvas=e;else{let{width:T=1,height:g=1}=e||{};this.canvas=new OffscreenCanvas(T,g),this.isHeadless=!0}let n=this.canvas.getContext("webgl2",{antialias:!1});if(!n)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=n,this.glHelpers={typeToArray:new Map([[n.FLOAT,Float32Array],[n.HALF_FLOAT,Uint16Array],[n.UNSIGNED_SHORT,Uint16Array],[n.SHORT,Int16Array],[n.BYTE,Int8Array],[n.UNSIGNED_INT,Uint32Array],[n.INT,Int32Array]]),typeToInternalFormatString:new Map([[n.FLOAT,"RGBA32F"],[n.HALF_FLOAT,"RGBA16F"],[n.UNSIGNED_SHORT,"RGBA32UI"],[n.SHORT,"RGBA32I"],[n.BYTE,"RGBA32I"],[n.UNSIGNED_INT,"RGBA32UI"],[n.INT,"RGBA32I"]]),unsignedIntTypes:new Set([n.UNSIGNED_BYTE,n.UNSIGNED_SHORT,n.UNSIGNED_INT])},this.textureUnitPool={free:[],next:0,max:n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.textureOptions=u,r&&(this.historyDepth=r),this.debug=s??(typeof process<"u"&&!1),this.cursorTarget=l??(this.canvas instanceof HTMLCanvasElement?this.canvas:void 0),this.animationFrameId=null;let d=[];i&&i.forEach(T=>T(this,{gl:n,canvas:this.canvas,injectGLSL:g=>{d.push(g)},emitHook:this.emitHook.bind(this)}));let h=this.gl.createProgram();if(!h)throw new Error("Failed to create WebGL program");this.program=h;let p=this.createShader(this.gl.VERTEX_SHADER,de),c=this.createShader(n.FRAGMENT_SHADER,Te(t,d));if(n.attachShader(h,p),n.attachShader(h,c),n.bindAttribLocation(h,0,"a_position"),n.linkProgram(h),n.deleteShader(p),n.deleteShader(c),!n.getProgramParameter(h,n.LINK_STATUS))throw console.error("Program link error:",n.getProgramInfoLog(h)),n.deleteProgram(h),new Error("Failed to link WebGL program");if(this.vao=n.createVertexArray(),n.bindVertexArray(this.vao),this.buffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.buffer),n.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),n.STATIC_DRAW),n.enableVertexAttribArray(0),n.vertexAttribPointer(0,2,n.FLOAT,!1,0,0),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.useProgram(h),this.canvas instanceof HTMLCanvasElement)this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]});else{let T=g=>{let E=Object.getOwnPropertyDescriptor(OffscreenCanvas.prototype,g);Object.defineProperty(this.canvas,g,{get:()=>E.get.call(this.canvas),set:a=>{E.set.call(this.canvas,a),this.updateResolution()},configurable:E.configurable,enumerable:E.enumerable})};T("width"),T("height")}this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this._initializeTexture(P,this.canvas,{...this.textureOptions}),this.intermediateFbo=n.createFramebuffer(),this.historyDepth>0&&this._initializeTexture(W,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.cursorTarget&&this.addEventListeners(),this.emitHook("_init")}resolveGLConstant(t){let e=this.gl[t];if(e===void 0)throw new Error(`Unknown GL constant: ${t}`);return e}emitHook(t,...e){this.hooks.get(t)?.forEach(i=>i.call(this,...e))}on(t,e){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(e)}off(t,e){let i=this.hooks.get(t);i&&i.splice(i.indexOf(e),1)}createShader(t,e){let i=this.gl.createShader(t);if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",e),console.error(this.gl.getShaderInfoLog(i)),this.gl.deleteShader(i),new Error("Shader compilation failed");return i}getCursorTargetRect(){let t=this.cursorTarget;return t===window?{left:0,top:0,width:window.innerWidth,height:window.innerHeight}:t.getBoundingClientRect()}addEventListeners(){if(!this.cursorTarget)return;let t=(i,r)=>{if(!this.uniforms.has("u_cursor"))return;let s=this.getCursorTargetRect(),l=(i-s.left)/s.width,u=1-(r-s.top)/s.height;this.cursorPosition[0]=Math.max(0,Math.min(1,l)),this.cursorPosition[1]=Math.max(0,Math.min(1,u)),this.updateUniforms({u_cursor:this.cursorPosition})},e=(i,r,s)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=i,i){let l=this.getCursorTargetRect(),u=r,n=s;this.clickPosition[0]=Math.max(0,Math.min(1,(u-l.left)/l.width)),this.clickPosition[1]=Math.max(0,Math.min(1,1-(n-l.top)/l.height))}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",i=>{let r=i;this.isTouchDevice||t(r.clientX,r.clientY)}),this.eventListeners.set("mousedown",i=>{let r=i;this.isTouchDevice||r.button===0&&(this.isMouseDown=!0,e(!0,r.clientX,r.clientY))}),this.eventListeners.set("mouseup",i=>{let r=i;this.isTouchDevice||r.button===0&&e(!1)}),this.eventListeners.set("touchmove",i=>{let r=i;r.touches.length>0&&t(r.touches[0].clientX,r.touches[0].clientY)}),this.eventListeners.set("touchstart",i=>{let r=i;this.isTouchDevice=!0,r.touches.length>0&&(t(r.touches[0].clientX,r.touches[0].clientY),e(!0,r.touches[0].clientX,r.touches[0].clientY))}),this.eventListeners.set("touchend",i=>{i.touches.length===0&&e(!1)}),this.eventListeners.forEach((i,r)=>{this.cursorTarget.addEventListener(r,i)})}updateResolution(){let t=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...t),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:t}):this.initializeUniform("u_resolution","float",t),this.resizeTexture(P,...t),this.historyDepth>0&&this.resizeTexture(W,...t),this.emitHook("updateResolution",...t)}resizeTexture(t,e,i){let r=this.textures.get(t);if(!r||r.width===e&&r.height===i)return;this.gl.deleteTexture(r.texture),r.width=e,r.height=i;let{texture:s}=this.createTexture(t,r);r.texture=s,r.history&&(r.history.writeIndex=0,this.clearHistoryTextureLayers(r))}reserveTextureUnit(t){let e=this.textures.get(t);if(e)return e.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}resolveTextureOptions(t){let{gl:e}=this,i=t?.internalFormat,r=t?.type??fe(i)??"UNSIGNED_BYTE",s=this.resolveGLConstant(r),l=i??this.glHelpers.typeToInternalFormatString.get(s)??"RGBA8",u=/^(R|RG|RGB|RGBA)(8|16|32)(UI|I)$/.test(l),n=t?.format??(u?"RGBA_INTEGER":"RGBA"),d={type:s,format:this.resolveGLConstant(n),internalFormat:this.resolveGLConstant(l),minFilter:this.resolveGLConstant(t?.minFilter??"LINEAR"),magFilter:this.resolveGLConstant(t?.magFilter??"LINEAR"),wrapS:this.resolveGLConstant(t?.wrapS??"CLAMP_TO_EDGE"),wrapT:this.resolveGLConstant(t?.wrapT??"CLAMP_TO_EDGE"),preserveY:t?.preserveY,isIntegerColorFormat:u};if((d.internalFormat===e.RGBA16F||d.internalFormat===e.RGBA32F)&&!e.getExtension("EXT_color_buffer_float"))throw new Error("Missing EXT_color_buffer_float.");return d}getPixelArray(t,e){let i=this.glHelpers.typeToArray.get(t)??Uint8Array;return new i(e)}clearHistoryTextureLayers(t){if(!t.history)return;let e=this.gl,{type:i,format:r}=t.options,s=this.getPixelArray(i,t.width*t.height*4);e.activeTexture(e.TEXTURE0+t.unitIndex),e.bindTexture(e.TEXTURE_2D_ARRAY,t.texture);for(let l=0;l<t.history.depth;++l)e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,l,t.width,t.height,1,r,i,s)}initializeUniform(t,e,i,r){let s=r?.arrayLength;if(this.uniforms.has(t))throw new Error(`${t} is already initialized.`);if(e!=="float"&&e!=="int")throw new Error(`Invalid uniform type: ${e}. Expected 'float' or 'int'.`);if(s&&!(Array.isArray(i)&&i.length===s))throw new Error(`${t} array length mismatch: must initialize with ${s} elements.`);let l=this.gl.getUniformLocation(this.program,t);if(!l&&s&&(l=this.gl.getUniformLocation(this.program,`${t}[0]`)),!l){this.log(`${t} not in shader. Skipping initialization.`);return}let u=s?i[0]:i,n=Array.isArray(u)?u.length:1;this.uniforms.set(t,{type:e,length:n,location:l,arrayLength:s});try{this.updateUniforms({[t]:i})}catch(d){throw this.uniforms.delete(t),d}this.emitHook("initializeUniform",...arguments)}log(...t){this.debug&&console.debug(...t)}updateUniforms(t,e){this.gl.useProgram(this.program),Object.entries(t).forEach(([i,r])=>{let s=this.uniforms.get(i);if(!s){this.log(`${i} not in shader. Skipping update.`);return}let l=`uniform${s.length}${s.type.charAt(0)}`;if(s.arrayLength){if(!Array.isArray(r))throw new Error(`${i} is an array, but the value passed to updateUniforms is not an array.`);let u=r.length;if(!u)return;if(u>s.arrayLength)throw new Error(`${i} received ${u} values, but maximum length is ${s.arrayLength}.`);if(r.some(h=>(Array.isArray(h)?h.length:1)!==s.length))throw new Error(`Tried to update ${i} with some elements that are not length ${s.length}.`);let n=new(s.type==="float"?Float32Array:Int32Array)(r.flat()),d=s.location;if(e?.startIndex){let h=this.gl.getUniformLocation(this.program,`${i}[${e.startIndex}]`);if(!h)throw new Error(`${i}[${e.startIndex}] not in shader. Did you pass an invalid startIndex?`);d=h}this.gl[l+"v"](d,n)}else{if(Array.isArray(r)||(r=[r]),r.length!==s.length)throw new Error(`Invalid uniform value length: ${r.length}. Expected ${s.length}.`);this.gl[l](s.location,...r)}}),this.emitHook("updateUniforms",...arguments)}createTexture(t,e){let{width:i,height:r}=e,s=e.history?.depth??0,l=this.gl.createTexture();if(!l)throw new Error("Failed to create texture");let u=e.unitIndex;if(typeof u!="number")try{u=this.reserveTextureUnit(t)}catch(p){throw this.gl.deleteTexture(l),p}let n=s>0,d=n?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:h}=e;return this.gl.activeTexture(this.gl.TEXTURE0+u),this.gl.bindTexture(d,l),this.gl.texParameteri(d,this.gl.TEXTURE_WRAP_S,h.wrapS),this.gl.texParameteri(d,this.gl.TEXTURE_WRAP_T,h.wrapT),this.gl.texParameteri(d,this.gl.TEXTURE_MIN_FILTER,h.minFilter),this.gl.texParameteri(d,this.gl.TEXTURE_MAG_FILTER,h.magFilter),n?this.gl.texStorage3D(d,1,h.internalFormat,i,r,s):t===P&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,h.internalFormat,i,r,0,h.format,h.type,null),{texture:l,unitIndex:u}}_initializeTexture(t,e,i){if(this.textures.has(t))throw new Error(`Texture '${D(t)}' is already initialized.`);let{history:r=0,...s}=i??{},{width:l,height:u}=J(e);if(!l||!u)throw new Error("Texture source must have valid dimensions");let n={width:l,height:u,options:this.resolveTextureOptions(s)};r>0&&(n.history={depth:r,writeIndex:0});let{texture:d,unitIndex:h}=this.createTexture(t,n),p={texture:d,unitIndex:h,...n};r>0&&(this.initializeUniform(`${D(t)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(p)),this.textures.set(t,p),this.updateTexture(t,e);let c=this.gl.getUniformLocation(this.program,D(t));c&&this.gl.uniform1i(c,h)}initializeTexture(t,e,i){let r=i?.history!=null&&i.history>0?{...i,history:i.history+1}:i;this._initializeTexture(t,e,r),this.emitHook("initializeTexture",...arguments)}updateTextures(t,e){Object.entries(t).forEach(([i,r])=>{this.updateTexture(i,r,e)}),this.emitHook("updateTextures",...arguments)}updateTexture(t,e,i){let r=this.textures.get(t);if(!r)throw new Error(`Texture '${D(t)}' is not initialized.`);if(e instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+r.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,e);return}let s=e;if(e instanceof o){let c=e.textures.get(P),T=c.width,g=c.height;if(e.gl===this.gl){if(!r.history){this.gl.activeTexture(this.gl.TEXTURE0+r.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,c.texture);return}let{depth:L}=r.history,w=i?.historyWriteIndex===void 0?[r.history.writeIndex]:Array.isArray(i?.historyWriteIndex)?i.historyWriteIndex.map(S=>U(S,L)):[U(i.historyWriteIndex,L)];this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,e.intermediateFbo),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,r.texture);for(let S of w)this.gl.copyTexSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,S,0,0,T,g);this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,null),this.gl.activeTexture(this.gl.TEXTURE0+r.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,r.texture);let C=`${D(t)}FrameOffset`;this.updateUniforms({[C]:w[w.length-1]}),i?.historyWriteIndex===void 0&&(r.history.writeIndex=(r.history.writeIndex+1)%L);return}let{width:E,height:a,options:{format:y,type:b}}=c,I=this.getPixelArray(b,E*a*4);e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,e.intermediateFbo),e.gl.readPixels(0,0,E,a,y,b,I),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),s={data:I,width:E,height:a}}let{width:l,height:u}=J(s);if(!l||!u)return;let n="isPartial"in s&&s.isPartial;n||this.resizeTexture(t,l,u);let h=!("data"in s&&s.data)&&!r.options?.preserveY,p=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL);if(r.history){if(this.gl.activeTexture(this.gl.TEXTURE0+r.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,r.texture),!i?.skipHistoryWrite){let{depth:c}=r.history,T=i?.historyWriteIndex===void 0?[r.history.writeIndex]:Array.isArray(i.historyWriteIndex)?i.historyWriteIndex.map(a=>U(a,c)):[U(i.historyWriteIndex,c)];this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h);let g=s.data??s;for(let a of T)this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,a,l,u,1,r.options.format,r.options.type,g);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,p);let E=`${D(t)}FrameOffset`;this.updateUniforms({[E]:T[T.length-1]}),i?.historyWriteIndex===void 0&&(r.history.writeIndex=(r.history.writeIndex+1)%c)}}else{if(this.gl.activeTexture(this.gl.TEXTURE0+r.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,r.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h),n){let c=s;this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,c.x??0,c.y??0,l,u,r.options.format,r.options.type,c.data)}else this.gl.texImage2D(this.gl.TEXTURE_2D,0,r.options.internalFormat,l,u,0,r.options.format,r.options.type,s.data??s);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,p)}}bindIntermediate(){let t=this.gl,e=this.textures.get(P);t.bindFramebuffer(t.FRAMEBUFFER,this.intermediateFbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.texture,0)}clear(){this.bindIntermediate();let t=this.gl,e=this.textures.get(P);if(e.options.isIntegerColorFormat){let i=e.options.type;this.glHelpers.unsignedIntTypes.has(i)?t.clearBufferuiv(t.COLOR,0,new Uint32Array(4)):t.clearBufferiv(t.COLOR,0,new Int32Array(4))}else t.clear(t.COLOR_BUFFER_BIT)}draw(t){this.emitHook("beforeDraw",...arguments);let e=this.gl,i=e.drawingBufferWidth,r=e.drawingBufferHeight;t?.skipClear?this.bindIntermediate():this.clear(),e.useProgram(this.program),e.bindVertexArray(this.vao),e.viewport(0,0,i,r),e.drawArrays(e.TRIANGLES,0,3),this.isHeadless||this.textures.get(P).options.isIntegerColorFormat||(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.intermediateFbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.blitFramebuffer(0,0,i,r,0,0,i,r,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,null)),this.emitHook("afterDraw",...arguments)}step(t){this._step(performance.now()-this.startTime,t)}_step(t,e){this.emitHook("beforeStep",t,this.frame,e);let i={};this.uniforms.has("u_time")&&(i.u_time=t),this.uniforms.has("u_frame")&&(i.u_frame=this.frame),this.updateUniforms(i),this.draw(e);let r=this.textures.get(W);if(r&&!e?.skipHistoryWrite){let{writeIndex:s,depth:l}=r.history,u=this.gl;u.bindFramebuffer(u.READ_FRAMEBUFFER,this.intermediateFbo),u.bindTexture(u.TEXTURE_2D_ARRAY,r.texture),u.copyTexSubImage3D(u.TEXTURE_2D_ARRAY,0,0,0,s,0,0,u.drawingBufferWidth,u.drawingBufferHeight),u.bindFramebuffer(u.READ_FRAMEBUFFER,null);let n=(s+1)%l;this.updateUniforms({[`${D(W)}FrameOffset`]:n}),r.history.writeIndex=n}++this.frame,this.emitHook("afterStep",t,this.frame,e)}play(t){this.pause(),this.isPlaying=!0;let e=i=>{i=(i-this.startTime)/1e3;let r=t?.(i,this.frame)??void 0;this._step(i,r),this.isPlaying&&(this.animationFrameId=requestAnimationFrame(e))};this.animationFrameId=requestAnimationFrame(e),this.emitHook("play")}_pause(){this.isPlaying=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}pause(){this._pause(),this.emitHook("pause")}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(t=>{t.history&&(t.history.writeIndex=0,this.clearHistoryTextureLayers(t))}),this.clear(),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this._pause(),this.cursorTarget&&(this.eventListeners.forEach((t,e)=>{this.cursorTarget.removeEventListener(e,t)}),this.eventListeners.clear()),this.resolutionObserver&&(this.resolutionObserver.disconnect(),this.resolutionObserver=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(t=>{this.gl.deleteTexture(t.texture)}),this.textures.clear(),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.uniforms.clear(),this.hooks.clear()}},Z=Y;var Q={data:new Uint8Array(4),width:1,height:1};function K(o){return o instanceof HTMLVideoElement||o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof OffscreenCanvas}function ee(o){return JSON.stringify(o,Object.keys(o).sort())}function H(o,t,e,i,r=0){let s=1/0,l=-1/0,u=1/0,n=-1/0,d=0,h=0;for(let p of e){let c=(r+t*i+p)*4,T=o[c],g=o[c+1];s=Math.min(s,T),l=Math.max(l,T),u=Math.min(u,g),n=Math.max(n,g),d+=o[c+2],h+=o[c+3]}return[(s+l)/2,(u+n)/2,d/e.length,h/e.length]}var X=null;function te(){return X||(X=import("@mediapipe/tasks-vision").then(({FilesetResolver:o})=>o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),X}function re(o){return{historyParams:o?", framesAgo":"",fn:o?(i,r,s,l)=>{let u=s.replace(/\w+ /g,""),n=s?`${s}, int framesAgo`:"int framesAgo",d=u?`${u}, 0`:"0";return`${i} ${r}(${n}) {
${l}
}
${i} ${r}(${s}) { return ${r}(${d}); }`}:(i,r,s,l)=>`${i} ${r}(${s}) {
${l}
}`}}var v=33,ge=6,_=v+ge,m={LEFT_EYE:2,RIGHT_EYE:5,LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_HIP:23,RIGHT_HIP:24,LEFT_KNEE:25,RIGHT_KNEE:26,LEFT_WRIST:15,RIGHT_WRIST:16,LEFT_PINKY:17,RIGHT_PINKY:18,LEFT_INDEX:19,RIGHT_INDEX:20,LEFT_THUMB:21,RIGHT_THUMB:22,LEFT_ANKLE:27,RIGHT_ANKLE:28,LEFT_HEEL:29,RIGHT_HEEL:30,LEFT_FOOT_INDEX:31,RIGHT_FOOT_INDEX:32,BODY_CENTER:v,LEFT_HAND_CENTER:v+1,RIGHT_HAND_CENTER:v+2,LEFT_FOOT_CENTER:v+3,RIGHT_FOOT_CENTER:v+4,TORSO_CENTER:v+5},pe=Array.from({length:v},(o,t)=>t),Ee=[m.LEFT_WRIST,m.LEFT_PINKY,m.LEFT_THUMB,m.LEFT_INDEX],_e=[m.RIGHT_WRIST,m.RIGHT_PINKY,m.RIGHT_THUMB,m.RIGHT_INDEX],xe=[m.LEFT_ANKLE,m.LEFT_HEEL,m.LEFT_FOOT_INDEX],Re=[m.RIGHT_ANKLE,m.RIGHT_HEEL,m.RIGHT_FOOT_INDEX],ye=[m.LEFT_SHOULDER,m.RIGHT_SHOULDER,m.LEFT_HIP,m.RIGHT_HIP],N=512,x=1,be={modelPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",maxPoses:1,minPoseDetectionConfidence:.5,minPosePresenceConfidence:.5,minTrackingConfidence:.5},Ie=`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
uniform mediump sampler2D u_mask;
uniform float u_poseIndex;
void main() {
	ivec2 texCoord = ivec2(vec2(v_uv.x, 1.0 - v_uv.y) * vec2(textureSize(u_mask, 0)));
	float confidence = texelFetch(u_mask, texCoord, 0).r;
	if (confidence < 0.01) discard;
	outColor = vec4(1.0, confidence, u_poseIndex, 1.0);
}`,M=new Map;function Le(o,t){let e=o.landmarks.data,i=t.length;e[0]=i;for(let r=0;r<i;++r){let s=t[r];for(let b=0;b<v;++b){let I=s[b],L=(x+r*_+b)*4;e[L]=I.x,e[L+1]=1-I.y,e[L+2]=I.z??0,e[L+3]=I.visibility??1}let l=H(e,r,pe,_,x),u=(x+r*_+m.BODY_CENTER)*4;e[u]=l[0],e[u+1]=l[1],e[u+2]=l[2],e[u+3]=l[3];let n=H(e,r,Ee,_,x),d=(x+r*_+m.LEFT_HAND_CENTER)*4;e[d]=n[0],e[d+1]=n[1],e[d+2]=n[2],e[d+3]=n[3];let h=H(e,r,_e,_,x),p=(x+r*_+m.RIGHT_HAND_CENTER)*4;e[p]=h[0],e[p+1]=h[1],e[p+2]=h[2],e[p+3]=h[3];let c=H(e,r,xe,_,x),T=(x+r*_+m.LEFT_FOOT_CENTER)*4;e[T]=c[0],e[T+1]=c[1],e[T+2]=c[2],e[T+3]=c[3];let g=H(e,r,Re,_,x),E=(x+r*_+m.RIGHT_FOOT_CENTER)*4;e[E]=g[0],e[E+1]=g[1],e[E+2]=g[2],e[E+3]=g[3];let a=H(e,r,ye,_,x),y=(x+r*_+m.TORSO_CENTER)*4;e[y]=a[0],e[y+1]=a[1],e[y+2]=a[2],e[y+3]=a[3]}o.state.nPoses=i}function Fe(o,t){let{maskShader:e,maxPoses:i}=o;if(!t||t.length===0)return e.clear();for(let r=0;r<t.length;++r){let s=t[r];e.updateTextures({u_mask:s.getAsWebGLTexture()}),e.updateUniforms({u_poseIndex:(r+1)/i}),e.step({skipClear:r>0}),s.close()}}function Ae(o){let{textureName:t,options:{history:e,...i}={}}=o,r={...be,...i},s=ee({...r,textureName:t}),l=r.maxPoses*_+x,u=Math.ceil(l/N);return function(n,d){let{injectGLSL:h,emitHook:p}=d,c=M.get(s),T=c?.landmarks.data??new Float32Array(N*u*4),g=c?.mediapipeCanvas??new OffscreenCanvas(1,1),E=c?.maskShader??(()=>{let f=new Z(Ie,{canvas:g});return f.initializeTexture("u_mask",Q),f.initializeUniform("u_poseIndex","float",0),f})(),a=null,y=!1,b=!1;function I(f){if(!a)return;let{nPoses:R}=a.state,F=R*_+x,G=Math.ceil(F/N),O=f;typeof O>"u"&&S.length>0&&(O=S,S=[]),n.updateTextures({u_poseLandmarksTex:{data:a.landmarks.data,width:N,height:G,isPartial:!0},u_poseMask:E},e?{skipHistoryWrite:b,historyWriteIndex:O}:void 0),n.updateUniforms({u_nPoses:R}),p("pose:result",a.state.result)}async function L(){if(M.has(s))a=M.get(s);else{let[f,{PoseLandmarker:R}]=await Promise.all([te(),import("@mediapipe/tasks-vision")]);if(y)return;let F=await R.createFromOptions(f,{baseOptions:{modelAssetPath:r.modelPath,delegate:"GPU"},canvas:g,runningMode:"VIDEO",numPoses:r.maxPoses,minPoseDetectionConfidence:r.minPoseDetectionConfidence,minPosePresenceConfidence:r.minPosePresenceConfidence,minTrackingConfidence:r.minTrackingConfidence,outputSegmentationMasks:!0});if(y){F.close(),E.destroy();return}a={landmarker:F,mediapipeCanvas:g,maskShader:E,subscribers:new Map,maxPoses:r.maxPoses,state:{nCalls:0,runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nPoses:0},landmarks:{data:T,textureHeight:u}},M.set(s,a)}a.subscribers.set(I,!1)}let w=L();n.on("_init",()=>{n.initializeUniform("u_maxPoses","int",r.maxPoses),n.initializeUniform("u_nPoses","int",0),n.initializeTexture("u_poseLandmarksTex",{data:T,width:N,height:u},{internalFormat:"RGBA32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST",history:e}),n.initializeTexture("u_poseMask",E,{minFilter:"NEAREST",magFilter:"NEAREST",history:e}),w.then(()=>{y||!a||p("pose:ready")})});let C=0,S=[],z=()=>{e&&(I(C),S.push(C),C=(C+1)%(e+1))};n.on("initializeTexture",(f,R)=>{f===t&&K(R)&&(z(),V(R))}),n.on("updateTextures",(f,R)=>{let F=f[t];K(F)&&(b=R?.skipHistoryWrite??!1,b||z(),V(F))});async function V(f){let R=performance.now();if(await w,!a)return;let F=++a.state.nCalls;a.state.pending=a.state.pending.then(async()=>{if(!a||F!==a.state.nCalls)return;let G=f instanceof HTMLVideoElement?"VIDEO":"IMAGE";a.state.runningMode!==G&&(a.state.runningMode=G,await a.landmarker.setOptions({runningMode:G}));let O=!1;if(f!==a.state.source?(a.state.source=f,a.state.videoTime=-1,O=!0):f instanceof HTMLVideoElement?f.currentTime!==a.state.videoTime&&(a.state.videoTime=f.currentTime,O=!0):f instanceof HTMLImageElement||R-a.state.resultTimestamp>2&&(O=!0),O){let A;if(f instanceof HTMLVideoElement){if(f.videoWidth===0||f.videoHeight===0||f.readyState<2)return;A=a.landmarker.detectForVideo(f,R)}else{if(f.width===0||f.height===0)return;A=a.landmarker.detect(f)}if(A){a.state.resultTimestamp=R,a.state.result=A,Le(a,A.landmarks),Fe(a,A.segmentationMasks);for(let B of a.subscribers.keys())B(),a.subscribers.set(B,!0)}}else if(a.state.result)for(let[A,B]of a.subscribers.entries())B||(A(),a.subscribers.set(A,!0))}),await a.state.pending}n.on("destroy",()=>{y=!0,a&&(a.subscribers.delete(I),a.subscribers.size===0&&(a.landmarker.close(),a.maskShader.destroy(),M.delete(s))),a=null});let{fn:k,historyParams:ie}=re(e),ne=e?`int layer = (u_poseMaskFrameOffset - framesAgo + ${e+1}) % ${e+1};
	vec4 mask = texture(u_poseMask, vec3(pos, float(layer)));`:"vec4 mask = texture(u_poseMask, pos);";h(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform highp sampler2D${e?"Array":""} u_poseLandmarksTex;${e?`
uniform int u_poseLandmarksTexFrameOffset;`:""}
uniform ${e?"highp":"mediump"} sampler2D${e?"Array":""} u_poseMask;${e?`
uniform int u_poseMaskFrameOffset;`:""}

#define POSE_LANDMARK_LEFT_EYE ${m.LEFT_EYE}
#define POSE_LANDMARK_RIGHT_EYE ${m.RIGHT_EYE}
#define POSE_LANDMARK_LEFT_SHOULDER ${m.LEFT_SHOULDER}
#define POSE_LANDMARK_RIGHT_SHOULDER ${m.RIGHT_SHOULDER}
#define POSE_LANDMARK_LEFT_ELBOW ${m.LEFT_ELBOW}
#define POSE_LANDMARK_RIGHT_ELBOW ${m.RIGHT_ELBOW}
#define POSE_LANDMARK_LEFT_HIP ${m.LEFT_HIP}
#define POSE_LANDMARK_RIGHT_HIP ${m.RIGHT_HIP}
#define POSE_LANDMARK_LEFT_KNEE ${m.LEFT_KNEE}
#define POSE_LANDMARK_RIGHT_KNEE ${m.RIGHT_KNEE}
#define POSE_LANDMARK_BODY_CENTER ${m.BODY_CENTER}
#define POSE_LANDMARK_LEFT_HAND_CENTER ${m.LEFT_HAND_CENTER}
#define POSE_LANDMARK_RIGHT_HAND_CENTER ${m.RIGHT_HAND_CENTER}
#define POSE_LANDMARK_LEFT_FOOT_CENTER ${m.LEFT_FOOT_CENTER}
#define POSE_LANDMARK_RIGHT_FOOT_CENTER ${m.RIGHT_FOOT_CENTER}
#define POSE_LANDMARK_TORSO_CENTER ${m.TORSO_CENTER}

${k("int","nPosesAt","",e?`
	int layer = (u_poseLandmarksTexFrameOffset - framesAgo + ${e+1}) % ${e+1};
	return int(texelFetch(u_poseLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_poseLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${k("vec4","poseLandmark","int poseIndex, int landmarkIndex",`int i = ${x} + poseIndex * ${_} + landmarkIndex;
	int x = i % ${N};
	int y = i / ${N};${e?`
	int layer = (u_poseLandmarksTexFrameOffset - framesAgo + ${e+1}) % ${e+1};
	return texelFetch(u_poseLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_poseLandmarksTex, ivec2(x, y), 0);`}`)}
${k("vec2","poseAt","vec2 pos",`${ne}
	float poseIndex = floor(mask.b * float(u_maxPoses) + 0.5) - 1.0;
	return vec2(mask.g, poseIndex);`)}
${k("float","inPose","vec2 pos",`vec2 pose = poseAt(pos${ie}); return step(0.0, pose.y) * pose.x;`)}`)}}var ve=Ae;
//# sourceMappingURL=pose.js.map