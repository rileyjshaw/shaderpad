"use strict";var se=Object.create;var U=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty;var he=(o,i)=>{for(var e in i)U(o,e,{get:i[e],enumerable:!0})},j=(o,i,e,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of ae(i))!le.call(o,t)&&t!==e&&U(o,t,{get:()=>i[t],enumerable:!(n=oe(i,t))||n.enumerable});return o};var q=(o,i,e)=>(e=o!=null?se(ue(o)):{},j(i||!o||!o.__esModule?U(e,"default",{value:o,enumerable:!0}):e,o)),me=o=>j(U({},"__esModule",{value:!0}),o);var Ae={};he(Ae,{default:()=>Fe});module.exports=me(Ae);function W(o,i){return(o%i+i)%i}var ce=`#version 300 es
in vec2 a_position;
out vec2 v_uv;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
    v_uv = a_position * 0.5 + 0.5;
}`,$=Symbol("u_history"),C=Symbol("__SHADERPAD_BUFFER");function de(o,i){if(!i?.length)return o;let e=o.split(`
`),n=e.findLastIndex(t=>{let r=t.trimStart();return r.startsWith("precision ")||r.startsWith("#version ")})+1;return e.splice(n,0,...i),e.join(`
`)}function J(o){return o instanceof WebGLTexture?{width:0,height:0}:o instanceof B?{width:o.canvas.width,height:o.canvas.height}:o instanceof HTMLVideoElement?{width:o.videoWidth,height:o.videoHeight}:o instanceof HTMLImageElement?{width:o.naturalWidth??o.width,height:o.naturalHeight??o.height}:{width:o.width,height:o.height}}function D(o){return typeof o=="symbol"?o.description??"":o}var B=class o{isHeadless=!1;isTouchDevice=!1;gl;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;vao=null;program=null;animationFrameId;eventListeners=new Map;frame=0;startTime=0;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;resolutionObserver=null;hooks=new Map;historyDepth=0;textureOptions;debug;intermediateFbo=null;constructor(i,{canvas:e,plugins:n,history:t,debug:r,...u}={}){if(e&&"getContext"in e)this.canvas=e;else{let{width:c=1,height:T=1}=e||{};this.canvas=new OffscreenCanvas(c,T),this.isHeadless=!0}let s=this.canvas.getContext("webgl2",{antialias:!1});if(!s)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=s,this.textureUnitPool={free:[],next:0,max:s.getParameter(s.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.textureOptions=u,t&&(this.historyDepth=t),this.debug=r??(typeof process<"u"&&!1),this.animationFrameId=null;let l=[];n&&n.forEach(c=>c(this,{gl:s,canvas:this.canvas,injectGLSL:T=>{l.push(T)},emitHook:this.emitHook.bind(this)}));let m=this.gl.createProgram();if(!m)throw new Error("Failed to create WebGL program");this.program=m;let d=this.createShader(this.gl.VERTEX_SHADER,ce),g=this.createShader(s.FRAGMENT_SHADER,de(i,l));if(s.attachShader(m,d),s.attachShader(m,g),s.bindAttribLocation(m,0,"a_position"),s.linkProgram(m),s.deleteShader(d),s.deleteShader(g),!s.getProgramParameter(m,s.LINK_STATUS))throw console.error("Program link error:",s.getProgramInfoLog(m)),s.deleteProgram(m),new Error("Failed to link WebGL program");if(this.vao=s.createVertexArray(),s.bindVertexArray(this.vao),this.buffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),s.STATIC_DRAW),s.enableVertexAttribArray(0),s.vertexAttribPointer(0,2,s.FLOAT,!1,0,0),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.useProgram(m),this.canvas instanceof HTMLCanvasElement)this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]});else{let c=T=>{let p=Object.getOwnPropertyDescriptor(OffscreenCanvas.prototype,T);Object.defineProperty(this.canvas,T,{get:()=>p.get.call(this.canvas),set:_=>{p.set.call(this.canvas,_),this.updateResolution()},configurable:p.configurable,enumerable:p.enumerable})};c("width"),c("height")}this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this._initializeTexture(C,this.canvas,{...this.textureOptions}),this.intermediateFbo=s.createFramebuffer(),this.historyDepth>0&&this._initializeTexture($,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.canvas instanceof HTMLCanvasElement&&this.addEventListeners(),this.emitHook("init")}resolveGLConstant(i){let e=this.gl[i];if(e===void 0)throw new Error(`Unknown GL constant: ${i}`);return e}emitHook(i,...e){this.hooks.get(i)?.forEach(n=>n.call(this,...e))}on(i,e){this.hooks.has(i)||this.hooks.set(i,[]),this.hooks.get(i).push(e)}off(i,e){let n=this.hooks.get(i);n&&n.splice(n.indexOf(e),1)}createShader(i,e){let n=this.gl.createShader(i);if(this.gl.shaderSource(n,e),this.gl.compileShader(n),!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",e),console.error(this.gl.getShaderInfoLog(n)),this.gl.deleteShader(n),new Error("Shader compilation failed");return n}addEventListeners(){let i=this.canvas,e=(t,r)=>{if(!this.uniforms.has("u_cursor"))return;let u=i.getBoundingClientRect();this.cursorPosition[0]=(t-u.left)/u.width,this.cursorPosition[1]=1-(r-u.top)/u.height,this.updateUniforms({u_cursor:this.cursorPosition})},n=(t,r,u)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=t,t){let s=i.getBoundingClientRect(),l=r,m=u;this.clickPosition[0]=(l-s.left)/s.width,this.clickPosition[1]=1-(m-s.top)/s.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",t=>{let r=t;this.isTouchDevice||e(r.clientX,r.clientY)}),this.eventListeners.set("mousedown",t=>{let r=t;this.isTouchDevice||r.button===0&&(this.isMouseDown=!0,n(!0,r.clientX,r.clientY))}),this.eventListeners.set("mouseup",t=>{let r=t;this.isTouchDevice||r.button===0&&n(!1)}),this.eventListeners.set("touchmove",t=>{let r=t;r.touches.length>0&&e(r.touches[0].clientX,r.touches[0].clientY)}),this.eventListeners.set("touchstart",t=>{let r=t;this.isTouchDevice=!0,r.touches.length>0&&(e(r.touches[0].clientX,r.touches[0].clientY),n(!0,r.touches[0].clientX,r.touches[0].clientY))}),this.eventListeners.set("touchend",t=>{t.touches.length===0&&n(!1)}),this.eventListeners.forEach((t,r)=>{i.addEventListener(r,t)})}updateResolution(){let i=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...i),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:i}):this.initializeUniform("u_resolution","float",i),this.resizeTexture(C,...i),this.historyDepth>0&&this.resizeTexture($,...i),this.emitHook("updateResolution",...i)}resizeTexture(i,e,n){let t=this.textures.get(i);if(!t||t.width===e&&t.height===n)return;this.gl.deleteTexture(t.texture),t.width=e,t.height=n;let{texture:r}=this.createTexture(i,t);t.texture=r,t.history&&(t.history.writeIndex=0,this.clearHistoryTextureLayers(t))}reserveTextureUnit(i){let e=this.textures.get(i);if(e)return e.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}resolveTextureOptions(i){let{gl:e}=this,n=this.resolveGLConstant(i?.type??"UNSIGNED_BYTE"),t={type:n,format:this.resolveGLConstant(i?.format??"RGBA"),internalFormat:this.resolveGLConstant(i?.internalFormat??(n===e.FLOAT?"RGBA32F":n===e.HALF_FLOAT?"RGBA16F":"RGBA8")),minFilter:this.resolveGLConstant(i?.minFilter??"LINEAR"),magFilter:this.resolveGLConstant(i?.magFilter??"LINEAR"),wrapS:this.resolveGLConstant(i?.wrapS??"CLAMP_TO_EDGE"),wrapT:this.resolveGLConstant(i?.wrapT??"CLAMP_TO_EDGE"),preserveY:i?.preserveY};if((t.internalFormat===e.RGBA16F||t.internalFormat===e.RGBA32F)&&!e.getExtension("EXT_color_buffer_float"))throw new Error("Missing EXT_color_buffer_float.");return t}getPixelArray(i,e){return i===this.gl.FLOAT?new Float32Array(e):i===this.gl.HALF_FLOAT?new Uint16Array(e):new Uint8Array(e)}clearHistoryTextureLayers(i){if(!i.history)return;let e=this.gl,{type:n,format:t}=i.options,r=this.getPixelArray(n,i.width*i.height*4);e.activeTexture(e.TEXTURE0+i.unitIndex),e.bindTexture(e.TEXTURE_2D_ARRAY,i.texture);for(let u=0;u<i.history.depth;++u)e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,u,i.width,i.height,1,t,n,r)}initializeUniform(i,e,n,t){let r=t?.arrayLength;if(this.uniforms.has(i))throw new Error(`${i} is already initialized.`);if(e!=="float"&&e!=="int")throw new Error(`Invalid uniform type: ${e}. Expected 'float' or 'int'.`);if(r&&!(Array.isArray(n)&&n.length===r))throw new Error(`${i} array length mismatch: must initialize with ${r} elements.`);let u=this.gl.getUniformLocation(this.program,i);if(!u&&r&&(u=this.gl.getUniformLocation(this.program,`${i}[0]`)),!u){this.log(`${i} not in shader. Skipping initialization.`);return}let s=r?n[0]:n,l=Array.isArray(s)?s.length:1;this.uniforms.set(i,{type:e,length:l,location:u,arrayLength:r});try{this.updateUniforms({[i]:n})}catch(m){throw this.uniforms.delete(i),m}this.emitHook("initializeUniform",...arguments)}log(...i){this.debug&&console.debug(...i)}updateUniforms(i,e){this.gl.useProgram(this.program),Object.entries(i).forEach(([n,t])=>{let r=this.uniforms.get(n);if(!r){this.log(`${n} not in shader. Skipping update.`);return}let u=`uniform${r.length}${r.type.charAt(0)}`;if(r.arrayLength){if(!Array.isArray(t))throw new Error(`${n} is an array, but the value passed to updateUniforms is not an array.`);let s=t.length;if(!s)return;if(s>r.arrayLength)throw new Error(`${n} received ${s} values, but maximum length is ${r.arrayLength}.`);if(t.some(d=>(Array.isArray(d)?d.length:1)!==r.length))throw new Error(`Tried to update ${n} with some elements that are not length ${r.length}.`);let l=new(r.type==="float"?Float32Array:Int32Array)(t.flat()),m=r.location;if(e?.startIndex){let d=this.gl.getUniformLocation(this.program,`${n}[${e.startIndex}]`);if(!d)throw new Error(`${n}[${e.startIndex}] not in shader. Did you pass an invalid startIndex?`);m=d}this.gl[u+"v"](m,l)}else{if(Array.isArray(t)||(t=[t]),t.length!==r.length)throw new Error(`Invalid uniform value length: ${t.length}. Expected ${r.length}.`);this.gl[u](r.location,...t)}}),this.emitHook("updateUniforms",...arguments)}createTexture(i,e){let{width:n,height:t}=e,r=e.history?.depth??0,u=this.gl.createTexture();if(!u)throw new Error("Failed to create texture");let s=e.unitIndex;if(typeof s!="number")try{s=this.reserveTextureUnit(i)}catch(g){throw this.gl.deleteTexture(u),g}let l=r>0,m=l?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:d}=e;return this.gl.activeTexture(this.gl.TEXTURE0+s),this.gl.bindTexture(m,u),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_S,d.wrapS),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_T,d.wrapT),this.gl.texParameteri(m,this.gl.TEXTURE_MIN_FILTER,d.minFilter),this.gl.texParameteri(m,this.gl.TEXTURE_MAG_FILTER,d.magFilter),l?this.gl.texStorage3D(m,1,d.internalFormat,n,t,r):i===C&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,d.internalFormat,n,t,0,d.format,d.type,null),{texture:u,unitIndex:s}}_initializeTexture(i,e,n){if(this.textures.has(i))throw new Error(`Texture '${D(i)}' is already initialized.`);let{history:t=0,...r}=n??{},{width:u,height:s}=J(e);if(!u||!s)throw new Error("Texture source must have valid dimensions");let l={width:u,height:s,options:this.resolveTextureOptions(r)};t>0&&(l.history={depth:t,writeIndex:0});let{texture:m,unitIndex:d}=this.createTexture(i,l),g={texture:m,unitIndex:d,...l};t>0&&(this.initializeUniform(`${D(i)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(g)),this.textures.set(i,g),this.updateTexture(i,e);let c=this.gl.getUniformLocation(this.program,D(i));c&&this.gl.uniform1i(c,d)}initializeTexture(i,e,n){let t=n?.history!=null&&n.history>0?{...n,history:n.history+1}:n;this._initializeTexture(i,e,t),this.emitHook("initializeTexture",...arguments)}updateTextures(i,e){Object.entries(i).forEach(([n,t])=>{this.updateTexture(n,t,e)}),this.emitHook("updateTextures",...arguments)}updateTexture(i,e,n){let t=this.textures.get(i);if(!t)throw new Error(`Texture '${D(i)}' is not initialized.`);if(e instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,e);return}let r=e;if(e instanceof o){let c=e.textures.get(C);if(e.gl===this.gl){this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,c.texture);return}let{width:T,height:p,options:{format:_,type:a}}=c,b=this.getPixelArray(a,T*p*4);e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,e.intermediateFbo),e.gl.readPixels(0,0,T,p,_,a,b),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),r={data:b,width:T,height:p}}let{width:u,height:s}=J(r);if(!u||!s)return;let l="isPartial"in r&&r.isPartial;l||this.resizeTexture(i,u,s);let d=!("data"in r&&r.data)&&!t.options?.preserveY,g=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL);if(t.history){if(this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,t.texture),!n?.skipHistoryWrite){let{depth:c}=t.history,T=n?.historyWriteIndex===void 0?[t.history.writeIndex]:Array.isArray(n.historyWriteIndex)?n.historyWriteIndex.map(a=>W(a,c)):[W(n.historyWriteIndex,c)];this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,d);let p=r.data??r;for(let a of T)this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,a,u,s,1,t.options.format,t.options.type,p);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g);let _=`${D(i)}FrameOffset`;this.updateUniforms({[_]:T[T.length-1]}),n?.historyWriteIndex===void 0&&(t.history.writeIndex=(t.history.writeIndex+1)%c)}}else{if(this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,t.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,d),l){let c=r;this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,c.x??0,c.y??0,u,s,t.options.format,t.options.type,c.data)}else this.gl.texImage2D(this.gl.TEXTURE_2D,0,t.options.internalFormat,u,s,0,t.options.format,t.options.type,r.data??r);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g)}}bindIntermediate(){let i=this.gl,e=this.textures.get(C);i.bindFramebuffer(i.FRAMEBUFFER,this.intermediateFbo),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e.texture,0)}clear(){this.bindIntermediate(),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}draw(i){this.emitHook("beforeDraw",...arguments);let e=this.gl,n=e.drawingBufferWidth,t=e.drawingBufferHeight;i?.skipClear?this.bindIntermediate():this.clear(),e.useProgram(this.program),e.bindVertexArray(this.vao),e.viewport(0,0,n,t),e.drawArrays(e.TRIANGLES,0,3),this.isHeadless||(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.intermediateFbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.blitFramebuffer(0,0,n,t,0,0,n,t,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,null)),this.emitHook("afterDraw",...arguments)}step(i){this._step(performance.now()-this.startTime,i)}_step(i,e){this.emitHook("beforeStep",...arguments);let n={};this.uniforms.has("u_time")&&(n.u_time=i),this.uniforms.has("u_frame")&&(n.u_frame=this.frame),this.updateUniforms(n),this.draw(e);let t=this.textures.get($);if(t&&!e?.skipHistoryWrite){let{writeIndex:r,depth:u}=t.history,s=this.gl;s.bindTexture(s.TEXTURE_2D_ARRAY,t.texture),s.copyTexSubImage3D(s.TEXTURE_2D_ARRAY,0,0,0,r,0,0,s.drawingBufferWidth,s.drawingBufferHeight);let l=(r+1)%u;this.updateUniforms({[`${D($)}FrameOffset`]:l}),t.history.writeIndex=l}++this.frame,this.emitHook("afterStep",...arguments)}play(i,e){this.pause();let n=t=>{t=(t-this.startTime)/1e3;let r=i?.(t,this.frame)??void 0;this._step(t,r),this.animationFrameId=requestAnimationFrame(n),e?.(t,this.frame)};this.animationFrameId=requestAnimationFrame(n),this.emitHook("play")}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.emitHook("pause")}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(i=>{i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}),this.clear(),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.canvas instanceof HTMLCanvasElement&&(this.eventListeners.forEach((i,e)=>{this.canvas.removeEventListener(e,i)}),this.eventListeners.clear()),this.resolutionObserver&&(this.resolutionObserver.disconnect(),this.resolutionObserver=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(i=>{this.gl.deleteTexture(i.texture)}),this.textures.clear(),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.uniforms.clear(),this.hooks.clear()}},Z=B;var Q={data:new Uint8Array(4),width:1,height:1};function Y(o){return o instanceof HTMLVideoElement||o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof OffscreenCanvas}function ee(o){return JSON.stringify(o,Object.keys(o).sort())}function S(o,i,e,n,t=0){let r=1/0,u=-1/0,s=1/0,l=-1/0,m=0,d=0;for(let g of e){let c=(t+i*n+g)*4,T=o[c],p=o[c+1];r=Math.min(r,T),u=Math.max(u,T),s=Math.min(s,p),l=Math.max(l,p),m+=o[c+2],d+=o[c+3]}return[(r+u)/2,(s+l)/2,m/e.length,d/e.length]}var X=null;function te(){return X||(X=import("@mediapipe/tasks-vision").then(({FilesetResolver:o})=>o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),X}function ie(o){return{historyParams:o?", framesAgo":"",fn:o?(n,t,r,u)=>{let s=r.replace(/\w+ /g,""),l=r?`${r}, int framesAgo`:"int framesAgo",m=s?`${s}, 0`:"0";return`${n} ${t}(${l}) {
${u}
}
${n} ${t}(${r}) { return ${t}(${m}); }`}:(n,t,r,u)=>`${n} ${t}(${r}) {
${u}
}`}}var y=33,fe=6,E=y+fe,h={LEFT_EYE:2,RIGHT_EYE:5,LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_HIP:23,RIGHT_HIP:24,LEFT_KNEE:25,RIGHT_KNEE:26,LEFT_WRIST:15,RIGHT_WRIST:16,LEFT_PINKY:17,RIGHT_PINKY:18,LEFT_INDEX:19,RIGHT_INDEX:20,LEFT_THUMB:21,RIGHT_THUMB:22,LEFT_ANKLE:27,RIGHT_ANKLE:28,LEFT_HEEL:29,RIGHT_HEEL:30,LEFT_FOOT_INDEX:31,RIGHT_FOOT_INDEX:32,BODY_CENTER:y,LEFT_HAND_CENTER:y+1,RIGHT_HAND_CENTER:y+2,LEFT_FOOT_CENTER:y+3,RIGHT_FOOT_CENTER:y+4,TORSO_CENTER:y+5},Te=Array.from({length:y},(o,i)=>i),pe=[h.LEFT_WRIST,h.LEFT_PINKY,h.LEFT_THUMB,h.LEFT_INDEX],ge=[h.RIGHT_WRIST,h.RIGHT_PINKY,h.RIGHT_THUMB,h.RIGHT_INDEX],Ee=[h.LEFT_ANKLE,h.LEFT_HEEL,h.LEFT_FOOT_INDEX],xe=[h.RIGHT_ANKLE,h.RIGHT_HEEL,h.RIGHT_FOOT_INDEX],_e=[h.LEFT_SHOULDER,h.RIGHT_SHOULDER,h.LEFT_HIP,h.RIGHT_HIP],P=512,x=1,Le={modelPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",maxPoses:1,minPoseDetectionConfidence:.5,minPosePresenceConfidence:.5,minTrackingConfidence:.5},be=`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
uniform mediump sampler2D u_mask;
uniform float u_poseIndex;
void main() {
	ivec2 texCoord = ivec2(vec2(v_uv.x, 1.0 - v_uv.y) * vec2(textureSize(u_mask, 0)));
	float confidence = texelFetch(u_mask, texCoord, 0).r;
	if (confidence < 0.01) discard;
	outColor = vec4(1.0, confidence, u_poseIndex, 1.0);
}`,w=new Map;function Re(o,i){let e=o.landmarks.data,n=i.length;e[0]=n;for(let t=0;t<n;++t){let r=i[t];for(let F=0;F<y;++F){let A=r[F],O=(x+t*E+F)*4;e[O]=A.x,e[O+1]=1-A.y,e[O+2]=A.z??0,e[O+3]=A.visibility??1}let u=S(e,t,Te,E,x),s=(x+t*E+h.BODY_CENTER)*4;e[s]=u[0],e[s+1]=u[1],e[s+2]=u[2],e[s+3]=u[3];let l=S(e,t,pe,E,x),m=(x+t*E+h.LEFT_HAND_CENTER)*4;e[m]=l[0],e[m+1]=l[1],e[m+2]=l[2],e[m+3]=l[3];let d=S(e,t,ge,E,x),g=(x+t*E+h.RIGHT_HAND_CENTER)*4;e[g]=d[0],e[g+1]=d[1],e[g+2]=d[2],e[g+3]=d[3];let c=S(e,t,Ee,E,x),T=(x+t*E+h.LEFT_FOOT_CENTER)*4;e[T]=c[0],e[T+1]=c[1],e[T+2]=c[2],e[T+3]=c[3];let p=S(e,t,xe,E,x),_=(x+t*E+h.RIGHT_FOOT_CENTER)*4;e[_]=p[0],e[_+1]=p[1],e[_+2]=p[2],e[_+3]=p[3];let a=S(e,t,_e,E,x),b=(x+t*E+h.TORSO_CENTER)*4;e[b]=a[0],e[b+1]=a[1],e[b+2]=a[2],e[b+3]=a[3]}o.state.nPoses=n}function ve(o,i){let{maskShader:e,maxPoses:n}=o;if(!i||i.length===0)return e.clear();for(let t=0;t<i.length;++t){let r=i[t];e.updateTextures({u_mask:r.getAsWebGLTexture()}),e.updateUniforms({u_poseIndex:(t+1)/n}),e.step({skipClear:t>0}),r.close()}}function ye(o){let{textureName:i,options:{history:e,...n}={}}=o,t={...Le,...n},r=ee({...t,textureName:i}),u=t.maxPoses*E+x,s=Math.ceil(u/P);return function(l,m){let{injectGLSL:d,emitHook:g}=m,c=w.get(r),T=c?.landmarks.data??new Float32Array(P*s*4),p=c?.mediapipeCanvas??new OffscreenCanvas(1,1),_=c?.maskShader??(()=>{let f=new Z(be,{canvas:p});return f.initializeTexture("u_mask",Q),f.initializeUniform("u_poseIndex","float",0),f})(),a=null,b=!1,F=!1;function A(f){if(!a)return;let{nPoses:L}=a.state,R=L*E+x,H=Math.ceil(R/P),I=f;typeof I>"u"&&k.length>0&&(I=k,k=[]),l.updateTextures({u_poseLandmarksTex:{data:a.landmarks.data,width:P,height:H,isPartial:!0},u_poseMask:_},e?{skipHistoryWrite:F,historyWriteIndex:I}:void 0),l.updateUniforms({u_nPoses:L}),g("pose:result",a.state.result)}async function O(){if(w.has(r))a=w.get(r);else{let[f,{PoseLandmarker:L}]=await Promise.all([te(),import("@mediapipe/tasks-vision")]);if(b)return;let R=await L.createFromOptions(f,{baseOptions:{modelAssetPath:t.modelPath,delegate:"GPU"},canvas:p,runningMode:"VIDEO",numPoses:t.maxPoses,minPoseDetectionConfidence:t.minPoseDetectionConfidence,minPosePresenceConfidence:t.minPosePresenceConfidence,minTrackingConfidence:t.minTrackingConfidence,outputSegmentationMasks:!0});if(b){R.close(),_.destroy();return}a={landmarker:R,mediapipeCanvas:p,maskShader:_,subscribers:new Map,maxPoses:t.maxPoses,state:{nCalls:0,runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nPoses:0},landmarks:{data:T,textureHeight:s}},w.set(r,a)}a.subscribers.set(A,!1)}let K=O();l.on("init",()=>{l.initializeUniform("u_maxPoses","int",t.maxPoses),l.initializeUniform("u_nPoses","int",0),l.initializeTexture("u_poseLandmarksTex",{data:T,width:P,height:s},{internalFormat:"RGBA32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST",history:e}),l.initializeTexture("u_poseMask",_,{minFilter:"NEAREST",magFilter:"NEAREST",history:e}),K.then(()=>{b||!a||g("pose:ready")})});let M=0,k=[],z=()=>{e&&(A(M),k.push(M),M=(M+1)%(e+1))};l.on("initializeTexture",(f,L)=>{f===i&&Y(L)&&(z(),V(L))}),l.on("updateTextures",(f,L)=>{let R=f[i];Y(R)&&(F=L?.skipHistoryWrite??!1,F||z(),V(R))});async function V(f){let L=performance.now();if(await K,!a)return;let R=++a.state.nCalls;a.state.pending=a.state.pending.then(async()=>{if(!a||R!==a.state.nCalls)return;let H=f instanceof HTMLVideoElement?"VIDEO":"IMAGE";a.state.runningMode!==H&&(a.state.runningMode=H,await a.landmarker.setOptions({runningMode:H}));let I=!1;if(f!==a.state.source?(a.state.source=f,a.state.videoTime=-1,I=!0):f instanceof HTMLVideoElement?f.currentTime!==a.state.videoTime&&(a.state.videoTime=f.currentTime,I=!0):f instanceof HTMLImageElement||L-a.state.resultTimestamp>2&&(I=!0),I){let v;if(f instanceof HTMLVideoElement){if(f.videoWidth===0||f.videoHeight===0||f.readyState<2)return;v=a.landmarker.detectForVideo(f,L)}else{if(f.width===0||f.height===0)return;v=a.landmarker.detect(f)}if(v){a.state.resultTimestamp=L,a.state.result=v,Re(a,v.landmarks),ve(a,v.segmentationMasks);for(let G of a.subscribers.keys())G(),a.subscribers.set(G,!0)}}else if(a.state.result)for(let[v,G]of a.subscribers.entries())G||(v(),a.subscribers.set(v,!0))}),await a.state.pending}l.on("destroy",()=>{b=!0,a&&(a.subscribers.delete(A),a.subscribers.size===0&&(a.landmarker.close(),a.maskShader.destroy(),w.delete(r))),a=null});let{fn:N,historyParams:re}=ie(e),ne=e?`int layer = (u_poseMaskFrameOffset - framesAgo + ${e+1}) % ${e+1};
	vec4 mask = texture(u_poseMask, vec3(pos, float(layer)));`:"vec4 mask = texture(u_poseMask, pos);";d(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform highp sampler2D${e?"Array":""} u_poseLandmarksTex;${e?`
uniform int u_poseLandmarksTexFrameOffset;`:""}
uniform ${e?"highp":"mediump"} sampler2D${e?"Array":""} u_poseMask;${e?`
uniform int u_poseMaskFrameOffset;`:""}

#define POSE_LANDMARK_LEFT_EYE ${h.LEFT_EYE}
#define POSE_LANDMARK_RIGHT_EYE ${h.RIGHT_EYE}
#define POSE_LANDMARK_LEFT_SHOULDER ${h.LEFT_SHOULDER}
#define POSE_LANDMARK_RIGHT_SHOULDER ${h.RIGHT_SHOULDER}
#define POSE_LANDMARK_LEFT_ELBOW ${h.LEFT_ELBOW}
#define POSE_LANDMARK_RIGHT_ELBOW ${h.RIGHT_ELBOW}
#define POSE_LANDMARK_LEFT_HIP ${h.LEFT_HIP}
#define POSE_LANDMARK_RIGHT_HIP ${h.RIGHT_HIP}
#define POSE_LANDMARK_LEFT_KNEE ${h.LEFT_KNEE}
#define POSE_LANDMARK_RIGHT_KNEE ${h.RIGHT_KNEE}
#define POSE_LANDMARK_BODY_CENTER ${h.BODY_CENTER}
#define POSE_LANDMARK_LEFT_HAND_CENTER ${h.LEFT_HAND_CENTER}
#define POSE_LANDMARK_RIGHT_HAND_CENTER ${h.RIGHT_HAND_CENTER}
#define POSE_LANDMARK_LEFT_FOOT_CENTER ${h.LEFT_FOOT_CENTER}
#define POSE_LANDMARK_RIGHT_FOOT_CENTER ${h.RIGHT_FOOT_CENTER}
#define POSE_LANDMARK_TORSO_CENTER ${h.TORSO_CENTER}

${N("int","nPosesAt","",e?`
	int layer = (u_poseLandmarksTexFrameOffset - framesAgo + ${e+1}) % ${e+1};
	return int(texelFetch(u_poseLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_poseLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${N("vec4","poseLandmark","int poseIndex, int landmarkIndex",`int i = ${x} + poseIndex * ${E} + landmarkIndex;
	int x = i % ${P};
	int y = i / ${P};${e?`
	int layer = (u_poseLandmarksTexFrameOffset - framesAgo + ${e+1}) % ${e+1};
	return texelFetch(u_poseLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_poseLandmarksTex, ivec2(x, y), 0);`}`)}
${N("vec2","poseAt","vec2 pos",`${ne}
	float poseIndex = floor(mask.b * float(u_maxPoses) + 0.5) - 1.0;
	return vec2(mask.g, poseIndex);`)}
${N("float","inPose","vec2 pos",`vec2 pose = poseAt(pos${re}); return step(0.0, pose.y) * pose.x;`)}`)}}var Fe=ye;
//# sourceMappingURL=pose.js.map