"use strict";var ae=Object.create;var K=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var he=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var ce=(o,t)=>{for(var e in t)K(o,e,{get:t[e],enumerable:!0})},J=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ue(t))!me.call(o,i)&&i!==e&&K(o,i,{get:()=>t[i],enumerable:!(r=le(t,i))||r.enumerable});return o};var Z=(o,t,e)=>(e=o!=null?ae(he(o)):{},J(t||!o||!o.__esModule?K(e,"default",{value:o,enumerable:!0}):e,o)),de=o=>J(K({},"__esModule",{value:!0}),o);var Oe={};ce(Oe,{default:()=>Pe});module.exports=de(Oe);function M(o,t){return(o%t+t)%t}var fe=`#version 300 es
in vec2 a_position;
out vec2 v_uv;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
    v_uv = a_position * 0.5 + 0.5;
}`,Te=[["8UI","UNSIGNED_BYTE"],["8I","BYTE"],["16UI","UNSIGNED_SHORT"],["16I","SHORT"],["16F","HALF_FLOAT"],["32UI","UNSIGNED_INT"],["32I","INT"],["32F","FLOAT"],["8","UNSIGNED_BYTE"]],V={float:"f",int:"i",uint:"ui"};function ge(o){return o&&Te.find(([t])=>o.endsWith(t))?.[1]}var k=Symbol("u_history"),A=Symbol("__SHADERPAD_BUFFER"),B=new WeakMap;function pe(o,t){if(!t?.length)return o;let e=o.split(`
`),r=e.findLastIndex(i=>{let s=i.trimStart();return s.startsWith("precision ")||s.startsWith("#version ")})+1;return e.splice(r,0,...t),e.join(`
`)}function Q(o){return o instanceof WebGLTexture?{width:0,height:0}:o instanceof z?{width:o.canvas.width,height:o.canvas.height}:o instanceof HTMLVideoElement?{width:o.videoWidth,height:o.videoHeight}:o instanceof HTMLImageElement?{width:o.naturalWidth??o.width,height:o.naturalHeight??o.height}:{width:o.width,height:o.height}}function D(o){return typeof o=="symbol"?o.description??"":o}var z=class o{isHeadless=!1;isTouchDevice=!1;gl;glHelpers;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;vao=null;program=null;animationFrameId;eventListeners=new Map;frame=0;startTime=0;isPlaying=!1;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;resolutionObserver=null;hooks=new Map;historyDepth=0;textureOptions;debug;cursorTarget;intermediateFbo=null;constructor(t,{canvas:e,plugins:r,history:i,debug:s,cursorTarget:u,...a}={}){if(e&&"getContext"in e)this.canvas=e;else{let{width:f=1,height:p=1}=e||{};this.canvas=new OffscreenCanvas(f,p),this.isHeadless=!0}let n=this.canvas.getContext("webgl2",{antialias:!1});if(!n)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=n,this.glHelpers={typeToArray:new Map([[n.FLOAT,Float32Array],[n.HALF_FLOAT,Uint16Array],[n.UNSIGNED_SHORT,Uint16Array],[n.SHORT,Int16Array],[n.BYTE,Int8Array],[n.UNSIGNED_INT,Uint32Array],[n.INT,Int32Array]]),typeToInternalFormatString:new Map([[n.FLOAT,"RGBA32F"],[n.HALF_FLOAT,"RGBA16F"],[n.UNSIGNED_SHORT,"RGBA32UI"],[n.SHORT,"RGBA32I"],[n.BYTE,"RGBA32I"],[n.UNSIGNED_INT,"RGBA32UI"],[n.INT,"RGBA32I"]]),unsignedIntTypes:new Set([n.UNSIGNED_BYTE,n.UNSIGNED_SHORT,n.UNSIGNED_INT])};let m=B.get(this.canvas);m||(m={textureUnitPool:{free:[],next:0,max:n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},instances:new Set([this])},B.set(this.canvas,m)),this.textureUnitPool=m.textureUnitPool,m.instances.add(this),this.textureOptions=a,i&&(this.historyDepth=i),this.debug=s??(typeof process<"u"&&!1),this.cursorTarget=u??(this.canvas instanceof HTMLCanvasElement?this.canvas:void 0),this.animationFrameId=null;let d=[];r&&r.forEach(f=>f(this,{gl:n,canvas:this.canvas,injectGLSL:p=>{d.push(p)},emitHook:this.emitHook.bind(this)}));let c=this.gl.createProgram();if(!c)throw new Error("Failed to create WebGL program");this.program=c;let g=this.createShader(this.gl.VERTEX_SHADER,fe),x=this.createShader(n.FRAGMENT_SHADER,pe(t,d));if(n.attachShader(c,g),n.attachShader(c,x),n.bindAttribLocation(c,0,"a_position"),n.linkProgram(c),n.deleteShader(g),n.deleteShader(x),!n.getProgramParameter(c,n.LINK_STATUS))throw console.error("Program link error:",n.getProgramInfoLog(c)),n.deleteProgram(c),new Error("Failed to link WebGL program");if(this.vao=n.createVertexArray(),n.bindVertexArray(this.vao),this.buffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.buffer),n.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),n.STATIC_DRAW),n.enableVertexAttribArray(0),n.vertexAttribPointer(0,2,n.FLOAT,!1,0,0),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.useProgram(c),this.canvas instanceof HTMLCanvasElement)this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]});else{let f=p=>{let l=Object.getOwnPropertyDescriptor(OffscreenCanvas.prototype,p),E=this.canvas;Object.defineProperty(E,p,{get:()=>l.get.call(E),set:_=>{l.set.call(E,_);let b=B.get(E);if(b)for(let L of b.instances)L.updateResolution()},configurable:l.configurable,enumerable:l.enumerable})};f("width"),f("height")}this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this._initializeTexture(A,this.canvas,{...this.textureOptions}),this.intermediateFbo=n.createFramebuffer(),this.bindIntermediate(),n.bindFramebuffer(n.FRAMEBUFFER,null),this.historyDepth>0&&this._initializeTexture(k,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.cursorTarget&&this.addEventListeners(),this.emitHook("_init")}resolveGLConstant(t){let e=this.gl[t];if(e===void 0)throw new Error(`Unknown GL constant: ${t}`);return e}emitHook(t,...e){this.hooks.get(t)?.forEach(r=>r.call(this,...e))}on(t,e){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(e)}off(t,e){let r=this.hooks.get(t);r&&r.splice(r.indexOf(e),1)}createShader(t,e){let r=this.gl.createShader(t);if(this.gl.shaderSource(r,e),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",e),console.error(this.gl.getShaderInfoLog(r)),this.gl.deleteShader(r),new Error("Shader compilation failed");return r}getCursorTargetRect(){let t=this.cursorTarget;return t===window?{left:0,top:0,width:window.innerWidth,height:window.innerHeight}:t.getBoundingClientRect()}addEventListeners(){if(!this.cursorTarget)return;let t=(r,i)=>{if(!this.uniforms.has("u_cursor"))return;let s=this.getCursorTargetRect(),u=(r-s.left)/s.width,a=1-(i-s.top)/s.height;this.cursorPosition[0]=Math.max(0,Math.min(1,u)),this.cursorPosition[1]=Math.max(0,Math.min(1,a)),this.updateUniforms({u_cursor:this.cursorPosition})},e=(r,i,s)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=r,r){let u=this.getCursorTargetRect(),a=i,n=s;this.clickPosition[0]=Math.max(0,Math.min(1,(a-u.left)/u.width)),this.clickPosition[1]=Math.max(0,Math.min(1,1-(n-u.top)/u.height))}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",r=>{let i=r;this.isTouchDevice||t(i.clientX,i.clientY)}),this.eventListeners.set("mousedown",r=>{let i=r;this.isTouchDevice||i.button===0&&(this.isMouseDown=!0,e(!0,i.clientX,i.clientY))}),this.eventListeners.set("mouseup",r=>{let i=r;this.isTouchDevice||i.button===0&&e(!1)}),this.eventListeners.set("touchmove",r=>{let i=r;i.touches.length>0&&t(i.touches[0].clientX,i.touches[0].clientY)}),this.eventListeners.set("touchstart",r=>{let i=r;this.isTouchDevice=!0,i.touches.length>0&&(t(i.touches[0].clientX,i.touches[0].clientY),e(!0,i.touches[0].clientX,i.touches[0].clientY))}),this.eventListeners.set("touchend",r=>{r.touches.length===0&&e(!1)}),this.eventListeners.forEach((r,i)=>{this.cursorTarget.addEventListener(i,r)})}updateResolution(){let t=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...t),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:t}):this.initializeUniform("u_resolution","float",t),this.resizeTexture(A,...t),this.historyDepth>0&&this.resizeTexture(k,...t),this.emitHook("updateResolution",...t)}resizeTexture(t,e,r){let i=this.textures.get(t);if(!i||i.width===e&&i.height===r)return;this.gl.deleteTexture(i.texture),i.width=e,i.height=r;let{texture:s}=this.createTexture(t,i);i.texture=s,i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}reserveTextureUnit(t){let e=this.textures.get(t);if(e)return e.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}resolveTextureOptions(t){let{gl:e}=this,r=t?.internalFormat,i=t?.type??ge(r)??"UNSIGNED_BYTE",s=this.resolveGLConstant(i),u=r??this.glHelpers.typeToInternalFormatString.get(s)??"RGBA8",a=/^(R|RG|RGB|RGBA)(8|16|32)(UI|I)$/.test(u),n=t?.format??(a?"RGBA_INTEGER":"RGBA"),m={type:s,format:this.resolveGLConstant(n),internalFormat:this.resolveGLConstant(u),minFilter:this.resolveGLConstant(t?.minFilter??"LINEAR"),magFilter:this.resolveGLConstant(t?.magFilter??"LINEAR"),wrapS:this.resolveGLConstant(t?.wrapS??"CLAMP_TO_EDGE"),wrapT:this.resolveGLConstant(t?.wrapT??"CLAMP_TO_EDGE"),preserveY:t?.preserveY,isIntegerColorFormat:a};if((m.internalFormat===e.RGBA16F||m.internalFormat===e.RGBA32F)&&!e.getExtension("EXT_color_buffer_float"))throw new Error("Missing EXT_color_buffer_float.");return m}getPixelArray(t,e){let r=this.glHelpers.typeToArray.get(t)??Uint8Array;return new r(e)}isNotRgba(t){return t!==this.gl.RGBA&&t!==this.gl.RGBA_INTEGER}clearHistoryTextureLayers(t){if(!t.history)return;let e=this.gl,{type:r,format:i}=t.options,s=this.getPixelArray(r,t.width*t.height*4);e.activeTexture(e.TEXTURE0+t.unitIndex),e.bindTexture(e.TEXTURE_2D_ARRAY,t.texture);let u=this.isNotRgba(i),a;u&&(a=e.getParameter(e.UNPACK_ALIGNMENT),e.pixelStorei(e.UNPACK_ALIGNMENT,1));for(let n=0;n<t.history.depth;++n)e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,n,t.width,t.height,1,i,r,s);u&&e.pixelStorei(e.UNPACK_ALIGNMENT,a)}initializeUniform(t,e,r,i){let s=i?.arrayLength;if(this.uniforms.has(t))throw new Error(`${t} is already initialized.`);if(!V[e])throw new Error(`Invalid uniform type: ${e}. Expected one of: ${Object.keys(V).join(", ")}.`);if(s&&!(Array.isArray(r)&&r.length===s))throw new Error(`${t} array length mismatch: must initialize with ${s} elements.`);let u=this.gl.getUniformLocation(this.program,t);if(!u&&s&&(u=this.gl.getUniformLocation(this.program,`${t}[0]`)),!u){this.log(`${t} not in shader. Skipping initialization.`);return}let a=s?r[0]:r,n=Array.isArray(a)?a.length:1;this.uniforms.set(t,{type:e,length:n,location:u,arrayLength:s});try{this.updateUniforms({[t]:r})}catch(m){throw this.uniforms.delete(t),m}this.emitHook("initializeUniform",...arguments)}log(...t){this.debug&&console.debug(...t)}updateUniforms(t,e){this.gl.useProgram(this.program),Object.entries(t).forEach(([r,i])=>{let s=this.uniforms.get(r);if(!s){this.log(`${r} not in shader. Skipping update.`);return}let u=`uniform${s.length}${V[s.type]}`;if(s.arrayLength){if(!Array.isArray(i))throw new Error(`${r} is an array, but the value passed to updateUniforms is not an array.`);let a=i.length;if(!a)return;if(a>s.arrayLength)throw new Error(`${r} received ${a} values, but maximum length is ${s.arrayLength}.`);if(i.some(c=>(Array.isArray(c)?c.length:1)!==s.length))throw new Error(`Tried to update ${r} with some elements that are not length ${s.length}.`);let n=i.flat(),m=s.type==="float"?new Float32Array(n):s.type==="uint"?new Uint32Array(n):new Int32Array(n),d=s.location;if(e?.startIndex){let c=this.gl.getUniformLocation(this.program,`${r}[${e.startIndex}]`);if(!c)throw new Error(`${r}[${e.startIndex}] not in shader. Did you pass an invalid startIndex?`);d=c}this.gl[u+"v"](d,m)}else{if(Array.isArray(i)||(i=[i]),i.length!==s.length)throw new Error(`Invalid uniform value length: ${i.length}. Expected ${s.length}.`);this.gl[u](s.location,...i)}}),this.emitHook("updateUniforms",...arguments)}createTexture(t,e){let{width:r,height:i}=e,s=e.history?.depth??0,u=this.gl.createTexture();if(!u)throw new Error("Failed to create texture");let a=e.unitIndex;if(typeof a!="number")try{a=this.reserveTextureUnit(t)}catch(c){throw this.gl.deleteTexture(u),c}let n=s>0,m=n?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:d}=e;return this.gl.activeTexture(this.gl.TEXTURE0+a),this.gl.bindTexture(m,u),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_S,d.wrapS),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_T,d.wrapT),this.gl.texParameteri(m,this.gl.TEXTURE_MIN_FILTER,d.minFilter),this.gl.texParameteri(m,this.gl.TEXTURE_MAG_FILTER,d.magFilter),n?this.gl.texStorage3D(m,1,d.internalFormat,r,i,s):t===A&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,d.internalFormat,r,i,0,d.format,d.type,null),{texture:u,unitIndex:a}}_initializeTexture(t,e,r){if(this.textures.has(t))throw new Error(`Texture '${D(t)}' is already initialized.`);let{history:i=0,...s}=r??{},{width:u,height:a}=Q(e);if(!u||!a)throw new Error("Texture source must have valid dimensions");let n={width:u,height:a,options:e instanceof o&&Object.keys(s).length===0&&e.textures.has(A)?e.textures.get(A).options:this.resolveTextureOptions(s)};i>0&&(n.history={depth:i,writeIndex:0});let{texture:m,unitIndex:d}=this.createTexture(t,n),c={texture:m,unitIndex:d,...n};i>0&&(this.initializeUniform(`${D(t)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(c)),this.textures.set(t,c),t!==A&&t!==k&&this.updateTexture(t,e),this.gl.useProgram(this.program);let g=this.gl.getUniformLocation(this.program,D(t));g&&this.gl.uniform1i(g,d)}initializeTexture(t,e,r){let i=r?.history!=null&&r.history>0?{...r,history:r.history+1}:r;this._initializeTexture(t,e,i),this.emitHook("initializeTexture",...arguments)}updateTextures(t,e){Object.entries(t).forEach(([r,i])=>{this.updateTexture(r,i,e)}),this.emitHook("updateTextures",...arguments)}updateTexture(t,e,r){let i=this.textures.get(t);if(!i)throw new Error(`Texture '${D(t)}' is not initialized.`);if(e instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,e);return}let s=e;if(e instanceof o){let f=e.textures.get(A),p=f.width,l=f.height;if(e.gl===this.gl){if(!i.history){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,f.texture);return}let{depth:P}=i.history,O=r?.historyWriteIndex===void 0?[i.history.writeIndex]:Array.isArray(r?.historyWriteIndex)?r.historyWriteIndex.map(w=>M(w,P)):[M(r.historyWriteIndex,P)];this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,e.intermediateFbo),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture);for(let w of O)this.gl.copyTexSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,w,0,0,p,l);this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,null),this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture);let W=`${D(t)}FrameOffset`;this.updateUniforms({[W]:O[O.length-1]}),r?.historyWriteIndex===void 0&&(i.history.writeIndex=(i.history.writeIndex+1)%P);return}let{width:E,height:_,options:{format:b,type:L}}=f,C=this.getPixelArray(L,E*_*4);e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,e.intermediateFbo),e.gl.readPixels(0,0,E,_,b,L,C),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),s={data:C,width:E,height:_}}let{width:u,height:a}=Q(s);if(!u||!a)return;let n="isPartial"in s&&s.isPartial;n||this.resizeTexture(t,u,a);let m="data"in s&&s.data,d=!m&&!i.options?.preserveY,c=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL),g=m&&this.isNotRgba(i.options.format),x;if(g&&(x=this.gl.getParameter(this.gl.UNPACK_ALIGNMENT),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1)),i.history){if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture),!r?.skipHistoryWrite){let{depth:f}=i.history,p=r?.historyWriteIndex===void 0?[i.history.writeIndex]:Array.isArray(r.historyWriteIndex)?r.historyWriteIndex.map(_=>M(_,f)):[M(r.historyWriteIndex,f)];this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,d);let l=s.data??s;for(let _ of p)this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,_,u,a,1,i.options.format,i.options.type,l);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,c);let E=`${D(t)}FrameOffset`;this.updateUniforms({[E]:p[p.length-1]}),r?.historyWriteIndex===void 0&&(i.history.writeIndex=(i.history.writeIndex+1)%f)}}else{if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,i.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,d),n){let f=s;this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,f.x??0,f.y??0,u,a,i.options.format,i.options.type,f.data)}else this.gl.texImage2D(this.gl.TEXTURE_2D,0,i.options.internalFormat,u,a,0,i.options.format,i.options.type,s.data??s);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,c)}g&&this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,x)}bindIntermediate(){let t=this.gl,e=this.textures.get(A);t.bindFramebuffer(t.FRAMEBUFFER,this.intermediateFbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.texture,0)}clear(){this.bindIntermediate();let t=this.gl,e=this.textures.get(A);if(e.options.isIntegerColorFormat){let r=e.options.type;this.glHelpers.unsignedIntTypes.has(r)?t.clearBufferuiv(t.COLOR,0,new Uint32Array(4)):t.clearBufferiv(t.COLOR,0,new Int32Array(4))}else t.clear(t.COLOR_BUFFER_BIT)}draw(t){this.emitHook("beforeDraw",...arguments);let e=this.gl,r=e.drawingBufferWidth,i=e.drawingBufferHeight;t?.skipClear?this.bindIntermediate():this.clear(),e.useProgram(this.program),e.bindVertexArray(this.vao),e.viewport(0,0,r,i),e.drawArrays(e.TRIANGLES,0,3),this.isHeadless||this.textures.get(A).options.isIntegerColorFormat||(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.intermediateFbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.blitFramebuffer(0,0,r,i,0,0,r,i,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,null)),this.emitHook("afterDraw",...arguments)}step(t){this._step(performance.now()-this.startTime,t)}_step(t,e){this.emitHook("beforeStep",t,this.frame,e);let r={};this.uniforms.has("u_time")&&(r.u_time=t),this.uniforms.has("u_frame")&&(r.u_frame=this.frame),this.updateUniforms(r),this.draw(e);let i=this.textures.get(k);if(i&&!e?.skipHistoryWrite){let{writeIndex:s,depth:u}=i.history,a=this.gl;a.bindFramebuffer(a.READ_FRAMEBUFFER,this.intermediateFbo),a.bindTexture(a.TEXTURE_2D_ARRAY,i.texture),a.copyTexSubImage3D(a.TEXTURE_2D_ARRAY,0,0,0,s,0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.bindFramebuffer(a.READ_FRAMEBUFFER,null);let n=(s+1)%u;this.updateUniforms({[`${D(k)}FrameOffset`]:n}),i.history.writeIndex=n}++this.frame,this.emitHook("afterStep",t,this.frame,e)}play(t){this.pause(),this.isPlaying=!0;let e=r=>{r=(r-this.startTime)/1e3;let i=t?.(r,this.frame)??void 0;this._step(r,i),this.isPlaying&&(this.animationFrameId=requestAnimationFrame(e))};this.animationFrameId=requestAnimationFrame(e),this.emitHook("play")}_pause(){this.isPlaying=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}pause(){this._pause(),this.emitHook("pause")}resetFrame(){this.frame=0,this.startTime=performance.now()}reset(){this.resetFrame(),this.textures.forEach(t=>{t.history&&(t.history.writeIndex=0,this.clearHistoryTextureLayers(t))}),this.clear(),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this._pause(),this.cursorTarget&&(this.eventListeners.forEach((e,r)=>{this.cursorTarget.removeEventListener(r,e)}),this.eventListeners.clear()),this.resolutionObserver&&(this.resolutionObserver.disconnect(),this.resolutionObserver=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(e=>{this.textureUnitPool.free.push(e.unitIndex),this.gl.deleteTexture(e.texture)}),this.textures.clear();let t=B.get(this.canvas);t&&(t.instances.delete(this),t.instances.size===0&&B.delete(this.canvas)),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.uniforms.clear(),this.hooks.clear()}},ee=z;var te={data:new Uint8Array(4),width:1,height:1};function q(o){return o instanceof HTMLVideoElement||o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof OffscreenCanvas}function ie(o){return JSON.stringify(o,Object.keys(o).sort())}function U(o,t,e,r,i=0){let s=1/0,u=-1/0,a=1/0,n=-1/0,m=0,d=0;for(let c of e){let g=(i+t*r+c)*4,x=o[g],f=o[g+1];s=Math.min(s,x),u=Math.max(u,x),a=Math.min(a,f),n=Math.max(n,f),m+=o[g+2],d+=o[g+3]}return[(s+u)/2,(a+n)/2,m/e.length,d/e.length]}var j=null;function re(){return j||(j=import("@mediapipe/tasks-vision").then(({FilesetResolver:o})=>o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),j}function ne(o){return{historyParams:o?", framesAgo":"",fn:o?(r,i,s,u)=>{let a=s.replace(/\w+ /g,""),n=s?`${s}, int framesAgo`:"int framesAgo",m=a?`${a}, 0`:"0";return`${r} ${i}(${n}) {
${u}
}
${r} ${i}(${s}) { return ${i}(${m}); }`}:(r,i,s,u)=>`${r} ${i}(${s}) {
${u}
}`}}var S=33,Ee=6,R=S+Ee,h={LEFT_EYE:2,RIGHT_EYE:5,LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_HIP:23,RIGHT_HIP:24,LEFT_KNEE:25,RIGHT_KNEE:26,LEFT_WRIST:15,RIGHT_WRIST:16,LEFT_PINKY:17,RIGHT_PINKY:18,LEFT_INDEX:19,RIGHT_INDEX:20,LEFT_THUMB:21,RIGHT_THUMB:22,LEFT_ANKLE:27,RIGHT_ANKLE:28,LEFT_HEEL:29,RIGHT_HEEL:30,LEFT_FOOT_INDEX:31,RIGHT_FOOT_INDEX:32,BODY_CENTER:S,LEFT_HAND_CENTER:S+1,RIGHT_HAND_CENTER:S+2,LEFT_FOOT_CENTER:S+3,RIGHT_FOOT_CENTER:S+4,TORSO_CENTER:S+5},_e=Array.from({length:S},(o,t)=>t),xe=[h.LEFT_WRIST,h.LEFT_PINKY,h.LEFT_THUMB,h.LEFT_INDEX],Re=[h.RIGHT_WRIST,h.RIGHT_PINKY,h.RIGHT_THUMB,h.RIGHT_INDEX],ye=[h.LEFT_ANKLE,h.LEFT_HEEL,h.LEFT_FOOT_INDEX],be=[h.RIGHT_ANKLE,h.RIGHT_HEEL,h.RIGHT_FOOT_INDEX],Ie=[h.LEFT_SHOULDER,h.RIGHT_SHOULDER,h.LEFT_HIP,h.RIGHT_HIP],H=512,y=1,Le={modelPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",maxPoses:1,minPoseDetectionConfidence:.5,minPosePresenceConfidence:.5,minTrackingConfidence:.5},Ae=`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
uniform mediump sampler2D u_mask;
uniform float u_poseIndex;
void main() {
	ivec2 texCoord = ivec2(vec2(v_uv.x, 1.0 - v_uv.y) * vec2(textureSize(u_mask, 0)));
	float confidence = texelFetch(u_mask, texCoord, 0).r;
	if (confidence < 0.01) discard;
	outColor = vec4(1.0, confidence, u_poseIndex, 1.0);
}`,$=new Map;function Fe(o,t){let e=o.landmarks.data,r=t.length;e[0]=r;for(let i=0;i<r;++i){let s=t[i];for(let _=0;_<S;++_){let b=s[_],L=(y+i*R+_)*4;e[L]=b.x,e[L+1]=1-b.y,e[L+2]=b.z??0,e[L+3]=b.visibility??1}let u=U(e,i,_e,R,y),a=(y+i*R+h.BODY_CENTER)*4;e[a]=u[0],e[a+1]=u[1],e[a+2]=u[2],e[a+3]=u[3];let n=U(e,i,xe,R,y),m=(y+i*R+h.LEFT_HAND_CENTER)*4;e[m]=n[0],e[m+1]=n[1],e[m+2]=n[2],e[m+3]=n[3];let d=U(e,i,Re,R,y),c=(y+i*R+h.RIGHT_HAND_CENTER)*4;e[c]=d[0],e[c+1]=d[1],e[c+2]=d[2],e[c+3]=d[3];let g=U(e,i,ye,R,y),x=(y+i*R+h.LEFT_FOOT_CENTER)*4;e[x]=g[0],e[x+1]=g[1],e[x+2]=g[2],e[x+3]=g[3];let f=U(e,i,be,R,y),p=(y+i*R+h.RIGHT_FOOT_CENTER)*4;e[p]=f[0],e[p+1]=f[1],e[p+2]=f[2],e[p+3]=f[3];let l=U(e,i,Ie,R,y),E=(y+i*R+h.TORSO_CENTER)*4;e[E]=l[0],e[E+1]=l[1],e[E+2]=l[2],e[E+3]=l[3]}o.state.nPoses=r}function ve(o,t){let{maskShader:e,maxPoses:r}=o;if(!t||t.length===0)return e.clear();for(let i=0;i<t.length;++i){let s=t[i];e.updateTextures({u_mask:s.getAsWebGLTexture()}),e.updateUniforms({u_poseIndex:(i+1)/r}),e.step({skipClear:i>0}),s.close()}}function Se(o){let{textureName:t,options:{history:e,...r}={}}=o,i={...Le,...r},s=ie({...i,textureName:t}),u=i.maxPoses*R+y,a=Math.ceil(u/H);return function(n,m){let{injectGLSL:d,emitHook:c}=m,g=$.get(s),x=g?.landmarks.data??new Float32Array(H*a*4),f=g?.mediapipeCanvas??new OffscreenCanvas(1,1),p=g?.maskShader??(()=>{let T=new ee(Ae,{canvas:f});return T.initializeTexture("u_mask",te),T.initializeUniform("u_poseIndex","float",0),T})(),l=null,E=!1,_=!1;function b(T){if(!l)return;let{nPoses:I}=l.state,F=I*R+y,G=Math.ceil(F/H),N=T;typeof N>"u"&&O.length>0&&(N=O,O=[]),n.updateTextures({u_poseLandmarksTex:{data:l.landmarks.data,width:H,height:G,isPartial:!0},u_poseMask:p},e?{skipHistoryWrite:_,historyWriteIndex:N}:void 0),n.updateUniforms({u_nPoses:I}),c("pose:result",l.state.result)}async function L(){if($.has(s))l=$.get(s);else{let[T,{PoseLandmarker:I}]=await Promise.all([re(),import("@mediapipe/tasks-vision")]);if(E)return;let F=await I.createFromOptions(T,{baseOptions:{modelAssetPath:i.modelPath,delegate:"GPU"},canvas:f,runningMode:"VIDEO",numPoses:i.maxPoses,minPoseDetectionConfidence:i.minPoseDetectionConfidence,minPosePresenceConfidence:i.minPosePresenceConfidence,minTrackingConfidence:i.minTrackingConfidence,outputSegmentationMasks:!0});if(E){F.close(),p.destroy();return}l={landmarker:F,mediapipeCanvas:f,maskShader:p,subscribers:new Map,maxPoses:i.maxPoses,state:{nCalls:0,runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nPoses:0},landmarks:{data:x,textureHeight:a}},$.set(s,l)}l.subscribers.set(b,!1)}let C=L();n.on("_init",()=>{n.initializeUniform("u_maxPoses","int",i.maxPoses),n.initializeUniform("u_nPoses","int",0),n.initializeTexture("u_poseLandmarksTex",{data:x,width:H,height:a},{internalFormat:"RGBA32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST",history:e}),n.initializeTexture("u_poseMask",p,{minFilter:"NEAREST",magFilter:"NEAREST",history:e}),C.then(()=>{E||!l||c("pose:ready")})});let P=0,O=[],W=()=>{e&&(b(P),O.push(P),P=(P+1)%(e+1))};n.on("initializeTexture",(T,I)=>{T===t&&q(I)&&(W(),w(I))}),n.on("updateTextures",(T,I)=>{let F=T[t];q(F)&&(_=I?.skipHistoryWrite??!1,_||W(),w(F))});async function w(T){let I=performance.now();if(await C,!l)return;let F=++l.state.nCalls;l.state.pending=l.state.pending.then(async()=>{if(!l||F!==l.state.nCalls)return;let G=T instanceof HTMLVideoElement?"VIDEO":"IMAGE";l.state.runningMode!==G&&(l.state.runningMode=G,await l.landmarker.setOptions({runningMode:G}));let N=!1;if(T!==l.state.source?(l.state.source=T,l.state.videoTime=-1,N=!0):T instanceof HTMLVideoElement?T.currentTime!==l.state.videoTime&&(l.state.videoTime=T.currentTime,N=!0):T instanceof HTMLImageElement||I-l.state.resultTimestamp>2&&(N=!0),N){let v;if(T instanceof HTMLVideoElement){if(T.videoWidth===0||T.videoHeight===0||T.readyState<2)return;v=l.landmarker.detectForVideo(T,I)}else{if(T.width===0||T.height===0)return;v=l.landmarker.detect(T)}if(v){l.state.resultTimestamp=I,l.state.result=v,Fe(l,v.landmarks),ve(l,v.segmentationMasks);for(let X of l.subscribers.keys())X(),l.subscribers.set(X,!0)}}else if(l.state.result)for(let[v,X]of l.subscribers.entries())X||(v(),l.subscribers.set(v,!0))}),await l.state.pending}n.on("destroy",()=>{E=!0,l&&(l.subscribers.delete(b),l.subscribers.size===0&&(l.landmarker.close(),l.maskShader.destroy(),$.delete(s))),l=null});let{fn:Y,historyParams:se}=ne(e),oe=e?`int layer = (u_poseMaskFrameOffset - framesAgo + ${e+1}) % ${e+1};
	vec4 mask = texture(u_poseMask, vec3(pos, float(layer)));`:"vec4 mask = texture(u_poseMask, pos);";d(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform highp sampler2D${e?"Array":""} u_poseLandmarksTex;${e?`
uniform int u_poseLandmarksTexFrameOffset;`:""}
uniform ${e?"highp":"mediump"} sampler2D${e?"Array":""} u_poseMask;${e?`
uniform int u_poseMaskFrameOffset;`:""}

#define POSE_LANDMARK_LEFT_EYE ${h.LEFT_EYE}
#define POSE_LANDMARK_RIGHT_EYE ${h.RIGHT_EYE}
#define POSE_LANDMARK_LEFT_SHOULDER ${h.LEFT_SHOULDER}
#define POSE_LANDMARK_RIGHT_SHOULDER ${h.RIGHT_SHOULDER}
#define POSE_LANDMARK_LEFT_ELBOW ${h.LEFT_ELBOW}
#define POSE_LANDMARK_RIGHT_ELBOW ${h.RIGHT_ELBOW}
#define POSE_LANDMARK_LEFT_HIP ${h.LEFT_HIP}
#define POSE_LANDMARK_RIGHT_HIP ${h.RIGHT_HIP}
#define POSE_LANDMARK_LEFT_KNEE ${h.LEFT_KNEE}
#define POSE_LANDMARK_RIGHT_KNEE ${h.RIGHT_KNEE}
#define POSE_LANDMARK_BODY_CENTER ${h.BODY_CENTER}
#define POSE_LANDMARK_LEFT_HAND_CENTER ${h.LEFT_HAND_CENTER}
#define POSE_LANDMARK_RIGHT_HAND_CENTER ${h.RIGHT_HAND_CENTER}
#define POSE_LANDMARK_LEFT_FOOT_CENTER ${h.LEFT_FOOT_CENTER}
#define POSE_LANDMARK_RIGHT_FOOT_CENTER ${h.RIGHT_FOOT_CENTER}
#define POSE_LANDMARK_TORSO_CENTER ${h.TORSO_CENTER}

${Y("int","nPosesAt","",e?`
	int layer = (u_poseLandmarksTexFrameOffset - framesAgo + ${e+1}) % ${e+1};
	return int(texelFetch(u_poseLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_poseLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${Y("vec4","poseLandmark","int poseIndex, int landmarkIndex",`int i = ${y} + poseIndex * ${R} + landmarkIndex;
	int x = i % ${H};
	int y = i / ${H};${e?`
	int layer = (u_poseLandmarksTexFrameOffset - framesAgo + ${e+1}) % ${e+1};
	return texelFetch(u_poseLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_poseLandmarksTex, ivec2(x, y), 0);`}`)}
${Y("vec2","poseAt","vec2 pos",`${oe}
	float poseIndex = floor(mask.b * float(u_maxPoses) + 0.5) - 1.0;
	return vec2(mask.g, poseIndex);`)}
${Y("float","inPose","vec2 pos",`vec2 pose = poseAt(pos${se}); return step(0.0, pose.y) * pose.x;`)}`)}}var Pe=Se;
//# sourceMappingURL=pose.js.map