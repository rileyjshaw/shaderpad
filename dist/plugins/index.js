"use strict";var D=Object.create;var T=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var G=(o,c)=>{for(var a in c)T(o,a,{get:c[a],enumerable:!0})},S=(o,c,a,_)=>{if(c&&typeof c=="object"||typeof c=="function")for(let r of B(c))!U.call(o,r)&&r!==a&&T(o,r,{get:()=>c[r],enumerable:!(_=Y(c,r))||_.enumerable});return o};var w=(o,c,a)=>(a=o!=null?D(H(o)):{},S(c||!o||!o.__esModule?T(a,"default",{value:o,enumerable:!0}):a,o)),$=o=>S(T({},"__esModule",{value:!0}),o);var X={};G(X,{face:()=>V,helpers:()=>K,save:()=>W});module.exports=$(X);function W(){return function(o,c){let{gl:a,canvas:_}=c,r=document.createElement("a");o.save=async function(m){if(a.clear(a.COLOR_BUFFER_BIT),a.drawArrays(a.TRIANGLES,0,6),m&&!`${m}`.toLowerCase().endsWith(".png")&&(m=`${m}.png`),m=m||"export.png","ongesturechange"in window)try{let p=await new Promise(f=>_.toBlob(f,"image/png")),y=new File([p],m,{type:p.type});if(navigator.canShare?.({files:[y]})){await navigator.share({files:[y]});return}}catch(p){console.warn("Web Share API failed:",p)}else r.download=m,r.href=_.toDataURL(),r.click()}}}var d={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function V(o){let{textureName:c,options:a}=o,_="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(r,m){let{uniforms:p,injectGLSL:y}=m,f=null,b=null,L=-1,k=new Map,l=a?.maxFaces??1,I=512,N=512,u=document.createElement("canvas");u.width=I,u.height=N;let g=u.getContext("2d");g.globalCompositeOperation="lighten";async function O(){try{let{FilesetResolver:n,FaceLandmarker:i}=await import("@mediapipe/tasks-vision");b=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),f=await i.createFromOptions(b,{baseOptions:{modelAssetPath:a?.modelPath||_},runningMode:"VIDEO",numFaces:a?.maxFaces??1,minFaceDetectionConfidence:a?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:a?.minFacePresenceConfidence??.5,minTrackingConfidence:a?.minTrackingConfidence??.5,outputFaceBlendshapes:a?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:a?.outputFacialTransformationMatrixes??!1})}catch(n){throw console.error("Failed to initialize Face Landmarker:",n),n}}function A(n){let i=1/0,t=-1/0,s=1/0,e=-1/0;for(let F of n)i=Math.min(i,F.x),t=Math.max(t,F.x),s=Math.min(s,F.y),e=Math.max(e,F.y);let x=(i+t)/2,E=(s+e)/2;return[x,E]}function h(n,i){g.fillStyle=`rgb(${Math.round(i.r*255)}, ${Math.round(i.g*255)}, ${Math.round(i.b*255)})`;let t=n[0];g.beginPath(),g.moveTo(t.x*u.width,t.y*u.height);for(let s=1;s<n.length;s++){let e=n[s];g.lineTo(e.x*u.width,e.y*u.height)}g.closePath(),g.fill()}async function z(n){if(!f){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:i}=await import("@mediapipe/tasks-vision");g.clearRect(0,0,u.width,u.height),n.forEach((t,s)=>{h(d.OUTER_LIP.map(e=>t[e]),{r:.25,g:0,b:0}),h(d.INNER_LIP.map(e=>t[e]),{r:.75,g:0,b:0}),h(i.FACE_LANDMARKS_TESSELATION.map(({start:e})=>t[e]),{r:0,g:.25,b:0}),h(i.FACE_LANDMARKS_FACE_OVAL.map(({start:e})=>t[e]),{r:0,g:1,b:0}),h(d.LEFT_EYEBROW.map(e=>t[e]),{r:0,g:0,b:.15}),h(d.RIGHT_EYEBROW.map(e=>t[e]),{r:0,g:0,b:.35}),h(d.LEFT_EYE.map(e=>t[e]),{r:0,g:0,b:.65}),h(d.RIGHT_EYE.map(e=>t[e]),{r:0,g:0,b:.85})}),r.updateTextures({u_faceMask:u})}catch(i){console.error("[Face Plugin] Failed to generate mask texture:",i)}}function C(n){if(!n.faceLandmarks)return;let i=[],t=[],s=[],e=[];for(let E of n.faceLandmarks){let F=A(E),R=E[d.LEFT_EYE_CENTER],M=E[d.RIGHT_EYE_CENTER],P=E[d.NOSE_TIP];i.push([F[0],1-F[1]]),t.push([R.x,1-R.y]),s.push([M.x,1-M.y]),e.push([P.x,1-P.y])}z(n.faceLandmarks).catch(E=>{console.warn("Mask texture update error:",E)});let x={u_nFaces:n.faceLandmarks.length};n.faceLandmarks.length&&(p.has("u_faceCenter")&&(x.u_faceCenter=i),p.has("u_leftEye")&&(x.u_leftEye=t),p.has("u_rightEye")&&(x.u_rightEye=s),p.has("u_noseTip")&&(x.u_noseTip=e)),r.updateUniforms(x)}r.registerHook("init",async()=>{r.initializeTexture("u_faceMask",u),r.initializeUniform("u_maxFaces","int",l),r.initializeUniform("u_nFaces","int",0);let n=Array.from({length:l},()=>[.5,.5]);r.initializeUniform("u_faceCenter","float",n,{arrayLength:l}),r.initializeUniform("u_leftEye","float",n,{arrayLength:l}),r.initializeUniform("u_rightEye","float",n,{arrayLength:l}),r.initializeUniform("u_noseTip","float",n,{arrayLength:l}),await O()}),r.registerHook("updateTextures",n=>{Object.entries(n).forEach(([i,t])=>{if(i===c&&(k.set(i,t),!!f))try{if(t instanceof HTMLVideoElement){if(t.currentTime!==L){L=t.currentTime;let s=performance.now(),e=f.detectForVideo(t,s);C(e)}}else if(t instanceof HTMLImageElement){let s=f.detect(t);C(s)}}catch(s){console.warn("Face detection error:",s)}})}),r.registerHook("destroy",()=>{f&&(f.close(),f=null),b=null,k.clear(),u.remove()}),y(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceCenter[${l}];
uniform vec2 u_leftEye[${l}];
uniform vec2 u_rightEye[${l}];
uniform vec2 u_noseTip[${l}];
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var v=`float historyZ(highp sampler2DArray tex, int frameOffset, int framesAgo) {
	int historyDepth = textureSize(tex, 0).z;
	int z = (historyDepth + frameOffset - framesAgo) % historyDepth;
	return float(z);
}`;function K(){return function(o,c){c.injectGLSL(v)}}0&&(module.exports={face,helpers,save});
//# sourceMappingURL=index.js.map