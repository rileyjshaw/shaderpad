import{a as w}from"../chunk-EK64KAZ3.mjs";import"../chunk-LXQJ4NRK.mjs";import{a as I,b as C,c as D,e as F,f as P}from"../chunk-JRSBIGBN.mjs";var z={data:new Float32Array(1).fill(1),width:1,height:1},N={modelPath:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",outputConfidenceMasks:!1},V=`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
uniform sampler2D u_categoryMask;
uniform sampler2D u_confidenceMask;
uniform float u_maxCategoryIndex;

void main() {
	vec2 uv = vec2(v_uv.x, 1.0 - v_uv.y);
	float normalizedCategoryIndex = texture(u_categoryMask, uv).r * 255.0 / u_maxCategoryIndex;
	float confidence = texture(u_confidenceMask, uv).r;
	outColor = vec4(confidence, normalizedCategoryIndex, 0.0, 1.0);
}`,p=new Map;function G(S,u,n){let{outputConfidenceMasks:x,mask:{shader:c,confidence:s}}=S,{width:r,height:g}=u;if((s.width!==r||s.height!==g)&&(s.width=r,s.height=g,s.data=new Float32Array(r*g).fill(1)),x&&n?.length){let f=u.getAsUint8Array(),h=n.map(a=>a.getAsFloat32Array()),_=s.data;for(let a=0;a<f.length;++a){let e=f[a];_[a]=h[e][a]}}c.updateTextures({u_categoryMask:u.getAsWebGLTexture(),u_confidenceMask:s}),c.step(),u.close(),n?.forEach(f=>f.close())}function U(S){let{textureName:u,options:{history:n,...x}={}}=S,c={...N,...x},s=D({...c,textureName:u});return function(r,g){let{injectGLSL:f,emitHook:h}=g,a=p.get(s)?.mask.canvas??new OffscreenCanvas(1,1),e=null,M=!1,T=!1;function k(t){if(!e)return;let i=t;typeof i>"u"&&b.length>0&&(i=b,b=[]),r.updateTextures({u_segmentMask:e.mask.shader},n?{skipHistoryWrite:T,historyWriteIndex:i}:void 0),h("segmenter:result",e.state.result)}async function R(){if(p.has(s))e=p.get(s);else{let[t,{ImageSegmenter:i}]=await Promise.all([F(),import("@mediapipe/tasks-vision")]);if(M)return;let m=await i.createFromOptions(t,{baseOptions:{modelAssetPath:c.modelPath,delegate:"GPU"},canvas:a,runningMode:"VIDEO",outputCategoryMask:!0,outputConfidenceMasks:c.outputConfidenceMasks});if(M){m.close();return}let l=new w(V,{canvas:a});l.initializeTexture("u_categoryMask",I),l.initializeTexture("u_confidenceMask",z,{format:"RED",internalFormat:"R32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST"});let d=m.getLabels().length||1;l.initializeUniform("u_maxCategoryIndex","float",Math.max(1,d-1)),e={segmenter:m,outputConfidenceMasks:c.outputConfidenceMasks,subscribers:new Map,numCategories:d,state:{nCalls:0,runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve()},mask:{canvas:a,shader:l,confidence:{data:null,width:0,height:0}}},p.set(s,e)}e.subscribers.set(k,!1)}let E=R();r.on("_init",()=>{r.initializeUniform("u_numCategories","int",1),r.initializeTexture("u_segmentMask",a,{minFilter:"NEAREST",magFilter:"NEAREST",history:n}),E.then(()=>{M||!e||(r.updateUniforms({u_numCategories:e.numCategories}),h("segmenter:ready"))})});let y=0,b=[],A=()=>{n&&(k(y),b.push(y),y=(y+1)%(n+1))};r.on("initializeTexture",(t,i)=>{t===u&&C(i)&&(A(),O(i))}),r.on("updateTextures",(t,i)=>{let m=t[u];C(m)&&(T=i?.skipHistoryWrite??!1,T||A(),O(m))});async function O(t){let i=performance.now();if(await E,!e)return;let m=++e.state.nCalls;e.state.pending=e.state.pending.then(async()=>{if(!e||m!==e.state.nCalls)return;let l=t instanceof HTMLVideoElement?"VIDEO":"IMAGE";e.state.runningMode!==l&&(e.state.runningMode=l,await e.segmenter.setOptions({runningMode:l}));let d=!1;if(t!==e.state.source?(e.state.source=t,e.state.videoTime=-1,d=!0):t instanceof HTMLVideoElement?t.currentTime!==e.state.videoTime&&(e.state.videoTime=t.currentTime,d=!0):t instanceof HTMLImageElement||i-e.state.resultTimestamp>2&&(d=!0),d){let o;if(t instanceof HTMLVideoElement){if(t.videoWidth===0||t.videoHeight===0||t.readyState<2)return;o=e.segmenter.segmentForVideo(t,i)}else{if(t.width===0||t.height===0)return;o=e.segmenter.segment(t)}if(o){e.state.resultTimestamp=i,e.state.result=o,o.categoryMask&&G(e,o.categoryMask,o.confidenceMasks);for(let v of e.subscribers.keys())v(),e.subscribers.set(v,!0)}}else if(e.state.result){for(let[o,v]of e.subscribers.entries())v||(o(),e.subscribers.set(o,!0));e.subscribers.set(k,!0)}}),await e.state.pending}r.on("destroy",()=>{M=!0,e&&(e.subscribers.delete(k),e.subscribers.size===0&&(e.segmenter.close(),e.mask.shader.destroy(),p.delete(s))),e=null});let{fn:L}=P(n),H=n?`int layer = (u_segmentMaskFrameOffset - framesAgo + ${n+1}) % ${n+1};
	vec4 mask = texture(u_segmentMask, vec3(pos, float(layer)));`:"vec4 mask = texture(u_segmentMask, pos);";f(`
uniform ${n?"highp":"mediump"} sampler2D${n?"Array":""} u_segmentMask;${n?`
uniform int u_segmentMaskFrameOffset;`:""}
uniform int u_numCategories;

${L("vec2","segmentAt","vec2 pos",`${H}
	return vec2(mask.r, mask.g);`)}`)}}var B=U;export{B as default};
//# sourceMappingURL=segmenter.mjs.map