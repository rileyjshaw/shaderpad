import{a as w}from"../chunk-Q4CJO6XA.mjs";import"../chunk-LXQJ4NRK.mjs";import{a as I,b as T,c as D,e as F,f as P}from"../chunk-JRSBIGBN.mjs";var z={data:new Float32Array(1).fill(1),width:1,height:1},N={modelPath:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",outputConfidenceMasks:!1},V=`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
uniform sampler2D u_categoryMask;
uniform sampler2D u_confidenceMask;
uniform float u_maxCategoryIndex;

void main() {
	vec2 uv = vec2(v_uv.x, 1.0 - v_uv.y);
	float normalizedCategoryIndex = texture(u_categoryMask, uv).r * 255.0 / u_maxCategoryIndex;
	float confidence = texture(u_confidenceMask, uv).r;
	outColor = vec4(confidence, normalizedCategoryIndex, 0.0, 1.0);
}`,M=new Map;function G(S,a,i){let{numCategories:C,outputConfidenceMasks:d,mask:{shader:o,confidence:n}}=S,{width:p,height:h}=a;if((n.width!==p||n.height!==h)&&(n.width=p,n.height=h,n.data=new Float32Array(p*h).fill(1)),d&&i?.length){let l=a.getAsUint8Array(),_=i.map(e=>e.getAsFloat32Array()),f=n.data;for(let e=0;e<l.length;++e){let g=l[e];f[e]=_[g][e]}}o.updateTextures({u_categoryMask:a.getAsWebGLTexture(),u_confidenceMask:n}),o.step(),a.close(),i?.forEach(l=>l.close())}function U(S){let{textureName:a,options:{history:i,...C}={}}=S,d={...N,...C},o=D({...d,textureName:a});return function(n,p){let{injectGLSL:h,emitHook:l}=p,f=M.get(o)?.mask.canvas??new OffscreenCanvas(1,1),e=null,g=!1,x=!1;function k(t){if(!e)return;let s=t;typeof s>"u"&&b.length>0&&(s=b,b=[]),n.updateTextures({u_segmentMask:e.mask.shader},i?{skipHistoryWrite:x,historyWriteIndex:s}:void 0),l("segmenter:result",e.state.result)}async function R(){if(M.has(o))e=M.get(o);else{let[t,{ImageSegmenter:s}]=await Promise.all([F(),import("@mediapipe/tasks-vision")]);if(g)return;let u=await s.createFromOptions(t,{baseOptions:{modelAssetPath:d.modelPath,delegate:"GPU"},canvas:f,runningMode:"VIDEO",outputCategoryMask:!0,outputConfidenceMasks:d.outputConfidenceMasks});if(g){u.close();return}let m=new w(V,{canvas:f});m.initializeTexture("u_categoryMask",I),m.initializeTexture("u_confidenceMask",z,{format:"RED",internalFormat:"R32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST"});let c=u.getLabels().length||1;m.initializeUniform("u_maxCategoryIndex","float",Math.max(1,c-1)),e={segmenter:u,outputConfidenceMasks:d.outputConfidenceMasks,subscribers:new Map,numCategories:c,state:{nCalls:0,runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve()},mask:{canvas:f,shader:m,confidence:{data:null,width:0,height:0}}},M.set(o,e)}e.subscribers.set(k,!1)}let E=R();n.on("init",()=>{n.initializeUniform("u_numCategories","int",1),n.initializeTexture("u_segmentMask",f,{minFilter:"NEAREST",magFilter:"NEAREST",history:i}),E.then(()=>{g||!e||(n.updateUniforms({u_numCategories:e.numCategories}),l("segmenter:ready"))})});let y=0,b=[],A=()=>{i&&(k(y),b.push(y),y=(y+1)%(i+1))};n.on("initializeTexture",(t,s)=>{t===a&&T(s)&&(A(),O(s))}),n.on("updateTextures",(t,s)=>{let u=t[a];T(u)&&(x=s?.skipHistoryWrite??!1,x||A(),O(u))});async function O(t){let s=performance.now();if(await E,!e)return;let u=++e.state.nCalls;e.state.pending=e.state.pending.then(async()=>{if(!e||u!==e.state.nCalls)return;let m=t instanceof HTMLVideoElement?"VIDEO":"IMAGE";e.state.runningMode!==m&&(e.state.runningMode=m,await e.segmenter.setOptions({runningMode:m}));let c=!1;if(t!==e.state.source?(e.state.source=t,e.state.videoTime=-1,c=!0):t instanceof HTMLVideoElement?t.currentTime!==e.state.videoTime&&(e.state.videoTime=t.currentTime,c=!0):t instanceof HTMLImageElement||s-e.state.resultTimestamp>2&&(c=!0),c){let r;if(t instanceof HTMLVideoElement){if(t.videoWidth===0||t.videoHeight===0||t.readyState<2)return;r=e.segmenter.segmentForVideo(t,s)}else{if(t.width===0||t.height===0)return;r=e.segmenter.segment(t)}if(r){e.state.resultTimestamp=s,e.state.result=r,r.categoryMask&&G(e,r.categoryMask,r.confidenceMasks);for(let v of e.subscribers.keys())v(),e.subscribers.set(v,!0)}}else if(e.state.result){for(let[r,v]of e.subscribers.entries())v||(r(),e.subscribers.set(r,!0));e.subscribers.set(k,!0)}}),await e.state.pending}n.on("destroy",()=>{g=!0,e&&(e.subscribers.delete(k),e.subscribers.size===0&&(e.segmenter.close(),e.mask.shader.destroy(),M.delete(o))),e=null});let{fn:L}=P(i),H=i?`int layer = (u_segmentMaskFrameOffset - framesAgo + ${i+1}) % ${i+1};
	vec4 mask = texture(u_segmentMask, vec3(pos, float(layer)));`:"vec4 mask = texture(u_segmentMask, pos);";h(`
uniform ${i?"highp":"mediump"} sampler2D${i?"Array":""} u_segmentMask;${i?`
uniform int u_segmentMaskFrameOffset;`:""}
uniform int u_numCategories;

${L("vec2","segmentAt","vec2 pos",`${H}
	return vec2(mask.r, mask.g);`)}`)}}var B=U;export{B as default};
//# sourceMappingURL=segmenter.mjs.map