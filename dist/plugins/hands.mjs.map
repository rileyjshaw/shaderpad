{"version":3,"sources":["../../src/plugins/hands.ts"],"sourcesContent":["import ShaderPad, { PluginContext, TextureSource } from '../index';\nimport type { HandLandmarker, NormalizedLandmark } from '@mediapipe/tasks-vision';\n\nexport interface HandsPluginOptions {\n\tmodelPath?: string;\n\tmaxHands?: number;\n\tminHandDetectionConfidence?: number;\n\tminHandPresenceConfidence?: number;\n\tminTrackingConfidence?: number;\n}\n\nconst LANDMARK_COUNT = 21 + 1; // See https://ai.google.dev/edge/mediapipe/solutions/vision/hand_landmarker#models, plus the hand center.\nconst HAND_CENTER_LANDMARKS = [0, 0, 5, 9, 13, 17]; // Wrist + MCP joints of all fingers, weighted toward the wrist.\n\nfunction hands(config: { textureName: string; options?: HandsPluginOptions }) {\n\tconst { textureName, options } = config;\n\tconst defaultModelPath =\n\t\t'https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task';\n\n\treturn function (shaderPad: ShaderPad, context: PluginContext) {\n\t\tconst { injectGLSL } = context;\n\n\t\tlet handLandmarker: HandLandmarker | null = null;\n\t\tlet vision: any = null;\n\t\tlet lastVideoTime = -1;\n\t\tconst textureSources = new Map<string, TextureSource>();\n\t\tconst maxHands = options?.maxHands ?? 2;\n\n\t\tasync function initializeHandLandmarker() {\n\t\t\ttry {\n\t\t\t\tconst { FilesetResolver, HandLandmarker } = await import('@mediapipe/tasks-vision');\n\t\t\t\tvision = await FilesetResolver.forVisionTasks(\n\t\t\t\t\t'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm'\n\t\t\t\t);\n\n\t\t\t\thandLandmarker = await HandLandmarker.createFromOptions(vision, {\n\t\t\t\t\tbaseOptions: {\n\t\t\t\t\t\tmodelAssetPath: options?.modelPath || defaultModelPath,\n\t\t\t\t\t},\n\t\t\t\t\trunningMode: 'VIDEO',\n\t\t\t\t\tnumHands: options?.maxHands ?? 2,\n\t\t\t\t\tminHandDetectionConfidence: options?.minHandDetectionConfidence ?? 0.5,\n\t\t\t\t\tminHandPresenceConfidence: options?.minHandPresenceConfidence ?? 0.5,\n\t\t\t\t\tminTrackingConfidence: options?.minTrackingConfidence ?? 0.5,\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('Failed to initialize Hand Landmarker:', error);\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\n\t\tfunction calculateHandCenter(landmarks: NormalizedLandmark[]): [number, number] {\n\t\t\tconst visibleLandmarks = HAND_CENTER_LANDMARKS.map(index => landmarks[index]).filter(\n\t\t\t\tlandmark => landmark && typeof landmark.x === 'number' && typeof landmark.y === 'number'\n\t\t\t);\n\t\t\tif (visibleLandmarks.length === 0) return [0, 0];\n\n\t\t\tlet sumX = 0,\n\t\t\t\tsumY = 0;\n\t\t\tfor (const landmark of visibleLandmarks) {\n\t\t\t\tsumX += landmark.x;\n\t\t\t\tsumY += landmark.y;\n\t\t\t}\n\t\t\treturn [sumX / visibleLandmarks.length, sumY / visibleLandmarks.length];\n\t\t}\n\n\t\tfunction processHandResults(result: any) {\n\t\t\tif (!result.landmarks) return;\n\n\t\t\tconst nHands = result.landmarks.length;\n\t\t\tconst updates: Parameters<typeof shaderPad.updateUniforms>[0] = { u_nHands: nHands };\n\t\t\tif (nHands) {\n\t\t\t\tupdates.u_handLandmarks = result.landmarks.flatMap((landmarks: NormalizedLandmark[]) => {\n\t\t\t\t\tconst handCenter = calculateHandCenter(landmarks);\n\t\t\t\t\thandCenter[1] = 1.0 - handCenter[1];\n\t\t\t\t\treturn landmarks.map(landmark => [landmark.x, 1.0 - landmark.y]).concat([handCenter]);\n\t\t\t\t});\n\t\t\t}\n\t\t\tshaderPad.updateUniforms(updates);\n\t\t}\n\n\t\tshaderPad.registerHook('init', async () => {\n\t\t\tshaderPad.initializeUniform('u_maxHands', 'int', maxHands);\n\t\t\tshaderPad.initializeUniform('u_nHands', 'int', 0);\n\t\t\tconst defaultHandLandmarks: [number, number][] = Array.from({ length: maxHands * LANDMARK_COUNT }, () => [\n\t\t\t\t0.5, 0.5,\n\t\t\t]);\n\t\t\tshaderPad.initializeUniform('u_handLandmarks', 'float', defaultHandLandmarks, {\n\t\t\t\tarrayLength: maxHands * LANDMARK_COUNT,\n\t\t\t});\n\t\t\tawait initializeHandLandmarker();\n\t\t});\n\n\t\tshaderPad.registerHook('updateTextures', (updates: Record<string, TextureSource>) => {\n\t\t\tObject.entries(updates).forEach(([name, source]) => {\n\t\t\t\tif (name !== textureName) return;\n\t\t\t\ttextureSources.set(name, source);\n\t\t\t\tif (!handLandmarker) return;\n\t\t\t\ttry {\n\t\t\t\t\tif (source instanceof HTMLVideoElement) {\n\t\t\t\t\t\tif (source.currentTime !== lastVideoTime) {\n\t\t\t\t\t\t\tlastVideoTime = source.currentTime;\n\t\t\t\t\t\t\tconst timestamp = performance.now();\n\t\t\t\t\t\t\tconst result = handLandmarker.detectForVideo(source, timestamp);\n\t\t\t\t\t\t\tprocessHandResults(result);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (source instanceof HTMLImageElement) {\n\t\t\t\t\t\tconst result = handLandmarker.detect(source);\n\t\t\t\t\t\tprocessHandResults(result);\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.warn('Hand detection error:', error);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tshaderPad.registerHook('destroy', () => {\n\t\t\tif (handLandmarker) {\n\t\t\t\thandLandmarker.close();\n\t\t\t\thandLandmarker = null;\n\t\t\t}\n\t\t\tvision = null;\n\t\t\ttextureSources.clear();\n\t\t});\n\n\t\tinjectGLSL(`\nuniform int u_maxHands;\nuniform int u_nHands;\nuniform vec2 u_handLandmarks[${maxHands * LANDMARK_COUNT}];\nvec2 handLandmark(int handIndex, int landmarkIndex) {\n\treturn u_handLandmarks[handIndex * ${LANDMARK_COUNT} + landmarkIndex];\n}`);\n\t};\n}\n\nexport default hands;\n"],"mappings":"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","names":["LANDMARK_COUNT","HAND_CENTER_LANDMARKS","hands","config","textureName","options","defaultModelPath","shaderPad","context","injectGLSL","handLandmarker","vision","lastVideoTime","textureSources","maxHands","initializeHandLandmarker","FilesetResolver","HandLandmarker","error","calculateHandCenter","landmarks","visibleLandmarks","index","landmark","sumX","sumY","processHandResults","result","nHands","updates","handCenter","defaultHandLandmarks","name","source","timestamp","hands_default"]}