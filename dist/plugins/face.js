"use strict";var D=Object.create;var T=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var W=(c,s)=>{for(var r in s)T(c,r,{get:s[r],enumerable:!0})},v=(c,s,r,d)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of $(s))!V.call(c,a)&&a!==r&&T(c,a,{get:()=>s[a],enumerable:!(d=B(s,a))||d.enumerable});return c};var S=(c,s,r)=>(r=c!=null?D(G(c)):{},v(s||!c||!c.__esModule?T(r,"default",{value:c,enumerable:!0}):r,c)),K=c=>v(T({},"__esModule",{value:!0}),c);var q={};W(q,{default:()=>j});module.exports=K(q);var l={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function X(c){let{textureName:s,options:r}=c,d="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(a,w){let{uniforms:_,injectGLSL:O}=w,p=null,b=null,L=-1,y=new Map,u=r?.maxFaces??1,Y=512,z=512,m=document.createElement("canvas");m.width=Y,m.height=z;let E=m.getContext("2d");E.globalCompositeOperation="lighten";async function H(){try{let{FilesetResolver:t,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");b=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),p=await e.createFromOptions(b,{baseOptions:{modelAssetPath:r?.modelPath||d},runningMode:"VIDEO",numFaces:r?.maxFaces??1,minFaceDetectionConfidence:r?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:r?.minFacePresenceConfidence??.5,minTrackingConfidence:r?.minTrackingConfidence??.5,outputFaceBlendshapes:r?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:r?.outputFacialTransformationMatrixes??!1})}catch(t){throw console.error("Failed to initialize Face Landmarker:",t),t}}function x(t){let e=1/0,i=-1/0,o=1/0,n=-1/0;for(let f of t)e=Math.min(e,f.x),i=Math.max(i,f.x),o=Math.min(o,f.y),n=Math.max(n,f.y);let F=(e+i)/2,h=(o+n)/2;return[F,h]}function g(t,e){E.fillStyle=`rgb(${Math.round(e.r*255)}, ${Math.round(e.g*255)}, ${Math.round(e.b*255)})`;let i=t[0];E.beginPath(),E.moveTo(i.x*m.width,i.y*m.height);for(let o=1;o<t.length;o++){let n=t[o];E.lineTo(n.x*m.width,n.y*m.height)}E.closePath(),E.fill()}async function P(t){if(!p){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");E.clearRect(0,0,m.width,m.height),t.forEach((i,o)=>{g(l.OUTER_LIP.map(n=>i[n]),{r:.25,g:0,b:0}),g(l.INNER_LIP.map(n=>i[n]),{r:.75,g:0,b:0}),g(e.FACE_LANDMARKS_TESSELATION.map(({start:n})=>i[n]),{r:0,g:.25,b:0}),g(e.FACE_LANDMARKS_FACE_OVAL.map(({start:n})=>i[n]),{r:0,g:1,b:0}),g(l.LEFT_EYEBROW.map(n=>i[n]),{r:0,g:0,b:.15}),g(l.RIGHT_EYEBROW.map(n=>i[n]),{r:0,g:0,b:.35}),g(l.LEFT_EYE.map(n=>i[n]),{r:0,g:0,b:.65}),g(l.RIGHT_EYE.map(n=>i[n]),{r:0,g:0,b:.85})}),a.updateTextures({u_faceMask:m})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function k(t){if(!t.faceLandmarks)return;let e=[],i=[],o=[],n=[],F=[];for(let f of t.faceLandmarks){let C=x(f),M=f[l.LEFT_EYE_CENTER],R=f[l.RIGHT_EYE_CENTER],I=f[l.NOSE_TIP],A=l.INNER_LIP.map(U=>f[U]),N=x(A);e.push([C[0],1-C[1]]),i.push([M.x,1-M.y]),o.push([R.x,1-R.y]),n.push([I.x,1-I.y]),F.push([N[0],1-N[1]])}P(t.faceLandmarks).catch(f=>{console.warn("Mask texture update error:",f)});let h={u_nFaces:t.faceLandmarks.length};t.faceLandmarks.length&&(_.has("u_faceCenter")&&(h.u_faceCenter=e),_.has("u_leftEye")&&(h.u_leftEye=i),_.has("u_rightEye")&&(h.u_rightEye=o),_.has("u_noseTip")&&(h.u_noseTip=n),_.has("u_mouth")&&(h.u_mouth=F)),a.updateUniforms(h)}a.registerHook("init",async()=>{a.initializeTexture("u_faceMask",m),a.initializeUniform("u_maxFaces","int",u),a.initializeUniform("u_nFaces","int",0);let t=Array.from({length:u},()=>[.5,.5]);a.initializeUniform("u_faceCenter","float",t,{arrayLength:u}),a.initializeUniform("u_leftEye","float",t,{arrayLength:u}),a.initializeUniform("u_rightEye","float",t,{arrayLength:u}),a.initializeUniform("u_noseTip","float",t,{arrayLength:u}),a.initializeUniform("u_mouth","float",t,{arrayLength:u}),await H()}),a.registerHook("updateTextures",t=>{let e=t[s];if(!(!e||(y.get(s)!==e&&(L=-1),y.set(s,e),!p)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==L){L=e.currentTime;let o=performance.now(),n=p.detectForVideo(e,o);k(n)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let o=p.detect(e);k(o)}}catch(o){console.warn("Face detection error:",o)}}),a.registerHook("destroy",()=>{p&&(p.close(),p=null),b=null,y.clear(),m.remove()}),O(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceCenter[${u}];
uniform vec2 u_leftEye[${u}];
uniform vec2 u_rightEye[${u}];
uniform vec2 u_noseTip[${u}];
uniform vec2 u_mouth[${u}];
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var j=X;
//# sourceMappingURL=face.js.map