"use strict";var Z=Object.create;var b=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var te=(c,u)=>{for(var r in u)b(c,r,{get:u[r],enumerable:!0})},U=(c,u,r,k)=>{if(u&&typeof u=="object"||typeof u=="function")for(let s of J(u))!ee.call(c,s)&&s!==r&&b(c,s,{get:()=>u[s],enumerable:!(k=q(u,s))||k.enumerable});return c};var K=(c,u,r)=>(r=c!=null?Z(Q(c)):{},U(u||!c||!c.__esModule?b(r,"default",{value:c,enumerable:!0}):r,c)),ne=c=>U(b({},"__esModule",{value:!0}),c);var oe={};te(oe,{default:()=>ie});module.exports=ne(oe);var M=478,ae=2,_=M+ae,l={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95],FACE_CENTER:M,MOUTH_CENTER:M+1};function re(c){let{textureName:u,options:r}=c,k="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(s,V){let{injectGLSL:$,gl:A}=V,E=null,O=null,y=-1,N="VIDEO",S=new Map,D=r?.maxFaces??1,L=512,v=0,t=null,z=512,B=512,m=document.createElement("canvas");m.width=z,m.height=B;let F=m.getContext("2d");F.globalCompositeOperation="lighten";async function G(){try{let{FilesetResolver:n,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");O=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),E=await e.createFromOptions(O,{baseOptions:{modelAssetPath:r?.modelPath||k},runningMode:N,numFaces:r?.maxFaces??1,minFaceDetectionConfidence:r?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:r?.minFacePresenceConfidence??.5,minTrackingConfidence:r?.minTrackingConfidence??.5,outputFaceBlendshapes:r?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:r?.outputFacialTransformationMatrixes??!1})}catch(n){throw console.error("Failed to initialize Face Landmarker:",n),n}}function w(n,e,a){let o=1/0,i=-1/0,T=1/0,d=-1/0,f=0,R=0;for(let j of a){let I=(e*_+j)*4,Y=n[I],P=n[I+1];o=Math.min(o,Y),i=Math.max(i,Y),T=Math.min(T,P),d=Math.max(d,P),f+=n[I+2],R+=n[I+3]}let p=(o+i)/2,h=(T+d)/2,x=f/a.length,C=R/a.length;return[p,h,x,C]}function g(n,e,a){if(!t)return;F.fillStyle=`rgb(${Math.round(a.r*255)}, ${Math.round(a.g*255)}, ${Math.round(a.b*255)})`,F.beginPath();let o=(n*_+e[0])*4,i=t[o],T=t[o+1];F.moveTo(i*m.width,T*m.height);for(let d=1;d<e.length;++d){let f=(n*_+e[d])*4,R=t[f],p=t[f+1];F.lineTo(R*m.width,p*m.height)}F.closePath(),F.fill()}async function W(n){if(!E||!t){console.warn("[Face Plugin] Cannot update mask: faceLandmarker or landmarksDataArray missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");F.clearRect(0,0,m.width,m.height);for(let a=0;a<n;++a)g(a,l.OUTER_LIP,{r:.25,g:0,b:0}),g(a,l.INNER_LIP,{r:.75,g:0,b:0}),g(a,e.FACE_LANDMARKS_TESSELATION.map(({start:o})=>o),{r:0,g:.25,b:0}),g(a,e.FACE_LANDMARKS_FACE_OVAL.map(({start:o})=>o),{r:0,g:1,b:0}),g(a,l.LEFT_EYEBROW,{r:0,g:0,b:.15}),g(a,l.RIGHT_EYEBROW,{r:0,g:0,b:.35}),g(a,l.LEFT_EYE,{r:0,g:0,b:.65}),g(a,l.RIGHT_EYE,{r:0,g:0,b:.85});s.updateTextures({u_faceMask:m})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function X(n){if(!t)return;let e=n.length,a=e*_;for(let i=0;i<e;++i){let T=n[i];for(let h=0;h<M;++h){let x=T[h],C=(i*_+h)*4;t[C]=x.x,t[C+1]=1-x.y,t[C+2]=x.z??0,t[C+3]=x.visibility??1}let d=w(t,i,Array.from({length:M},(h,x)=>x)),f=(i*_+l.FACE_CENTER)*4;t[f]=d[0],t[f+1]=d[1],t[f+2]=0,t[f+3]=1;let R=w(t,i,l.INNER_LIP),p=(i*_+l.MOUTH_CENTER)*4;t[p]=R[0],t[p+1]=R[1],t[p+2]=0,t[p+3]=1}let o=Math.ceil(a/L);s.updateTextures({u_faceLandmarksTex:{data:t,width:L,height:o}})}function H(n){if(!n.faceLandmarks||!t)return;let e=n.faceLandmarks.length;X(n.faceLandmarks),W(e).catch(a=>{console.warn("Mask texture update error:",a)}),s.updateUniforms({u_nFaces:e}),r?.onResults?.(n)}s.registerHook("init",async()=>{s.initializeTexture("u_faceMask",m,{preserveY:!0}),s.initializeUniform("u_maxFaces","int",D),s.initializeUniform("u_nFaces","int",0);let n=D*_;v=Math.ceil(n/L);let e=L*v*4;t=new Float32Array(e),s.initializeTexture("u_faceLandmarksTex",{data:t,width:L,height:v},{internalFormat:A.RGBA32F,type:A.FLOAT,minFilter:A.NEAREST,magFilter:A.NEAREST}),await G()}),s.registerHook("updateTextures",async n=>{let e=n[u];if(!(!e||(S.get(u)!==e&&(y=-1),S.set(u,e),!E)))try{let o=e instanceof HTMLVideoElement?"VIDEO":"IMAGE";if(N!==o&&(N=o,await E.setOptions({runningMode:N})),e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==y){y=e.currentTime;let i=performance.now(),T=E.detectForVideo(e,i);H(T)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let i=E.detect(e);H(i)}}catch(o){console.warn("Face detection error:",o)}}),s.registerHook("destroy",()=>{E&&(E.close(),E=null),O=null,S.clear(),m.remove(),t=null}),$(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform sampler2D u_faceLandmarksTex;
uniform sampler2D u_faceMask;

#define FACE_LANDMARK_L_EYE_CENTER ${l.LEFT_EYE_CENTER}
#define FACE_LANDMARK_R_EYE_CENTER ${l.RIGHT_EYE_CENTER}
#define FACE_LANDMARK_NOSE_TIP ${l.NOSE_TIP}
#define FACE_LANDMARK_FACE_CENTER ${l.FACE_CENTER}
#define FACE_LANDMARK_MOUTH_CENTER ${l.MOUTH_CENTER}

vec4 faceLandmark(int faceIndex, int landmarkIndex) {
	int i = faceIndex * ${_} + landmarkIndex;
	int x = i % ${L};
	int y = i / ${L};
	return texelFetch(u_faceLandmarksTex, ivec2(x, y), 0);
}
float inFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float inEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float inMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var ie=re;
//# sourceMappingURL=face.js.map