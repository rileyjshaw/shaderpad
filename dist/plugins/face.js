"use strict";var P=Object.create;var T=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var B=(c,s)=>{for(var r in s)T(c,r,{get:s[r],enumerable:!0})},R=(c,s,r,_)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of A(s))!U.call(c,i)&&i!==r&&T(c,i,{get:()=>s[i],enumerable:!(_=z(s,i))||_.enumerable});return c};var I=(c,s,r)=>(r=c!=null?P(D(c)):{},R(s||!c||!c.__esModule?T(r,"default",{value:c,enumerable:!0}):r,c)),G=c=>R(T({},"__esModule",{value:!0}),c);var W={};B(W,{default:()=>V});module.exports=G(W);var f={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function $(c){let{textureName:s,options:r}=c,_="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(i,v){let{uniforms:F,injectGLSL:N}=v,l=null,b=null,y=-1,x=new Map,m=r?.maxFaces??1,S=512,w=512,u=document.createElement("canvas");u.width=S,u.height=w;let p=u.getContext("2d");p.globalCompositeOperation="lighten";async function O(){try{let{FilesetResolver:n,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");b=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),l=await e.createFromOptions(b,{baseOptions:{modelAssetPath:r?.modelPath||_},runningMode:"VIDEO",numFaces:r?.maxFaces??1,minFaceDetectionConfidence:r?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:r?.minFacePresenceConfidence??.5,minTrackingConfidence:r?.minTrackingConfidence??.5,outputFaceBlendshapes:r?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:r?.outputFacialTransformationMatrixes??!1})}catch(n){throw console.error("Failed to initialize Face Landmarker:",n),n}}function Y(n){let e=1/0,a=-1/0,o=1/0,t=-1/0;for(let h of n)e=Math.min(e,h.x),a=Math.max(a,h.x),o=Math.min(o,h.y),t=Math.max(t,h.y);let d=(e+a)/2,g=(o+t)/2;return[d,g]}function E(n,e){p.fillStyle=`rgb(${Math.round(e.r*255)}, ${Math.round(e.g*255)}, ${Math.round(e.b*255)})`;let a=n[0];p.beginPath(),p.moveTo(a.x*u.width,a.y*u.height);for(let o=1;o<n.length;o++){let t=n[o];p.lineTo(t.x*u.width,t.y*u.height)}p.closePath(),p.fill()}async function H(n){if(!l){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");p.clearRect(0,0,u.width,u.height),n.forEach((a,o)=>{E(f.OUTER_LIP.map(t=>a[t]),{r:.25,g:0,b:0}),E(f.INNER_LIP.map(t=>a[t]),{r:.75,g:0,b:0}),E(e.FACE_LANDMARKS_TESSELATION.map(({start:t})=>a[t]),{r:0,g:.25,b:0}),E(e.FACE_LANDMARKS_FACE_OVAL.map(({start:t})=>a[t]),{r:0,g:1,b:0}),E(f.LEFT_EYEBROW.map(t=>a[t]),{r:0,g:0,b:.15}),E(f.RIGHT_EYEBROW.map(t=>a[t]),{r:0,g:0,b:.35}),E(f.LEFT_EYE.map(t=>a[t]),{r:0,g:0,b:.65}),E(f.RIGHT_EYE.map(t=>a[t]),{r:0,g:0,b:.85})}),i.updateTextures({u_faceMask:u})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function L(n){if(!n.faceLandmarks)return;let e=[],a=[],o=[],t=[];for(let g of n.faceLandmarks){let h=Y(g),k=g[f.LEFT_EYE_CENTER],C=g[f.RIGHT_EYE_CENTER],M=g[f.NOSE_TIP];e.push([h[0],1-h[1]]),a.push([k.x,1-k.y]),o.push([C.x,1-C.y]),t.push([M.x,1-M.y])}H(n.faceLandmarks).catch(g=>{console.warn("Mask texture update error:",g)});let d={u_nFaces:n.faceLandmarks.length};n.faceLandmarks.length&&(F.has("u_faceCenter")&&(d.u_faceCenter=e),F.has("u_leftEye")&&(d.u_leftEye=a),F.has("u_rightEye")&&(d.u_rightEye=o),F.has("u_noseTip")&&(d.u_noseTip=t)),i.updateUniforms(d)}i.registerHook("init",async()=>{i.initializeTexture("u_faceMask",u),i.initializeUniform("u_maxFaces","int",m),i.initializeUniform("u_nFaces","int",0);let n=Array.from({length:m},()=>[.5,.5]);i.initializeUniform("u_faceCenter","float",n,{arrayLength:m}),i.initializeUniform("u_leftEye","float",n,{arrayLength:m}),i.initializeUniform("u_rightEye","float",n,{arrayLength:m}),i.initializeUniform("u_noseTip","float",n,{arrayLength:m}),await O()}),i.registerHook("updateTextures",n=>{let e=n[s];if(!(!e||(x.get(s)!==e&&(y=-1),x.set(s,e),!l)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==y){y=e.currentTime;let o=performance.now(),t=l.detectForVideo(e,o);L(t)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let o=l.detect(e);L(o)}}catch(o){console.warn("Face detection error:",o)}}),i.registerHook("destroy",()=>{l&&(l.close(),l=null),b=null,x.clear(),u.remove()}),N(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceCenter[${m}];
uniform vec2 u_leftEye[${m}];
uniform vec2 u_rightEye[${m}];
uniform vec2 u_noseTip[${m}];
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var V=$;
//# sourceMappingURL=face.js.map