"use strict";var z=Object.create;var T=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var B=(c,s)=>{for(var r in s)T(c,r,{get:s[r],enumerable:!0})},R=(c,s,r,h)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of H(s))!U.call(c,i)&&i!==r&&T(c,i,{get:()=>s[i],enumerable:!(h=A(s,i))||h.enumerable});return c};var I=(c,s,r)=>(r=c!=null?z(D(c)):{},R(s||!c||!c.__esModule?T(r,"default",{value:c,enumerable:!0}):r,c)),G=c=>R(T({},"__esModule",{value:!0}),c);var W={};B(W,{default:()=>V});module.exports=G(W);var f={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function $(c){let{textureName:s,options:r}=c,h="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(i,N){let{uniforms:F,injectGLSL:O}=N,l=null,b=null,x=-1,y=new Map,m=r?.maxFaces??1,v=512,w=512,u=document.createElement("canvas");u.width=v,u.height=w;let p=u.getContext("2d");p.globalCompositeOperation="lighten";async function S(){try{let{FilesetResolver:t,FaceLandmarker:a}=await import("@mediapipe/tasks-vision");b=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),l=await a.createFromOptions(b,{baseOptions:{modelAssetPath:r?.modelPath||h},runningMode:"VIDEO",numFaces:r?.maxFaces??1,minFaceDetectionConfidence:r?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:r?.minFacePresenceConfidence??.5,minTrackingConfidence:r?.minTrackingConfidence??.5,outputFaceBlendshapes:r?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:r?.outputFacialTransformationMatrixes??!1})}catch(t){throw console.error("Failed to initialize Face Landmarker:",t),t}}function Y(t){let a=1/0,n=-1/0,o=1/0,e=-1/0;for(let d of t)a=Math.min(a,d.x),n=Math.max(n,d.x),o=Math.min(o,d.y),e=Math.max(e,d.y);let _=(a+n)/2,g=(o+e)/2;return[_,g]}function E(t,a){p.fillStyle=`rgb(${Math.round(a.r*255)}, ${Math.round(a.g*255)}, ${Math.round(a.b*255)})`;let n=t[0];p.beginPath(),p.moveTo(n.x*u.width,n.y*u.height);for(let o=1;o<t.length;o++){let e=t[o];p.lineTo(e.x*u.width,e.y*u.height)}p.closePath(),p.fill()}async function P(t){if(!l){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:a}=await import("@mediapipe/tasks-vision");p.clearRect(0,0,u.width,u.height),t.forEach((n,o)=>{E(f.OUTER_LIP.map(e=>n[e]),{r:.25,g:0,b:0}),E(f.INNER_LIP.map(e=>n[e]),{r:.75,g:0,b:0}),E(a.FACE_LANDMARKS_TESSELATION.map(({start:e})=>n[e]),{r:0,g:.25,b:0}),E(a.FACE_LANDMARKS_FACE_OVAL.map(({start:e})=>n[e]),{r:0,g:1,b:0}),E(f.LEFT_EYEBROW.map(e=>n[e]),{r:0,g:0,b:.15}),E(f.RIGHT_EYEBROW.map(e=>n[e]),{r:0,g:0,b:.35}),E(f.LEFT_EYE.map(e=>n[e]),{r:0,g:0,b:.65}),E(f.RIGHT_EYE.map(e=>n[e]),{r:0,g:0,b:.85})}),i.updateTextures({u_faceMask:u})}catch(a){console.error("[Face Plugin] Failed to generate mask texture:",a)}}function L(t){if(!t.faceLandmarks)return;let a=[],n=[],o=[],e=[];for(let g of t.faceLandmarks){let d=Y(g),k=g[f.LEFT_EYE_CENTER],C=g[f.RIGHT_EYE_CENTER],M=g[f.NOSE_TIP];a.push([d[0],1-d[1]]),n.push([k.x,1-k.y]),o.push([C.x,1-C.y]),e.push([M.x,1-M.y])}P(t.faceLandmarks).catch(g=>{console.warn("Mask texture update error:",g)});let _={u_nFaces:t.faceLandmarks.length};t.faceLandmarks.length&&(F.has("u_faceCenter")&&(_.u_faceCenter=a),F.has("u_leftEye")&&(_.u_leftEye=n),F.has("u_rightEye")&&(_.u_rightEye=o),F.has("u_noseTip")&&(_.u_noseTip=e)),i.updateUniforms(_)}i.registerHook("init",async()=>{i.initializeTexture("u_faceMask",u),i.initializeUniform("u_maxFaces","int",m),i.initializeUniform("u_nFaces","int",0);let t=Array.from({length:m},()=>[.5,.5]);i.initializeUniform("u_faceCenter","float",t,{arrayLength:m}),i.initializeUniform("u_leftEye","float",t,{arrayLength:m}),i.initializeUniform("u_rightEye","float",t,{arrayLength:m}),i.initializeUniform("u_noseTip","float",t,{arrayLength:m}),await S()}),i.registerHook("updateTextures",t=>{Object.entries(t).forEach(([a,n])=>{if(a===s&&(y.set(a,n),!!l))try{if(n instanceof HTMLVideoElement){if(n.currentTime!==x){x=n.currentTime;let o=performance.now(),e=l.detectForVideo(n,o);L(e)}}else if(n instanceof HTMLImageElement){let o=l.detect(n);L(o)}}catch(o){console.warn("Face detection error:",o)}})}),i.registerHook("destroy",()=>{l&&(l.close(),l=null),b=null,y.clear(),u.remove()}),O(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceCenter[${m}];
uniform vec2 u_leftEye[${m}];
uniform vec2 u_rightEye[${m}];
uniform vec2 u_noseTip[${m}];
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var V=$;
//# sourceMappingURL=face.js.map