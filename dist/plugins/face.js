"use strict";var P=Object.create;var k=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var G=(c,u)=>{for(var i in u)k(c,i,{get:u[i],enumerable:!0})},v=(c,u,i,L)=>{if(u&&typeof u=="object"||typeof u=="function")for(let a of D(u))!B.call(c,a)&&a!==i&&k(c,a,{get:()=>u[a],enumerable:!(L=U(u,a))||L.enumerable});return c};var S=(c,u,i)=>(i=c!=null?P($(c)):{},v(u||!c||!c.__esModule?k(i,"default",{value:c,enumerable:!0}):i,c)),V=c=>v(k({},"__esModule",{value:!0}),c);var X={};G(X,{default:()=>K});module.exports=V(X);var x=478,f={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function W(c){let{textureName:u,options:i}=c,L="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(a,w){let{uniforms:E,injectGLSL:O}=w,l=null,y=null,C=-1,M=new Map,s=i?.maxFaces??1,z=512,A=512,m=document.createElement("canvas");m.width=z,m.height=A;let p=m.getContext("2d");p.globalCompositeOperation="lighten";async function Y(){try{let{FilesetResolver:t,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");y=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),l=await e.createFromOptions(y,{baseOptions:{modelAssetPath:i?.modelPath||L},runningMode:"VIDEO",numFaces:i?.maxFaces??1,minFaceDetectionConfidence:i?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:i?.minFacePresenceConfidence??.5,minTrackingConfidence:i?.minTrackingConfidence??.5,outputFaceBlendshapes:i?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:i?.outputFacialTransformationMatrixes??!1})}catch(t){throw console.error("Failed to initialize Face Landmarker:",t),t}}function R(t){let e=1/0,r=-1/0,o=1/0,n=-1/0;for(let _ of t)e=Math.min(e,_.x),r=Math.max(r,_.x),o=Math.min(o,_.y),n=Math.max(n,_.y);let F=(e+r)/2,T=(o+n)/2;return[F,T]}function d(t,e){p.fillStyle=`rgb(${Math.round(e.r*255)}, ${Math.round(e.g*255)}, ${Math.round(e.b*255)})`;let r=t[0];p.beginPath(),p.moveTo(r.x*m.width,r.y*m.height);for(let o=1;o<t.length;o++){let n=t[o];p.lineTo(n.x*m.width,n.y*m.height)}p.closePath(),p.fill()}async function H(t){if(!l){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");p.clearRect(0,0,m.width,m.height),t.forEach((r,o)=>{d(f.OUTER_LIP.map(n=>r[n]),{r:.25,g:0,b:0}),d(f.INNER_LIP.map(n=>r[n]),{r:.75,g:0,b:0}),d(e.FACE_LANDMARKS_TESSELATION.map(({start:n})=>r[n]),{r:0,g:.25,b:0}),d(e.FACE_LANDMARKS_FACE_OVAL.map(({start:n})=>r[n]),{r:0,g:1,b:0}),d(f.LEFT_EYEBROW.map(n=>r[n]),{r:0,g:0,b:.15}),d(f.RIGHT_EYEBROW.map(n=>r[n]),{r:0,g:0,b:.35}),d(f.LEFT_EYE.map(n=>r[n]),{r:0,g:0,b:.65}),d(f.RIGHT_EYE.map(n=>r[n]),{r:0,g:0,b:.85})}),a.updateTextures({u_faceMask:m})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function N(t){if(!t.faceLandmarks)return;let e=[],r=[],o=[],n=[],F=[],T=[];for(let I of t.faceLandmarks){let h=I.map(b=>[b.x,1-b.y]);e.push(h),r.push(R(h)),o.push(h[f.LEFT_EYE_CENTER]),n.push(h[f.RIGHT_EYE_CENTER]),F.push(h[f.NOSE_TIP]),T.push(R(f.INNER_LIP.map(b=>h[b])))}H(t.faceLandmarks).catch(I=>{console.warn("Mask texture update error:",I)});let _=t.faceLandmarks.length,g={u_nFaces:_};_&&(E.has("u_faceLandmarks")&&(g.u_faceLandmarks=e),E.has("u_faceCenter")&&(g.u_faceCenter=r),E.has("u_leftEye")&&(g.u_leftEye=o),E.has("u_rightEye")&&(g.u_rightEye=n),E.has("u_noseTip")&&(g.u_noseTip=F),E.has("u_mouth")&&(g.u_mouth=T)),a.updateUniforms(g)}a.registerHook("init",async()=>{a.initializeTexture("u_faceMask",m),a.initializeUniform("u_maxFaces","int",s),a.initializeUniform("u_nFaces","int",0);let t=Array.from({length:s*x},()=>[.5,.5]),e=Array.from({length:s},()=>[.5,.5]);a.initializeUniform("u_faceLandmarks","float",t,{arrayLength:s*x}),a.initializeUniform("u_faceCenter","float",e,{arrayLength:s}),a.initializeUniform("u_leftEye","float",e,{arrayLength:s}),a.initializeUniform("u_rightEye","float",e,{arrayLength:s}),a.initializeUniform("u_noseTip","float",e,{arrayLength:s}),a.initializeUniform("u_mouth","float",e,{arrayLength:s}),await Y()}),a.registerHook("updateTextures",t=>{let e=t[u];if(!(!e||(M.get(u)!==e&&(C=-1),M.set(u,e),!l)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==C){C=e.currentTime;let o=performance.now(),n=l.detectForVideo(e,o);N(n)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let o=l.detect(e);N(o)}}catch(o){console.warn("Face detection error:",o)}}),a.registerHook("destroy",()=>{l&&(l.close(),l=null),y=null,M.clear(),m.remove()}),O(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceLandmarks[${s*x}];
uniform vec2 u_faceCenter[${s}];
uniform vec2 u_leftEye[${s}];
uniform vec2 u_rightEye[${s}];
uniform vec2 u_noseTip[${s}];
uniform vec2 u_mouth[${s}];
uniform sampler2D u_faceMask;
vec2 faceLandmark(int faceIndex, int landmarkIndex) {
	return u_faceLandmarks[faceIndex * ${x} + landmarkIndex];
}
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var K=W;
//# sourceMappingURL=face.js.map