"use strict";var j=Object.create;var b=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var ee=(o,u)=>{for(var i in u)b(o,i,{get:u[i],enumerable:!0})},P=(o,u,i,A)=>{if(u&&typeof u=="object"||typeof u=="function")for(let c of q(u))!Q.call(o,c)&&c!==i&&b(o,c,{get:()=>u[c],enumerable:!(A=Z(u,c))||A.enumerable});return o};var U=(o,u,i)=>(i=o!=null?j(J(o)):{},P(u||!o||!o.__esModule?b(i,"default",{value:o,enumerable:!0}):i,o)),te=o=>P(b({},"__esModule",{value:!0}),o);var ie={};ee(ie,{default:()=>re});module.exports=te(ie);var k=478,ne=2,d=k+ne,m={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95],FACE_CENTER:k,MOUTH_CENTER:k+1};function ae(o){let{textureName:u,options:i}=o,A="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(c,K){let{injectGLSL:$,gl:N}=K,T=null,I=null,y=-1,O=new Map,v=i?.maxFaces??1,p=512,S=0,t=null,z=512,B=512,l=document.createElement("canvas");l.width=z,l.height=B;let _=l.getContext("2d");_.globalCompositeOperation="lighten";async function G(){try{let{FilesetResolver:n,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");I=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),T=await e.createFromOptions(I,{baseOptions:{modelAssetPath:i?.modelPath||A},runningMode:"VIDEO",numFaces:i?.maxFaces??1,minFaceDetectionConfidence:i?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:i?.minFacePresenceConfidence??.5,minTrackingConfidence:i?.minTrackingConfidence??.5,outputFaceBlendshapes:i?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:i?.outputFacialTransformationMatrixes??!1})}catch(n){throw console.error("Failed to initialize Face Landmarker:",n),n}}function w(n,e,a){let r=1/0,s=-1/0,h=1/0,f=-1/0,E=0,C=0;for(let X of a){let M=(e*d+X)*4,H=n[M],Y=n[M+1];r=Math.min(r,H),s=Math.max(s,H),h=Math.min(h,Y),f=Math.max(f,Y),E+=n[M+2],C+=n[M+3]}let g=(r+s)/2,L=(h+f)/2,x=E/a.length,R=C/a.length;return[g,L,x,R]}function F(n,e,a){if(!t)return;_.fillStyle=`rgb(${Math.round(a.r*255)}, ${Math.round(a.g*255)}, ${Math.round(a.b*255)})`,_.beginPath();let r=(n*d+e[0])*4,s=t[r],h=t[r+1];_.moveTo(s*l.width,h*l.height);for(let f=1;f<e.length;++f){let E=(n*d+e[f])*4,C=t[E],g=t[E+1];_.lineTo(C*l.width,g*l.height)}_.closePath(),_.fill()}async function V(n){if(!T||!t){console.warn("[Face Plugin] Cannot update mask: faceLandmarker or landmarksDataArray missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");_.clearRect(0,0,l.width,l.height);for(let a=0;a<n;++a)F(a,m.OUTER_LIP,{r:.25,g:0,b:0}),F(a,m.INNER_LIP,{r:.75,g:0,b:0}),F(a,e.FACE_LANDMARKS_TESSELATION.map(({start:r})=>r),{r:0,g:.25,b:0}),F(a,e.FACE_LANDMARKS_FACE_OVAL.map(({start:r})=>r),{r:0,g:1,b:0}),F(a,m.LEFT_EYEBROW,{r:0,g:0,b:.15}),F(a,m.RIGHT_EYEBROW,{r:0,g:0,b:.35}),F(a,m.LEFT_EYE,{r:0,g:0,b:.65}),F(a,m.RIGHT_EYE,{r:0,g:0,b:.85});c.updateTextures({u_faceMask:l})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function W(n){if(!t)return;let e=n.length,a=e*d;for(let s=0;s<e;++s){let h=n[s];for(let L=0;L<k;++L){let x=h[L],R=(s*d+L)*4;t[R]=x.x,t[R+1]=1-x.y,t[R+2]=x.z??0,t[R+3]=x.visibility??1}let f=w(t,s,Array.from({length:k},(L,x)=>x)),E=(s*d+m.FACE_CENTER)*4;t[E]=f[0],t[E+1]=f[1],t[E+2]=0,t[E+3]=1;let C=w(t,s,m.INNER_LIP),g=(s*d+m.MOUTH_CENTER)*4;t[g]=C[0],t[g+1]=C[1],t[g+2]=0,t[g+3]=1}let r=Math.ceil(a/p);c.updateTextures({u_faceLandmarksTex:{data:t,width:p,height:r}})}function D(n){if(!n.faceLandmarks||!t)return;let e=n.faceLandmarks.length;W(n.faceLandmarks),V(e).catch(a=>{console.warn("Mask texture update error:",a)}),c.updateUniforms({u_nFaces:e})}c.registerHook("init",async()=>{c.initializeTexture("u_faceMask",l,{preserveY:!0}),c.initializeUniform("u_maxFaces","int",v),c.initializeUniform("u_nFaces","int",0);let n=v*d;S=Math.ceil(n/p);let e=p*S*4;t=new Float32Array(e),c.initializeTexture("u_faceLandmarksTex",{data:t,width:p,height:S},{internalFormat:N.RGBA32F,type:N.FLOAT,minFilter:N.NEAREST,magFilter:N.NEAREST}),await G()}),c.registerHook("updateTextures",n=>{let e=n[u];if(!(!e||(O.get(u)!==e&&(y=-1),O.set(u,e),!T)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==y){y=e.currentTime;let r=performance.now(),s=T.detectForVideo(e,r);D(s)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let r=T.detect(e);D(r)}}catch(r){console.warn("Face detection error:",r)}}),c.registerHook("destroy",()=>{T&&(T.close(),T=null),I=null,O.clear(),l.remove(),t=null}),$(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform sampler2D u_faceLandmarksTex;
uniform sampler2D u_faceMask;

#define FACE_LANDMARK_L_EYE_CENTER ${m.LEFT_EYE_CENTER}
#define FACE_LANDMARK_R_EYE_CENTER ${m.RIGHT_EYE_CENTER}
#define FACE_LANDMARK_NOSE_TIP ${m.NOSE_TIP}
#define FACE_LANDMARK_FACE_CENTER ${m.FACE_CENTER}
#define FACE_LANDMARK_MOUTH_CENTER ${m.MOUTH_CENTER}

vec4 faceLandmark(int faceIndex, int landmarkIndex) {
	int i = faceIndex * ${d} + landmarkIndex;
	int x = i % ${p};
	int y = i / ${p};
	return texelFetch(u_faceLandmarksTex, ivec2(x, y), 0);
}
float inFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float inEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float inMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var re=ae;
//# sourceMappingURL=face.js.map