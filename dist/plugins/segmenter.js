"use strict";var q=Object.create;var D=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var te=(o,e)=>{for(var t in e)D(o,t,{get:e[t],enumerable:!0})},W=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Z(e))!ee.call(o,i)&&i!==t&&D(o,i,{get:()=>e[i],enumerable:!(r=J(e,i))||r.enumerable});return o};var $=(o,e,t)=>(t=o!=null?q(Q(o)):{},W(e||!o||!o.__esModule?D(t,"default",{value:o,enumerable:!0}):t,o)),ie=o=>W(D({},"__esModule",{value:!0}),o);var ce={};te(ce,{default:()=>ge});module.exports=ie(ce);function M(o,e){return(o%e+e)%e}var re=`#version 300 es
in vec2 a_position;
out vec2 v_uv;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
    v_uv = a_position * 0.5 + 0.5;
}`,ne=[["8UI","UNSIGNED_BYTE"],["8I","BYTE"],["16UI","UNSIGNED_SHORT"],["16I","SHORT"],["16F","HALF_FLOAT"],["32UI","UNSIGNED_INT"],["32I","INT"],["32F","FLOAT"],["8","UNSIGNED_BYTE"]],k={float:"f",int:"i",uint:"ui"};function se(o){return o&&ne.find(([e])=>o.endsWith(e))?.[1]}var P=Symbol("u_history"),v=Symbol("__SHADERPAD_BUFFER"),G=new WeakMap;function oe(o,e){if(!e?.length)return o;let t=o.split(`
`),r=t.findLastIndex(i=>{let s=i.trimStart();return s.startsWith("precision ")||s.startsWith("#version ")})+1;return t.splice(r,0,...e),t.join(`
`)}function X(o){return o instanceof WebGLTexture?{width:0,height:0}:o instanceof N?{width:o.canvas.width,height:o.canvas.height}:o instanceof HTMLVideoElement?{width:o.videoWidth,height:o.videoHeight}:o instanceof HTMLImageElement?{width:o.naturalWidth??o.width,height:o.naturalHeight??o.height}:{width:o.width,height:o.height}}function _(o){return typeof o=="symbol"?o.description??"":o}var N=class o{isHeadless=!1;isTouchDevice=!1;gl;glHelpers;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;vao=null;program=null;animationFrameId;eventListeners=new Map;frame=0;startTime=0;isPlaying=!1;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;resolutionObserver=null;hooks=new Map;historyDepth=0;textureOptions;debug;cursorTarget;intermediateFbo=null;constructor(e,{canvas:t,plugins:r,history:i,debug:s,cursorTarget:a,...l}={}){if(t&&"getContext"in t)this.canvas=t;else{let{width:f=1,height:p=1}=t||{};this.canvas=new OffscreenCanvas(f,p),this.isHeadless=!0}let n=this.canvas.getContext("webgl2",{antialias:!1});if(!n)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=n,this.glHelpers={typeToArray:new Map([[n.FLOAT,Float32Array],[n.HALF_FLOAT,Uint16Array],[n.UNSIGNED_SHORT,Uint16Array],[n.SHORT,Int16Array],[n.BYTE,Int8Array],[n.UNSIGNED_INT,Uint32Array],[n.INT,Int32Array]]),typeToInternalFormatString:new Map([[n.FLOAT,"RGBA32F"],[n.HALF_FLOAT,"RGBA16F"],[n.UNSIGNED_SHORT,"RGBA32UI"],[n.SHORT,"RGBA32I"],[n.BYTE,"RGBA32I"],[n.UNSIGNED_INT,"RGBA32UI"],[n.INT,"RGBA32I"]]),unsignedIntTypes:new Set([n.UNSIGNED_BYTE,n.UNSIGNED_SHORT,n.UNSIGNED_INT])};let m=G.get(this.canvas);m||(m={textureUnitPool:{free:[],next:0,max:n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},instances:new Set([this])},G.set(this.canvas,m)),this.textureUnitPool=m.textureUnitPool,m.instances.add(this),this.textureOptions=l,i&&(this.historyDepth=i),this.debug=s??(typeof process<"u"&&!1),this.cursorTarget=a??(this.canvas instanceof HTMLCanvasElement?this.canvas:void 0),this.animationFrameId=null;let c=[];r&&r.forEach(f=>f(this,{gl:n,canvas:this.canvas,injectGLSL:p=>{c.push(p)},emitHook:this.emitHook.bind(this)}));let h=this.gl.createProgram();if(!h)throw new Error("Failed to create WebGL program");this.program=h;let u=this.createShader(this.gl.VERTEX_SHADER,re),E=this.createShader(n.FRAGMENT_SHADER,oe(e,c));if(n.attachShader(h,u),n.attachShader(h,E),n.bindAttribLocation(h,0,"a_position"),n.linkProgram(h),n.deleteShader(u),n.deleteShader(E),!n.getProgramParameter(h,n.LINK_STATUS))throw console.error("Program link error:",n.getProgramInfoLog(h)),n.deleteProgram(h),new Error("Failed to link WebGL program");if(this.vao=n.createVertexArray(),n.bindVertexArray(this.vao),this.buffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.buffer),n.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),n.STATIC_DRAW),n.enableVertexAttribArray(0),n.vertexAttribPointer(0,2,n.FLOAT,!1,0,0),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.useProgram(h),this.canvas instanceof HTMLCanvasElement)this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]});else{let f=p=>{let y=Object.getOwnPropertyDescriptor(OffscreenCanvas.prototype,p),x=this.canvas;Object.defineProperty(x,p,{get:()=>y.get.call(x),set:T=>{y.set.call(x,T);let F=G.get(x);if(F)for(let I of F.instances)I.updateResolution()},configurable:y.configurable,enumerable:y.enumerable})};f("width"),f("height")}this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this._initializeTexture(v,this.canvas,{...this.textureOptions}),this.intermediateFbo=n.createFramebuffer(),this.bindIntermediate(),n.bindFramebuffer(n.FRAMEBUFFER,null),this.historyDepth>0&&this._initializeTexture(P,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.cursorTarget&&this.addEventListeners(),this.emitHook("_init")}resolveGLConstant(e){let t=this.gl[e];if(t===void 0)throw new Error(`Unknown GL constant: ${e}`);return t}emitHook(e,...t){this.hooks.get(e)?.forEach(r=>r.call(this,...t))}on(e,t){this.hooks.has(e)||this.hooks.set(e,[]),this.hooks.get(e).push(t)}off(e,t){let r=this.hooks.get(e);r&&r.splice(r.indexOf(t),1)}createShader(e,t){let r=this.gl.createShader(e);if(this.gl.shaderSource(r,t),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",t),console.error(this.gl.getShaderInfoLog(r)),this.gl.deleteShader(r),new Error("Shader compilation failed");return r}getCursorTargetRect(){let e=this.cursorTarget;return e===window?{left:0,top:0,width:window.innerWidth,height:window.innerHeight}:e.getBoundingClientRect()}addEventListeners(){if(!this.cursorTarget)return;let e=(r,i)=>{if(!this.uniforms.has("u_cursor"))return;let s=this.getCursorTargetRect(),a=(r-s.left)/s.width,l=1-(i-s.top)/s.height;this.cursorPosition[0]=Math.max(0,Math.min(1,a)),this.cursorPosition[1]=Math.max(0,Math.min(1,l)),this.updateUniforms({u_cursor:this.cursorPosition})},t=(r,i,s)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=r,r){let a=this.getCursorTargetRect(),l=i,n=s;this.clickPosition[0]=Math.max(0,Math.min(1,(l-a.left)/a.width)),this.clickPosition[1]=Math.max(0,Math.min(1,1-(n-a.top)/a.height))}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",r=>{let i=r;this.isTouchDevice||e(i.clientX,i.clientY)}),this.eventListeners.set("mousedown",r=>{let i=r;this.isTouchDevice||i.button===0&&(this.isMouseDown=!0,t(!0,i.clientX,i.clientY))}),this.eventListeners.set("mouseup",r=>{let i=r;this.isTouchDevice||i.button===0&&t(!1)}),this.eventListeners.set("touchmove",r=>{let i=r;i.touches.length>0&&e(i.touches[0].clientX,i.touches[0].clientY)}),this.eventListeners.set("touchstart",r=>{let i=r;this.isTouchDevice=!0,i.touches.length>0&&(e(i.touches[0].clientX,i.touches[0].clientY),t(!0,i.touches[0].clientX,i.touches[0].clientY))}),this.eventListeners.set("touchend",r=>{r.touches.length===0&&t(!1)}),this.eventListeners.forEach((r,i)=>{this.cursorTarget.addEventListener(i,r)})}updateResolution(){let e=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...e),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:e}):this.initializeUniform("u_resolution","float",e),this.resizeTexture(v,...e),this.historyDepth>0&&this.resizeTexture(P,...e),this.emitHook("updateResolution",...e)}resizeTexture(e,t,r){let i=this.textures.get(e);if(!i||i.width===t&&i.height===r)return;this.gl.deleteTexture(i.texture),i.width=t,i.height=r;let{texture:s}=this.createTexture(e,i);i.texture=s,i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}reserveTextureUnit(e){let t=this.textures.get(e);if(t)return t.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}resolveTextureOptions(e){let{gl:t}=this,r=e?.internalFormat,i=e?.type??se(r)??"UNSIGNED_BYTE",s=this.resolveGLConstant(i),a=r??this.glHelpers.typeToInternalFormatString.get(s)??"RGBA8",l=/^(R|RG|RGB|RGBA)(8|16|32)(UI|I)$/.test(a),n=e?.format??(l?"RGBA_INTEGER":"RGBA"),m={type:s,format:this.resolveGLConstant(n),internalFormat:this.resolveGLConstant(a),minFilter:this.resolveGLConstant(e?.minFilter??"LINEAR"),magFilter:this.resolveGLConstant(e?.magFilter??"LINEAR"),wrapS:this.resolveGLConstant(e?.wrapS??"CLAMP_TO_EDGE"),wrapT:this.resolveGLConstant(e?.wrapT??"CLAMP_TO_EDGE"),preserveY:e?.preserveY,isIntegerColorFormat:l};if((m.internalFormat===t.RGBA16F||m.internalFormat===t.RGBA32F)&&!t.getExtension("EXT_color_buffer_float"))throw new Error("Missing EXT_color_buffer_float.");return m}getPixelArray(e,t){let r=this.glHelpers.typeToArray.get(e)??Uint8Array;return new r(t)}isNotRgba(e){return e!==this.gl.RGBA&&e!==this.gl.RGBA_INTEGER}clearHistoryTextureLayers(e){if(!e.history)return;let t=this.gl,{type:r,format:i}=e.options,s=this.getPixelArray(r,e.width*e.height*4);t.activeTexture(t.TEXTURE0+e.unitIndex),t.bindTexture(t.TEXTURE_2D_ARRAY,e.texture);let a=this.isNotRgba(i),l;a&&(l=t.getParameter(t.UNPACK_ALIGNMENT),t.pixelStorei(t.UNPACK_ALIGNMENT,1));for(let n=0;n<e.history.depth;++n)t.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,n,e.width,e.height,1,i,r,s);a&&t.pixelStorei(t.UNPACK_ALIGNMENT,l)}initializeUniform(e,t,r,i){let s=i?.arrayLength;if(this.uniforms.has(e))throw new Error(`${e} is already initialized.`);if(!k[t])throw new Error(`Invalid uniform type: ${t}. Expected one of: ${Object.keys(k).join(", ")}.`);if(s&&!(Array.isArray(r)&&r.length===s))throw new Error(`${e} array length mismatch: must initialize with ${s} elements.`);let a=this.gl.getUniformLocation(this.program,e);if(!a&&s&&(a=this.gl.getUniformLocation(this.program,`${e}[0]`)),!a){this.log(`${e} not in shader. Skipping initialization.`);return}let l=s?r[0]:r,n=Array.isArray(l)?l.length:1;this.uniforms.set(e,{type:t,length:n,location:a,arrayLength:s});try{this.updateUniforms({[e]:r})}catch(m){throw this.uniforms.delete(e),m}this.emitHook("initializeUniform",...arguments)}log(...e){this.debug&&console.debug(...e)}updateUniforms(e,t){this.gl.useProgram(this.program),Object.entries(e).forEach(([r,i])=>{let s=this.uniforms.get(r);if(!s){this.log(`${r} not in shader. Skipping update.`);return}let a=`uniform${s.length}${k[s.type]}`;if(s.arrayLength){if(!Array.isArray(i))throw new Error(`${r} is an array, but the value passed to updateUniforms is not an array.`);let l=i.length;if(!l)return;if(l>s.arrayLength)throw new Error(`${r} received ${l} values, but maximum length is ${s.arrayLength}.`);if(i.some(h=>(Array.isArray(h)?h.length:1)!==s.length))throw new Error(`Tried to update ${r} with some elements that are not length ${s.length}.`);let n=i.flat(),m=s.type==="float"?new Float32Array(n):s.type==="uint"?new Uint32Array(n):new Int32Array(n),c=s.location;if(t?.startIndex){let h=this.gl.getUniformLocation(this.program,`${r}[${t.startIndex}]`);if(!h)throw new Error(`${r}[${t.startIndex}] not in shader. Did you pass an invalid startIndex?`);c=h}this.gl[a+"v"](c,m)}else{if(Array.isArray(i)||(i=[i]),i.length!==s.length)throw new Error(`Invalid uniform value length: ${i.length}. Expected ${s.length}.`);this.gl[a](s.location,...i)}}),this.emitHook("updateUniforms",...arguments)}createTexture(e,t){let{width:r,height:i}=t,s=t.history?.depth??0,a=this.gl.createTexture();if(!a)throw new Error("Failed to create texture");let l=t.unitIndex;if(typeof l!="number")try{l=this.reserveTextureUnit(e)}catch(h){throw this.gl.deleteTexture(a),h}let n=s>0,m=n?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:c}=t;return this.gl.activeTexture(this.gl.TEXTURE0+l),this.gl.bindTexture(m,a),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_S,c.wrapS),this.gl.texParameteri(m,this.gl.TEXTURE_WRAP_T,c.wrapT),this.gl.texParameteri(m,this.gl.TEXTURE_MIN_FILTER,c.minFilter),this.gl.texParameteri(m,this.gl.TEXTURE_MAG_FILTER,c.magFilter),n?this.gl.texStorage3D(m,1,c.internalFormat,r,i,s):e===v&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,c.internalFormat,r,i,0,c.format,c.type,null),{texture:a,unitIndex:l}}_initializeTexture(e,t,r){if(this.textures.has(e))throw new Error(`Texture '${_(e)}' is already initialized.`);let{history:i=0,...s}=r??{},{width:a,height:l}=X(t);if(!a||!l)throw new Error("Texture source must have valid dimensions");let n={width:a,height:l,options:t instanceof o&&Object.keys(s).length===0&&t.textures.has(v)?t.textures.get(v).options:this.resolveTextureOptions(s)};i>0&&(n.history={depth:i,writeIndex:0});let{texture:m,unitIndex:c}=this.createTexture(e,n),h={texture:m,unitIndex:c,...n};i>0&&(this.initializeUniform(`${_(e)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(h)),this.textures.set(e,h),e!==v&&e!==P&&this.updateTexture(e,t),this.gl.useProgram(this.program);let u=this.gl.getUniformLocation(this.program,_(e));u&&this.gl.uniform1i(u,c)}initializeTexture(e,t,r){let i=r?.history!=null&&r.history>0?{...r,history:r.history+1}:r;this._initializeTexture(e,t,i),this.emitHook("initializeTexture",...arguments)}updateTextures(e,t){Object.entries(e).forEach(([r,i])=>{this.updateTexture(r,i,t)}),this.emitHook("updateTextures",...arguments)}updateTexture(e,t,r){let i=this.textures.get(e);if(!i)throw new Error(`Texture '${_(e)}' is not initialized.`);if(t instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,t);return}let s=t;if(t instanceof o){let f=t.textures.get(v),p=f.width,y=f.height;if(t.gl===this.gl){if(!i.history){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,f.texture);return}let{depth:w}=i.history,U=r?.historyWriteIndex===void 0?[i.history.writeIndex]:Array.isArray(r?.historyWriteIndex)?r.historyWriteIndex.map(d=>M(d,w)):[M(r.historyWriteIndex,w)];this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,t.intermediateFbo),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture);for(let d of U)this.gl.copyTexSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,d,0,0,p,y);this.gl.bindFramebuffer(this.gl.READ_FRAMEBUFFER,null),this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture);let g=`${_(e)}FrameOffset`;this.updateUniforms({[g]:U[U.length-1]}),r?.historyWriteIndex===void 0&&(i.history.writeIndex=(i.history.writeIndex+1)%w);return}let{width:x,height:T,options:{format:F,type:I}}=f,L=this.getPixelArray(I,x*T*4);t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,t.intermediateFbo),t.gl.readPixels(0,0,x,T,F,I,L),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),s={data:L,width:x,height:T}}let{width:a,height:l}=X(s);if(!a||!l)return;let n="isPartial"in s&&s.isPartial;n||this.resizeTexture(e,a,l);let m="data"in s&&s.data,c=!m&&!i.options?.preserveY,h=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL),u=m&&this.isNotRgba(i.options.format),E;if(u&&(E=this.gl.getParameter(this.gl.UNPACK_ALIGNMENT),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1)),i.history){if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture),!r?.skipHistoryWrite){let{depth:f}=i.history,p=r?.historyWriteIndex===void 0?[i.history.writeIndex]:Array.isArray(r.historyWriteIndex)?r.historyWriteIndex.map(T=>M(T,f)):[M(r.historyWriteIndex,f)];this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,c);let y=s.data??s;for(let T of p)this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,T,a,l,1,i.options.format,i.options.type,y);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h);let x=`${_(e)}FrameOffset`;this.updateUniforms({[x]:p[p.length-1]}),r?.historyWriteIndex===void 0&&(i.history.writeIndex=(i.history.writeIndex+1)%f)}}else{if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,i.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,c),n){let f=s;this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,f.x??0,f.y??0,a,l,i.options.format,i.options.type,f.data)}else this.gl.texImage2D(this.gl.TEXTURE_2D,0,i.options.internalFormat,a,l,0,i.options.format,i.options.type,s.data??s);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h)}u&&this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,E)}bindIntermediate(){let e=this.gl,t=this.textures.get(v);e.bindFramebuffer(e.FRAMEBUFFER,this.intermediateFbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.texture,0)}clear(){this.bindIntermediate();let e=this.gl,t=this.textures.get(v);if(t.options.isIntegerColorFormat){let r=t.options.type;this.glHelpers.unsignedIntTypes.has(r)?e.clearBufferuiv(e.COLOR,0,new Uint32Array(4)):e.clearBufferiv(e.COLOR,0,new Int32Array(4))}else e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.emitHook("beforeDraw",...arguments);let t=this.gl,r=t.drawingBufferWidth,i=t.drawingBufferHeight;e?.skipClear?this.bindIntermediate():this.clear(),t.useProgram(this.program),t.bindVertexArray(this.vao),t.viewport(0,0,r,i),t.drawArrays(t.TRIANGLES,0,3),this.isHeadless||this.textures.get(v).options.isIntegerColorFormat||(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.intermediateFbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.blitFramebuffer(0,0,r,i,0,0,r,i,t.COLOR_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,null)),this.emitHook("afterDraw",...arguments)}step(e){this._step(performance.now()-this.startTime,e)}_step(e,t){this.emitHook("beforeStep",e,this.frame,t);let r={};this.uniforms.has("u_time")&&(r.u_time=e),this.uniforms.has("u_frame")&&(r.u_frame=this.frame),this.updateUniforms(r),this.draw(t);let i=this.textures.get(P);if(i&&!t?.skipHistoryWrite){let{writeIndex:s,depth:a}=i.history,l=this.gl;l.bindFramebuffer(l.READ_FRAMEBUFFER,this.intermediateFbo),l.bindTexture(l.TEXTURE_2D_ARRAY,i.texture),l.copyTexSubImage3D(l.TEXTURE_2D_ARRAY,0,0,0,s,0,0,l.drawingBufferWidth,l.drawingBufferHeight),l.bindFramebuffer(l.READ_FRAMEBUFFER,null);let n=(s+1)%a;this.updateUniforms({[`${_(P)}FrameOffset`]:n}),i.history.writeIndex=n}++this.frame,this.emitHook("afterStep",e,this.frame,t)}play(e){this.pause(),this.isPlaying=!0;let t=r=>{r=(r-this.startTime)/1e3;let i=e?.(r,this.frame)??void 0;this._step(r,i),this.isPlaying&&(this.animationFrameId=requestAnimationFrame(t))};this.animationFrameId=requestAnimationFrame(t),this.emitHook("play")}_pause(){this.isPlaying=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}pause(){this._pause(),this.emitHook("pause")}resetFrame(){this.frame=0,this.startTime=performance.now()}reset(){this.resetFrame(),this.textures.forEach(e=>{e.history&&(e.history.writeIndex=0,this.clearHistoryTextureLayers(e))}),this.clear(),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this._pause(),this.cursorTarget&&(this.eventListeners.forEach((t,r)=>{this.cursorTarget.removeEventListener(r,t)}),this.eventListeners.clear()),this.resolutionObserver&&(this.resolutionObserver.disconnect(),this.resolutionObserver=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(t=>{this.textureUnitPool.free.push(t.unitIndex),this.gl.deleteTexture(t.texture)}),this.textures.clear();let e=G.get(this.canvas);e&&(e.instances.delete(this),e.instances.size===0&&G.delete(this.canvas)),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.uniforms.clear(),this.hooks.clear()}},Y=N;var z={data:new Uint8Array(4),width:1,height:1};function B(o){return o instanceof HTMLVideoElement||o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof OffscreenCanvas}function V(o){return JSON.stringify(o,Object.keys(o).sort())}var H=null;function K(){return H||(H=import("@mediapipe/tasks-vision").then(({FilesetResolver:o})=>o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),H}function j(o){return{historyParams:o?", framesAgo":"",fn:o?(r,i,s,a)=>{let l=s.replace(/\w+ /g,""),n=s?`${s}, int framesAgo`:"int framesAgo",m=l?`${l}, 0`:"0";return`${r} ${i}(${n}) {
${a}
}
${r} ${i}(${s}) { return ${i}(${m}); }`}:(r,i,s,a)=>`${r} ${i}(${s}) {
${a}
}`}}var ae={data:new Float32Array(1).fill(1),width:1,height:1},ue={modelPath:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite",outputConfidenceMasks:!1},le=`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
uniform sampler2D u_categoryMask;
uniform sampler2D u_confidenceMask;
uniform float u_maxCategoryIndex;

void main() {
	vec2 uv = vec2(v_uv.x, 1.0 - v_uv.y);
	float normalizedCategoryIndex = texture(u_categoryMask, uv).r * 255.0 / u_maxCategoryIndex;
	float confidence = texture(u_confidenceMask, uv).r;
	outColor = vec4(confidence, normalizedCategoryIndex, 0.0, 1.0);
}`,C=new Map;function he(o,e,t){let{outputConfidenceMasks:r,mask:{shader:i,confidence:s}}=o,{width:a,height:l}=e;if((s.width!==a||s.height!==l)&&(s.width=a,s.height=l,s.data=new Float32Array(a*l).fill(1)),r&&t?.length){let n=e.getAsUint8Array(),m=t.map(h=>h.getAsFloat32Array()),c=s.data;for(let h=0;h<n.length;++h){let u=n[h];c[h]=m[u][h]}}i.updateTextures({u_categoryMask:e.getAsWebGLTexture(),u_confidenceMask:s}),i.step(),e.close(),t?.forEach(n=>n.close())}function me(o){let{textureName:e,options:{history:t,...r}={}}=o,i={...ue,...r},s=V({...i,textureName:e});return function(a,l){let{injectGLSL:n,emitHook:m}=l,h=C.get(s)?.mask.canvas??new OffscreenCanvas(1,1),u=null,E=!1,f=!1;function p(g){if(!u)return;let d=g;typeof d>"u"&&F.length>0&&(d=F,F=[]),a.updateTextures({u_segmentMask:u.mask.shader},t?{skipHistoryWrite:f,historyWriteIndex:d}:void 0),m("segmenter:result",u.state.result)}async function y(){if(C.has(s))u=C.get(s);else{let[g,{ImageSegmenter:d}]=await Promise.all([K(),import("@mediapipe/tasks-vision")]);if(E)return;let A=await d.createFromOptions(g,{baseOptions:{modelAssetPath:i.modelPath,delegate:"GPU"},canvas:h,runningMode:"VIDEO",outputCategoryMask:!0,outputConfidenceMasks:i.outputConfidenceMasks});if(E){A.close();return}let R=new Y(le,{canvas:h});R.initializeTexture("u_categoryMask",z),R.initializeTexture("u_confidenceMask",ae,{format:"RED",internalFormat:"R32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST"});let S=A.getLabels().length||1;R.initializeUniform("u_maxCategoryIndex","float",Math.max(1,S-1)),u={segmenter:A,outputConfidenceMasks:i.outputConfidenceMasks,subscribers:new Map,numCategories:S,state:{nCalls:0,runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve()},mask:{canvas:h,shader:R,confidence:{data:null,width:0,height:0}}},C.set(s,u)}u.subscribers.set(p,!1)}let x=y();a.on("_init",()=>{a.initializeUniform("u_numCategories","int",1),a.initializeTexture("u_segmentMask",h,{minFilter:"NEAREST",magFilter:"NEAREST",history:t}),x.then(()=>{E||!u||(a.updateUniforms({u_numCategories:u.numCategories}),m("segmenter:ready"))})});let T=0,F=[],I=()=>{t&&(p(T),F.push(T),T=(T+1)%(t+1))};a.on("initializeTexture",(g,d)=>{g===e&&B(d)&&(I(),L(d))}),a.on("updateTextures",(g,d)=>{let A=g[e];B(A)&&(f=d?.skipHistoryWrite??!1,f||I(),L(A))});async function L(g){let d=performance.now();if(await x,!u)return;let A=++u.state.nCalls;u.state.pending=u.state.pending.then(async()=>{if(!u||A!==u.state.nCalls)return;let R=g instanceof HTMLVideoElement?"VIDEO":"IMAGE";u.state.runningMode!==R&&(u.state.runningMode=R,await u.segmenter.setOptions({runningMode:R}));let S=!1;if(g!==u.state.source?(u.state.source=g,u.state.videoTime=-1,S=!0):g instanceof HTMLVideoElement?g.currentTime!==u.state.videoTime&&(u.state.videoTime=g.currentTime,S=!0):g instanceof HTMLImageElement||d-u.state.resultTimestamp>2&&(S=!0),S){let b;if(g instanceof HTMLVideoElement){if(g.videoWidth===0||g.videoHeight===0||g.readyState<2)return;b=u.segmenter.segmentForVideo(g,d)}else{if(g.width===0||g.height===0)return;b=u.segmenter.segment(g)}if(b){u.state.resultTimestamp=d,u.state.result=b,b.categoryMask&&he(u,b.categoryMask,b.confidenceMasks);for(let O of u.subscribers.keys())O(),u.subscribers.set(O,!0)}}else if(u.state.result){for(let[b,O]of u.subscribers.entries())O||(b(),u.subscribers.set(b,!0));u.subscribers.set(p,!0)}}),await u.state.pending}a.on("destroy",()=>{E=!0,u&&(u.subscribers.delete(p),u.subscribers.size===0&&(u.segmenter.close(),u.mask.shader.destroy(),C.delete(s))),u=null});let{fn:w}=j(t),U=t?`int layer = (u_segmentMaskFrameOffset - framesAgo + ${t+1}) % ${t+1};
	vec4 mask = texture(u_segmentMask, vec3(pos, float(layer)));`:"vec4 mask = texture(u_segmentMask, pos);";n(`
uniform ${t?"highp":"mediump"} sampler2D${t?"Array":""} u_segmentMask;${t?`
uniform int u_segmentMaskFrameOffset;`:""}
uniform int u_numCategories;

${w("vec2","segmentAt","vec2 pos",`${U}
	return vec2(mask.r, mask.g);`)}`)}}var ge=me;
//# sourceMappingURL=segmenter.js.map