"use strict";var C=Object.create;var v=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var O=(n,t)=>{for(var e in t)v(n,e,{get:t[e],enumerable:!0})},R=(n,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of F(t))!D.call(n,r)&&r!==e&&v(n,r,{get:()=>t[r],enumerable:!(i=M(t,r))||i.enumerable});return n};var z=(n,t,e)=>(e=n!=null?C(k(n)):{},R(t||!n||!n.__esModule?v(e,"default",{value:n,enumerable:!0}):e,n)),G=n=>R(v({},"__esModule",{value:!0}),n);var Y={};O(Y,{default:()=>X});module.exports=G(Y);var H=`#version 300 es
in vec2 aPosition;
out vec2 v_uv;
void main() {
    v_uv = aPosition * 0.5 + 0.5;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}
`,B=33.333333333333336,E=Symbol("u_history");function W(n,t){if(!t?.length)return n;let e=n.split(`
`),i=e.findLastIndex(r=>{let s=r.trimStart();return s.startsWith("precision ")||s.startsWith("#version ")})+1;return e.splice(i,0,...t),e.join(`
`)}function S(n){return n instanceof WebGLTexture?{width:0,height:0}:n instanceof HTMLVideoElement?{width:n.videoWidth,height:n.videoHeight}:n instanceof HTMLImageElement?{width:n.naturalWidth??n.width,height:n.naturalHeight??n.height}:{width:n.width,height:n.height}}function T(n){return typeof n=="symbol"?n.description??"":n}var L=class{isInternalCanvas=!1;isTouchDevice=!1;gl;fragmentShaderSrc;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;program=null;aPositionLocation=0;animationFrameId;resolutionObserver;resizeObserver;resizeTimeout=null;lastResizeTime=-1/0;eventListeners=new Map;frame=0;startTime=0;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;onResize;hooks=new Map;historyDepth;debug;constructor(t,e={}){if(this.canvas=e.canvas||document.createElement("canvas"),!e.canvas){this.isInternalCanvas=!0;let r=this.canvas;r.style.position="fixed",r.style.inset="0",r.style.height="100dvh",r.style.width="100dvw",document.body.appendChild(r)}if(this.gl=this.canvas.getContext("webgl2",{antialias:!1}),!this.gl)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.textureUnitPool={free:[],next:0,max:this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.historyDepth=e.history??0,this.debug=e.debug??(typeof process<"u"&&!1),this.animationFrameId=null,this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resizeObserver=new ResizeObserver(()=>this.throttledHandleResize());let i=[];if(e.plugins){let r={gl:this.gl,uniforms:this.uniforms,textures:this.textures,canvas:this.canvas,reserveTextureUnit:this.reserveTextureUnit.bind(this),releaseTextureUnit:this.releaseTextureUnit.bind(this),injectGLSL:s=>{i.push(s)}};Object.defineProperty(r,"program",{get:()=>this.program,enumerable:!0,configurable:!0}),e.plugins.forEach(s=>s(this,r))}this.fragmentShaderSrc=W(t,i),this.init(),this.canvas instanceof HTMLCanvasElement&&this.addEventListeners()}registerHook(t,e){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(e)}init(){let t=H;if(this.program=this.gl.createProgram(),!this.program)throw new Error("Failed to create WebGL program");let e=this.createShader(this.gl.VERTEX_SHADER,t),i=this.createShader(this.gl.FRAGMENT_SHADER,this.fragmentShaderSrc);if(this.gl.attachShader(this.program,e),this.gl.attachShader(this.program,i),this.gl.linkProgram(this.program),this.gl.deleteShader(e),this.gl.deleteShader(i),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw console.error("Program link error:",this.gl.getProgramInfoLog(this.program)),this.gl.deleteProgram(this.program),new Error("Failed to link WebGL program");this.aPositionLocation=this.gl.getAttribLocation(this.program,"aPosition"),this.setupBuffer(),this.gl.useProgram(this.program),this.canvas instanceof HTMLCanvasElement&&(this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}),this.resizeObserver.observe(this.canvas)),this.isInternalCanvas||this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this.historyDepth>0&&this._initializeTexture(E,this.canvas,{history:this.historyDepth}),this.hooks.get("init")?.forEach(r=>r.call(this))}createShader(t,e){let i=this.gl.createShader(t);if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",e),console.error(this.gl.getShaderInfoLog(i)),this.gl.deleteShader(i),new Error("Shader compilation failed");return i}setupBuffer(){let t=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);this.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.gl.enableVertexAttribArray(this.aPositionLocation),this.gl.vertexAttribPointer(this.aPositionLocation,2,this.gl.FLOAT,!1,0,0)}throttledHandleResize(){clearTimeout(this.resizeTimeout);let t=performance.now(),e=this.lastResizeTime+B-t;e<=0?(this.lastResizeTime=t,this.handleResize()):this.resizeTimeout=setTimeout(()=>this.throttledHandleResize(),e)}handleResize(){if(!(this.canvas instanceof HTMLCanvasElement))return;let t=window.devicePixelRatio||1,e=this.canvas.clientWidth*t,i=this.canvas.clientHeight*t;this.isInternalCanvas&&(this.canvas.width!==e||this.canvas.height!==i)&&(this.canvas.width=e,this.canvas.height=i),this.onResize?.(e,i)}addEventListeners(){let t=this.canvas,e=(r,s)=>{if(!this.uniforms.has("u_cursor"))return;let l=t.getBoundingClientRect();this.cursorPosition[0]=(r-l.left)/l.width,this.cursorPosition[1]=1-(s-l.top)/l.height,this.updateUniforms({u_cursor:this.cursorPosition})},i=(r,s,l)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=r,r){let u=t.getBoundingClientRect(),o=s,g=l;this.clickPosition[0]=(o-u.left)/u.width,this.clickPosition[1]=1-(g-u.top)/u.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",r=>{let s=r;this.isTouchDevice||e(s.clientX,s.clientY)}),this.eventListeners.set("mousedown",r=>{let s=r;this.isTouchDevice||s.button===0&&(this.isMouseDown=!0,i(!0,s.clientX,s.clientY))}),this.eventListeners.set("mouseup",r=>{let s=r;this.isTouchDevice||s.button===0&&i(!1)}),this.eventListeners.set("touchmove",r=>{let s=r;s.touches.length>0&&e(s.touches[0].clientX,s.touches[0].clientY)}),this.eventListeners.set("touchstart",r=>{let s=r;this.isTouchDevice=!0,s.touches.length>0&&(e(s.touches[0].clientX,s.touches[0].clientY),i(!0,s.touches[0].clientX,s.touches[0].clientY))}),this.eventListeners.set("touchend",r=>{r.touches.length===0&&i(!1)}),this.eventListeners.forEach((r,s)=>{t.addEventListener(s,r)})}updateResolution(){let t=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...t),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:t}):this.initializeUniform("u_resolution","float",t),this.hooks.get("updateResolution")?.forEach(e=>e.call(this))}reserveTextureUnit(t){let e=this.textures.get(t);if(e)return e.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}releaseTextureUnit(t){let e=this.textures.get(t);e&&this.textureUnitPool.free.push(e.unitIndex)}clearHistoryTextureLayers(t){if(!t.history)return;let e=t.options?.type??this.gl.UNSIGNED_BYTE,i=e===this.gl.FLOAT?new Float32Array(t.width*t.height*4):new Uint8Array(t.width*t.height*4);this.gl.activeTexture(this.gl.TEXTURE0+t.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,t.texture);for(let r=0;r<t.history.depth;++r)this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,r,t.width,t.height,1,t.options?.format??this.gl.RGBA,e,i)}initializeUniform(t,e,i,r){let s=r?.arrayLength;if(this.uniforms.has(t))throw new Error(`${t} is already initialized.`);if(e!=="float"&&e!=="int")throw new Error(`Invalid uniform type: ${e}. Expected 'float' or 'int'.`);if(s&&!(Array.isArray(i)&&i.length===s))throw new Error(`${t} array length mismatch: must initialize with ${s} elements.`);let l=this.gl.getUniformLocation(this.program,t);if(!l&&s&&(l=this.gl.getUniformLocation(this.program,`${t}[0]`)),!l){this.log(`${t} not found in fragment shader. Skipping initialization.`);return}let u=s?i[0]:i,o=Array.isArray(u)?u.length:1;this.uniforms.set(t,{type:e,length:o,location:l,arrayLength:s});try{this.updateUniforms({[t]:i})}catch(g){throw this.uniforms.delete(t),g}this.hooks.get("initializeUniform")?.forEach(g=>g.call(this,...arguments))}log(...t){this.debug&&console.debug(...t)}updateUniforms(t,e){this.gl.useProgram(this.program),Object.entries(t).forEach(([i,r])=>{let s=this.uniforms.get(i);if(!s){this.log(`${i} not found in fragment shader. Skipping update.`);return}let l=`uniform${s.length}${s.type.charAt(0)}`;if(s.arrayLength){if(!Array.isArray(r))throw new Error(`${i} is an array, but the value passed to updateUniforms is not an array.`);let u=r.length;if(!u)return;if(u>s.arrayLength)throw new Error(`${i} received ${u} values, but maximum length is ${s.arrayLength}.`);if(r.some(h=>(Array.isArray(h)?h.length:1)!==s.length))throw new Error(`Tried to update ${i} with some elements that are not length ${s.length}.`);let o=new(s.type==="float"?Float32Array:Int32Array)(r.flat()),g=s.location;if(e?.startIndex){let h=this.gl.getUniformLocation(this.program,`${i}[${e.startIndex}]`);if(!h)throw new Error(`${i}[${e.startIndex}] not found in fragment shader. Did you pass an invalid startIndex?`);g=h}this.gl[l+"v"](s.location,o)}else{if(Array.isArray(r)||(r=[r]),r.length!==s.length)throw new Error(`Invalid uniform value length: ${r.length}. Expected ${s.length}.`);this.gl[l](s.location,...r)}}),this.hooks.get("updateUniforms")?.forEach(i=>i.call(this,...arguments))}createTexture(t,e,i){let{width:r,height:s}=e,l=e.history?.depth??0,u=this.gl.createTexture();if(!u)throw new Error("Failed to create texture");let o=i?.unitIndex;if(typeof o!="number")try{o=this.reserveTextureUnit(t)}catch(c){throw this.gl.deleteTexture(u),c}let g=l>0,h=g?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D;if(this.gl.activeTexture(this.gl.TEXTURE0+o),this.gl.bindTexture(h,u),this.gl.texParameteri(h,this.gl.TEXTURE_WRAP_S,i?.wrapS??this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(h,this.gl.TEXTURE_WRAP_T,i?.wrapT??this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(h,this.gl.TEXTURE_MIN_FILTER,i?.minFilter??this.gl.LINEAR),this.gl.texParameteri(h,this.gl.TEXTURE_MAG_FILTER,i?.magFilter??this.gl.LINEAR),g){let c=i?.type??this.gl.UNSIGNED_BYTE,f=i?.internalFormat??(c===this.gl.FLOAT?this.gl.RGBA32F:this.gl.RGBA8);this.gl.texStorage3D(h,1,f,r,s,l)}return{texture:u,unitIndex:o}}_initializeTexture(t,e,i){if(this.textures.has(t))throw new Error(`Texture '${T(t)}' is already initialized.`);let{history:r=0,...s}=i??{},{width:l,height:u}=S(e);if(!l||!u)throw new Error("Texture source must have valid dimensions");let o={width:l,height:u};r>0&&(o.history={depth:r,writeIndex:0});let{texture:g,unitIndex:h}=this.createTexture(t,o,s),c={texture:g,unitIndex:h,...o,options:s};r>0&&(this.initializeUniform(`${T(t)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(c)),this.textures.set(t,c),this.updateTexture(t,e);let f=this.gl.getUniformLocation(this.program,T(t));f&&this.gl.uniform1i(f,h)}initializeTexture(t,e,i){this._initializeTexture(t,e,i),this.hooks.get("initializeTexture")?.forEach(r=>r.call(this,...arguments))}updateTextures(t){this.hooks.get("updateTextures")?.forEach(e=>e.call(this,...arguments)),Object.entries(t).forEach(([e,i])=>{this.updateTexture(e,i)})}updateTexture(t,e){let i=this.textures.get(t);if(!i)throw new Error(`Texture '${T(t)}' is not initialized.`);if(e instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,e);return}let{width:r,height:s}=S(e);if(!r||!s)return;let l="isPartial"in e&&e.isPartial;if(!l&&(i.width!==r||i.height!==s)){this.gl.deleteTexture(i.texture),i.width=r,i.height=s;let{texture:h}=this.createTexture(t,i,{...i.options,unitIndex:i.unitIndex});i.texture=h,i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}let u="data"in e&&e.data,o=!u&&!i.options?.preserveY,g=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL);if(i.history){let h=t===E;this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture),h?this.gl.copyTexSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,i.history.writeIndex,0,0,r,s):(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,o),this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,i.history.writeIndex,r,s,1,i.options?.format??this.gl.RGBA,i.options?.type??this.gl.UNSIGNED_BYTE,e.data??e),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g));let c=`${T(t)}FrameOffset`;this.updateUniforms({[c]:i.history.writeIndex}),i.history.writeIndex=(i.history.writeIndex+1)%i.history.depth}else{this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,i.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,o);let h=i.options?.format??this.gl.RGBA,c=i.options?.type??this.gl.UNSIGNED_BYTE;if(l)this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,e.x??0,e.y??0,r,s,h,c,e.data);else{let f=i.options?.internalFormat??(u?c===this.gl.FLOAT?this.gl.RGBA32F:this.gl.RGBA8:this.gl.RGBA);this.gl.texImage2D(this.gl.TEXTURE_2D,0,f,r,s,0,h,c,e.data??e)}this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g)}}draw(t=!0){let e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.vertexAttribPointer(this.aPositionLocation,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.aPositionLocation),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),t&&e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLES,0,6)}step(t){this.uniforms.has("u_time")&&this.updateUniforms({u_time:t}),this.uniforms.has("u_frame")&&this.updateUniforms({u_frame:this.frame}),this.draw(),this.textures.get(E)&&this.updateTexture(E,this.canvas),this.hooks.get("step")?.forEach(e=>e.call(this,t,this.frame)),++this.frame}play(t){this.pause();let e=i=>{i=(i-this.startTime)/1e3,this.step(i),this.animationFrameId=requestAnimationFrame(e),t&&t(i,this.frame)};this.animationFrameId=requestAnimationFrame(e)}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(t=>{t.history&&(t.history.writeIndex=0,this.clearHistoryTextureLayers(t))}),this.hooks.get("reset")?.forEach(t=>t.call(this))}destroy(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resolutionObserver.disconnect(),this.resizeObserver.disconnect(),this.canvas instanceof HTMLCanvasElement&&this.eventListeners.forEach((t,e)=>{this.canvas.removeEventListener(e,t)}),this.program&&this.gl.deleteProgram(this.program),this.textures.forEach(t=>{this.gl.deleteTexture(t.texture)}),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.hooks.get("destroy")?.forEach(t=>t.call(this)),this.isInternalCanvas&&this.canvas instanceof HTMLCanvasElement&&this.canvas.remove()}},P=L;var A={data:new Uint8Array(4),width:1,height:1};function $(n){let t=Array.from({length:n},(i,r)=>`uniform sampler2D u_confidenceMask${r};`).join(`
`),e=Array.from({length:n},(i,r)=>`		${r>0?"else ":""}if (i == ${r}) c = texelFetch(u_confidenceMask${r}, texCoord, 0).r;`).join(`
`);return`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
${t}

void main() {
	ivec2 texCoord = ivec2(v_uv * vec2(textureSize(u_confidenceMask0, 0)));
	float maxConfidence = 0.0;
	int maxIndex = 0;

	for (int i = 0; i < ${n}; i++) {
		float c = 0.0;
${e}
		if (c > maxConfidence) {
			maxConfidence = c;
			maxIndex = i;
		}
	}

	// Normalize index: 0 = background, 1/(n-1) to 1 for foreground categories.
	float normalizedIndex = float(maxIndex) / float(max(1, ${n-1}));
	outColor = vec4(normalizedIndex, maxConfidence, 0.0, 1.0);
}`}function N(n){let{textureName:t,options:e}=n,i="https://storage.googleapis.com/mediapipe-models/image_segmenter/hair_segmenter/float32/latest/hair_segmenter.tflite";return function(r,s){let{injectGLSL:l,gl:u}=s,o=null,g=null,h=-1,c="VIDEO",f=new Map,b=1,y=new OffscreenCanvas(1,1),p=null;async function U(){try{let{FilesetResolver:m,ImageSegmenter:a}=await import("@mediapipe/tasks-vision");g=await m.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),o=await a.createFromOptions(g,{baseOptions:{modelAssetPath:e?.modelPath||i,delegate:"GPU"},canvas:y,runningMode:c,outputCategoryMask:e?.outputCategoryMask??!1,outputConfidenceMasks:!0});let d=o.getLabels();d.length&&(b=d.length),r.updateUniforms({u_numCategories:b})}catch(m){throw console.error("[Segmenter Plugin] Failed to initialize:",m),m}}function I(m){if(!p)return;let a={};for(let d=0;d<m.length;d++)a[`u_confidenceMask${d}`]=m[d].getAsWebGLTexture();p.updateTextures(a),p.draw(),r.updateTextures({u_segmentMask:y})}function _(m){let{confidenceMasks:a}=m;if(!(!a||a.length===0)){if(!p){let d=$(a.length);p=new P(d,{canvas:y});for(let x=0;x<a.length;x++)p.initializeTexture(`u_confidenceMask${x}`,A)}I(a)}}r.registerHook("init",async()=>{r.initializeTexture("u_segmentMask",A,{preserveY:!0,minFilter:u.NEAREST,magFilter:u.NEAREST}),r.initializeUniform("u_numCategories","int",b),await U()}),r.registerHook("updateTextures",async m=>{let a=m[t];if(!(!a||(f.get(t)!==a&&(h=-1),f.set(t,a),!o)))try{let x=a instanceof HTMLVideoElement?"VIDEO":"IMAGE";if(c!==x&&(c=x,await o.setOptions({runningMode:c})),a instanceof HTMLVideoElement){if(a.videoWidth===0||a.videoHeight===0||a.readyState<2)return;if(a.currentTime!==h){h=a.currentTime;let w=o.segmentForVideo(a,performance.now());_(w)}}else if(a instanceof HTMLImageElement||a instanceof HTMLCanvasElement){if(a.width===0||a.height===0)return;let w=o.segment(a);_(w)}}catch(x){console.error("[Segmenter Plugin] Segmentation error:",x)}}),r.registerHook("destroy",()=>{o&&(o.close(),o=null),p&&(p.destroy(),p=null),g=null,f.clear()}),l(`
uniform sampler2D u_segmentMask;
uniform int u_numCategories;

vec2 segmentAt(vec2 pos) {
	vec4 mask = texture(u_segmentMask, pos);
	return vec2(mask.r, mask.g);
}`)}}var X=N;
//# sourceMappingURL=segmenter.js.map