"use strict";var z=Object.create;var R=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var q=(s,e)=>{for(var t in e)R(s,t,{get:e[t],enumerable:!0})},O=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of V(e))!K.call(s,i)&&i!==t&&R(s,i,{get:()=>e[i],enumerable:!(n=Y(e,i))||n.enumerable});return s};var k=(s,e,t)=>(t=s!=null?z(j(s)):{},O(e||!s||!s.__esModule?R(t,"default",{value:s,enumerable:!0}):t,s)),J=s=>O(R({},"__esModule",{value:!0}),s);var se={};q(se,{default:()=>ne});module.exports=J(se);var Z=`#version 300 es
out vec2 v_uv;
void main() {
    int id = gl_VertexID;
    vec2 uv = vec2(float((id << 1) & 2), float(id & 2));
    gl_Position = vec4(uv * vec2(2.0, -2.0) + vec2(-1.0, 1.0), 0.0, 1.0);
    v_uv = gl_Position.xy * 0.5 + 0.5;
}`,A=Symbol("u_history"),F=Symbol("__SHADERPAD_BUFFER");function Q(s,e){if(!e?.length)return s;let t=s.split(`
`),n=t.findLastIndex(i=>{let r=i.trimStart();return r.startsWith("precision ")||r.startsWith("#version ")})+1;return t.splice(n,0,...e),t.join(`
`)}function D(s){return s instanceof WebGLTexture?{width:0,height:0}:s instanceof P?{width:s.canvas.width,height:s.canvas.height}:s instanceof HTMLVideoElement?{width:s.videoWidth,height:s.videoHeight}:s instanceof HTMLImageElement?{width:s.naturalWidth??s.width,height:s.naturalHeight??s.height}:{width:s.width,height:s.height}}function L(s){return typeof s=="symbol"?s.description??"":s}var P=class s{isHeadless=!1;isTouchDevice=!1;gl;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;program=null;aPositionLocation=0;animationFrameId;eventListeners=new Map;frame=0;startTime=0;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;resolutionObserver=null;hooks=new Map;historyDepth=0;textureOptions;debug;intermediateFbo=null;constructor(e,{canvas:t,plugins:n,history:i,debug:r,...u}={}){if(t&&"getContext"in t)this.canvas=t;else{let{width:a=1,height:f=1}=t||{};this.canvas=new OffscreenCanvas(a,f),this.isHeadless=!0}let o=this.canvas.getContext("webgl2",{antialias:!1});if(!o)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=o,this.textureUnitPool={free:[],next:0,max:o.getParameter(o.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.textureOptions=u,i&&(this.historyDepth=i),this.debug=r??(typeof process<"u"&&!1),this.animationFrameId=null;let m=[];n&&n.forEach(a=>a(this,{gl:o,canvas:this.canvas,injectGLSL:f=>{m.push(f)},emitHook:this.emitHook.bind(this)}));let l=this.gl.createProgram();if(!l)throw new Error("Failed to create WebGL program");this.program=l;let h=this.createShader(this.gl.VERTEX_SHADER,Z),g=this.createShader(o.FRAGMENT_SHADER,Q(e,m));if(o.attachShader(l,h),o.attachShader(l,g),o.linkProgram(l),o.deleteShader(h),o.deleteShader(g),!o.getProgramParameter(l,o.LINK_STATUS))throw console.error("Program link error:",o.getProgramInfoLog(l)),o.deleteProgram(l),new Error("Failed to link WebGL program");if(this.aPositionLocation=o.getAttribLocation(l,"aPosition"),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.useProgram(l),this.canvas instanceof HTMLCanvasElement)this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]});else{let a=f=>{let d=Object.getOwnPropertyDescriptor(OffscreenCanvas.prototype,f);Object.defineProperty(this.canvas,f,{get:()=>d.get.call(this.canvas),set:T=>{d.set.call(this.canvas,T),this.updateResolution()},configurable:d.configurable,enumerable:d.enumerable})};a("width"),a("height")}this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this._initializeTexture(F,this.canvas,{...this.textureOptions}),this.intermediateFbo=o.createFramebuffer(),this.historyDepth>0&&this._initializeTexture(A,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.canvas instanceof HTMLCanvasElement&&this.addEventListeners(),this.emitHook("init")}resolveGLConstant(e){let t=this.gl[e];if(t===void 0)throw new Error(`Unknown GL constant: ${e}`);return t}emitHook(e,...t){this.hooks.get(e)?.forEach(n=>n.call(this,...t))}on(e,t){this.hooks.has(e)||this.hooks.set(e,[]),this.hooks.get(e).push(t)}off(e,t){let n=this.hooks.get(e);n&&n.splice(n.indexOf(t),1)}createShader(e,t){let n=this.gl.createShader(e);if(this.gl.shaderSource(n,t),this.gl.compileShader(n),!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",t),console.error(this.gl.getShaderInfoLog(n)),this.gl.deleteShader(n),new Error("Shader compilation failed");return n}addEventListeners(){let e=this.canvas,t=(i,r)=>{if(!this.uniforms.has("u_cursor"))return;let u=e.getBoundingClientRect();this.cursorPosition[0]=(i-u.left)/u.width,this.cursorPosition[1]=1-(r-u.top)/u.height,this.updateUniforms({u_cursor:this.cursorPosition})},n=(i,r,u)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=i,i){let o=e.getBoundingClientRect(),m=r,l=u;this.clickPosition[0]=(m-o.left)/o.width,this.clickPosition[1]=1-(l-o.top)/o.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",i=>{let r=i;this.isTouchDevice||t(r.clientX,r.clientY)}),this.eventListeners.set("mousedown",i=>{let r=i;this.isTouchDevice||r.button===0&&(this.isMouseDown=!0,n(!0,r.clientX,r.clientY))}),this.eventListeners.set("mouseup",i=>{let r=i;this.isTouchDevice||r.button===0&&n(!1)}),this.eventListeners.set("touchmove",i=>{let r=i;r.touches.length>0&&t(r.touches[0].clientX,r.touches[0].clientY)}),this.eventListeners.set("touchstart",i=>{let r=i;this.isTouchDevice=!0,r.touches.length>0&&(t(r.touches[0].clientX,r.touches[0].clientY),n(!0,r.touches[0].clientX,r.touches[0].clientY))}),this.eventListeners.set("touchend",i=>{i.touches.length===0&&n(!1)}),this.eventListeners.forEach((i,r)=>{e.addEventListener(r,i)})}updateResolution(){let e=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...e),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:e}):this.initializeUniform("u_resolution","float",e),this.resizeTexture(F,...e),this.historyDepth>0&&this.resizeTexture(A,...e),this.emitHook("updateResolution",...e)}resizeTexture(e,t,n){let i=this.textures.get(e);if(!i||i.width===t&&i.height===n)return;this.gl.deleteTexture(i.texture),i.width=t,i.height=n;let{texture:r}=this.createTexture(e,i);i.texture=r,i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}reserveTextureUnit(e){let t=this.textures.get(e);if(t)return t.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}resolveTextureOptions(e){let{gl:t}=this,n=this.resolveGLConstant(e?.type??"UNSIGNED_BYTE"),i={type:n,format:this.resolveGLConstant(e?.format??"RGBA"),internalFormat:this.resolveGLConstant(e?.internalFormat??(n===t.FLOAT?"RGBA32F":n===t.HALF_FLOAT?"RGBA16F":"RGBA8")),minFilter:this.resolveGLConstant(e?.minFilter??"LINEAR"),magFilter:this.resolveGLConstant(e?.magFilter??"LINEAR"),wrapS:this.resolveGLConstant(e?.wrapS??"CLAMP_TO_EDGE"),wrapT:this.resolveGLConstant(e?.wrapT??"CLAMP_TO_EDGE"),preserveY:e?.preserveY};if((i.internalFormat===t.RGBA16F||i.internalFormat===t.RGBA32F)&&!t.getExtension("EXT_color_buffer_float"))throw new Error("Missing EXT_color_buffer_float.");return i}getPixelArray(e,t){return e===this.gl.FLOAT?new Float32Array(t):e===this.gl.HALF_FLOAT?new Uint16Array(t):new Uint8Array(t)}clearHistoryTextureLayers(e){if(!e.history)return;let t=this.gl,{type:n,format:i}=e.options,r=this.getPixelArray(n,e.width*e.height*4);t.activeTexture(t.TEXTURE0+e.unitIndex),t.bindTexture(t.TEXTURE_2D_ARRAY,e.texture);for(let u=0;u<e.history.depth;++u)t.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,u,e.width,e.height,1,i,n,r)}initializeUniform(e,t,n,i){let r=i?.arrayLength;if(this.uniforms.has(e))throw new Error(`${e} is already initialized.`);if(t!=="float"&&t!=="int")throw new Error(`Invalid uniform type: ${t}. Expected 'float' or 'int'.`);if(r&&!(Array.isArray(n)&&n.length===r))throw new Error(`${e} array length mismatch: must initialize with ${r} elements.`);let u=this.gl.getUniformLocation(this.program,e);if(!u&&r&&(u=this.gl.getUniformLocation(this.program,`${e}[0]`)),!u){this.log(`${e} not in shader. Skipping initialization.`);return}let o=r?n[0]:n,m=Array.isArray(o)?o.length:1;this.uniforms.set(e,{type:t,length:m,location:u,arrayLength:r});try{this.updateUniforms({[e]:n})}catch(l){throw this.uniforms.delete(e),l}this.emitHook("initializeUniform",...arguments)}log(...e){this.debug&&console.debug(...e)}updateUniforms(e,t){this.gl.useProgram(this.program),Object.entries(e).forEach(([n,i])=>{let r=this.uniforms.get(n);if(!r){this.log(`${n} not in shader. Skipping update.`);return}let u=`uniform${r.length}${r.type.charAt(0)}`;if(r.arrayLength){if(!Array.isArray(i))throw new Error(`${n} is an array, but the value passed to updateUniforms is not an array.`);let o=i.length;if(!o)return;if(o>r.arrayLength)throw new Error(`${n} received ${o} values, but maximum length is ${r.arrayLength}.`);if(i.some(h=>(Array.isArray(h)?h.length:1)!==r.length))throw new Error(`Tried to update ${n} with some elements that are not length ${r.length}.`);let m=new(r.type==="float"?Float32Array:Int32Array)(i.flat()),l=r.location;if(t?.startIndex){let h=this.gl.getUniformLocation(this.program,`${n}[${t.startIndex}]`);if(!h)throw new Error(`${n}[${t.startIndex}] not in shader. Did you pass an invalid startIndex?`);l=h}this.gl[u+"v"](l,m)}else{if(Array.isArray(i)||(i=[i]),i.length!==r.length)throw new Error(`Invalid uniform value length: ${i.length}. Expected ${r.length}.`);this.gl[u](r.location,...i)}}),this.emitHook("updateUniforms",...arguments)}createTexture(e,t){let{width:n,height:i}=t,r=t.history?.depth??0,u=this.gl.createTexture();if(!u)throw new Error("Failed to create texture");let o=t.unitIndex;if(typeof o!="number")try{o=this.reserveTextureUnit(e)}catch(g){throw this.gl.deleteTexture(u),g}let m=r>0,l=m?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:h}=t;return this.gl.activeTexture(this.gl.TEXTURE0+o),this.gl.bindTexture(l,u),this.gl.texParameteri(l,this.gl.TEXTURE_WRAP_S,h.wrapS),this.gl.texParameteri(l,this.gl.TEXTURE_WRAP_T,h.wrapT),this.gl.texParameteri(l,this.gl.TEXTURE_MIN_FILTER,h.minFilter),this.gl.texParameteri(l,this.gl.TEXTURE_MAG_FILTER,h.magFilter),m?this.gl.texStorage3D(l,1,h.internalFormat,n,i,r):e===F&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,h.internalFormat,n,i,0,h.format,h.type,null),{texture:u,unitIndex:o}}_initializeTexture(e,t,n){if(this.textures.has(e))throw new Error(`Texture '${L(e)}' is already initialized.`);let{history:i=0,...r}=n??{},{width:u,height:o}=D(t);if(!u||!o)throw new Error("Texture source must have valid dimensions");let m={width:u,height:o,options:this.resolveTextureOptions(r)};i>0&&(m.history={depth:i,writeIndex:0});let{texture:l,unitIndex:h}=this.createTexture(e,m),g={texture:l,unitIndex:h,...m};i>0&&(this.initializeUniform(`${L(e)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(g)),this.textures.set(e,g),this.updateTexture(e,t);let a=this.gl.getUniformLocation(this.program,L(e));a&&this.gl.uniform1i(a,h)}initializeTexture(e,t,n){this._initializeTexture(e,t,n),this.emitHook("initializeTexture",...arguments)}updateTextures(e,t){Object.entries(e).forEach(([n,i])=>{this.updateTexture(n,i,t)}),this.emitHook("updateTextures",...arguments)}updateTexture(e,t,n){let i=this.textures.get(e);if(!i)throw new Error(`Texture '${L(e)}' is not initialized.`);if(t instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,t);return}let r=t;if(t instanceof s){let a=t.textures.get(F);if(t.gl===this.gl){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,a.texture);return}let{width:f,height:d,options:{format:T,type:w}}=a,S=this.getPixelArray(w,f*d*4);t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,t.intermediateFbo),t.gl.readPixels(0,0,f,d,T,w,S),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),r={data:S,width:f,height:d}}let{width:u,height:o}=D(r);if(!u||!o)return;let m="isPartial"in r&&r.isPartial;m||this.resizeTexture(e,u,o);let h=!("data"in r&&r.data)&&!i.options?.preserveY,g=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL);if(i.history){if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture),!n?.skipHistoryWrite){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h),this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,i.history.writeIndex,u,o,1,i.options.format,i.options.type,r.data??r),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g);let a=`${L(e)}FrameOffset`;this.updateUniforms({[a]:i.history.writeIndex}),i.history.writeIndex=(i.history.writeIndex+1)%i.history.depth}}else{if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,i.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,h),m){let a=r;this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,a.x??0,a.y??0,u,o,i.options.format,i.options.type,a.data)}else this.gl.texImage2D(this.gl.TEXTURE_2D,0,i.options.internalFormat,u,o,0,i.options.format,i.options.type,r.data??r);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,g)}}bindIntermediate(){let e=this.gl,t=this.textures.get(F);e.bindFramebuffer(e.FRAMEBUFFER,this.intermediateFbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.texture,0)}clear(){this.bindIntermediate(),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}draw(e){this.emitHook("beforeDraw",...arguments);let t=this.gl,n=t.drawingBufferWidth,i=t.drawingBufferHeight;e?.skipClear?this.bindIntermediate():this.clear(),t.useProgram(this.program),t.viewport(0,0,n,i),t.drawArrays(t.TRIANGLES,0,3),this.isHeadless||(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.intermediateFbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.blitFramebuffer(0,0,n,i,0,0,n,i,t.COLOR_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,null)),this.emitHook("afterDraw",...arguments)}step(e){this._step(performance.now()-this.startTime,e)}_step(e,t){this.emitHook("beforeStep",...arguments);let n={};this.uniforms.has("u_time")&&(n.u_time=e),this.uniforms.has("u_frame")&&(n.u_frame=this.frame),this.updateUniforms(n),this.draw(t);let i=this.textures.get(A);if(i&&!t?.skipHistoryWrite){let{writeIndex:r,depth:u}=i.history,o=this.gl;o.bindTexture(o.TEXTURE_2D_ARRAY,i.texture),o.copyTexSubImage3D(o.TEXTURE_2D_ARRAY,0,0,0,r,0,0,o.drawingBufferWidth,o.drawingBufferHeight),this.updateUniforms({[`${L(A)}FrameOffset`]:r}),i.history.writeIndex=(r+1)%u}++this.frame,this.emitHook("afterStep",...arguments)}play(e,t){this.pause();let n=i=>{i=(i-this.startTime)/1e3;let r=e?.(i,this.frame)??void 0;this._step(i,r),this.animationFrameId=requestAnimationFrame(n),t?.(i,this.frame)};this.animationFrameId=requestAnimationFrame(n),this.emitHook("play")}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.emitHook("pause")}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(e=>{e.history&&(e.history.writeIndex=0,this.clearHistoryTextureLayers(e))}),this.clear(),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.canvas instanceof HTMLCanvasElement&&(this.eventListeners.forEach((e,t)=>{this.canvas.removeEventListener(t,e)}),this.eventListeners.clear()),this.resolutionObserver&&(this.resolutionObserver.disconnect(),this.resolutionObserver=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(e=>{this.gl.deleteTexture(e.texture)}),this.textures.clear(),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.uniforms.clear(),this.hooks.clear()}},G=P;var H={data:new Uint8Array(4),width:1,height:1};function M(s){return s instanceof HTMLVideoElement||s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof OffscreenCanvas}function $(s){return JSON.stringify(s,Object.keys(s).sort())}var I=null;function B(){return I||(I=import("@mediapipe/tasks-vision").then(({FilesetResolver:s})=>s.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),I}function W(s){return{historyParams:s?", framesAgo":"",fn:s?(n,i,r,u)=>{let o=r.replace(/\w+ /g,""),m=r?`${r}, int framesAgo`:"int framesAgo",l=o?`${o}, 0`:"0";return`${n} ${i}(${m}) {
${u}
}
${n} ${i}(${r}) { return ${i}(${l}); }`}:(n,i,r,u)=>`${n} ${i}(${r}) {
${u}
}`}}var ee={modelPath:"https://storage.googleapis.com/mediapipe-models/image_segmenter/hair_segmenter/float32/latest/hair_segmenter.tflite",outputCategoryMask:!1};function te(s){let e=Array.from({length:s},(n,i)=>`uniform mediump sampler2D u_confidenceMask${i};`).join(`
`),t=Array.from({length:s},(n,i)=>`		${i>0?"else ":""}if (i == ${i}) c = texelFetch(u_confidenceMask${i}, texCoord, 0).r;`).join(`
`);return`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
${e}

void main() {
	ivec2 texCoord = ivec2(vec2(v_uv.x, 1.0 - v_uv.y) * vec2(textureSize(u_confidenceMask0, 0)));
	float maxConfidence = 0.0;
	int maxIndex = 0;

	for (int i = 0; i < ${s}; ++i) {
		float c = 0.0;
${t}
		if (c > maxConfidence) {
			maxConfidence = c;
			maxIndex = i;
		}
	}

	// Normalize index: 0 = background, 1/(n-1) to 1 for foreground categories.
	float normalizedIndex = float(maxIndex) / float(max(1, ${s-1}));
	outColor = vec4(normalizedIndex, maxConfidence, 0.0, 1.0);
}`}var _=new Map;function ie(s,e){let{maskShader:t}=s,n={};for(let i=0;i<e.length;++i)n[`u_confidenceMask${i}`]=e[i].getAsWebGLTexture();t.updateTextures(n),t.draw(),e.forEach(i=>i.close())}function re(s){let{textureName:e,options:{history:t,...n}={}}=s,i={...ee,...n},r=$({...i,textureName:e});return function(u,o){let{injectGLSL:m,emitHook:l}=o,g=_.get(r)?.mediapipeCanvas??new OffscreenCanvas(1,1),a=null,f=!1,d=!1;function T(){a&&(u.updateTextures({u_segmentMask:a.maskShader},{skipHistoryWrite:d}),l("segmenter:result",a.state.result))}async function w(){if(_.has(r))a=_.get(r);else{let[c,{ImageSegmenter:p}]=await Promise.all([B(),import("@mediapipe/tasks-vision")]);if(f)return;let b=await p.createFromOptions(c,{baseOptions:{modelAssetPath:i.modelPath,delegate:"GPU"},canvas:g,runningMode:"VIDEO",outputCategoryMask:i.outputCategoryMask,outputConfidenceMasks:!0});if(f){b.close();return}let E=b.getLabels(),v=E.length||1,x=new G(te(v),{canvas:g});for(let y=0;y<v;++y)x.initializeTexture(`u_confidenceMask${y}`,H);a={segmenter:b,mediapipeCanvas:g,maskShader:x,subscribers:new Map,state:{runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve()},labels:E,numCategories:v},_.set(r,a)}a.subscribers.set(T,!1)}let S=w();u.on("init",()=>{u.initializeUniform("u_numCategories","int",1),u.initializeTexture("u_segmentMask",g,{minFilter:"NEAREST",magFilter:"NEAREST",history:t}),S.then(()=>{f||!a||(u.updateUniforms({u_numCategories:a.numCategories}),l("segmenter:ready"))})}),u.on("initializeTexture",(c,p)=>{c===e&&M(p)&&C(p)}),u.on("updateTextures",(c,p)=>{let b=c[e];M(b)&&(d=p?.skipHistoryWrite??!1,C(b))});let U=0;async function C(c){let p=performance.now(),b=++U;await S,a&&(a.state.pending=a.state.pending.then(async()=>{if(b!==U||!a)return;let E=c instanceof HTMLVideoElement?"VIDEO":"IMAGE";a.state.runningMode!==E&&(a.state.runningMode=E,await a.segmenter.setOptions({runningMode:E}));let v=!1;if(c!==a.state.source?(a.state.source=c,a.state.videoTime=-1,v=!0):c instanceof HTMLVideoElement?c.currentTime!==a.state.videoTime&&(a.state.videoTime=c.currentTime,v=!0):c instanceof HTMLImageElement||p-a.state.resultTimestamp>2&&(v=!0),v){let x;if(c instanceof HTMLVideoElement){if(c.videoWidth===0||c.videoHeight===0||c.readyState<2)return;x=a.segmenter.segmentForVideo(c,p)}else{if(c.width===0||c.height===0)return;x=a.segmenter.segment(c)}if(x){a.state.resultTimestamp=p,a.state.result=x,x.confidenceMasks&&x.confidenceMasks.length>0?ie(a,x.confidenceMasks):a.maskShader.clear();for(let y of a.subscribers.keys())y(),a.subscribers.set(y,!0)}}else a.state.result&&!a.subscribers.get(T)&&(T(),a.subscribers.set(T,!0))}),await a.state.pending)}u.on("destroy",()=>{f=!0,a&&(a.subscribers.delete(T),a.subscribers.size===0&&(a.segmenter.close(),a.maskShader.destroy(),_.delete(r))),a=null});let{fn:X}=W(t),N=t?`int layer = (u_segmentMaskFrameOffset - framesAgo + ${t}) % ${t};
	vec4 mask = texture(u_segmentMask, vec3(pos, float(layer)));`:"vec4 mask = texture(u_segmentMask, pos);";m(`
uniform ${t?"highp":"mediump"} sampler2D${t?"Array":""} u_segmentMask;${t?`
uniform int u_segmentMaskFrameOffset;`:""}
uniform int u_numCategories;

${X("vec2","segmentAt","vec2 pos",`${N}
	return vec2(mask.r, mask.g);`)}`)}}var ne=re;
//# sourceMappingURL=segmenter.js.map