"use strict";var z=Object.create;var A=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var $=(a,t)=>{for(var e in t)A(a,e,{get:t[e],enumerable:!0})},U=(a,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of G(t))!X.call(a,i)&&i!==e&&A(a,i,{get:()=>t[i],enumerable:!(n=B(t,i))||n.enumerable});return a};var O=(a,t,e)=>(e=a!=null?z(W(a)):{},U(t||!a||!a.__esModule?A(e,"default",{value:a,enumerable:!0}):e,a)),Y=a=>U(A({},"__esModule",{value:!0}),a);var ie={};$(ie,{default:()=>te});module.exports=Y(ie);var N=`#version 300 es
in vec2 aPosition;
out vec2 v_uv;
void main() {
    v_uv = aPosition * 0.5 + 0.5;
    gl_Position = vec4(aPosition, 0.0, 1.0);
}`,V=33.333333333333336,j=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),w=Symbol("u_history"),F=Symbol("__SHADERPAD_BUFFER");function K(a,t){if(!t?.length)return a;let e=a.split(`
`),n=e.findLastIndex(i=>{let r=i.trimStart();return r.startsWith("precision ")||r.startsWith("#version ")})+1;return e.splice(n,0,...t),e.join(`
`)}function C(a){return a instanceof WebGLTexture?{width:0,height:0}:a instanceof P?{width:a.canvas.width,height:a.canvas.height}:a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a instanceof HTMLImageElement?{width:a.naturalWidth??a.width,height:a.naturalHeight??a.height}:{width:a.width,height:a.height}}function _(a){return typeof a=="symbol"?a.description??"":a}var P=class a{isInternalCanvas=!1;isTouchDevice=!1;gl;uniforms=new Map;textures=new Map;textureUnitPool;buffer=null;program=null;aPositionLocation=0;animationFrameId;resolutionObserver;resizeObserver;resizeTimeout=null;lastResizeTime=-1/0;eventListeners=new Map;frame=0;startTime=0;cursorPosition=[.5,.5];clickPosition=[.5,.5];isMouseDown=!1;canvas;hooks=new Map;historyDepth=0;textureOptions;debug;intermediateFbo=null;constructor(t,{canvas:e,plugins:n,history:i,debug:r,...u}={}){if(this.canvas=e||document.createElement("canvas"),!e){this.isInternalCanvas=!0;let d=this.canvas;d.style.position="fixed",d.style.inset="0",d.style.height="100dvh",d.style.width="100dvw",document.body.appendChild(d)}if(this.canvas instanceof OffscreenCanvas){let d=x=>{let T=Object.getOwnPropertyDescriptor(OffscreenCanvas.prototype,x);Object.defineProperty(this.canvas,x,{get:()=>T.get.call(this.canvas),set:l=>{T.set.call(this.canvas,l),this.updateResolution()},configurable:T.configurable,enumerable:T.enumerable})};d("width"),d("height")}let s=this.canvas.getContext("webgl2",{antialias:!1});if(!s)throw new Error("WebGL2 not supported. Please use a browser that supports WebGL2.");this.gl=s,this.textureUnitPool={free:[],next:0,max:s.getParameter(s.MAX_COMBINED_TEXTURE_IMAGE_UNITS)},this.textureOptions=u;let{internalFormat:h,type:c}=u;(c===s.FLOAT||c===s.HALF_FLOAT||h===s.RGBA16F||h===s.RGBA32F||h===s.R16F||h===s.R32F||h===s.RG16F||h===s.RG32F)&&!s.getExtension("EXT_color_buffer_float")&&(console.warn("EXT_color_buffer_float not supported, falling back to RGBA8"),delete this.textureOptions?.internalFormat,delete this.textureOptions?.format,delete this.textureOptions?.type),i&&(this.historyDepth=i),this.debug=r??(typeof process<"u"&&!1),this.animationFrameId=null,this.resolutionObserver=new MutationObserver(()=>this.updateResolution()),this.resizeObserver=new ResizeObserver(()=>this.throttledHandleResize());let f=[];n&&n.forEach(d=>d(this,{gl:s,canvas:this.canvas,injectGLSL:x=>{f.push(x)},emitHook:this.emitHook.bind(this)}));let o=this.gl.createProgram();if(!o)throw new Error("Failed to create WebGL program");this.program=o;let g=this.createShader(this.gl.VERTEX_SHADER,N),b=this.createShader(s.FRAGMENT_SHADER,K(t,f));if(s.attachShader(o,g),s.attachShader(o,b),s.linkProgram(o),s.deleteShader(g),s.deleteShader(b),!s.getProgramParameter(o,s.LINK_STATUS))throw console.error("Program link error:",s.getProgramInfoLog(o)),s.deleteProgram(o),new Error("Failed to link WebGL program");this.aPositionLocation=s.getAttribLocation(o,"aPosition"),this.buffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,j,s.STATIC_DRAW),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.enableVertexAttribArray(this.aPositionLocation),s.vertexAttribPointer(this.aPositionLocation,2,s.FLOAT,!1,0,0),s.useProgram(o),this.canvas instanceof HTMLCanvasElement&&(this.resolutionObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}),this.resizeObserver.observe(this.canvas)),this.isInternalCanvas||this.updateResolution(),this.initializeUniform("u_cursor","float",this.cursorPosition),this.initializeUniform("u_click","float",[...this.clickPosition,this.isMouseDown?1:0]),this.initializeUniform("u_time","float",0),this.initializeUniform("u_frame","int",0),this._initializeTexture(F,this.canvas,{...this.textureOptions}),this.intermediateFbo=s.createFramebuffer(),this.historyDepth>0&&this._initializeTexture(w,this.canvas,{history:this.historyDepth,...this.textureOptions}),this.canvas instanceof HTMLCanvasElement&&this.addEventListeners(),this.emitHook("init")}emitHook(t,...e){this.hooks.get(t)?.forEach(n=>n.call(this,...e))}on(t,e){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(e)}off(t,e){let n=this.hooks.get(t);n&&n.splice(n.indexOf(e),1)}createShader(t,e){let n=this.gl.createShader(t);if(this.gl.shaderSource(n,e),this.gl.compileShader(n),!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS))throw console.error("Shader compilation failed:",e),console.error(this.gl.getShaderInfoLog(n)),this.gl.deleteShader(n),new Error("Shader compilation failed");return n}throttledHandleResize(){clearTimeout(this.resizeTimeout);let t=performance.now(),e=this.lastResizeTime+V-t;e<=0?(this.lastResizeTime=t,this.handleResize()):this.resizeTimeout=setTimeout(()=>this.throttledHandleResize(),e)}handleResize(){if(!(this.canvas instanceof HTMLCanvasElement))return;let t=window.devicePixelRatio||1,e=this.canvas.clientWidth*t,n=this.canvas.clientHeight*t;this.isInternalCanvas&&(this.canvas.width!==e||this.canvas.height!==n)&&(this.canvas.width=e,this.canvas.height=n),this.emitHook("resize",e,n)}addEventListeners(){let t=this.canvas,e=(i,r)=>{if(!this.uniforms.has("u_cursor"))return;let u=t.getBoundingClientRect();this.cursorPosition[0]=(i-u.left)/u.width,this.cursorPosition[1]=1-(r-u.top)/u.height,this.updateUniforms({u_cursor:this.cursorPosition})},n=(i,r,u)=>{if(this.uniforms.has("u_click")){if(this.isMouseDown=i,i){let s=t.getBoundingClientRect(),h=r,c=u;this.clickPosition[0]=(h-s.left)/s.width,this.clickPosition[1]=1-(c-s.top)/s.height}this.updateUniforms({u_click:[...this.clickPosition,this.isMouseDown?1:0]})}};this.eventListeners.set("mousemove",i=>{let r=i;this.isTouchDevice||e(r.clientX,r.clientY)}),this.eventListeners.set("mousedown",i=>{let r=i;this.isTouchDevice||r.button===0&&(this.isMouseDown=!0,n(!0,r.clientX,r.clientY))}),this.eventListeners.set("mouseup",i=>{let r=i;this.isTouchDevice||r.button===0&&n(!1)}),this.eventListeners.set("touchmove",i=>{let r=i;r.touches.length>0&&e(r.touches[0].clientX,r.touches[0].clientY)}),this.eventListeners.set("touchstart",i=>{let r=i;this.isTouchDevice=!0,r.touches.length>0&&(e(r.touches[0].clientX,r.touches[0].clientY),n(!0,r.touches[0].clientX,r.touches[0].clientY))}),this.eventListeners.set("touchend",i=>{i.touches.length===0&&n(!1)}),this.eventListeners.forEach((i,r)=>{t.addEventListener(r,i)})}updateResolution(){let t=[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight];this.gl.viewport(0,0,...t),this.uniforms.has("u_resolution")?this.updateUniforms({u_resolution:t}):this.initializeUniform("u_resolution","float",t),this.resizeTexture(F,...t),this.historyDepth>0&&this.resizeTexture(w,...t),this.emitHook("updateResolution",...t)}resizeTexture(t,e,n){let i=this.textures.get(t);if(!i||i.width===e&&i.height===n)return;this.gl.deleteTexture(i.texture),i.width=e,i.height=n;let{texture:r}=this.createTexture(t,i);i.texture=r,i.history&&(i.history.writeIndex=0,this.clearHistoryTextureLayers(i))}reserveTextureUnit(t){let e=this.textures.get(t);if(e)return e.unitIndex;if(this.textureUnitPool.free.length>0)return this.textureUnitPool.free.pop();if(this.textureUnitPool.next>=this.textureUnitPool.max)throw new Error("Exceeded the available texture units for this device.");return this.textureUnitPool.next++}releaseTextureUnit(t){let e=this.textures.get(t);e&&this.textureUnitPool.free.push(e.unitIndex)}resolveTextureOptions(t){let{gl:e}=this,n=t?.type??e.UNSIGNED_BYTE;return{type:n,format:t?.format??e.RGBA,internalFormat:t?.internalFormat??(n===e.FLOAT?e.RGBA32F:n===e.HALF_FLOAT?e.RGBA16F:e.RGBA8),minFilter:t?.minFilter??e.LINEAR,magFilter:t?.magFilter??e.LINEAR,wrapS:t?.wrapS??e.CLAMP_TO_EDGE,wrapT:t?.wrapT??e.CLAMP_TO_EDGE,preserveY:t?.preserveY}}getPixelArray(t,e){return t===this.gl.FLOAT?new Float32Array(e):t===this.gl.HALF_FLOAT?new Uint16Array(e):new Uint8Array(e)}clearHistoryTextureLayers(t){if(!t.history)return;let e=this.gl,{type:n,format:i}=t.options,r=this.getPixelArray(n,t.width*t.height*4);e.activeTexture(e.TEXTURE0+t.unitIndex),e.bindTexture(e.TEXTURE_2D_ARRAY,t.texture);for(let u=0;u<t.history.depth;++u)e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,u,t.width,t.height,1,i,n,r)}initializeUniform(t,e,n,i){let r=i?.arrayLength;if(this.uniforms.has(t))throw new Error(`${t} is already initialized.`);if(e!=="float"&&e!=="int")throw new Error(`Invalid uniform type: ${e}. Expected 'float' or 'int'.`);if(r&&!(Array.isArray(n)&&n.length===r))throw new Error(`${t} array length mismatch: must initialize with ${r} elements.`);let u=this.gl.getUniformLocation(this.program,t);if(!u&&r&&(u=this.gl.getUniformLocation(this.program,`${t}[0]`)),!u){this.log(`${t} not in shader. Skipping initialization.`);return}let s=r?n[0]:n,h=Array.isArray(s)?s.length:1;this.uniforms.set(t,{type:e,length:h,location:u,arrayLength:r});try{this.updateUniforms({[t]:n})}catch(c){throw this.uniforms.delete(t),c}this.emitHook("initializeUniform",...arguments)}log(...t){this.debug&&console.debug(...t)}updateUniforms(t,e){this.gl.useProgram(this.program),Object.entries(t).forEach(([n,i])=>{let r=this.uniforms.get(n);if(!r){this.log(`${n} not in shader. Skipping update.`);return}let u=`uniform${r.length}${r.type.charAt(0)}`;if(r.arrayLength){if(!Array.isArray(i))throw new Error(`${n} is an array, but the value passed to updateUniforms is not an array.`);let s=i.length;if(!s)return;if(s>r.arrayLength)throw new Error(`${n} received ${s} values, but maximum length is ${r.arrayLength}.`);if(i.some(m=>(Array.isArray(m)?m.length:1)!==r.length))throw new Error(`Tried to update ${n} with some elements that are not length ${r.length}.`);let h=new(r.type==="float"?Float32Array:Int32Array)(i.flat()),c=r.location;if(e?.startIndex){let m=this.gl.getUniformLocation(this.program,`${n}[${e.startIndex}]`);if(!m)throw new Error(`${n}[${e.startIndex}] not in shader. Did you pass an invalid startIndex?`);c=m}this.gl[u+"v"](c,h)}else{if(Array.isArray(i)||(i=[i]),i.length!==r.length)throw new Error(`Invalid uniform value length: ${i.length}. Expected ${r.length}.`);this.gl[u](r.location,...i)}}),this.emitHook("updateUniforms",...arguments)}createTexture(t,e){let{width:n,height:i}=e,r=e.history?.depth??0,u=this.gl.createTexture();if(!u)throw new Error("Failed to create texture");let s=e.unitIndex;if(typeof s!="number")try{s=this.reserveTextureUnit(t)}catch(f){throw this.gl.deleteTexture(u),f}let h=r>0,c=h?this.gl.TEXTURE_2D_ARRAY:this.gl.TEXTURE_2D,{options:m}=e;return this.gl.activeTexture(this.gl.TEXTURE0+s),this.gl.bindTexture(c,u),this.gl.texParameteri(c,this.gl.TEXTURE_WRAP_S,m.wrapS),this.gl.texParameteri(c,this.gl.TEXTURE_WRAP_T,m.wrapT),this.gl.texParameteri(c,this.gl.TEXTURE_MIN_FILTER,m.minFilter),this.gl.texParameteri(c,this.gl.TEXTURE_MAG_FILTER,m.magFilter),h?this.gl.texStorage3D(c,1,m.internalFormat,n,i,r):t===F&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,m.internalFormat,n,i,0,m.format,m.type,null),{texture:u,unitIndex:s}}_initializeTexture(t,e,n){if(this.textures.has(t))throw new Error(`Texture '${_(t)}' is already initialized.`);let{history:i=0,...r}=n??{},{width:u,height:s}=C(e);if(!u||!s)throw new Error("Texture source must have valid dimensions");let h={width:u,height:s,options:this.resolveTextureOptions(r)};i>0&&(h.history={depth:i,writeIndex:0});let{texture:c,unitIndex:m}=this.createTexture(t,h),f={texture:c,unitIndex:m,...h};i>0&&(this.initializeUniform(`${_(t)}FrameOffset`,"int",0),this.clearHistoryTextureLayers(f)),this.textures.set(t,f),this.updateTexture(t,e);let o=this.gl.getUniformLocation(this.program,_(t));o&&this.gl.uniform1i(o,m)}initializeTexture(t,e,n){this._initializeTexture(t,e,n),this.emitHook("initializeTexture",...arguments)}updateTextures(t,e){Object.entries(t).forEach(([n,i])=>{this.updateTexture(n,i,e)}),this.emitHook("updateTextures",...arguments)}updateTexture(t,e,n){let i=this.textures.get(t);if(!i)throw new Error(`Texture '${_(t)}' is not initialized.`);if(e instanceof WebGLTexture){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,e);return}let r=e;if(e instanceof a){let o=e.textures.get(F);if(e.gl===this.gl){this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,o.texture);return}let{width:g,height:b,options:{format:d,type:x}}=o,T=this.getPixelArray(x,g*b*4);e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,e.intermediateFbo),e.gl.readPixels(0,0,g,b,d,x,T),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),r={data:T,width:g,height:b}}let{width:u,height:s}=C(r);if(!u||!s)return;let h="isPartial"in r&&r.isPartial;h||this.resizeTexture(t,u,s);let m=!("data"in r&&r.data)&&!i.options?.preserveY,f=this.gl.getParameter(this.gl.UNPACK_FLIP_Y_WEBGL);if(i.history){if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,i.texture),!n?.skipHistoryWrite){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,m),this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,i.history.writeIndex,u,s,1,i.options.format,i.options.type,r.data??r),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,f);let o=`${_(t)}FrameOffset`;this.updateUniforms({[o]:i.history.writeIndex}),i.history.writeIndex=(i.history.writeIndex+1)%i.history.depth}}else{if(this.gl.activeTexture(this.gl.TEXTURE0+i.unitIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,i.texture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,m),h){let o=r;this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,o.x??0,o.y??0,u,s,i.options.format,i.options.type,o.data)}else this.gl.texImage2D(this.gl.TEXTURE_2D,0,i.options.internalFormat,u,s,0,i.options.format,i.options.type,r.data??r);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,f)}}draw(t){this.emitHook("beforeDraw",...arguments);let e=this.gl,n=e.drawingBufferWidth,i=e.drawingBufferHeight,r=this.textures.get(F);e.bindFramebuffer(e.FRAMEBUFFER,this.intermediateFbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r.texture,0),e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.vertexAttribPointer(this.aPositionLocation,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.aPositionLocation),e.viewport(0,0,n,i),t?.skipClear||e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLES,0,6);let u=this.textures.get(w);u&&!t?.skipHistoryWrite&&(e.bindTexture(e.TEXTURE_2D_ARRAY,u.texture),e.copyTexSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,u.history.writeIndex,0,0,n,i)),e.bindFramebuffer(e.READ_FRAMEBUFFER,this.intermediateFbo),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.blitFramebuffer(0,0,n,i,0,0,n,i,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,null),this.emitHook("afterDraw",...arguments)}step(t,e){this.emitHook("beforeStep",...arguments);let n={};this.uniforms.has("u_time")&&(n.u_time=t),this.uniforms.has("u_frame")&&(n.u_frame=this.frame),this.updateUniforms(n),this.draw(e);let i=this.textures.get(w);if(i&&!e?.skipHistoryWrite){let{writeIndex:r,depth:u}=i.history;this.updateUniforms({[`${_(w)}FrameOffset`]:r}),i.history.writeIndex=(r+1)%u}++this.frame,this.emitHook("afterStep",...arguments)}play(t,e){this.pause();let n=i=>{i=(i-this.startTime)/1e3;let r=e?.(i,this.frame)??void 0;this.step(i,r),this.animationFrameId=requestAnimationFrame(n),t?.(i,this.frame)};this.animationFrameId=requestAnimationFrame(n),this.emitHook("play")}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.emitHook("pause")}reset(){this.frame=0,this.startTime=performance.now(),this.textures.forEach(t=>{t.history&&(t.history.writeIndex=0,this.clearHistoryTextureLayers(t))}),this.emitHook("reset")}destroy(){this.emitHook("destroy"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resolutionObserver.disconnect(),this.resizeObserver.disconnect(),this.canvas instanceof HTMLCanvasElement&&this.eventListeners.forEach((t,e)=>{this.canvas.removeEventListener(e,t)}),this.program&&this.gl.deleteProgram(this.program),this.intermediateFbo&&(this.gl.deleteFramebuffer(this.intermediateFbo),this.intermediateFbo=null),this.textures.forEach(t=>{this.gl.deleteTexture(t.texture)}),this.textureUnitPool.free=[],this.textureUnitPool.next=0,this.buffer&&(this.gl.deleteBuffer(this.buffer),this.buffer=null),this.isInternalCanvas&&this.canvas instanceof HTMLCanvasElement&&this.canvas.remove()}},k=P;function M(a){return a instanceof HTMLVideoElement||a instanceof HTMLImageElement||a instanceof HTMLCanvasElement||a instanceof OffscreenCanvas}function D(a){return JSON.stringify(a,Object.keys(a).sort())}var I=null;function H(){return I||(I=import("@mediapipe/tasks-vision").then(({FilesetResolver:a})=>a.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),I}var q={data:new Uint8Array(4),width:1,height:1},Z={modelPath:"https://storage.googleapis.com/mediapipe-models/image_segmenter/hair_segmenter/float32/latest/hair_segmenter.tflite",outputCategoryMask:!1};function J(a){let t=Array.from({length:a},(n,i)=>`uniform sampler2D u_confidenceMask${i};`).join(`
`),e=Array.from({length:a},(n,i)=>`		${i>0?"else ":""}if (i == ${i}) c = texelFetch(u_confidenceMask${i}, texCoord, 0).r;`).join(`
`);return`#version 300 es
precision mediump float;
in vec2 v_uv;
out vec4 outColor;
${t}

void main() {
	ivec2 texCoord = ivec2(v_uv * vec2(textureSize(u_confidenceMask0, 0)));
	float maxConfidence = 0.0;
	int maxIndex = 0;

	for (int i = 0; i < ${a}; ++i) {
		float c = 0.0;
${e}
		if (c > maxConfidence) {
			maxConfidence = c;
			maxIndex = i;
		}
	}

	// Normalize index: 0 = background, 1/(n-1) to 1 for foreground categories.
	float normalizedIndex = float(maxIndex) / float(max(1, ${a-1}));
	outColor = vec4(normalizedIndex, maxConfidence, 0.0, 1.0);
}`}var L=new Map;function Q(a,t){let{mask:{shader:e}}=a,n={};for(let i=0;i<t.length;++i)n[`u_confidenceMask${i}`]=t[i].getAsWebGLTexture();e.updateTextures(n),e.draw(),t.forEach(i=>i.close())}function ee(a){let{textureName:t,options:e={}}=a,n={...Z,...e},i=D({...n,textureName:t});return function(r,u){let{injectGLSL:s,gl:h,emitHook:c}=u,f=L.get(i)?.canvas??new OffscreenCanvas(1,1),o=null;function g(){o&&(r.updateTextures({u_segmentMask:o.canvas}),c("segmenter:result",o.state.result))}async function b(){if(L.has(i))o=L.get(i);else{let[l,{ImageSegmenter:p}]=await Promise.all([H(),import("@mediapipe/tasks-vision")]),S=await p.createFromOptions(l,{baseOptions:{modelAssetPath:n.modelPath,delegate:"GPU"},canvas:f,runningMode:"VIDEO",outputCategoryMask:n.outputCategoryMask,outputConfidenceMasks:!0}),y=S.getLabels(),E=y.length||1,v=new k(J(E),{canvas:f});for(let R=0;R<E;++R)v.initializeTexture(`u_confidenceMask${R}`,q);o={segmenter:S,canvas:f,subscribers:new Map,state:{runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve()},labels:y,numCategories:E,mask:{shader:v}},L.set(i,o)}o.subscribers.set(g,!1)}let d=b();r.on("init",()=>{r.initializeUniform("u_numCategories","int",1),r.initializeTexture("u_segmentMask",f,{preserveY:!0,minFilter:h.NEAREST,magFilter:h.NEAREST}),d.then(()=>{r.updateUniforms({u_numCategories:o.numCategories}),c("segmenter:ready")})}),r.on("initializeTexture",(l,p)=>{l===t&&M(p)&&T(p)}),r.on("updateTextures",l=>{let p=l[t];M(p)&&T(p)});let x=0;async function T(l){let p=performance.now(),S=++x;await d,o&&(o.state.pending=o.state.pending.then(async()=>{if(S!==x||!o)return;let y=l instanceof HTMLVideoElement?"VIDEO":"IMAGE";o.state.runningMode!==y&&(o.state.runningMode=y,await o.segmenter.setOptions({runningMode:y}));let E=!1;if(l!==o.state.source?(o.state.source=l,o.state.videoTime=-1,E=!0):l instanceof HTMLVideoElement?l.currentTime!==o.state.videoTime&&(o.state.videoTime=l.currentTime,E=!0):l instanceof HTMLImageElement||p-o.state.resultTimestamp>2&&(E=!0),E){let v;if(l instanceof HTMLVideoElement){if(l.videoWidth===0||l.videoHeight===0||l.readyState<2)return;v=o.segmenter.segmentForVideo(l,p)}else{if(l.width===0||l.height===0)return;v=o.segmenter.segment(l)}if(v?.confidenceMasks&&v.confidenceMasks.length>0){o.state.resultTimestamp=p,o.state.result=v,Q(o,v.confidenceMasks);for(let R of o.subscribers.keys())R(),o.subscribers.set(R,!0)}}else o.state.result&&!o.subscribers.get(g)&&(g(),o.subscribers.set(g,!0))}),await o.state.pending)}r.on("destroy",()=>{o&&(o.subscribers.delete(g),o.subscribers.size===0&&(o.segmenter.close(),o.mask.shader?.destroy(),L.delete(i))),o=null}),s(`
uniform sampler2D u_segmentMask;
uniform int u_numCategories;

vec2 segmentAt(vec2 pos) {
	vec4 mask = texture(u_segmentMask, pos);
	return vec2(mask.r, mask.g);
}`)}}var te=ee;
//# sourceMappingURL=segmenter.js.map