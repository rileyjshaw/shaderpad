"use strict";var B=Object.create;var S=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var Y=(e,o)=>{for(var a in o)S(e,a,{get:o[a],enumerable:!0})},R=(e,o,a,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of j(o))!q.call(e,t)&&t!==a&&S(e,t,{get:()=>o[t],enumerable:!(s=W(o,t))||s.enumerable});return e};var w=(e,o,a)=>(a=e!=null?B(X(e)):{},R(o||!e||!e.__esModule?S(a,"default",{value:e,enumerable:!0}):a,e)),J=e=>R(S({},"__esModule",{value:!0}),e);var ie={};Y(ie,{default:()=>ae});module.exports=J(ie);var se={data:new Uint8Array(4),width:1,height:1};function $(e){return e instanceof HTMLVideoElement||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}function V(e){return JSON.stringify(e,Object.keys(e).sort())}function U(e,o,a,s,t=0){let i=1/0,u=-1/0,m=1/0,d=-1/0,f=0,g=0;for(let h of a){let c=(t+o*s+h)*4,D=e[c],L=e[c+1];i=Math.min(i,D),u=Math.max(u,D),m=Math.min(m,L),d=Math.max(d,L),f+=e[c+2],g+=e[c+3]}return[(i+u)/2,(m+d)/2,f/a.length,g/a.length]}var O=null;function z(){return O||(O=import("@mediapipe/tasks-vision").then(({FilesetResolver:e})=>e.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),O}function K(e){return{historyParams:e?", framesAgo":"",fn:e?(s,t,i,u)=>{let m=i.replace(/\w+ /g,""),d=i?`${i}, int framesAgo`:"int framesAgo",f=m?`${m}, 0`:"0";return`${s} ${t}(${d}) {
${u}
}
${s} ${t}(${i}) { return ${t}(${f}); }`}:(s,t,i,u)=>`${s} ${t}(${i}) {
${u}
}`}}var C=21,Z=1,H=C+Z,Q=[0,0,5,9,13,17],p=512,k=1,ee={modelPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",maxHands:2,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},b=new Map;function ne(e,o,a){let s=e.landmarks.data,t=o.length;s[0]=t;for(let i=0;i<t;++i){let u=o[i],m=a[i]?.[0]?.categoryName==="Right";for(let g=0;g<C;++g){let h=u[g],c=(k+i*H+g)*4;s[c]=h.x,s[c+1]=1-h.y,s[c+2]=h.z??0,s[c+3]=m?1:0}let d=U(s,i,Q,H,k),f=(k+i*H+C)*4;s[f]=d[0],s[f+1]=d[1],s[f+2]=d[2],s[f+3]=m?1:0}e.state.nHands=t}function te(e){let{textureName:o,options:{history:a,...s}={}}=e,t={...ee,...s},i=V({...t,textureName:o}),u=t.maxHands*H+k,m=Math.ceil(u/p);return function(d,f){let{injectGLSL:g,gl:h,emitHook:c}=f,L=b.get(i)?.landmarks.data??new Float32Array(p*m*4),n=null,I=!1;function y(){if(!n)return;let{nHands:r}=n.state,l=r*H+k,x=Math.ceil(l/p);d.updateTextures({u_handLandmarksTex:{data:n.landmarks.data,width:p,height:x,isPartial:!0}},{skipHistoryWrite:I}),d.updateUniforms({u_nHands:r}),c("hands:result",n.state.result)}async function G(){if(b.has(i))n=b.get(i);else{let[r,{HandLandmarker:l}]=await Promise.all([z(),import("@mediapipe/tasks-vision")]),x=new OffscreenCanvas(1,1);n={landmarker:await l.createFromOptions(r,{baseOptions:{modelAssetPath:t.modelPath,delegate:"GPU"},canvas:x,runningMode:"VIDEO",numHands:t.maxHands,minHandDetectionConfidence:t.minHandDetectionConfidence,minHandPresenceConfidence:t.minHandPresenceConfidence,minTrackingConfidence:t.minTrackingConfidence}),canvas:x,subscribers:new Map,maxHands:t.maxHands,state:{runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nHands:0},landmarks:{data:L,textureHeight:m}},b.set(i,n)}n.subscribers.set(y,!1)}let v=G();d.on("init",()=>{d.initializeUniform("u_maxHands","int",t.maxHands),d.initializeUniform("u_nHands","int",0),d.initializeTexture("u_handLandmarksTex",{data:L,width:p,height:m},{internalFormat:h.RGBA32F,type:h.FLOAT,minFilter:h.NEAREST,magFilter:h.NEAREST,history:a}),v.then(()=>c("hands:ready"))}),d.on("initializeTexture",(r,l)=>{r===o&&$(l)&&E(l)}),d.on("updateTextures",(r,l)=>{let x=r[o];$(x)&&(I=l?.skipHistoryWrite??!1,E(x))});let P=0;async function E(r){let l=performance.now(),x=++P;await v,n&&(n.state.pending=n.state.pending.then(async()=>{if(x!==P||!n)return;let A=r instanceof HTMLVideoElement?"VIDEO":"IMAGE";n.state.runningMode!==A&&(n.state.runningMode=A,await n.landmarker.setOptions({runningMode:A}));let _=!1;if(r!==n.state.source?(n.state.source=r,n.state.videoTime=-1,_=!0):r instanceof HTMLVideoElement?r.currentTime!==n.state.videoTime&&(n.state.videoTime=r.currentTime,_=!0):r instanceof HTMLImageElement||l-n.state.resultTimestamp>2&&(_=!0),_){let T;if(r instanceof HTMLVideoElement){if(r.videoWidth===0||r.videoHeight===0||r.readyState<2)return;T=n.landmarker.detectForVideo(r,l)}else{if(r.width===0||r.height===0)return;T=n.landmarker.detect(r)}if(T){n.state.resultTimestamp=l,n.state.result=T,ne(n,T.landmarks,T.handedness);for(let F of n.subscribers.keys())F(),n.subscribers.set(F,!0)}}else n.state.result&&!n.subscribers.get(y)&&(y(),n.subscribers.set(y,!0))}),await n.state.pending)}d.on("destroy",()=>{n&&(n.subscribers.delete(y),n.subscribers.size===0&&(n.landmarker.close(),b.delete(i))),n=null});let{fn:M,historyParams:N}=K(a);g(`
uniform int u_maxHands;
uniform int u_nHands;
uniform highp sampler2D${a?"Array":""} u_handLandmarksTex;${a?`
uniform int u_handLandmarksTexFrameOffset;`:""}

${M("int","nHandsAt","",a?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${a}) % ${a};
	return int(texelFetch(u_handLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_handLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${M("vec4","handLandmark","int handIndex, int landmarkIndex",`int i = ${k} + handIndex * ${H} + landmarkIndex;
	int x = i % ${p};
	int y = i / ${p};${a?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${a}) % ${a};
	return texelFetch(u_handLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_handLandmarksTex, ivec2(x, y), 0);`}`)}
${M("float","isRightHand","int handIndex",`return handLandmark(handIndex, 0${N}).w;`)}
${M("float","isLeftHand","int handIndex",`return 1.0 - handLandmark(handIndex, 0${N}).w;`)}`)}}var ae=te;
//# sourceMappingURL=hands.js.map