"use strict";var B=Object.create;var D=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var Y=(n,o)=>{for(var a in o)D(n,a,{get:o[a],enumerable:!0})},R=(n,o,a,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of j(o))!q.call(n,t)&&t!==a&&D(n,t,{get:()=>o[t],enumerable:!(s=W(o,t))||s.enumerable});return n};var w=(n,o,a)=>(a=n!=null?B(X(n)):{},R(o||!n||!n.__esModule?D(a,"default",{value:n,enumerable:!0}):a,n)),J=n=>R(D({},"__esModule",{value:!0}),n);var ie={};Y(ie,{default:()=>ae});module.exports=J(ie);var se={data:new Uint8Array(4),width:1,height:1};function $(n){return n instanceof HTMLVideoElement||n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof OffscreenCanvas}function V(n){return JSON.stringify(n,Object.keys(n).sort())}function U(n,o,a,s,t=0){let i=1/0,c=-1/0,m=1/0,d=-1/0,u=0,h=0;for(let p of a){let f=(t+o*s+p)*4,y=n[f],e=n[f+1];i=Math.min(i,y),c=Math.max(c,y),m=Math.min(m,e),d=Math.max(d,e),u+=n[f+2],h+=n[f+3]}return[(i+c)/2,(m+d)/2,u/a.length,h/a.length]}var O=null;function z(){return O||(O=import("@mediapipe/tasks-vision").then(({FilesetResolver:n})=>n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm"))),O}function K(n){return{historyParams:n?", framesAgo":"",fn:n?(s,t,i,c)=>{let m=i.replace(/\w+ /g,""),d=i?`${i}, int framesAgo`:"int framesAgo",u=m?`${m}, 0`:"0";return`${s} ${t}(${d}) {
${c}
}
${s} ${t}(${i}) { return ${t}(${u}); }`}:(s,t,i,c)=>`${s} ${t}(${i}) {
${c}
}`}}var C=21,Z=1,k=C+Z,Q=[0,0,5,9,13,17],x=512,L=1,ee={modelPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",maxHands:2,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},M=new Map;function ne(n,o,a){let s=n.landmarks.data,t=o.length;s[0]=t;for(let i=0;i<t;++i){let c=o[i],m=a[i]?.[0]?.categoryName==="Right";for(let h=0;h<C;++h){let p=c[h],f=(L+i*k+h)*4;s[f]=p.x,s[f+1]=1-p.y,s[f+2]=p.z??0,s[f+3]=m?1:0}let d=U(s,i,Q,k,L),u=(L+i*k+C)*4;s[u]=d[0],s[u+1]=d[1],s[u+2]=d[2],s[u+3]=m?1:0}n.state.nHands=t}function te(n){let{textureName:o,options:{history:a,...s}={}}=n,t={...ee,...s},i=V({...t,textureName:o}),c=t.maxHands*k+L,m=Math.ceil(c/x);return function(d,u){let{injectGLSL:h,emitHook:p}=u,y=M.get(i)?.landmarks.data??new Float32Array(x*m*4),e=null,A=!1,I=!1;function b(){if(!e)return;let{nHands:r}=e.state,l=r*k+L,g=Math.ceil(l/x);d.updateTextures({u_handLandmarksTex:{data:e.landmarks.data,width:x,height:g,isPartial:!0}},{skipHistoryWrite:I}),d.updateUniforms({u_nHands:r}),p("hands:result",e.state.result)}async function G(){if(M.has(i))e=M.get(i);else{let[r,{HandLandmarker:l}]=await Promise.all([z(),import("@mediapipe/tasks-vision")]);if(A)return;let g=new OffscreenCanvas(1,1),T=await l.createFromOptions(r,{baseOptions:{modelAssetPath:t.modelPath,delegate:"GPU"},canvas:g,runningMode:"VIDEO",numHands:t.maxHands,minHandDetectionConfidence:t.minHandDetectionConfidence,minHandPresenceConfidence:t.minHandPresenceConfidence,minTrackingConfidence:t.minTrackingConfidence});if(A){T.close();return}e={landmarker:T,mediapipeCanvas:g,subscribers:new Map,maxHands:t.maxHands,state:{runningMode:"VIDEO",source:null,videoTime:-1,resultTimestamp:0,result:null,pending:Promise.resolve(),nHands:0},landmarks:{data:y,textureHeight:m}},M.set(i,e)}e.subscribers.set(b,!1)}let P=G();d.on("init",()=>{d.initializeUniform("u_maxHands","int",t.maxHands),d.initializeUniform("u_nHands","int",0),d.initializeTexture("u_handLandmarksTex",{data:y,width:x,height:m},{internalFormat:"RGBA32F",type:"FLOAT",minFilter:"NEAREST",magFilter:"NEAREST",history:a}),P.then(()=>{A||!e||p("hands:ready")})}),d.on("initializeTexture",(r,l)=>{r===o&&$(l)&&E(l)}),d.on("updateTextures",(r,l)=>{let g=r[o];$(g)&&(I=l?.skipHistoryWrite??!1,E(g))});let v=0;async function E(r){let l=performance.now(),g=++v;await P,e&&(e.state.pending=e.state.pending.then(async()=>{if(g!==v||!e)return;let T=r instanceof HTMLVideoElement?"VIDEO":"IMAGE";e.state.runningMode!==T&&(e.state.runningMode=T,await e.landmarker.setOptions({runningMode:T}));let S=!1;if(r!==e.state.source?(e.state.source=r,e.state.videoTime=-1,S=!0):r instanceof HTMLVideoElement?r.currentTime!==e.state.videoTime&&(e.state.videoTime=r.currentTime,S=!0):r instanceof HTMLImageElement||l-e.state.resultTimestamp>2&&(S=!0),S){let H;if(r instanceof HTMLVideoElement){if(r.videoWidth===0||r.videoHeight===0||r.readyState<2)return;H=e.landmarker.detectForVideo(r,l)}else{if(r.width===0||r.height===0)return;H=e.landmarker.detect(r)}if(H){e.state.resultTimestamp=l,e.state.result=H,ne(e,H.landmarks,H.handedness);for(let F of e.subscribers.keys())F(),e.subscribers.set(F,!0)}}else e.state.result&&!e.subscribers.get(b)&&(b(),e.subscribers.set(b,!0))}),await e.state.pending)}d.on("destroy",()=>{A=!0,e&&(e.subscribers.delete(b),e.subscribers.size===0&&(e.landmarker.close(),M.delete(i))),e=null});let{fn:_,historyParams:N}=K(a);h(`
uniform int u_maxHands;
uniform int u_nHands;
uniform highp sampler2D${a?"Array":""} u_handLandmarksTex;${a?`
uniform int u_handLandmarksTexFrameOffset;`:""}

${_("int","nHandsAt","",a?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${a}) % ${a};
	return int(texelFetch(u_handLandmarksTex, ivec3(0, 0, layer), 0).r + 0.5);`:`
	return int(texelFetch(u_handLandmarksTex, ivec2(0, 0), 0).r + 0.5);`)}
${_("vec4","handLandmark","int handIndex, int landmarkIndex",`int i = ${L} + handIndex * ${k} + landmarkIndex;
	int x = i % ${x};
	int y = i / ${x};${a?`
	int layer = (u_handLandmarksTexFrameOffset - framesAgo + ${a}) % ${a};
	return texelFetch(u_handLandmarksTex, ivec3(x, y, layer), 0);`:`
	return texelFetch(u_handLandmarksTex, ivec2(x, y), 0);`}`)}
${_("float","isRightHand","int handIndex",`return handLandmark(handIndex, 0${N}).w;`)}
${_("float","isLeftHand","int handIndex",`return 1.0 - handLandmark(handIndex, 0${N}).w;`)}`)}}var ae=te;
//# sourceMappingURL=hands.js.map