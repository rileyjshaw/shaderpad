var h=33;function E(_){let{textureName:w,options:d}=_,L="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task";return function(c,T){let{injectGLSL:v}=T,l=null,k=null,x=-1,C=new Map,p=d?.maxPoses??1,I=512,S=512,i=document.createElement("canvas");i.width=I,i.height=S;let s=i.getContext("2d"),f=document.createElement("canvas"),y=f.getContext("2d");s.globalCompositeOperation=y.globalCompositeOperation="lighten";let P=[];async function D(){try{let{FilesetResolver:n,PoseLandmarker:o}=await import("@mediapipe/tasks-vision");k=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),P.push(...o.POSE_CONNECTIONS),l=await o.createFromOptions(k,{baseOptions:{modelAssetPath:d?.modelPath||L},runningMode:"VIDEO",numPoses:d?.maxPoses??1,minPoseDetectionConfidence:d?.minPoseDetectionConfidence??.5,minPosePresenceConfidence:d?.minPosePresenceConfidence??.5,minTrackingConfidence:d?.minTrackingConfidence??.5,outputSegmentationMasks:d?.outputSegmentationMasks??!0})}catch(n){throw console.error("[Pose Plugin] Failed to initialize Pose Landmarker:",n),n}}function O(n){let o=1/0,e=-1/0,t=1/0,a=-1/0;for(let r of n)o=Math.min(o,r.x),e=Math.max(e,r.x),t=Math.min(t,r.y),a=Math.max(a,r.y);let m=(o+e)/2,u=(t+a)/2;return[m,u]}async function z(n,o){if(!l){console.warn("[Pose Plugin] Cannot update mask: poseLandmarker missing");return}try{if(s.clearRect(0,0,i.width,i.height),o&&o.length>0&&o.forEach(e=>{if(!e)return;let{width:t,height:a}=e,m=e.getAsUint8Array(),u=t*a,r=new Uint8ClampedArray(u*4);for(let g=0;g<u;g++)r[g*4+1]=m[g],r[g*4+3]=255;let M=new ImageData(r,t,a);t===i.width&&a===i.height?s.putImageData(M,0,0):(f.width!==t&&(f.width=t),f.height!==a&&(f.height=a),y.putImageData(M,0,0),s.drawImage(f,0,0,i.width,i.height))}),P.length){let e=Math.max(2,i.width/256);s.lineWidth=e,s.lineCap="round",s.strokeStyle="#00f",n.forEach(t=>{P.forEach(({start:a,end:m})=>{let u=t[a],r=t[m];!u||!r||(u.visibility??1)<.3||(r.visibility??1)<.3||(s.beginPath(),s.moveTo(u.x*i.width,u.y*i.height),s.lineTo(r.x*i.width,r.y*i.height),s.stroke())})})}c.updateTextures({u_poseMask:i})}catch(e){console.error("[Pose Plugin] Failed to generate mask texture:",e)}}function b(n){if(!n.landmarks)return;z(n.landmarks,n.segmentationMasks).catch(t=>{console.warn("[Pose Plugin] Mask texture update error:",t)});let o=n.landmarks.length,e={u_nPoses:o};if(o){e.u_poseLandmarks=n.landmarks.flatMap(a=>a.map(m=>[m.x,1-m.y]));let t=[];for(let a of n.landmarks){let m=O(a);t.push([m[0],1-m[1]])}e.u_poseCenter=t}c.updateUniforms(e)}c.registerHook("init",async()=>{c.initializeTexture("u_poseMask",i),c.initializeUniform("u_maxPoses","int",p),c.initializeUniform("u_nPoses","int",0);let n=Array.from({length:p*h},()=>[.5,.5]);c.initializeUniform("u_poseLandmarks","float",n,{arrayLength:p*h});let o=Array.from({length:p},()=>[.5,.5]);c.initializeUniform("u_poseCenter","float",o,{arrayLength:p}),await D()}),c.registerHook("updateTextures",n=>{Object.entries(n).forEach(([o,e])=>{if(o===w&&(C.set(o,e),!!l))try{if(e instanceof HTMLVideoElement){if(e.currentTime!==x){x=e.currentTime;let t=performance.now(),a=l.detectForVideo(e,t);b(a)}}else if(e instanceof HTMLImageElement){let t=l.detect(e);b(t)}}catch(t){console.error("[Pose Plugin] Pose detection error:",t)}})}),c.registerHook("destroy",()=>{l&&(l.close(),l=null),k=null,C.clear(),i.remove()}),v(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform vec2 u_poseLandmarks[${p*h}];
uniform sampler2D u_poseMask;
uniform vec2 u_poseCenter[${p}];
vec2 poseLandmark(int poseIndex, int landmarkIndex) {
	return u_poseLandmarks[poseIndex * ${h} + landmarkIndex];
}
float getBody(vec2 pos) { return texture(u_poseMask, pos).g; }
float getSkeleton(vec2 pos) { return texture(u_poseMask, pos).b; }`)}}var N=E;export{N as default};
//# sourceMappingURL=pose.mjs.map