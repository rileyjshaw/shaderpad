var h=33;function N(L){let{textureName:k,options:d}=L,_="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task";return function(u,v){let{injectGLSL:T}=v,l=null,P=null,x=-1,C=new Map,p=d?.maxPoses??1,S=512,I=512,o=document.createElement("canvas");o.width=S,o.height=I;let s=o.getContext("2d"),f=document.createElement("canvas"),M=f.getContext("2d");s.globalCompositeOperation=M.globalCompositeOperation="lighten";let y=[];async function D(){try{let{FilesetResolver:n,PoseLandmarker:e}=await import("@mediapipe/tasks-vision");P=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),y.push(...e.POSE_CONNECTIONS),l=await e.createFromOptions(P,{baseOptions:{modelAssetPath:d?.modelPath||_},runningMode:"VIDEO",numPoses:d?.maxPoses??1,minPoseDetectionConfidence:d?.minPoseDetectionConfidence??.5,minPosePresenceConfidence:d?.minPosePresenceConfidence??.5,minTrackingConfidence:d?.minTrackingConfidence??.5,outputSegmentationMasks:d?.outputSegmentationMasks??!0})}catch(n){throw console.error("[Pose Plugin] Failed to initialize Pose Landmarker:",n),n}}function z(n){let e=1/0,r=-1/0,t=1/0,i=-1/0;for(let a of n)e=Math.min(e,a.x),r=Math.max(r,a.x),t=Math.min(t,a.y),i=Math.max(i,a.y);let m=(e+r)/2,c=(t+i)/2;return[m,c]}async function E(n,e){if(!l){console.warn("[Pose Plugin] Cannot update mask: poseLandmarker missing");return}try{if(s.clearRect(0,0,o.width,o.height),e&&e.length>0&&e.forEach(r=>{if(!r)return;let{width:t,height:i}=r,m=r.getAsUint8Array(),c=t*i,a=new Uint8ClampedArray(c*4);for(let g=0;g<c;g++)a[g*4+1]=m[g],a[g*4+3]=255;let w=new ImageData(a,t,i);t===o.width&&i===o.height?s.putImageData(w,0,0):(f.width!==t&&(f.width=t),f.height!==i&&(f.height=i),M.putImageData(w,0,0),s.drawImage(f,0,0,o.width,o.height))}),y.length){let r=Math.max(2,o.width/256);s.lineWidth=r,s.lineCap="round",s.strokeStyle="#00f",n.forEach(t=>{y.forEach(({start:i,end:m})=>{let c=t[i],a=t[m];!c||!a||(c.visibility??1)<.3||(a.visibility??1)<.3||(s.beginPath(),s.moveTo(c.x*o.width,c.y*o.height),s.lineTo(a.x*o.width,a.y*o.height),s.stroke())})})}u.updateTextures({u_poseMask:o})}catch(r){console.error("[Pose Plugin] Failed to generate mask texture:",r)}}function b(n){if(!n.landmarks)return;E(n.landmarks,n.segmentationMasks).catch(t=>{console.warn("[Pose Plugin] Mask texture update error:",t)});let e=n.landmarks.length,r={u_nPoses:e};if(e){r.u_poseLandmarks=n.landmarks.flatMap(i=>i.map(m=>[m.x,1-m.y]));let t=[];for(let i of n.landmarks){let m=z(i);t.push([m[0],1-m[1]])}r.u_poseCenter=t}u.updateUniforms(r)}u.registerHook("init",async()=>{u.initializeTexture("u_poseMask",o),u.initializeUniform("u_maxPoses","int",p),u.initializeUniform("u_nPoses","int",0);let n=Array.from({length:p*h},()=>[.5,.5]);u.initializeUniform("u_poseLandmarks","float",n,{arrayLength:p*h});let e=Array.from({length:p},()=>[.5,.5]);u.initializeUniform("u_poseCenter","float",e,{arrayLength:p}),await D()}),u.registerHook("updateTextures",n=>{let e=n[k];if(!(!e||(C.get(k)!==e&&(x=-1),C.set(k,e),!l)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==x){x=e.currentTime;let t=performance.now(),i=l.detectForVideo(e,t);b(i)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let t=l.detect(e);b(t)}}catch(t){console.error("[Pose Plugin] Pose detection error:",t)}}),u.registerHook("destroy",()=>{l&&(l.close(),l=null),P=null,C.clear(),o.remove()}),T(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform vec2 u_poseLandmarks[${p*h}];
uniform sampler2D u_poseMask;
uniform vec2 u_poseCenter[${p}];
vec2 poseLandmark(int poseIndex, int landmarkIndex) {
	return u_poseLandmarks[poseIndex * ${h} + landmarkIndex];
}
float getBody(vec2 pos) { return texture(u_poseMask, pos).g; }
float getSkeleton(vec2 pos) { return texture(u_poseMask, pos).b; }`)}}var O=N;export{O as default};
//# sourceMappingURL=pose.mjs.map