var u=33,q=6,T=u+q,t={LEFT_EYE:2,RIGHT_EYE:5,LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_HIP:23,RIGHT_HIP:24,LEFT_KNEE:25,RIGHT_KNEE:26,LEFT_WRIST:15,RIGHT_WRIST:16,LEFT_PINKY:17,RIGHT_PINKY:18,LEFT_INDEX:19,RIGHT_INDEX:20,LEFT_THUMB:21,RIGHT_THUMB:22,LEFT_ANKLE:27,RIGHT_ANKLE:28,LEFT_HEEL:29,RIGHT_HEEL:30,LEFT_FOOT_INDEX:31,RIGHT_FOOT_INDEX:32,BODY_CENTER:u,LEFT_HAND_CENTER:u+1,RIGHT_HAND_CENTER:u+2,LEFT_FOOT_CENTER:u+3,RIGHT_FOOT_CENTER:u+4,TORSO_CENTER:u+5};function J($){let{textureName:M,options:d}=$,B="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task";return function(c,Y){let{injectGLSL:W,gl:x}=Y,R=null,G=null,K=-1,y=new Map,U=d?.maxPoses??1,I=512,w=0,e=null,X=512,z=512,E=document.createElement("canvas");E.width=X,E.height=z;let h=E.getContext("2d"),f=document.createElement("canvas"),v=f.getContext("2d");h.globalCompositeOperation=v.globalCompositeOperation="lighten";async function V(){try{let{FilesetResolver:o,PoseLandmarker:n}=await import("@mediapipe/tasks-vision");G=await o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),R=await n.createFromOptions(G,{baseOptions:{modelAssetPath:d?.modelPath||B},runningMode:"VIDEO",numPoses:d?.maxPoses??1,minPoseDetectionConfidence:d?.minPoseDetectionConfidence??.5,minPosePresenceConfidence:d?.minPosePresenceConfidence??.5,minTrackingConfidence:d?.minTrackingConfidence??.5,outputSegmentationMasks:d?.outputSegmentationMasks??!0})}catch(o){throw console.error("[Pose Plugin] Failed to initialize Pose Landmarker:",o),o}}function O(o,n,r){let s=1/0,i=-1/0,L=1/0,_=-1/0,l=0,a=0;for(let A of r){let m=(n*T+A)*4,N=o[m],H=o[m+1];s=Math.min(s,N),i=Math.max(i,N),L=Math.min(L,H),_=Math.max(_,H),l+=o[m+2],a+=o[m+3]}let p=(s+i)/2,P=(L+_)/2,g=l/r.length,F=a/r.length;return[p,P,g,F]}async function j(o){if(!R||!e){console.warn("[Pose Plugin] Cannot update mask: poseLandmarker or landmarksDataArray missing");return}try{h.clearRect(0,0,E.width,E.height),o&&o.length>0&&o.forEach(n=>{if(!n)return;let{width:r,height:s}=n,i=n.getAsUint8Array(),L=r*s,_=new Uint8ClampedArray(L*4);for(let a=0;a<L;a++)_[a*4+1]=i[a],_[a*4+3]=255;let l=new ImageData(_,r,s);r===E.width&&s===E.height?h.putImageData(l,0,0):(f.width!==r&&(f.width=r),f.height!==s&&(f.height=s),v.putImageData(l,0,0),h.drawImage(f,0,0,E.width,E.height))}),c.updateTextures({u_poseMask:E})}catch(n){console.error("[Pose Plugin] Failed to generate mask texture:",n)}}function Z(o){if(!e)return;let n=o.length,r=n*T;for(let i=0;i<n;++i){let L=o[i];for(let D=0;D<u;++D){let C=L[D],S=(i*T+D)*4;e[S]=C.x,e[S+1]=1-C.y,e[S+2]=C.z??0,e[S+3]=C.visibility??1}let _=O(e,i,Array.from({length:u},(D,C)=>C)),l=(i*T+t.BODY_CENTER)*4;e[l]=_[0],e[l+1]=_[1],e[l+2]=_[2],e[l+3]=_[3];let a=O(e,i,[t.LEFT_WRIST,t.LEFT_PINKY,t.LEFT_THUMB,t.LEFT_INDEX]),p=(i*T+t.LEFT_HAND_CENTER)*4;e[p]=a[0],e[p+1]=a[1],e[p+2]=a[2],e[p+3]=a[3];let P=O(e,i,[t.RIGHT_WRIST,t.RIGHT_PINKY,t.RIGHT_THUMB,t.RIGHT_INDEX]),g=(i*T+t.RIGHT_HAND_CENTER)*4;e[g]=P[0],e[g+1]=P[1],e[g+2]=P[2],e[g+3]=P[3];let F=O(e,i,[t.LEFT_ANKLE,t.LEFT_HEEL,t.LEFT_FOOT_INDEX]),A=(i*T+t.LEFT_FOOT_CENTER)*4;e[A]=F[0],e[A+1]=F[1],e[A+2]=F[2],e[A+3]=F[3];let m=O(e,i,[t.RIGHT_ANKLE,t.RIGHT_HEEL,t.RIGHT_FOOT_INDEX]),N=(i*T+t.RIGHT_FOOT_CENTER)*4;e[N]=m[0],e[N+1]=m[1],e[N+2]=m[2],e[N+3]=m[3];let H=O(e,i,[t.LEFT_SHOULDER,t.RIGHT_SHOULDER,t.LEFT_HIP,t.RIGHT_HIP]),k=(i*T+t.TORSO_CENTER)*4;e[k]=H[0],e[k+1]=H[1],e[k+2]=H[2],e[k+3]=H[3]}let s=Math.ceil(r/I);c.updateTextures({u_poseLandmarksTex:{data:e,width:I,height:s}})}function b(o){if(!o.landmarks||!e)return;let n=o.landmarks.length;Z(o.landmarks),j(o.segmentationMasks).catch(r=>{console.warn("[Pose Plugin] Mask texture update error:",r)}),c.updateUniforms({u_nPoses:n}),d?.onResults?.(o)}c.registerHook("init",async()=>{c.initializeTexture("u_poseMask",E),c.initializeUniform("u_maxPoses","int",U),c.initializeUniform("u_nPoses","int",0);let o=U*T;w=Math.ceil(o/I);let n=I*w*4;e=new Float32Array(n),c.initializeTexture("u_poseLandmarksTex",{data:e,width:I,height:w},{internalFormat:x.RGBA32F,type:x.FLOAT,minFilter:x.NEAREST,magFilter:x.NEAREST}),await V()}),c.registerHook("updateTextures",o=>{let n=o[M];if(!(!n||(y.get(M)!==n&&(K=-1),y.set(M,n),!R)))try{if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;if(n.currentTime!==K){K=n.currentTime;let s=performance.now(),i=R.detectForVideo(n,s);b(i)}}else if(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement){if(n.width===0||n.height===0)return;let s=R.detect(n);b(s)}}catch(s){console.error("[Pose Plugin] Pose detection error:",s)}}),c.registerHook("destroy",()=>{R&&(R.close(),R=null),G=null,y.clear(),E.remove(),e=null}),W(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform sampler2D u_poseLandmarksTex;
uniform sampler2D u_poseMask;

#define POSE_LANDMARK_LEFT_EYE ${t.LEFT_EYE}
#define POSE_LANDMARK_RIGHT_EYE ${t.RIGHT_EYE}
#define POSE_LANDMARK_LEFT_SHOULDER ${t.LEFT_SHOULDER}
#define POSE_LANDMARK_RIGHT_SHOULDER ${t.RIGHT_SHOULDER}
#define POSE_LANDMARK_LEFT_ELBOW ${t.LEFT_ELBOW}
#define POSE_LANDMARK_RIGHT_ELBOW ${t.RIGHT_ELBOW}
#define POSE_LANDMARK_LEFT_HIP ${t.LEFT_HIP}
#define POSE_LANDMARK_RIGHT_HIP ${t.RIGHT_HIP}
#define POSE_LANDMARK_LEFT_KNEE ${t.LEFT_KNEE}
#define POSE_LANDMARK_RIGHT_KNEE ${t.RIGHT_KNEE}
#define POSE_LANDMARK_BODY_CENTER ${t.BODY_CENTER}
#define POSE_LANDMARK_LEFT_HAND_CENTER ${t.LEFT_HAND_CENTER}
#define POSE_LANDMARK_RIGHT_HAND_CENTER ${t.RIGHT_HAND_CENTER}
#define POSE_LANDMARK_LEFT_FOOT_CENTER ${t.LEFT_FOOT_CENTER}
#define POSE_LANDMARK_RIGHT_FOOT_CENTER ${t.RIGHT_FOOT_CENTER}
#define POSE_LANDMARK_TORSO_CENTER ${t.TORSO_CENTER}

vec4 poseLandmark(int poseIndex, int landmarkIndex) {
	int i = poseIndex * ${T} + landmarkIndex;
	int x = i % ${I};
	int y = i / ${I};
	return texelFetch(u_poseLandmarksTex, ivec2(x, y), 0);
}
float inBody(vec2 pos) { return texture(u_poseMask, pos).g; }`)}}var Q=J;export{Q as default};
//# sourceMappingURL=pose.mjs.map