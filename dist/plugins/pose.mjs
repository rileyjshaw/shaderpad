var u=33,q=6,T=u+q,t={LEFT_EYE:2,RIGHT_EYE:5,LEFT_SHOULDER:11,RIGHT_SHOULDER:12,LEFT_ELBOW:13,RIGHT_ELBOW:14,LEFT_HIP:23,RIGHT_HIP:24,LEFT_KNEE:25,RIGHT_KNEE:26,LEFT_WRIST:15,RIGHT_WRIST:16,LEFT_PINKY:17,RIGHT_PINKY:18,LEFT_INDEX:19,RIGHT_INDEX:20,LEFT_THUMB:21,RIGHT_THUMB:22,LEFT_ANKLE:27,RIGHT_ANKLE:28,LEFT_HEEL:29,RIGHT_HEEL:30,LEFT_FOOT_INDEX:31,RIGHT_FOOT_INDEX:32,BODY_CENTER:u,LEFT_HAND_CENTER:u+1,RIGHT_HAND_CENTER:u+2,LEFT_FOOT_CENTER:u+3,RIGHT_FOOT_CENTER:u+4,TORSO_CENTER:u+5};function J($){let{textureName:M,options:L}=$,B="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task";return function(c,Y){let{injectGLSL:W,gl:x}=Y,d=null,G=null,K=-1,y=new Map,U=L?.maxPoses??1,I=512,w=0,e=null,X=512,z=512,E=document.createElement("canvas");E.width=X,E.height=z;let h=E.getContext("2d"),f=document.createElement("canvas"),v=f.getContext("2d");h.globalCompositeOperation=v.globalCompositeOperation="lighten";async function V(){try{let{FilesetResolver:o,PoseLandmarker:n}=await import("@mediapipe/tasks-vision");G=await o.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),d=await n.createFromOptions(G,{baseOptions:{modelAssetPath:L?.modelPath||B},runningMode:"VIDEO",numPoses:L?.maxPoses??1,minPoseDetectionConfidence:L?.minPoseDetectionConfidence??.5,minPosePresenceConfidence:L?.minPosePresenceConfidence??.5,minTrackingConfidence:L?.minTrackingConfidence??.5,outputSegmentationMasks:L?.outputSegmentationMasks??!0})}catch(o){throw console.error("[Pose Plugin] Failed to initialize Pose Landmarker:",o),o}}function O(o,n,s){let r=1/0,i=-1/0,R=1/0,_=-1/0,m=0,a=0;for(let A of s){let l=(n*T+A)*4,N=o[l],H=o[l+1];r=Math.min(r,N),i=Math.max(i,N),R=Math.min(R,H),_=Math.max(_,H),m+=o[l+2],a+=o[l+3]}let p=(r+i)/2,g=(R+_)/2,F=m/s.length,P=a/s.length;return[p,g,F,P]}async function j(o){if(!d||!e){console.warn("[Pose Plugin] Cannot update mask: poseLandmarker or landmarksDataArray missing");return}try{h.clearRect(0,0,E.width,E.height),o&&o.length>0&&o.forEach(n=>{if(!n)return;let{width:s,height:r}=n,i=n.getAsUint8Array(),R=s*r,_=new Uint8ClampedArray(R*4);for(let a=0;a<R;a++)_[a*4+1]=i[a],_[a*4+3]=255;let m=new ImageData(_,s,r);s===E.width&&r===E.height?h.putImageData(m,0,0):(f.width!==s&&(f.width=s),f.height!==r&&(f.height=r),v.putImageData(m,0,0),h.drawImage(f,0,0,E.width,E.height))}),c.updateTextures({u_poseMask:E})}catch(n){console.error("[Pose Plugin] Failed to generate mask texture:",n)}}function Z(o){if(!e)return;let n=o.length,s=n*T;for(let i=0;i<n;++i){let R=o[i];for(let D=0;D<u;++D){let C=R[D],k=(i*T+D)*4;e[k]=C.x,e[k+1]=1-C.y,e[k+2]=C.z??0,e[k+3]=C.visibility??1}let _=O(e,i,Array.from({length:u},(D,C)=>C)),m=(i*T+t.BODY_CENTER)*4;e[m]=_[0],e[m+1]=_[1],e[m+2]=_[2],e[m+3]=_[3];let a=O(e,i,[t.LEFT_WRIST,t.LEFT_PINKY,t.LEFT_THUMB,t.LEFT_INDEX]),p=(i*T+t.LEFT_HAND_CENTER)*4;e[p]=a[0],e[p+1]=a[1],e[p+2]=a[2],e[p+3]=a[3];let g=O(e,i,[t.RIGHT_WRIST,t.RIGHT_PINKY,t.RIGHT_THUMB,t.RIGHT_INDEX]),F=(i*T+t.RIGHT_HAND_CENTER)*4;e[F]=g[0],e[F+1]=g[1],e[F+2]=g[2],e[F+3]=g[3];let P=O(e,i,[t.LEFT_ANKLE,t.LEFT_HEEL,t.LEFT_FOOT_INDEX]),A=(i*T+t.LEFT_FOOT_CENTER)*4;e[A]=P[0],e[A+1]=P[1],e[A+2]=P[2],e[A+3]=P[3];let l=O(e,i,[t.RIGHT_ANKLE,t.RIGHT_HEEL,t.RIGHT_FOOT_INDEX]),N=(i*T+t.RIGHT_FOOT_CENTER)*4;e[N]=l[0],e[N+1]=l[1],e[N+2]=l[2],e[N+3]=l[3];let H=O(e,i,[t.LEFT_SHOULDER,t.RIGHT_SHOULDER,t.LEFT_HIP,t.RIGHT_HIP]),S=(i*T+t.TORSO_CENTER)*4;e[S]=H[0],e[S+1]=H[1],e[S+2]=H[2],e[S+3]=H[3]}let r=Math.ceil(s/I);c.updateTextures({u_poseLandmarksTex:{data:e,width:I,height:r}})}function b(o){if(!o.landmarks||!e)return;let n=o.landmarks.length;Z(o.landmarks),j(o.segmentationMasks).catch(s=>{console.warn("[Pose Plugin] Mask texture update error:",s)}),c.updateUniforms({u_nPoses:n})}c.registerHook("init",async()=>{c.initializeTexture("u_poseMask",E),c.initializeUniform("u_maxPoses","int",U),c.initializeUniform("u_nPoses","int",0);let o=U*T;w=Math.ceil(o/I);let n=I*w*4;e=new Float32Array(n),c.initializeTexture("u_poseLandmarksTex",{data:e,width:I,height:w},{internalFormat:x.RGBA32F,type:x.FLOAT,minFilter:x.NEAREST,magFilter:x.NEAREST}),await V()}),c.registerHook("updateTextures",o=>{let n=o[M];if(!(!n||(y.get(M)!==n&&(K=-1),y.set(M,n),!d)))try{if(n instanceof HTMLVideoElement){if(n.videoWidth===0||n.videoHeight===0||n.readyState<2)return;if(n.currentTime!==K){K=n.currentTime;let r=performance.now(),i=d.detectForVideo(n,r);b(i)}}else if(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement){if(n.width===0||n.height===0)return;let r=d.detect(n);b(r)}}catch(r){console.error("[Pose Plugin] Pose detection error:",r)}}),c.registerHook("destroy",()=>{d&&(d.close(),d=null),G=null,y.clear(),E.remove(),e=null}),W(`
uniform int u_maxPoses;
uniform int u_nPoses;
uniform sampler2D u_poseLandmarksTex;
uniform sampler2D u_poseMask;

#define POSE_LANDMARK_LEFT_EYE ${t.LEFT_EYE}
#define POSE_LANDMARK_RIGHT_EYE ${t.RIGHT_EYE}
#define POSE_LANDMARK_LEFT_SHOULDER ${t.LEFT_SHOULDER}
#define POSE_LANDMARK_RIGHT_SHOULDER ${t.RIGHT_SHOULDER}
#define POSE_LANDMARK_LEFT_ELBOW ${t.LEFT_ELBOW}
#define POSE_LANDMARK_RIGHT_ELBOW ${t.RIGHT_ELBOW}
#define POSE_LANDMARK_LEFT_HIP ${t.LEFT_HIP}
#define POSE_LANDMARK_RIGHT_HIP ${t.RIGHT_HIP}
#define POSE_LANDMARK_LEFT_KNEE ${t.LEFT_KNEE}
#define POSE_LANDMARK_RIGHT_KNEE ${t.RIGHT_KNEE}
#define POSE_LANDMARK_BODY_CENTER ${t.BODY_CENTER}
#define POSE_LANDMARK_LEFT_HAND_CENTER ${t.LEFT_HAND_CENTER}
#define POSE_LANDMARK_RIGHT_HAND_CENTER ${t.RIGHT_HAND_CENTER}
#define POSE_LANDMARK_LEFT_FOOT_CENTER ${t.LEFT_FOOT_CENTER}
#define POSE_LANDMARK_RIGHT_FOOT_CENTER ${t.RIGHT_FOOT_CENTER}
#define POSE_LANDMARK_TORSO_CENTER ${t.TORSO_CENTER}

vec4 poseLandmark(int poseIndex, int landmarkIndex) {
	int i = poseIndex * ${T} + landmarkIndex;
	int x = i % ${I};
	int y = i / ${I};
	return texelFetch(u_poseLandmarksTex, ivec2(x, y), 0);
}
float inBody(vec2 pos) { return texture(u_poseMask, pos).g; }`)}}var Q=J;export{Q as default};
//# sourceMappingURL=pose.mjs.map