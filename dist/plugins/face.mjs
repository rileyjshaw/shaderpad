var s={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function O(k){let{textureName:h,options:u}=k,C="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(r,M){let{uniforms:d,injectGLSL:R}=M,m=null,_=null,F=-1,T=new Map,c=u?.maxFaces??1,I=512,v=512,o=document.createElement("canvas");o.width=I,o.height=v;let f=o.getContext("2d");f.globalCompositeOperation="lighten";async function N(){try{let{FilesetResolver:n,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");_=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),m=await e.createFromOptions(_,{baseOptions:{modelAssetPath:u?.modelPath||C},runningMode:"VIDEO",numFaces:u?.maxFaces??1,minFaceDetectionConfidence:u?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:u?.minFacePresenceConfidence??.5,minTrackingConfidence:u?.minTrackingConfidence??.5,outputFaceBlendshapes:u?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:u?.outputFacialTransformationMatrixes??!1})}catch(n){throw console.error("Failed to initialize Face Landmarker:",n),n}}function S(n){let e=1/0,a=-1/0,i=1/0,t=-1/0;for(let g of n)e=Math.min(e,g.x),a=Math.max(a,g.x),i=Math.min(i,g.y),t=Math.max(t,g.y);let E=(e+a)/2,p=(i+t)/2;return[E,p]}function l(n,e){f.fillStyle=`rgb(${Math.round(e.r*255)}, ${Math.round(e.g*255)}, ${Math.round(e.b*255)})`;let a=n[0];f.beginPath(),f.moveTo(a.x*o.width,a.y*o.height);for(let i=1;i<n.length;i++){let t=n[i];f.lineTo(t.x*o.width,t.y*o.height)}f.closePath(),f.fill()}async function w(n){if(!m){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");f.clearRect(0,0,o.width,o.height),n.forEach((a,i)=>{l(s.OUTER_LIP.map(t=>a[t]),{r:.25,g:0,b:0}),l(s.INNER_LIP.map(t=>a[t]),{r:.75,g:0,b:0}),l(e.FACE_LANDMARKS_TESSELATION.map(({start:t})=>a[t]),{r:0,g:.25,b:0}),l(e.FACE_LANDMARKS_FACE_OVAL.map(({start:t})=>a[t]),{r:0,g:1,b:0}),l(s.LEFT_EYEBROW.map(t=>a[t]),{r:0,g:0,b:.15}),l(s.RIGHT_EYEBROW.map(t=>a[t]),{r:0,g:0,b:.35}),l(s.LEFT_EYE.map(t=>a[t]),{r:0,g:0,b:.65}),l(s.RIGHT_EYE.map(t=>a[t]),{r:0,g:0,b:.85})}),r.updateTextures({u_faceMask:o})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function b(n){if(!n.faceLandmarks)return;let e=[],a=[],i=[],t=[];for(let p of n.faceLandmarks){let g=S(p),y=p[s.LEFT_EYE_CENTER],x=p[s.RIGHT_EYE_CENTER],L=p[s.NOSE_TIP];e.push([g[0],1-g[1]]),a.push([y.x,1-y.y]),i.push([x.x,1-x.y]),t.push([L.x,1-L.y])}w(n.faceLandmarks).catch(p=>{console.warn("Mask texture update error:",p)});let E={u_nFaces:n.faceLandmarks.length};n.faceLandmarks.length&&(d.has("u_faceCenter")&&(E.u_faceCenter=e),d.has("u_leftEye")&&(E.u_leftEye=a),d.has("u_rightEye")&&(E.u_rightEye=i),d.has("u_noseTip")&&(E.u_noseTip=t)),r.updateUniforms(E)}r.registerHook("init",async()=>{r.initializeTexture("u_faceMask",o),r.initializeUniform("u_maxFaces","int",c),r.initializeUniform("u_nFaces","int",0);let n=Array.from({length:c},()=>[.5,.5]);r.initializeUniform("u_faceCenter","float",n,{arrayLength:c}),r.initializeUniform("u_leftEye","float",n,{arrayLength:c}),r.initializeUniform("u_rightEye","float",n,{arrayLength:c}),r.initializeUniform("u_noseTip","float",n,{arrayLength:c}),await N()}),r.registerHook("updateTextures",n=>{let e=n[h];if(!(!e||(T.get(h)!==e&&(F=-1),T.set(h,e),!m)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==F){F=e.currentTime;let i=performance.now(),t=m.detectForVideo(e,i);b(t)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let i=m.detect(e);b(i)}}catch(i){console.warn("Face detection error:",i)}}),r.registerHook("destroy",()=>{m&&(m.close(),m=null),_=null,T.clear(),o.remove()}),R(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceCenter[${c}];
uniform vec2 u_leftEye[${c}];
uniform vec2 u_rightEye[${c}];
uniform vec2 u_noseTip[${c}];
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var Y=O;export{Y as default};
//# sourceMappingURL=face.mjs.map