var F=478,u={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function A(I){let{textureName:T,options:s}=I,R="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(o,N){let{uniforms:_,injectGLSL:v}=N,m=null,b=null,k=-1,x=new Map,i=s?.maxFaces??1,S=512,w=512,c=document.createElement("canvas");c.width=S,c.height=w;let f=c.getContext("2d");f.globalCompositeOperation="lighten";async function O(){try{let{FilesetResolver:t,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");b=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),m=await e.createFromOptions(b,{baseOptions:{modelAssetPath:s?.modelPath||R},runningMode:"VIDEO",numFaces:s?.maxFaces??1,minFaceDetectionConfidence:s?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:s?.minFacePresenceConfidence??.5,minTrackingConfidence:s?.minTrackingConfidence??.5,outputFaceBlendshapes:s?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:s?.outputFacialTransformationMatrixes??!1})}catch(t){throw console.error("Failed to initialize Face Landmarker:",t),t}}function C(t){let e=1/0,a=-1/0,r=1/0,n=-1/0;for(let p of t)e=Math.min(e,p.x),a=Math.max(a,p.x),r=Math.min(r,p.y),n=Math.max(n,p.y);let E=(e+a)/2,h=(r+n)/2;return[E,h]}function l(t,e){f.fillStyle=`rgb(${Math.round(e.r*255)}, ${Math.round(e.g*255)}, ${Math.round(e.b*255)})`;let a=t[0];f.beginPath(),f.moveTo(a.x*c.width,a.y*c.height);for(let r=1;r<t.length;r++){let n=t[r];f.lineTo(n.x*c.width,n.y*c.height)}f.closePath(),f.fill()}async function z(t){if(!m){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");f.clearRect(0,0,c.width,c.height),t.forEach((a,r)=>{l(u.OUTER_LIP.map(n=>a[n]),{r:.25,g:0,b:0}),l(u.INNER_LIP.map(n=>a[n]),{r:.75,g:0,b:0}),l(e.FACE_LANDMARKS_TESSELATION.map(({start:n})=>a[n]),{r:0,g:.25,b:0}),l(e.FACE_LANDMARKS_FACE_OVAL.map(({start:n})=>a[n]),{r:0,g:1,b:0}),l(u.LEFT_EYEBROW.map(n=>a[n]),{r:0,g:0,b:.15}),l(u.RIGHT_EYEBROW.map(n=>a[n]),{r:0,g:0,b:.35}),l(u.LEFT_EYE.map(n=>a[n]),{r:0,g:0,b:.65}),l(u.RIGHT_EYE.map(n=>a[n]),{r:0,g:0,b:.85})}),o.updateTextures({u_faceMask:c})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function M(t){if(!t.faceLandmarks)return;let e=[],a=[],r=[],n=[],E=[],h=[];for(let y of t.faceLandmarks){let g=y.map(L=>[L.x,1-L.y]);e.push(g),a.push(C(g)),r.push(g[u.LEFT_EYE_CENTER]),n.push(g[u.RIGHT_EYE_CENTER]),E.push(g[u.NOSE_TIP]),h.push(C(u.INNER_LIP.map(L=>g[L])))}z(t.faceLandmarks).catch(y=>{console.warn("Mask texture update error:",y)});let p=t.faceLandmarks.length,d={u_nFaces:p};p&&(_.has("u_faceLandmarks")&&(d.u_faceLandmarks=e),_.has("u_faceCenter")&&(d.u_faceCenter=a),_.has("u_leftEye")&&(d.u_leftEye=r),_.has("u_rightEye")&&(d.u_rightEye=n),_.has("u_noseTip")&&(d.u_noseTip=E),_.has("u_mouth")&&(d.u_mouth=h)),o.updateUniforms(d)}o.registerHook("init",async()=>{o.initializeTexture("u_faceMask",c),o.initializeUniform("u_maxFaces","int",i),o.initializeUniform("u_nFaces","int",0);let t=Array.from({length:i*F},()=>[.5,.5]),e=Array.from({length:i},()=>[.5,.5]);o.initializeUniform("u_faceLandmarks","float",t,{arrayLength:i*F}),o.initializeUniform("u_faceCenter","float",e,{arrayLength:i}),o.initializeUniform("u_leftEye","float",e,{arrayLength:i}),o.initializeUniform("u_rightEye","float",e,{arrayLength:i}),o.initializeUniform("u_noseTip","float",e,{arrayLength:i}),o.initializeUniform("u_mouth","float",e,{arrayLength:i}),await O()}),o.registerHook("updateTextures",t=>{let e=t[T];if(!(!e||(x.get(T)!==e&&(k=-1),x.set(T,e),!m)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==k){k=e.currentTime;let r=performance.now(),n=m.detectForVideo(e,r);M(n)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let r=m.detect(e);M(r)}}catch(r){console.warn("Face detection error:",r)}}),o.registerHook("destroy",()=>{m&&(m.close(),m=null),b=null,x.clear(),c.remove()}),v(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceLandmarks[${i*F}];
uniform vec2 u_faceCenter[${i}];
uniform vec2 u_leftEye[${i}];
uniform vec2 u_rightEye[${i}];
uniform vec2 u_noseTip[${i}];
uniform vec2 u_mouth[${i}];
uniform sampler2D u_faceMask;
vec2 faceLandmark(int faceIndex, int landmarkIndex) {
	return u_faceLandmarks[faceIndex * ${F} + landmarkIndex];
}
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var Y=A;export{Y as default};
//# sourceMappingURL=face.mjs.map