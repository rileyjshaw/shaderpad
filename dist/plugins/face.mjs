var u={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function P(R){let{textureName:_,options:m}=R,I="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(r,N){let{uniforms:g,injectGLSL:v}=N,f=null,d=null,F=-1,T=new Map,o=m?.maxFaces??1,S=512,w=512,c=document.createElement("canvas");c.width=S,c.height=w;let l=c.getContext("2d");l.globalCompositeOperation="lighten";async function O(){try{let{FilesetResolver:t,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");d=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),f=await e.createFromOptions(d,{baseOptions:{modelAssetPath:m?.modelPath||I},runningMode:"VIDEO",numFaces:m?.maxFaces??1,minFaceDetectionConfidence:m?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:m?.minFacePresenceConfidence??.5,minTrackingConfidence:m?.minTrackingConfidence??.5,outputFaceBlendshapes:m?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:m?.outputFacialTransformationMatrixes??!1})}catch(t){throw console.error("Failed to initialize Face Landmarker:",t),t}}function b(t){let e=1/0,a=-1/0,i=1/0,n=-1/0;for(let s of t)e=Math.min(e,s.x),a=Math.max(a,s.x),i=Math.min(i,s.y),n=Math.max(n,s.y);let h=(e+a)/2,E=(i+n)/2;return[h,E]}function p(t,e){l.fillStyle=`rgb(${Math.round(e.r*255)}, ${Math.round(e.g*255)}, ${Math.round(e.b*255)})`;let a=t[0];l.beginPath(),l.moveTo(a.x*c.width,a.y*c.height);for(let i=1;i<t.length;i++){let n=t[i];l.lineTo(n.x*c.width,n.y*c.height)}l.closePath(),l.fill()}async function Y(t){if(!f){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");l.clearRect(0,0,c.width,c.height),t.forEach((a,i)=>{p(u.OUTER_LIP.map(n=>a[n]),{r:.25,g:0,b:0}),p(u.INNER_LIP.map(n=>a[n]),{r:.75,g:0,b:0}),p(e.FACE_LANDMARKS_TESSELATION.map(({start:n})=>a[n]),{r:0,g:.25,b:0}),p(e.FACE_LANDMARKS_FACE_OVAL.map(({start:n})=>a[n]),{r:0,g:1,b:0}),p(u.LEFT_EYEBROW.map(n=>a[n]),{r:0,g:0,b:.15}),p(u.RIGHT_EYEBROW.map(n=>a[n]),{r:0,g:0,b:.35}),p(u.LEFT_EYE.map(n=>a[n]),{r:0,g:0,b:.65}),p(u.RIGHT_EYE.map(n=>a[n]),{r:0,g:0,b:.85})}),r.updateTextures({u_faceMask:c})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function L(t){if(!t.faceLandmarks)return;let e=[],a=[],i=[],n=[],h=[];for(let s of t.faceLandmarks){let y=b(s),x=s[u.LEFT_EYE_CENTER],k=s[u.RIGHT_EYE_CENTER],C=s[u.NOSE_TIP],z=u.INNER_LIP.map(H=>s[H]),M=b(z);e.push([y[0],1-y[1]]),a.push([x.x,1-x.y]),i.push([k.x,1-k.y]),n.push([C.x,1-C.y]),h.push([M[0],1-M[1]])}Y(t.faceLandmarks).catch(s=>{console.warn("Mask texture update error:",s)});let E={u_nFaces:t.faceLandmarks.length};t.faceLandmarks.length&&(g.has("u_faceCenter")&&(E.u_faceCenter=e),g.has("u_leftEye")&&(E.u_leftEye=a),g.has("u_rightEye")&&(E.u_rightEye=i),g.has("u_noseTip")&&(E.u_noseTip=n),g.has("u_mouth")&&(E.u_mouth=h)),r.updateUniforms(E)}r.registerHook("init",async()=>{r.initializeTexture("u_faceMask",c),r.initializeUniform("u_maxFaces","int",o),r.initializeUniform("u_nFaces","int",0);let t=Array.from({length:o},()=>[.5,.5]);r.initializeUniform("u_faceCenter","float",t,{arrayLength:o}),r.initializeUniform("u_leftEye","float",t,{arrayLength:o}),r.initializeUniform("u_rightEye","float",t,{arrayLength:o}),r.initializeUniform("u_noseTip","float",t,{arrayLength:o}),r.initializeUniform("u_mouth","float",t,{arrayLength:o}),await O()}),r.registerHook("updateTextures",t=>{let e=t[_];if(!(!e||(T.get(_)!==e&&(F=-1),T.set(_,e),!f)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==F){F=e.currentTime;let i=performance.now(),n=f.detectForVideo(e,i);L(n)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let i=f.detect(e);L(i)}}catch(i){console.warn("Face detection error:",i)}}),r.registerHook("destroy",()=>{f&&(f.close(),f=null),d=null,T.clear(),c.remove()}),v(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceCenter[${o}];
uniform vec2 u_leftEye[${o}];
uniform vec2 u_rightEye[${o}];
uniform vec2 u_noseTip[${o}];
uniform vec2 u_mouth[${o}];
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var A=P;export{A as default};
//# sourceMappingURL=face.mjs.map