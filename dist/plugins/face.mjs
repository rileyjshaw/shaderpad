var L=478,V=2,l=L+V,o={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95],FACE_CENTER:L,MOUTH_CENTER:L+1};function W(D){let{textureName:A,options:f}=D,H="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(s,Y){let{injectGLSL:P,gl:R}=Y,E=null,N=null,M=-1,b=new Map,y=f?.maxFaces??1,g=512,I=0,t=null,U=512,K=512,c=document.createElement("canvas");c.width=U,c.height=K;let d=c.getContext("2d");d.globalCompositeOperation="lighten";async function $(){try{let{FilesetResolver:n,FaceLandmarker:e}=await import("@mediapipe/tasks-vision");N=await n.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),E=await e.createFromOptions(N,{baseOptions:{modelAssetPath:f?.modelPath||H},runningMode:"VIDEO",numFaces:f?.maxFaces??1,minFaceDetectionConfidence:f?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:f?.minFacePresenceConfidence??.5,minTrackingConfidence:f?.minTrackingConfidence??.5,outputFaceBlendshapes:f?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:f?.outputFacialTransformationMatrixes??!1})}catch(n){throw console.error("Failed to initialize Face Landmarker:",n),n}}function O(n,e,a){let r=1/0,i=-1/0,x=1/0,u=-1/0,m=0,p=0;for(let G of a){let k=(e*l+G)*4,v=n[k],w=n[k+1];r=Math.min(r,v),i=Math.max(i,v),x=Math.min(x,w),u=Math.max(u,w),m+=n[k+2],p+=n[k+3]}let _=(r+i)/2,h=(x+u)/2,F=m/a.length,C=p/a.length;return[_,h,F,C]}function T(n,e,a){if(!t)return;d.fillStyle=`rgb(${Math.round(a.r*255)}, ${Math.round(a.g*255)}, ${Math.round(a.b*255)})`,d.beginPath();let r=(n*l+e[0])*4,i=t[r],x=t[r+1];d.moveTo(i*c.width,x*c.height);for(let u=1;u<e.length;++u){let m=(n*l+e[u])*4,p=t[m],_=t[m+1];d.lineTo(p*c.width,_*c.height)}d.closePath(),d.fill()}async function z(n){if(!E||!t){console.warn("[Face Plugin] Cannot update mask: faceLandmarker or landmarksDataArray missing");return}try{let{FaceLandmarker:e}=await import("@mediapipe/tasks-vision");d.clearRect(0,0,c.width,c.height);for(let a=0;a<n;++a)T(a,o.OUTER_LIP,{r:.25,g:0,b:0}),T(a,o.INNER_LIP,{r:.75,g:0,b:0}),T(a,e.FACE_LANDMARKS_TESSELATION.map(({start:r})=>r),{r:0,g:.25,b:0}),T(a,e.FACE_LANDMARKS_FACE_OVAL.map(({start:r})=>r),{r:0,g:1,b:0}),T(a,o.LEFT_EYEBROW,{r:0,g:0,b:.15}),T(a,o.RIGHT_EYEBROW,{r:0,g:0,b:.35}),T(a,o.LEFT_EYE,{r:0,g:0,b:.65}),T(a,o.RIGHT_EYE,{r:0,g:0,b:.85});s.updateTextures({u_faceMask:c})}catch(e){console.error("[Face Plugin] Failed to generate mask texture:",e)}}function B(n){if(!t)return;let e=n.length,a=e*l;for(let i=0;i<e;++i){let x=n[i];for(let h=0;h<L;++h){let F=x[h],C=(i*l+h)*4;t[C]=F.x,t[C+1]=1-F.y,t[C+2]=F.z??0,t[C+3]=F.visibility??1}let u=O(t,i,Array.from({length:L},(h,F)=>F)),m=(i*l+o.FACE_CENTER)*4;t[m]=u[0],t[m+1]=u[1],t[m+2]=0,t[m+3]=1;let p=O(t,i,o.INNER_LIP),_=(i*l+o.MOUTH_CENTER)*4;t[_]=p[0],t[_+1]=p[1],t[_+2]=0,t[_+3]=1}let r=Math.ceil(a/g);s.updateTextures({u_faceLandmarksTex:{data:t,width:g,height:r}})}function S(n){if(!n.faceLandmarks||!t)return;let e=n.faceLandmarks.length;B(n.faceLandmarks),z(e).catch(a=>{console.warn("Mask texture update error:",a)}),s.updateUniforms({u_nFaces:e})}s.registerHook("init",async()=>{s.initializeTexture("u_faceMask",c,{preserveY:!0}),s.initializeUniform("u_maxFaces","int",y),s.initializeUniform("u_nFaces","int",0);let n=y*l;I=Math.ceil(n/g);let e=g*I*4;t=new Float32Array(e),s.initializeTexture("u_faceLandmarksTex",{data:t,width:g,height:I},{internalFormat:R.RGBA32F,type:R.FLOAT,minFilter:R.NEAREST,magFilter:R.NEAREST}),await $()}),s.registerHook("updateTextures",n=>{let e=n[A];if(!(!e||(b.get(A)!==e&&(M=-1),b.set(A,e),!E)))try{if(e instanceof HTMLVideoElement){if(e.videoWidth===0||e.videoHeight===0||e.readyState<2)return;if(e.currentTime!==M){M=e.currentTime;let r=performance.now(),i=E.detectForVideo(e,r);S(i)}}else if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){if(e.width===0||e.height===0)return;let r=E.detect(e);S(r)}}catch(r){console.warn("Face detection error:",r)}}),s.registerHook("destroy",()=>{E&&(E.close(),E=null),N=null,b.clear(),c.remove(),t=null}),P(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform sampler2D u_faceLandmarksTex;
uniform sampler2D u_faceMask;

#define FACE_LANDMARK_L_EYE_CENTER ${o.LEFT_EYE_CENTER}
#define FACE_LANDMARK_R_EYE_CENTER ${o.RIGHT_EYE_CENTER}
#define FACE_LANDMARK_NOSE_TIP ${o.NOSE_TIP}
#define FACE_LANDMARK_FACE_CENTER ${o.FACE_CENTER}
#define FACE_LANDMARK_MOUTH_CENTER ${o.MOUTH_CENTER}

vec4 faceLandmark(int faceIndex, int landmarkIndex) {
	int i = faceIndex * ${l} + landmarkIndex;
	int x = i % ${g};
	int y = i / ${g};
	return texelFetch(u_faceLandmarksTex, ivec2(x, y), 0);
}
float inFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float inEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float inMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}var X=W;export{X as default};
//# sourceMappingURL=face.mjs.map