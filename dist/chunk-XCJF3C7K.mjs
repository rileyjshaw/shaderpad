var s={LEFT_EYEBROW:[336,296,334,293,300,276,283,282,295,285],LEFT_EYE:[362,398,384,385,386,387,388,466,263,249,390,373,374,380,381,382],LEFT_EYE_CENTER:473,RIGHT_EYEBROW:[70,63,105,66,107,55,65,52,53,46],RIGHT_EYE:[33,246,161,160,159,158,157,173,133,155,154,153,145,144,163,7],RIGHT_EYE_CENTER:468,NOSE_TIP:4,OUTER_LIP:[61,185,40,39,37,0,267,269,270,409,291,375,321,405,314,17,84,181,91,146],INNER_LIP:[78,191,80,81,82,13,312,311,310,415,308,324,318,402,317,14,87,178,88,95]};function S(L){let{textureName:k,options:u}=L,C="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task";return function(r,M){let{uniforms:_,injectGLSL:R}=M,m=null,d=null,h=-1,F=new Map,c=u?.maxFaces??1,I=512,N=512,o=document.createElement("canvas");o.width=I,o.height=N;let f=o.getContext("2d");f.globalCompositeOperation="lighten";async function O(){try{let{FilesetResolver:t,FaceLandmarker:a}=await import("@mediapipe/tasks-vision");d=await t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"),m=await a.createFromOptions(d,{baseOptions:{modelAssetPath:u?.modelPath||C},runningMode:"VIDEO",numFaces:u?.maxFaces??1,minFaceDetectionConfidence:u?.minFaceDetectionConfidence??.5,minFacePresenceConfidence:u?.minFacePresenceConfidence??.5,minTrackingConfidence:u?.minTrackingConfidence??.5,outputFaceBlendshapes:u?.outputFaceBlendshapes??!1,outputFacialTransformationMatrixes:u?.outputFacialTransformationMatrixes??!1})}catch(t){throw console.error("Failed to initialize Face Landmarker:",t),t}}function v(t){let a=1/0,n=-1/0,i=1/0,e=-1/0;for(let g of t)a=Math.min(a,g.x),n=Math.max(n,g.x),i=Math.min(i,g.y),e=Math.max(e,g.y);let E=(a+n)/2,p=(i+e)/2;return[E,p]}function l(t,a){f.fillStyle=`rgb(${Math.round(a.r*255)}, ${Math.round(a.g*255)}, ${Math.round(a.b*255)})`;let n=t[0];f.beginPath(),f.moveTo(n.x*o.width,n.y*o.height);for(let i=1;i<t.length;i++){let e=t[i];f.lineTo(e.x*o.width,e.y*o.height)}f.closePath(),f.fill()}async function w(t){if(!m){console.warn("[Face Plugin] Cannot update mask: faceLandmarker missing");return}try{let{FaceLandmarker:a}=await import("@mediapipe/tasks-vision");f.clearRect(0,0,o.width,o.height),t.forEach((n,i)=>{l(s.OUTER_LIP.map(e=>n[e]),{r:.25,g:0,b:0}),l(s.INNER_LIP.map(e=>n[e]),{r:.75,g:0,b:0}),l(a.FACE_LANDMARKS_TESSELATION.map(({start:e})=>n[e]),{r:0,g:.25,b:0}),l(a.FACE_LANDMARKS_FACE_OVAL.map(({start:e})=>n[e]),{r:0,g:1,b:0}),l(s.LEFT_EYEBROW.map(e=>n[e]),{r:0,g:0,b:.15}),l(s.RIGHT_EYEBROW.map(e=>n[e]),{r:0,g:0,b:.35}),l(s.LEFT_EYE.map(e=>n[e]),{r:0,g:0,b:.65}),l(s.RIGHT_EYE.map(e=>n[e]),{r:0,g:0,b:.85})}),r.updateTextures({u_faceMask:o})}catch(a){console.error("[Face Plugin] Failed to generate mask texture:",a)}}function T(t){if(!t.faceLandmarks)return;let a=[],n=[],i=[],e=[];for(let p of t.faceLandmarks){let g=v(p),b=p[s.LEFT_EYE_CENTER],x=p[s.RIGHT_EYE_CENTER],y=p[s.NOSE_TIP];a.push([g[0],1-g[1]]),n.push([b.x,1-b.y]),i.push([x.x,1-x.y]),e.push([y.x,1-y.y])}w(t.faceLandmarks).catch(p=>{console.warn("Mask texture update error:",p)});let E={u_nFaces:t.faceLandmarks.length};t.faceLandmarks.length&&(_.has("u_faceCenter")&&(E.u_faceCenter=a),_.has("u_leftEye")&&(E.u_leftEye=n),_.has("u_rightEye")&&(E.u_rightEye=i),_.has("u_noseTip")&&(E.u_noseTip=e)),r.updateUniforms(E)}r.registerHook("init",async()=>{r.initializeTexture("u_faceMask",o),r.initializeUniform("u_maxFaces","int",c),r.initializeUniform("u_nFaces","int",0);let t=Array.from({length:c},()=>[.5,.5]);r.initializeUniform("u_faceCenter","float",t,{arrayLength:c}),r.initializeUniform("u_leftEye","float",t,{arrayLength:c}),r.initializeUniform("u_rightEye","float",t,{arrayLength:c}),r.initializeUniform("u_noseTip","float",t,{arrayLength:c}),await O()}),r.registerHook("updateTextures",t=>{Object.entries(t).forEach(([a,n])=>{if(a===k&&(F.set(a,n),!!m))try{if(n instanceof HTMLVideoElement){if(n.currentTime!==h){h=n.currentTime;let i=performance.now(),e=m.detectForVideo(n,i);T(e)}}else if(n instanceof HTMLImageElement){let i=m.detect(n);T(i)}}catch(i){console.warn("Face detection error:",i)}})}),r.registerHook("destroy",()=>{m&&(m.close(),m=null),d=null,F.clear(),o.remove()}),R(`
uniform int u_maxFaces;
uniform int u_nFaces;
uniform vec2 u_faceCenter[${c}];
uniform vec2 u_leftEye[${c}];
uniform vec2 u_rightEye[${c}];
uniform vec2 u_noseTip[${c}];
uniform sampler2D u_faceMask;
float getFace(vec2 pos) { return texture(u_faceMask, pos).g; }
float getEye(vec2 pos) { return texture(u_faceMask, pos).b; }
float getMouth(vec2 pos) { return texture(u_faceMask, pos).r; }`)}}export{S as a};
//# sourceMappingURL=chunk-XCJF3C7K.mjs.map